<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTTH Topology Center</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (Peta) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster (untuk ODP) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Leaflet Draw untuk drag & drop -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS untuk Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Kustomisasi Leaflet agar sesuai Tailwind */
        .leaflet-popup-content-wrapper { @apply rounded-lg shadow-lg border-0; }
        .leaflet-popup-content { @apply text-sm; }
        .leaflet-popup-tip { @apply shadow-none; }
        
        /* Sembunyikan scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        
        /* Sidebar transition */
        #sidebar { transition: margin-left 0.3s ease-in-out; }
        #main-content { transition: margin-left 0.3s ease-in-out; }
        .sidebar-collapsed { margin-left: -256px; /* 16rem */ }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Detail Modal */
        .detail-section {
            @apply border-b border-gray-200 pb-4 mb-4;
        }
        .detail-section:last-child {
            @apply border-b-0 pb-0 mb-0;
        }
        
        /* Placeholder text yang redup */
        .placeholder-help {
            @apply text-xs text-gray-400 mt-1;
        }
        
        /* Login form styles */
        .login-container {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        
        /* Dark mode styles */
        body.dark-mode {
            @apply bg-gray-900;
        }
        body.dark-mode .bg-white {
            @apply bg-gray-800 text-white;
        }
        body.dark-mode .bg-gray-50 {
            @apply bg-gray-700;
        }
        body.dark-mode .text-gray-800 {
            @apply text-gray-200;
        }
        body.dark-mode .text-gray-700 {
            @apply text-gray-300;
        }
        body.dark-mode .text-gray-600 {
            @apply text-gray-400;
        }
        body.dark-mode .text-gray-500 {
            @apply text-gray-500;
        }
        body.dark-mode .border-gray-200 {
            @apply border-gray-700;
        }
        body.dark-mode .border-gray-300 {
            @apply border-gray-600;
        }
        body.dark-mode .hover\:bg-gray-100:hover {
            @apply bg-gray-700;
        }
        body.dark-mode .hover\:bg-gray-50:hover {
            @apply bg-gray-700;
        }
        
        /* Custom styles for map filters */
        .filter-container {
            @apply bg-white p-4 rounded-lg shadow-md mb-4;
        }
        .filter-section {
            @apply mb-4 pb-4 border-b border-gray-200;
        }
        .filter-section:last-child {
            @apply border-b-0 pb-0 mb-0;
        }
        .filter-title {
            @apply font-semibold text-gray-700 mb-2;
        }
        .filter-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .filter-select {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .filter-button {
            @apply px-3 py-1 rounded text-sm text-white font-medium;
        }
        .filter-button.active {
            @apply opacity-100;
        }
        .filter-button.inactive {
            @apply opacity-50;
        }
        .search-result {
            @apply p-2 border-b border-gray-200 hover:bg-gray-50 cursor-pointer;
        }
        .search-result:last-child {
            @apply border-b-0;
        }
        .search-result-title {
            @apply font-medium text-gray-800;
        }
        .search-result-detail {
            @apply text-sm text-gray-600;
        }
        
        /* Custom styles for session timeout warning */
        .session-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            max-width: 350px;
        }
        
        /* Custom styles for capacity indicators */
        .capacity-indicator {
            height: 8px;
            border-radius: 4px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .capacity-bar {
            height: 100%;
            transition: width 0.3s ease;
        }
        .capacity-low {
            background-color: #10b981;
        }
        .capacity-medium {
            background-color: #f59e0b;
        }
        .capacity-high {
            background-color: #ef4444;
        }
        
        /* Custom styles for drag marker */
        .marker-dragging {
            opacity: 0.7;
        }
        
        /* Custom styles for connection lines */
        .connection-line {
            stroke: #3b82f6;
            stroke-width: 3;
            stroke-opacity: 0.7;
            fill: none;
        }
        .connection-line-feeder {
            stroke: #10b981;
        }
        .connection-line-distribution {
            stroke: #f59e0b;
        }
        .connection-line-customer {
            stroke: #8b5cf6;
            stroke-dasharray: 5, 5;
        }
        
        /* Custom styles for toggle buttons */
        .toggle-button {
            @apply px-4 py-2 rounded-md text-white font-medium transition-all duration-300 transform hover:scale-105;
        }
        .toggle-button.active {
            @apply shadow-lg;
        }
        .toggle-button.inactive {
            @apply opacity-60;
        }
        
        /* Custom styles for dashboard cards */
        .dashboard-card {
            @apply bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 cursor-pointer;
        }
        .dashboard-card:hover {
            @apply transform -translate-y-1;
        }
        
        /* Custom styles for inventory management */
        .inventory-item {
            @apply flex items-center justify-between p-3 border-b border-gray-200;
        }
        .inventory-item:last-child {
            @apply border-b-0;
        }
        .stock-low {
            @apply text-red-600 font-medium;
        }
        .stock-medium {
            @apply text-yellow-600 font-medium;
        }
        .stock-high {
            @apply text-green-600 font-medium;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center login-container">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-600">FTTH Center</h1>
                <p class="text-gray-600 mt-2">Silakan login untuk melanjutkan</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin@ftth.com">
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                    <span id="login-button-text">Login</span>
                    <div id="login-spinner" class="loader w-5 h-5 border-2 border-t-blue-200 ml-2 hidden"></div>
                </button>
                
                <div id="login-error" class="text-red-600 text-sm text-center hidden"></div>
            </form>
        </div>
    </div>

    <!-- 2. OVERLAY LOADING APLIKASI -->
    <div id="app-loader" class="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center hidden">
        <div class="loader"></div>
        <p class="text-gray-700 mt-4 text-lg">Memuat aplikasi...</p>
    </div>

    <!-- 3. SHELL APLIKASI UTAMA (Hidden by default) -->
    <div id="app-shell" class="hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-30">
            <div class="flex items-center justify-between p-4 border-b">
                <h1 class="text-xl font-bold text-blue-600">FTTH Center</h1>
                <button id="sidebar-close-btn" class="sm:hidden p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <nav class="py-4">
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="map">
                    <i data-lucide="map" class="w-5 h-5 mr-3"></i> Peta Jaringan
                </a>
                <div class="px-6 py-2 text-xs font-semibold text-gray-400 uppercase">Aset Jaringan</div>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="OLT">
                    <i data-lucide="server" class="w-5 h-5 mr-3"></i> OLT
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="ODC">
                    <i data-lucide="server-cog" class="w-5 h-5 mr-3"></i> ODC
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="ODP">
                    <i data-lucide="box" class="w-5 h-5 mr-3"></i> ODP
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="Pelanggan">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i> Pelanggan
                </a>
                <div class="px-6 py-2 text-xs font-semibold text-gray-400 uppercase">Manajemen</div>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="Paket">
                    <i data-lucide="package" class="w-5 h-5 mr-3"></i> Paket Layanan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="Karyawan">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i> Karyawan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="inventory">
                    <i data-lucide="package-2" class="w-5 h-5 mr-3"></i> Inventory
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="pengaturan">
                    <i data-lucide="settings" class="w-5 h-5 mr-3"></i> Pengaturan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="audit">
                    <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Audit Log
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="ml-0 sm:ml-64 relative min-h-screen">
            <!-- Top Navbar -->
            <header class="sticky top-0 bg-white shadow-md z-20">
                <div class="flex items-center justify-between h-16 px-4 sm:px-8">
                    <button id="sidebar-open-btn" class="p-2 -ml-2 rounded-md sm:hidden">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    
                    <div class="flex items-center space-x-4">
                        <div id="online-status" class="flex items-center space-x-2">
                            <span id="online-indicator" class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span id="online-text" class="text-sm font-medium text-gray-700">Online</span>
                        </div>
                        <div class="relative" id="user-menu-button">
                            <button class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100">
                                <img src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="User" class="w-8 h-8 rounded-full">
                                <div class="hidden md:block text-left">
                                    <div id="user-email" class="text-sm font-semibold">Admin FTTH</div>
                                    <div id="user-role" class="text-xs text-gray-500">Administrator</div>
                                </div>
                            </button>
                            <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content Area -->
            <div class="p-4 sm:p-8">
                
                <!-- Page: Dashboard -->
                <div id="page-dashboard" class="page-content">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                        <div class="text-sm text-gray-600">
                            <span id="current-time" class="font-medium"></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="dashboard-card" data-entity="ODP">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Total ODP</div>
                                    <div id="stat-odp" class="text-3xl font-bold text-gray-900">0</div>
                                </div>
                                <i data-lucide="box" class="w-10 h-10 text-blue-500"></i>
                            </div>
                        </div>
                        <div class="dashboard-card" data-entity="Pelanggan">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Total Pelanggan</div>
                                    <div id="stat-pelanggan" class="text-3xl font-bold text-gray-900">0</div>
                                </div>
                                <i data-lucide="users" class="w-10 h-10 text-green-500"></i>
                            </div>
                        </div>
                        <div class="dashboard-card" data-entity="OLT">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Total OLT</div>
                                    <div id="stat-olt" class="text-3xl font-bold text-gray-900">0</div>
                                </div>
                                <i data-lucide="server" class="w-10 h-10 text-red-500"></i>
                            </div>
                        </div>
                        <div class="dashboard-card" data-entity="Karyawan">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Karyawan</div>
                                    <div id="stat-karyawan" class="text-3xl font-bold text-blue-500">0</div>
                                </div>
                                <i data-lucide="user-check" class="w-10 h-10 text-blue-500"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network Status Card -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Status Jaringan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-2">Utilisasi Port ODP</div>
                                <div class="flex items-center">
                                    <div class="flex-1 mr-2">
                                        <div class="capacity-indicator">
                                            <div id="odp-capacity-bar" class="capacity-bar capacity-low" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <span id="odp-capacity-text" class="text-sm font-medium">0%</span>
                                </div>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-2">Utilisasi Port ODC</div>
                                <div class="flex items-center">
                                    <div class="flex-1 mr-2">
                                        <div class="capacity-indicator">
                                            <div id="odc-capacity-bar" class="capacity-bar capacity-low" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <span id="odc-capacity-text" class="text-sm font-medium">0%</span>
                                </div>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-2">Utilisasi Port OLT</div>
                                <div class="flex items-center">
                                    <div class="flex-1 mr-2">
                                        <div class="capacity-indicator">
                                            <div id="olt-capacity-bar" class="capacity-bar capacity-low" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <span id="olt-capacity-text" class="text-sm font-medium">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Antrian Sinkronisasi Offline</h3>
                        <div id="offline-queue-list" class="text-gray-600">Tidak ada item dalam antrian.</div>
                    </div>
                    <div class="mt-8 bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200">
                        <div class="flex items-center">
                            <i data-lucide="shield-check" class="w-6 h-6 text-blue-600 mr-3"></i>
                            <h3 class="text-lg font-semibold text-blue-800">Mode Administrator</h3>
                        </div>
                        <p class="mt-2 text-blue-700">Anda login sebagai Administrator dengan akses penuh ke semua fitur sistem.</p>
                    </div>
                </div>

                <!-- Page: Peta Jaringan -->
                <div id="page-map" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Peta Jaringan</h2>
                    
                    <!-- Filter Container -->
                    <div class="filter-container">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button id="toggle-olt" class="toggle-button bg-red-500 active">OLT</button>
                            <button id="toggle-odc" class="toggle-button bg-blue-500 active">ODC</button>
                            <button id="toggle-odp" class="toggle-button bg-green-500 active">ODP</button>
                            <button id="toggle-pelanggan" class="toggle-button bg-yellow-500 active">Pelanggan</button>
                            <button id="toggle-connections" class="toggle-button bg-purple-500 inactive">Koneksi</button>
                            <button id="clear-connections" class="toggle-button bg-gray-500 inactive">Hapus Koneksi</button>
                        </div>
                        
                        <!-- Search Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Device Type Filter -->
                            <div>
                                <label class="filter-title">Jenis Perangkat</label>
                                <select id="device-type-filter" class="filter-select">
                                    <option value="">Semua Perangkat</option>
                                    <option value="OLT">OLT</option>
                                    <option value="ODC">ODC</option>
                                    <option value="ODP">ODP</option>
                                    <option value="Pelanggan">Pelanggan</option>
                                </select>
                            </div>
                            
                            <!-- Region Code Filter -->
                            <div>
                                <label class="filter-title">Kode Wilayah</label>
                                <input type="text" id="region-code-filter" class="filter-input" placeholder="Contoh: SBY">
                            </div>
                            
                            <!-- Sector Code Filter -->
                            <div>
                                <label class="filter-title">Kode Sektor</label>
                                <input type="text" id="sector-code-filter" class="filter-input" placeholder="Contoh: FA">
                            </div>
                            
                            <!-- ONT SN Filter -->
                            <div>
                                <label class="filter-title">SN ONT</label>
                                <input type="text" id="ont-sn-filter" class="filter-input" placeholder="Contoh: ONT123456789">
                            </div>
                        </div>
                        
                        <!-- Apply Filters Button -->
                        <div class="mt-4 flex justify-end">
                            <button id="apply-filters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mr-2">Terapkan Filter</button>
                            <button id="reset-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">Reset Filter</button>
                        </div>
                    </div>
                    
                    <div id="map-container" class="w-full h-[70vh] rounded-lg shadow-md z-10"></div>
                </div>

                <!-- Page: Tabel Entitas (Dinamis) -->
                <div id="page-table" class="page-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="table-title" class="text-3xl font-bold text-gray-800">Manajemen Aset</h2>
                        <div class="flex space-x-2">
                            <button id="import-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-green-700">
                                <i data-lucide="upload" class="w-5 h-5"></i>
                                <span>Import</span>
                            </button>
                            <button id="export-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-green-700">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <span>Export</span>
                            </button>
                            <button id="add-new-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-blue-700">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Tambah Baru</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Section -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="table-search" placeholder="Cari data..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr id="table-header-row">
                                        <!-- Header dinamis di-inject di sini -->
                                    </tr>
                                </thead>
                                <tbody id="table-body" class="divide-y">
                                    <!-- Data dinamis di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <div class="text-sm text-gray-700">
                                Menampilkan <span id="showing-from">0</span> hingga <span id="showing-to">0</span> dari <span id="total-records">0</span> data
                            </div>
                            <div class="flex space-x-2">
                                <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50" disabled>
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                </button>
                                <span id="page-info" class="px-3 py-1">Halaman 1</span>
                                <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50" disabled>
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Inventory -->
                <div id="page-inventory" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Inventory Management</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- ONT Devices -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold">Perangkat ONT</h3>
                                <button id="add-ont-btn" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div id="ont-inventory-list" class="space-y-2">
                                <!-- ONT inventory items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Cables -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold">Kabel</h3>
                                <button id="add-cable-btn" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div id="cable-inventory-list" class="space-y-2">
                                <!-- Cable inventory items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Splitters -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold">Splitter</h3>
                                <button id="add-splitter-btn" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div id="splitter-inventory-list" class="space-y-2">
                                <!-- Splitter inventory items will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Other Materials -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold">Material Lainnya</h3>
                                <button id="add-material-btn" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div id="material-inventory-list" class="space-y-2">
                                <!-- Material inventory items will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Pengaturan -->
                <div id="page-pengaturan" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Pengaturan Sistem</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Mode Generate Nomor -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Mode Generate Nomor</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Generate Nomor Internet Otomatis</p>
                                        <p class="text-sm text-gray-600">Aktifkan untuk membuat nomor internet otomatis saat tambah pelanggan</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-generate-number" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Format Nomor Internet</label>
                                    <input type="text" id="number-format" value="PLG-{YYYY}-{MM}-{SEQ}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Variabel: {YYYY} = Tahun, {MM} = Bulan, {SEQ} = Urutan</p>
                                </div>
                            </div>
                        </div>

                        <!-- Backup Otomatis -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Backup Otomatis</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Aktifkan Backup Otomatis</p>
                                        <p class="text-sm text-gray-600">Backup data setiap hari</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-backup" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Waktu Backup</label>
                                    <select id="backup-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="00:00">00:00</option>
                                        <option value="01:00">01:00</option>
                                        <option value="02:00">02:00</option>
                                        <option value="03:00">03:00</option>
                                        <option value="04:00">04:00</option>
                                        <option value="05:00">05:00</option>
                                        <option value="06:00">06:00</option>
                                        <option value="07:00">07:00</option>
                                        <option value="08:00">08:00</option>
                                        <option value="09:00">09:00</option>
                                        <option value="10:00">10:00</option>
                                        <option value="11:00">11:00</option>
                                        <option value="12:00">12:00</option>
                                        <option value="13:00">13:00</option>
                                        <option value="14:00">14:00</option>
                                        <option value="15:00">15:00</option>
                                        <option value="16:00">16:00</option>
                                        <option value="17:00">17:00</option>
                                        <option value="18:00">18:00</option>
                                        <option value="19:00">19:00</option>
                                        <option value="20:00">20:00</option>
                                        <option value="21:00">21:00</option>
                                        <option value="22:00">22:00</option>
                                        <option value="23:00">23:00</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Mode Warna -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Mode Warna</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Mode Gelap</p>
                                        <p class="text-sm text-gray-600">Aktifkan tema gelap</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="dark-mode" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Bahasa -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Bahasa</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Bahasa</p>
                                        <p class="text-sm text-gray-600">Pilih bahasa tampilan</p>
                                    </div>
                                    <select id="language" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="id">Indonesia</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Session Management -->
                        <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4">Manajemen Sesi</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Timeout Sesi (menit)</label>
                                    <input type="number" id="session-timeout" value="15" min="5" max="60" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Warning Timeout (menit)</label>
                                    <input type="number" id="warning-timeout" value="13" min="1" max="59" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex items-end">
                                    <button id="save-session-settings" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                        Simpan Pengaturan
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Ubah Password -->
                        <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4">Ubah Password</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Saat Ini</label>
                                    <input type="password" id="current-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Baru</label>
                                    <input type="password" id="new-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Password Baru</label>
                                    <input type="password" id="confirm-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="mt-4">
                                <button id="save-password" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                    Simpan Password
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Audit Log -->
                <div id="page-audit" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Audit Log</h2>
                    
                    <!-- Filter Section -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                <input type="date" id="audit-date-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pengguna</label>
                                <select id="audit-user-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Pengguna</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Aksi</label>
                                <select id="audit-action-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Aksi</option>
                                    <option value="create">Tambah</option>
                                    <option value="update">Edit</option>
                                    <option value="delete">Hapus</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Entitas</label>
                                <select id="audit-entity-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Entitas</option>
                                    <option value="OLT">OLT</option>
                                    <option value="ODC">ODC</option>
                                    <option value="ODP">ODP</option>
                                    <option value="Pelanggan">Pelanggan</option>
                                    <option value="Paket">Paket</option>
                                    <option value="Karyawan">Karyawan</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="apply-audit-filters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mr-2">Terapkan Filter</button>
                            <button id="reset-audit-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">Reset Filter</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pengguna</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Entitas</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Detail</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-log-body" class="divide-y">
                                    <!-- Data log dinamis di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- 4. MODAL FORM (Dinamis) -->
    <div id="form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="entity-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="form-title" class="text-2xl font-bold text-gray-800">Form Entitas</h2>
                <button type="button" id="close-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="form-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Konten form dinamis di-inject di sini -->
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <input type="hidden" id="form-entity-type">
                <input type="hidden" id="form-entity-id">
                <button type="button" id="cancel-modal-button" class="bg-gray-200 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 flex items-center">
                    <span id="submit-button-text">Simpan</span>
                    <div id="submit-spinner" class="loader w-5 h-5 border-2 border-t-blue-200 ml-2 hidden"></div>
                </button>
            </div>
        </form>
    </div>

    <!-- 5. MODAL DETAIL (View Detail) -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="detail-title" class="text-2xl font-bold text-gray-800">Detail Data</h2>
                <button type="button" id="close-detail-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="detail-content">
                <!-- Konten detail di-inject di sini -->
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button type="button" id="close-detail-modal-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- 6. MODAL IMPORT -->
    <div id="import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Import Data</h2>
                <button type="button" id="close-import-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih File</label>
                <input type="file" id="import-file" accept=".csv,.xlsx,.xls" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-xs text-gray-500 mt-1">Format yang didukung: CSV, Excel (.xlsx, .xls)</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Entitas</label>
                <select id="import-entity-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Pilih Jenis Entitas</option>
                    <option value="OLT">OLT</option>
                    <option value="ODC">ODC</option>
                    <option value="ODP">ODP</option>
                    <option value="Pelanggan">Pelanggan</option>
                    <option value="Paket">Paket</option>
                    <option value="Karyawan">Karyawan</option>
                </select>
            </div>
            
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-import-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="button" id="process-import-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                    Import
                </button>
            </div>
        </div>
    </div>

    <!-- 7. MODAL INVENTORY -->
    <div id="inventory-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="inventory-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex items-center justify-between mb-6">
                <h2 id="inventory-form-title" class="text-2xl font-bold text-gray-800">Tambah Item Inventory</h2>
                <button type="button" id="close-inventory-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Item</label>
                    <select id="inventory-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Jenis</option>
                        <option value="ONT">ONT</option>
                        <option value="Kabel">Kabel</option>
                        <option value="Splitter">Splitter</option>
                        <option value="Material">Material Lainnya</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Item</label>
                    <input type="text" id="inventory-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stok Minimum</label>
                    <input type="number" id="inventory-min-stock" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stok Saat Ini</label>
                    <input type="number" id="inventory-current-stock" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button type="button" id="cancel-inventory-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                    Simpan
                </button>
            </div>
        </form>
    </div>

    <!-- 8. NOTIFICATION TOAST -->
    <div id="notification-toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden transition-opacity duration-300">
        <span id="toast-message"></span>
    </div>

    <!-- 9. SESSION WARNING MODAL -->
    <div id="session-warning" class="session-warning hidden">
        <div class="flex items-center mb-4">
            <i data-lucide="alert-circle" class="w-6 h-6 text-yellow-500 mr-3"></i>
            <h3 class="text-lg font-semibold">Sesi Akan Berakhir</h3>
        </div>
        <p class="text-gray-600 mb-4">Sesi Anda akan berakhir dalam <span id="session-countdown">2:00</span> menit karena tidak ada aktivitas. Apakah Anda ingin melanjutkan sesi?</p>
        <div class="flex justify-end space-x-2">
            <button id="extend-session" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Lanjutkan Sesi</button>
            <button id="logout-now" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Logout</button>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- SCRIPT UTAMA APLIKASI -->
    <!-- ====================================================================== -->
    <script>
        // --- Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyXLfovZUAPzPfm1LakEFPPgwGegaQr4o",
            authDomain: "user-management-bccb1.firebaseapp.com",
            projectId: "user-management-bccb1",
            storageBucket: "user-management-bccb1.firebasestorage.app",
            messagingSenderId: "22188892577",
            appId: "1:22188892577:web:d8c7ebe3e00e1974956be0",
            measurementId: "G-4SEKELHMTF"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Variabel Global & State ---
        let currentUser = null;
        let userId = null;
        let userRole = null;
        let isOnline = navigator.onLine;
        let map;
        let markerLayers = {
            OLT: L.layerGroup(),
            ODC: L.layerGroup(),
            ODP: L.markerClusterGroup(),
            Pelanggan: L.markerClusterGroup()
        };
        let connectionLines = [];
        let selectedMarker = null;
        let draggedMarker = null;
        
        // Data cache untuk aplikasi
        let dataCache = {
            OLT: [],
            ODC: [],
            ODP: [],
            Pelanggan: [],
            Paket: [],
            Karyawan: [],
            AuditLog: [],
            Inventory: []
        };
        
        let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
        let settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
        let currentPage = 1;
        let itemsPerPage = 10;
        let filteredData = [];
        
        // Session management variables
        let sessionTimeout;
        let warningTimeout;
        let countdownInterval;
        let sessionTimeoutMinutes = 15;
        let warningTimeoutMinutes = 13;

        // --- Selektor DOM ---
        const $ = document.getElementById.bind(document);
        const $$ = document.querySelectorAll.bind(document);
        
        const loginScreen = $('login-screen');
        const loginForm = $('login-form');
        const appLoader = $('app-loader');
        const appShell = $('app-shell');
        const sidebar = $('sidebar');
        const onlineIndicator = $('online-indicator');
        const onlineText = $('online-text');
        const formModal = $('form-modal');
        const entityForm = $('entity-form');
        const formTitle = $('form-title');
        const formContent = $('form-content');
        const formEntityType = $('form-entity-type');
        const formEntityId = $('form-entity-id');
        const detailModal = $('detail-modal');
        const detailTitle = $('detail-title');
        const detailContent = $('detail-content');
        const importModal = $('import-modal');
        const inventoryModal = $('inventory-modal');
        const inventoryForm = $('inventory-form');
        const toast = $('notification-toast');
        const toastMessage = $('toast-message');
        const sessionWarning = $('session-warning');

        // --- 1. Inisialisasi Aplikasi ---
        
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupAuthStateListener();
            setupOfflineSync();
            updateOnlineStatusUI(isOnline);
            loadSettings();
            applySettings();
            setupSessionManagement();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });

        // --- 2. Autentikasi Firebase ---
        
        function setupAuthStateListener() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User sudah login
                    currentUser = user;
                    userId = user.uid;
                    userRole = 'Administrator'; // Default role
                    
                    // Update UI dengan info user
                    $('user-email').textContent = user.email;
                    $('user-role').textContent = userRole;
                    
                    // Sembunyikan login screen, tampilkan aplikasi
                    loginScreen.classList.add('hidden');
                    appLoader.classList.remove('hidden');
                    
                    // Inisialisasi aplikasi
                    initAppUI();
                } else {
                    // User belum login
                    currentUser = null;
                    userId = null;
                    userRole = null;
                    
                    // Tampilkan login screen, sembunyikan aplikasi
                    loginScreen.classList.remove('hidden');
                    appShell.classList.add('hidden');
                    appLoader.classList.add('hidden');
                }
            });
        }

        // Event listener untuk form login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = $('login-email').value;
            const password = $('login-password').value;
            const loginError = $('login-error');
            const loginButtonText = $('login-button-text');
            const loginSpinner = $('login-spinner');
            
            // Tampilkan loading state
            loginButtonText.textContent = 'Logging in...';
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state listener akan menangani transisi ke aplikasi
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = getAuthErrorMessage(error.code);
                loginError.classList.remove('hidden');
            } finally {
                // Reset loading state
                loginButtonText.textContent = 'Login';
                loginSpinner.classList.add('hidden');
            }
        });

        // Event listener untuk logout
        $('logout-button').addEventListener('click', () => {
            auth.signOut();
        });

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'Format email tidak valid';
                case 'auth/user-disabled':
                    return 'Akun ini telah dinonaktifkan';
                case 'auth/user-not-found':
                    return 'Akun tidak ditemukan';
                case 'auth/wrong-password':
                    return 'Password salah';
                case 'auth/too-many-requests':
                    return 'Terlalu banyak percobaan login. Coba lagi nanti';
                default:
                    return 'Terjadi kesalahan saat login';
            }
        }

        // --- 3. Inisialisasi UI Aplikasi ---
        
        function initAppUI() {
            // Setup UI
            appLoader.classList.add('hidden');
            appShell.classList.remove('hidden');
            
            // Inisialisasi Peta
            initMap();
            
            // Setup Navigasi
            setupNavigation();

            // Setup User Menu
            $('user-menu-button').addEventListener('click', () => {
                $('user-menu-dropdown').classList.toggle('hidden');
            });

            // Setup Modal Detail
            $('close-detail-button').addEventListener('click', () => detailModal.classList.add('hidden'));
            $('close-detail-modal-button').addEventListener('click', () => detailModal.classList.add('hidden'));

            // Setup Modal Import
            $('close-import-modal-button').addEventListener('click', () => importModal.classList.add('hidden'));
            $('cancel-import-button').addEventListener('click', () => importModal.classList.add('hidden'));
            $('process-import-button').addEventListener('click', processImport);
            
            // Setup Import Button
            $('import-button').addEventListener('click', () => {
                importModal.classList.remove('hidden');
            });
            
            // Setup Modal Inventory
            $('close-inventory-modal-button').addEventListener('click', () => inventoryModal.classList.add('hidden'));
            $('cancel-inventory-button').addEventListener('click', () => inventoryModal.classList.add('hidden'));
            inventoryForm.addEventListener('submit', saveInventoryItem);
            
            // Setup Inventory Buttons
            $('add-ont-btn').addEventListener('click', () => showInventoryModal('ONT'));
            $('add-cable-btn').addEventListener('click', () => showInventoryModal('Kabel'));
            $('add-splitter-btn').addEventListener('click', () => showInventoryModal('Splitter'));
            $('add-material-btn').addEventListener('click', () => showInventoryModal('Material'));
            
            // Setup Dashboard Cards
            setupDashboardCards();
            
            // Setup Settings
            setupSettings();

            // Muat semua data dari Firebase atau cache lokal
            if (isOnline) {
                loadAllData();
            } else {
                loadLocalData();
            }

            // Tampilkan dashboard sebagai default
            showPage('dashboard');
        }

        // --- 4. Navigasi & UI Interactivity ---

        function setupNavigation() {
            // Kontrol Sidebar
            $('sidebar-open-btn').addEventListener('click', () => sidebar.classList.remove('sidebar-collapsed'));
            $('sidebar-close-btn').addEventListener('click', () => sidebar.classList.add('sidebar-collapsed'));
            
            if (window.innerWidth < 640) {
                 sidebar.classList.add('sidebar-collapsed');
            }
            
            // Navigasi Halaman
            $$('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    const entity = link.dataset.entity;
                    
                    if (entity) {
                        loadTablePage(entity);
                    }
                    showPage(page);
                    
                    if (window.innerWidth < 640) {
                        sidebar.classList.add('sidebar-collapsed');
                    }
                });
            });

            // Kontrol Modal
            $('close-modal-button').addEventListener('click', () => formModal.classList.add('hidden'));
            $('cancel-modal-button').addEventListener('click', () => formModal.classList.add('hidden'));
            $('add-new-button').addEventListener('click', () => {
                const currentEntity = $('table-title').dataset.entity;
                if (currentEntity) {
                    showFormModal(currentEntity);
                }
            });
        }

        function setupDashboardCards() {
            $$('.dashboard-card').forEach(card => {
                card.addEventListener('click', () => {
                    const entity = card.dataset.entity;
                    if (entity) {
                        loadTablePage(entity);
                        showPage('table');
                    }
                });
            });
        }

        function showPage(pageId) {
            $$('.page-content').forEach(page => page.classList.add('hidden'));
            $(pageId === 'table' ? 'page-table' : `page-${pageId}`).classList.remove('hidden');
            
            if (pageId === 'map') {
                // Perlu me-refresh peta jika ukurannya berubah saat disembunyikan
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
            }
        }

        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            if (type === 'error') {
                toast.classList.replace('bg-gray-900', 'bg-red-600');
            } else if (type === 'warning') {
                toast.classList.replace('bg-gray-900', 'bg-yellow-600');
            } else {
                toast.classList.replace('bg-red-600', 'bg-gray-900');
                toast.classList.replace('bg-yellow-600', 'bg-gray-900');
            }
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // --- 5. Logika Peta (Leaflet) ---

        function initMap() {
            map = L.map('map-container').setView([-6.2088, 106.8456], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Tambahkan semua layer group ke peta
            Object.values(markerLayers).forEach(layer => layer.addTo(map));
            
            // Setup event listeners untuk toggle layer
            setupMapControls();
            
            // Setup filter controls
            setupMapFilters();
        }

        function setupMapControls() {
            // Toggle OLT
            $('toggle-olt').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.OLT)) {
                    map.removeLayer(markerLayers.OLT);
                    $('toggle-olt').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.OLT);
                    $('toggle-olt').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle ODC
            $('toggle-odc').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.ODC)) {
                    map.removeLayer(markerLayers.ODC);
                    $('toggle-odc').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.ODC);
                    $('toggle-odc').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle ODP
            $('toggle-odp').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.ODP)) {
                    map.removeLayer(markerLayers.ODP);
                    $('toggle-odp').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.ODP);
                    $('toggle-odp').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle Pelanggan
            $('toggle-pelanggan').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.Pelanggan)) {
                    map.removeLayer(markerLayers.Pelanggan);
                    $('toggle-pelanggan').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.Pelanggan);
                    $('toggle-pelanggan').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle Connections
            $('toggle-connections').addEventListener('click', () => {
                if (connectionLines.length > 0) {
                    clearConnectionLines();
                    $('toggle-connections').classList.replace('active', 'inactive');
                } else {
                    showAllConnections();
                    $('toggle-connections').classList.replace('inactive', 'active');
                }
            });
            
            // Clear Connections
            $('clear-connections').addEventListener('click', () => {
                clearConnectionLines();
                $('toggle-connections').classList.replace('active', 'inactive');
            });
        }

        function setupMapFilters() {
            // Device type filter
            $('device-type-filter').addEventListener('change', (e) => {
                const deviceType = e.target.value;
                
                // Clear all markers
                Object.values(markerLayers).forEach(layer => layer.clearLayers());
                
                if (deviceType) {
                    // Render only selected device type
                    renderMarkers(deviceType, dataCache[deviceType]);
                } else {
                    // Render all device types
                    Object.keys(markerLayers).forEach(entityType => {
                        renderMarkers(entityType, dataCache[entityType]);
                    });
                }
            });
            
            // Region code filter
            $('region-code-filter').addEventListener('input', (e) => {
                const regionCode = e.target.value.toUpperCase();
                
                // Clear all markers
                Object.values(markerLayers).forEach(layer => layer.clearLayers());
                
                // Filter and render markers based on region code
                Object.keys(markerLayers).forEach(entityType => {
                    const filteredData = dataCache[entityType].filter(item => {
                        if (entityType === 'OLT' || entityType === 'ODC' || entityType === 'ODP') {
                            return item.kodeWilayah && item.kodeWilayah.toUpperCase().includes(regionCode);
                        } else if (entityType === 'Pelanggan') {
                            // For customers, check if their ODP matches the region
                            const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                            return odp && odp.kodeWilayah && odp.kodeWilayah.toUpperCase().includes(regionCode);
                        }
                        return false;
                    });
                    
                    renderMarkers(entityType, filteredData);
                });
            });
            
            // Sector code filter
            $('sector-code-filter').addEventListener('input', (e) => {
                const sectorCode = e.target.value.toUpperCase();
                
                // Clear all markers
                Object.values(markerLayers).forEach(layer => layer.clearLayers());
                
                // Filter and render markers based on sector code
                Object.keys(markerLayers).forEach(entityType => {
                    const filteredData = dataCache[entityType].filter(item => {
                        if (entityType === 'OLT' || entityType === 'ODC' || entityType === 'ODP') {
                            return item.kodeSektor && item.kodeSektor.toUpperCase().includes(sectorCode);
                        } else if (entityType === 'Pelanggan') {
                            // For customers, check if their ODP matches the sector
                            const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                            return odp && odp.kodeSektor && odp.kodeSektor.toUpperCase().includes(sectorCode);
                        }
                        return false;
                    });
                    
                    renderMarkers(entityType, filteredData);
                });
            });
            
            // ONT SN filter
            $('ont-sn-filter').addEventListener('input', (e) => {
                const ontSN = e.target.value.toUpperCase();
                
                // Clear all markers
                Object.values(markerLayers).forEach(layer => layer.clearLayers());
                
                // Filter and render markers based on ONT SN
                Object.keys(markerLayers).forEach(entityType => {
                    const filteredData = dataCache[entityType].filter(item => {
                        if (entityType === 'OLT') {
                            return item.sn && item.sn.toUpperCase().includes(ontSN);
                        } else if (entityType === 'Pelanggan') {
                            return item.snONT && item.snONT.toUpperCase().includes(ontSN);
                        }
                        return false;
                    });
                    
                    renderMarkers(entityType, filteredData);
                });
            });
            
            // Apply filters button
            $('apply-filters').addEventListener('click', () => {
                showToast('Filter diterapkan', 'success');
            });
            
            // Reset filters button
            $('reset-filters').addEventListener('click', () => {
                resetMapFilters();
            });
        }

        function resetMapFilters() {
            // Reset all filter inputs
            $('device-type-filter').value = '';
            $('region-code-filter').value = '';
            $('sector-code-filter').value = '';
            $('ont-sn-filter').value = '';
            
            // Render all markers
            Object.keys(markerLayers).forEach(entityType => {
                markerLayers[entityType].clearLayers();
                renderMarkers(entityType, dataCache[entityType]);
            });
        }

        function renderMarkers(entity, data) {
            const layer = markerLayers[entity];
            layer.clearLayers();

            data.forEach(item => {
                if (!item.location || !item.location.lat || !item.location.lng) return;

                const latLng = [item.location.lat, item.location.lng];
                let marker;

                // Kustomisasi marker berdasarkan entity
                if (entity === 'OLT') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'olt-marker',
                            html: '<div class="w-6 h-6 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="server" class="w-3 h-3 text-white"></i></div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        }),
                        id: item.id,
                        draggable: true
                    });
                } else if (entity === 'ODC') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'odc-marker',
                            html: '<div class="w-6 h-6 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="server-cog" class="w-3 h-3 text-white"></i></div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        }),
                        id: item.id,
                        draggable: true
                    });
                } else if (entity === 'ODP') {
                    const capacity = getOdpCapacity(item);
                    const color = capacity.percentage >= 100 ? 'red' : (capacity.percentage >= 75 ? 'orange' : 'green');
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'odp-marker',
                            html: `<div class="w-6 h-6 bg-${color}-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="box" class="w-3 h-3 text-white"></i></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        }),
                        id: item.id,
                        draggable: true
                    });
                } else if (entity === 'Pelanggan') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'pelanggan-marker',
                            html: '<div class="w-5 h-5 bg-green-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="user" class="w-2 h-2 text-white"></i></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        }),
                        id: item.id,
                        draggable: true
                    });
                }

                if (marker) {
                    marker.bindPopup(createPopupContent(entity, item));
                    
                    // Add drag event
                    marker.on('dragstart', function(e) {
                        draggedMarker = {
                            entity: entity,
                            id: item.id,
                            originalPosition: item.location
                        };
                        this._icon.classList.add('marker-dragging');
                    });
                    
                    marker.on('dragend', async function(e) {
                        this._icon.classList.remove('marker-dragging');
                        
                        const newPosition = e.target.getLatLng();
                        const newLocation = {
                            lat: newPosition.lat,
                            lng: newPosition.lng
                        };
                        
                        try {
                            // Update in database
                            await db.collection(entity).doc(item.id).update({
                                location: newLocation,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedBy: currentUser.email
                            });
                            
                            // Update in cache
                            const index = dataCache[entity].findIndex(i => i.id === item.id);
                            if (index !== -1) {
                                dataCache[entity][index].location = newLocation;
                            }
                            
                            // Log audit
                            await logAudit('update', entity, item.id, { 
                                location: { 
                                    from: draggedMarker.originalPosition, 
                                    to: newLocation 
                                } 
                            });
                            
                            showToast(`Lokasi ${entity} berhasil diperbarui`, 'success');
                            
                            // Update popup content
                            this.setPopupContent(createPopupContent(entity, {
                                ...item,
                                location: newLocation
                            }));
                        } catch (error) {
                            console.error('Error updating marker position:', error);
                            showToast('Gagal memperbarui lokasi', 'error');
                            
                            // Revert to original position
                            this.setLatLng(draggedMarker.originalPosition);
                        }
                        
                        draggedMarker = null;
                    });
                    
                    marker.on('click', () => {
                        selectedMarker = { entity, item };
                        showConnections(entity, item);
                    });
                    layer.addLayer(marker);
                }
            });
            
            // Render ulang ikon Lucide
            lucide.createIcons();
        }
        
        function createPopupContent(entity, item) {
            let content = `<div class="font-bold text-base mb-1">${item.namaODP || item.namaODC || item.name || item.code}</div>`;
            
            if (entity === 'OLT') {
                content += `<p>Model: ${item.model || 'N/A'}</p>`;
                content += `<p>Slot: ${item.totalSlots || 0}, Port: ${item.totalPorts || 0}</p>`;
                
                // Tambahkan data ODC yang terhubung
                const connectedODCs = dataCache.ODC.filter(odc => odc.oltRef === item.id);
                if (connectedODCs.length > 0) {
                    content += `<div class="mt-2 border-t pt-2"><p class="font-semibold">ODC Terhubung:</p>`;
                    connectedODCs.forEach(odc => {
                        content += `<p class="text-sm">- ${odc.namaODC} (Slot ${odc.oltSlot}/Port ${odc.oltPort})</p>`;
                    });
                    content += `</div>`;
                }
            } else if (entity === 'ODC') {
                content += `<p>Kapasitas: ${item.capacity || 0}</p>`;
                
                // Tambahkan data OLT yang terhubung
                const olt = dataCache.OLT.find(o => o.id === item.oltRef);
                if (olt) {
                    content += `<p>OLT: ${olt.name} (${olt.code})</p>`;
                }
                
                // Tambahkan data ODP yang terhubung
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === item.id);
                if (connectedODPs.length > 0) {
                    content += `<div class="mt-2 border-t pt-2"><p class="font-semibold">ODP Terhubung:</p>`;
                    connectedODPs.forEach(odp => {
                        content += `<p class="text-sm">- ${odp.namaODP}</p>`;
                    });
                    content += `</div>`;
                }
            } else if (entity === 'ODP') {
                const { used, total, percentage } = getOdpCapacity(item);
                content += `<p>Kapasitas: ${used} / ${total} (${percentage.toFixed(1)}%)</p>`;
                
                // Tambahkan data ODC yang terhubung
                const odc = dataCache.ODC.find(o => o.id === item.odcRef);
                if (odc) {
                    content += `<p>ODC: ${odc.namaODC}</p>`;
                }
                
                // Tambahkan data pelanggan yang terhubung
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === item.id);
                if (connectedPelanggan.length > 0) {
                    content += `<div class="mt-2 border-t pt-2"><p class="font-semibold">Pelanggan Terhubung:</p>`;
                    connectedPelanggan.forEach(pelanggan => {
                        content += `<p class="text-sm">- ${pelanggan.name} (Port ${pelanggan.odpPort})</p>`;
                    });
                    content += `</div>`;
                }
            } else if (entity === 'Pelanggan') {
                content += `<p>Alamat: ${item.address || 'N/A'}</p>`;
                content += `<p>Status: <span class="font-semibold ${item.status === 'active' ? 'text-green-600' : (item.status === 'pending' ? 'text-yellow-600' : 'text-gray-500')}">${item.status}</span></p>`;
                
                // Tambahkan data ODP yang terhubung
                const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                if (odp) {
                    content += `<p>ODP: ${odp.namaODP} (Port ${item.odpPort})</p>`;
                }
                
                // Tambahkan data ODC yang terhubung
                if (odp) {
                    const odc = dataCache.ODC.find(o => o.id === odp.odcRef);
                    if (odc) {
                        content += `<p>ODC: ${odc.namaODC}</p>`;
                    }
                }
            }
            
            if (item.location) {
                content += `<p class="text-xs text-gray-500">${item.location.lat.toFixed(4)}, ${item.location.lng.toFixed(4)}</p>`;
            }
            return content;
        }

        function showConnections(entity, item) {
            // Hapus koneksi yang ada
            clearConnectionLines();
            
            if (entity === 'OLT') {
                // Tampilkan koneksi ke ODC
                const connectedODCs = dataCache.ODC.filter(odc => odc.oltRef === item.id);
                connectedODCs.forEach(odc => {
                    if (odc.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [odc.location.lat, odc.location.lng],
                            '#3B82F6', // Blue
                            'OLT-ODC'
                        );
                    }
                });
            } else if (entity === 'ODC') {
                // Tampilkan koneksi ke OLT
                const olt = dataCache.OLT.find(o => o.id === item.oltRef);
                if (olt && olt.location) {
                    drawConnectionLine(
                        [item.location.lat, item.location.lng],
                        [olt.location.lat, olt.location.lng],
                        '#3B82F6', // Blue
                        'ODC-OLT'
                    );
                }
                
                // Tampilkan koneksi ke ODP
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === item.id);
                connectedODPs.forEach(odp => {
                    if (odp.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [odp.location.lat, odp.location.lng],
                            '#10B981', // Green
                            'ODC-ODP'
                        );
                    }
                });
            } else if (entity === 'ODP') {
                // Tampilkan koneksi ke ODC
                const odc = dataCache.ODC.find(o => o.id === item.odcRef);
                if (odc && odc.location) {
                    drawConnectionLine(
                        [item.location.lat, item.location.lng],
                        [odc.location.lat, odc.location.lng],
                        '#10B981', // Green
                        'ODP-ODC'
                    );
                }
                
                // Tampilkan koneksi ke Pelanggan
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === item.id);
                connectedPelanggan.forEach(pelanggan => {
                    if (pelanggan.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [pelanggan.location.lat, pelanggan.location.lng],
                            '#F59E0B', // Yellow
                            'ODP-Pelanggan'
                        );
                    }
                });
            } else if (entity === 'Pelanggan') {
                // Tampilkan koneksi ke ODP
                const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                if (odp && odp.location) {
                    drawConnectionLine(
                        [item.location.lat, item.location.lng],
                        [odp.location.lat, odp.location.lng],
                        '#F59E0B', // Yellow
                        'Pelanggan-ODP'
                    );
                }
                
                // Tampilkan koneksi ke ODC
                if (odp) {
                    const odc = dataCache.ODC.find(o => o.id === odp.odcRef);
                    if (odc && odc.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [odc.location.lat, odc.location.lng],
                            '#10B981', // Green
                            'Pelanggan-ODC'
                        );
                    }
                }
            }
        }

        function showAllConnections() {
            // Hapus koneksi yang ada
            clearConnectionLines();
            
            // Tampilkan semua koneksi OLT-ODC
            dataCache.OLT.forEach(olt => {
                if (!olt.location) return;
                
                const connectedODCs = dataCache.ODC.filter(odc => odc.oltRef === olt.id);
                connectedODCs.forEach(odc => {
                    if (odc.location) {
                        drawConnectionLine(
                            [olt.location.lat, olt.location.lng],
                            [odc.location.lat, odc.location.lng],
                            '#3B82F6', // Blue
                            'OLT-ODC'
                        );
                    }
                });
            });
            
            // Tampilkan semua koneksi ODC-ODP
            dataCache.ODC.forEach(odc => {
                if (!odc.location) return;
                
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === odc.id);
                connectedODPs.forEach(odp => {
                    if (odp.location) {
                        drawConnectionLine(
                            [odc.location.lat, odc.location.lng],
                            [odp.location.lat, odp.location.lng],
                            '#10B981', // Green
                            'ODC-ODP'
                        );
                    }
                });
            });
            
            // Tampilkan semua koneksi ODP-Pelanggan
            dataCache.ODP.forEach(odp => {
                if (!odp.location) return;
                
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === odp.id);
                connectedPelanggan.forEach(pelanggan => {
                    if (pelanggan.location) {
                        drawConnectionLine(
                            [odp.location.lat, odp.location.lng],
                            [pelanggan.location.lat, pelanggan.location.lng],
                            '#F59E0B', // Yellow
                            'ODP-Pelanggan'
                        );
                    }
                });
            });
        }

        function drawConnectionLine(startLatLng, endLatLng, color, type) {
            const polyline = L.polyline([startLatLng, endLatLng], {
                color: color,
                weight: 3,
                opacity: 0.7,
                dashArray: type.includes('Pelanggan') ? '10, 10' : null
            }).addTo(map);
            
            connectionLines.push(polyline);
        }

        function clearConnectionLines() {
            connectionLines.forEach(line => {
                map.removeLayer(line);
            });
            connectionLines = [];
        }

        // --- 6. Logika Data & Tampilan ---

        async function loadAllData() {
            try {
                // Load semua data dari Firebase
                await Promise.all([
                    loadDataFromFirestore('OLT'),
                    loadDataFromFirestore('ODC'),
                    loadDataFromFirestore('ODP'),
                    loadDataFromFirestore('Pelanggan'),
                    loadDataFromFirestore('Paket'),
                    loadDataFromFirestore('Karyawan'),
                    loadDataFromFirestore('AuditLog'),
                    loadDataFromFirestore('Inventory')
                ]);
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
                // Update UI dengan data
                renderMarkers('OLT', dataCache.OLT);
                renderMarkers('ODC', dataCache.ODC);
                renderMarkers('ODP', dataCache.ODP);
                renderMarkers('Pelanggan', dataCache.Pelanggan);
                
                renderAuditLog(dataCache.AuditLog);
                updateDashboardStats();
                renderInventoryList();
                
                showToast('Data berhasil dimuat', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Gagal memuat data', 'error');
                
                // Jika gagal memuat dari Firebase, coba dari localStorage
                loadLocalData();
            }
        }

        function loadLocalData() {
            try {
                // Load data dari localStorage
                const localData = JSON.parse(localStorage.getItem('ftthLocalData') || '{}');
                
                Object.keys(localData).forEach(key => {
                    if (dataCache.hasOwnProperty(key)) {
                        dataCache[key] = localData[key] || [];
                    }
                });
                
                // Update UI dengan data lokal
                renderMarkers('OLT', dataCache.OLT);
                renderMarkers('ODC', dataCache.ODC);
                renderMarkers('ODP', dataCache.ODP);
                renderMarkers('Pelanggan', dataCache.Pelanggan);
                
                renderAuditLog(dataCache.AuditLog);
                updateDashboardStats();
                renderInventoryList();
                
                showToast('Data berhasil dimuat dari cache lokal', 'success');
            } catch (error) {
                console.error('Error loading local data:', error);
                showToast('Gagal memuat data lokal', 'error');
            }
        }

        function saveLocalData() {
            try {
                // Simpan data ke localStorage
                const dataToSave = {};
                Object.keys(dataCache).forEach(key => {
                    dataToSave[key] = dataCache[key];
                });
                
                localStorage.setItem('ftthLocalData', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Error saving local data:', error);
            }
        }

        async function loadDataFromFirestore(entityType) {
            try {
                const snapshot = await db.collection(entityType).get();
                dataCache[entityType] = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error(`Error loading ${entityType}:`, error);
                dataCache[entityType] = [];
            }
        }

        function loadTablePage(entity) {
            $('table-title').textContent = `Manajemen ${entity}`;
            $('table-title').dataset.entity = entity;
            
            // Setup search dan filter
            setupTableSearch(entity);
            
            // Reset pagination
            currentPage = 1;
            
            // Render tabel
            renderTable(entity, dataCache[entity]);
        }

        function setupTableSearch(entity) {
            const searchInput = $('table-search');
            
            // Clear previous event listeners
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            // Add new event listeners
            newSearchInput.addEventListener('input', () => {
                filterTableData(entity, newSearchInput.value);
            });
            
            // Setup pagination
            setupPagination();
        }

        function filterTableData(entity, searchTerm) {
            let data = [...dataCache[entity]];
            
            // Filter berdasarkan search term
            if (searchTerm) {
                data = data.filter(item => {
                    // Cari di semua properti
                    return Object.values(item).some(value => {
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(searchTerm.toLowerCase());
                        }
                        return false;
                    });
                });
            }
            
            // Simpan data yang sudah difilter
            filteredData = data;
            
            // Reset pagination
            currentPage = 1;
            
            // Render tabel dengan data yang sudah difilter
            renderTable(entity, filteredData);
        }

        function setupPagination() {
            const prevButton = $('prev-page');
            const nextButton = $('next-page');
            
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    const entity = $('table-title').dataset.entity;
                    renderTable(entity, filteredData.length > 0 ? filteredData : dataCache[entity]);
                }
            });
            
            nextButton.addEventListener('click', () => {
                const entity = $('table-title').dataset.entity;
                const data = filteredData.length > 0 ? filteredData : dataCache[entity];
                const totalPages = Math.ceil(data.length / itemsPerPage);
                
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable(entity, data);
                }
            });
        }

        function renderTable(entity, data) {
            const tableHeader = $('table-header-row');
            const tableBody = $('table-body');
            
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            let headers = [];
            
            // Definisikan header tabel berdasarkan entity
            if (entity === 'OLT') headers = ['OLT', 'Type', 'Model', 'SN', 'Rak', 'Slot/Port', 'Lokasi', 'Aksi'];
            else if (entity === 'ODC') headers = ['Kode Wilayah', 'Kode Sektor', 'Nama ODC', 'Kapasitas', 'OLT', 'Slot/Port OLT', 'Panel Feeder', 'Panel Distribusi', 'Aksi'];
            else if (entity === 'ODP') headers = ['Kode Wilayah', 'Kode Sektor', 'Nomor ODP', 'Nama ODP', 'Panel Feeder', 'Port Feeder', 'Panel Distribusi', 'Port Distribusi', 'Kapasitas', 'Aksi'];
            else if (entity === 'Pelanggan') headers = ['No. Pelanggan', 'Nama', 'Username', 'Paket', 'ODP', 'Port', 'Status', 'Aksi'];
            else if (entity === 'Paket') headers = ['Jenis Paket', 'Kecepatan', 'Harga', 'Aksi'];
            else if (entity === 'Karyawan') headers = ['Nama', 'Email', 'Role', 'Status', 'Aksi'];
            
            // Render header
            headers.forEach(h => {
                tableHeader.innerHTML += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`;
            });

            // Pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);
            
            // Update pagination info
            $('showing-from').textContent = data.length > 0 ? startIndex + 1 : 0;
            $('showing-to').textContent = Math.min(endIndex, data.length);
            $('total-records').textContent = data.length;
            $('page-info').textContent = `Halaman ${currentPage}`;
            
            // Update pagination buttons
            const totalPages = Math.ceil(data.length / itemsPerPage);
            $('prev-page').disabled = currentPage === 1;
            $('next-page').disabled = currentPage === totalPages || totalPages === 0;

            // Render data
            paginatedData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                let rowHtml = '';
                if (entity === 'OLT') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.code}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.model || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.sn || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.rack || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.totalSlots || 0} Slot / ${item.totalPorts || 0} Port</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.location ? `${item.location.lat.toFixed(4)}, ${item.location.lng.toFixed(4)}` : 'N/A'}</td>
                    `;
                } else if (entity === 'ODC') {
                    const olt = dataCache.OLT.find(o => o.id === item.oltRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeWilayah}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeSektor}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.namaODC}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.capacity || 0}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${olt?.name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.oltSlot || 'N/A'}/${item.oltPort || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelFeeder || 'N/A'}/${item.portFeeder || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelDistribusi || 'N/A'}/${item.portDistribusi || 'N/A'}</td>
                    `;
                } else if (entity === 'ODP') {
                    const { used, total, percentage } = getOdpCapacity(item);
                    const odc = dataCache.ODC.find(o => o.id === item.odcRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeWilayah}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeSektor}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.nomorODC}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.namaODP}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelFeeder || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.portFeeder || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelDistribusi || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.portDistribusi || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            <div class="flex items-center">
                                <span class="font-medium ${percentage >= 100 ? 'text-red-600' : (percentage >= 75 ? 'text-orange-600' : 'text-green-600')}">
                                    ${used} / ${total}
                                </span>
                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full ${percentage >= 100 ? 'bg-red-500' : (percentage >= 75 ? 'bg-orange-500' : 'bg-green-500')}" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </td>
                    `;
                } else if (entity === 'Pelanggan') {
                    const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                    const paket = dataCache.Paket.find(p => p.id === item.paketRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.customerNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.username}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${paket?.jenis || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${odp?.namaODP || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.odpPort || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.status === 'active' ? 'bg-green-100 text-green-800' : (item.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800')}">
                                ${item.status}
                            </span>
                        </td>
                    `;
                } else if (entity === 'Paket') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.jenis}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kecepatan}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">Rp ${item.harga?.toLocaleString('id-ID') || 0}</td>
                    `;
                } else if (entity === 'Karyawan') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.nama}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.email}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.role}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${item.status}
                            </span>
                        </td>
                    `;
                }
                
                // Tombol aksi
                rowHtml += `
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center space-x-2">
                            <button class="view-btn text-green-600 hover:text-green-800 p-1" data-id="${item.id}" title="Lihat Detail">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button class="edit-btn text-blue-600 hover:text-blue-800 p-1" data-id="${item.id}" title="Edit">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-btn text-red-600 hover:text-red-800 p-1" data-id="${item.id}" title="Hapus">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                row.innerHTML = rowHtml;
                tableBody.appendChild(row);
            });

            // Render ulang ikon
            lucide.createIcons();

            // Tambahkan event listener untuk tombol aksi
            $$('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    showDetailModal(entity, id);
                });
            });

            $$('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    showFormModal(entity, id);
                });
            });

            $$('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    deleteEntity(entity, id);
                });
            });
        }

        function showDetailModal(entityType, entityId) {
            const entity = dataCache[entityType].find(e => e.id === entityId);
            if (!entity) return;
            
            detailTitle.textContent = `Detail ${entityType}`;
            detailContent.innerHTML = generateDetailContent(entityType, entity);
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Tampilkan modal
            detailModal.classList.remove('hidden');
        }

        function generateDetailContent(entityType, entity) {
            let content = '';
            
            if (entityType === 'OLT') {
                const connectedODCs = dataCache.ODC.filter(odc => odc.oltRef === entity.id);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi OLT</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">OLT</p>
                                <p class="font-medium">${entity.code}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Type OLT</p>
                                <p class="font-medium">${entity.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Model</p>
                                <p class="font-medium">${entity.model}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Serial Number</p>
                                <p class="font-medium">${entity.sn}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Rak</p>
                                <p class="font-medium">${entity.rack}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kapasitas</p>
                                <p class="font-medium">${entity.totalSlots} Slot / ${entity.totalPorts} Port</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Koneksi ke ODC</h3>
                        ${connectedODCs.length > 0 ? `
                            <div class="space-y-3">
                                ${connectedODCs.map(odc => `
                                    <div class="border rounded-lg p-3">
                                        <p class="font-medium">${odc.namaODC}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                            <div>
                                                <p class="text-gray-600">Slot/Port OLT</p>
                                                <p>${odc.oltSlot}/${odc.oltPort}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Panel Feeder</p>
                                                <p>${odc.panelFeeder}/${odc.portFeeder}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500">Tidak ada ODC yang terhubung</p>'}
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Rangkuman Jaringan</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="font-medium">OLT ${entity.name} terhubung ke:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                ${connectedODCs.map(odc => `
                                    <li>ODC ${odc.namaODC} melalui Slot ${odc.oltSlot} Port ${odc.oltPort}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            } else if (entityType === 'ODC') {
                const olt = dataCache.OLT.find(o => o.id === entity.oltRef);
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === entity.id);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi ODC</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Kode Wilayah</p>
                                <p class="font-medium">${entity.kodeWilayah}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kode Sektor</p>
                                <p class="font-medium">${entity.kodeSektor}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Nama ODC</p>
                                <p class="font-medium">${entity.namaODC}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kapasitas</p>
                                <p class="font-medium">${entity.capacity}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">OLT</p>
                                <p class="font-medium">${olt?.name || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Slot/Port OLT</p>
                                <p class="font-medium">${entity.oltSlot}/${entity.oltPort}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Feeder</p>
                                <p class="font-medium">${entity.panelFeeder}/${entity.portFeeder}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Distribusi</p>
                                <p class="font-medium">${entity.panelDistribusi}/${entity.portDistribusi}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Koneksi ke ODP</h3>
                        ${connectedODPs.length > 0 ? `
                            <div class="space-y-3">
                                ${connectedODPs.map(odp => `
                                    <div class="border rounded-lg p-3">
                                        <p class="font-medium">${odp.namaODP}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                            <div>
                                                <p class="text-gray-600">Panel Feeder</p>
                                                <p>${odp.panelFeeder}/${odp.portFeeder}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Panel Distribusi</p>
                                                <p>${odp.panelDistribusi}/${odp.portDistribusi}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Kapasitas</p>
                                                <p>${getOdpCapacity(odp).used}/${odp.totalPorts}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500">Tidak ada ODP yang terhubung</p>'}
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Rangkuman Hirarki Jaringan</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="font-medium">ODC ${entity.namaODC} terhubung dari:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                <li>OLT ${olt?.name || 'N/A'} melalui Slot ${entity.oltSlot} Port ${entity.oltPort}</li>
                                <li>Panel Feeder ${entity.panelFeeder} Port ${entity.portFeeder}</li>
                            </ul>
                            <p class="font-medium mt-3">Dan terhubung ke:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                ${connectedODPs.map(odp => `
                                    <li>ODP ${odp.namaODP} melalui Panel Distribusi ${odp.panelDistribusi} Port ${odp.portDistribusi}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            } else if (entityType === 'ODP') {
                const odc = dataCache.ODC.find(o => o.id === entity.odcRef);
                const olt = odc ? dataCache.OLT.find(o => o.id === odc.oltRef) : null;
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === entity.id);
                const { used, total, percentage } = getOdpCapacity(entity);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi ODP</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Kode Wilayah</p>
                                <p class="font-medium">${entity.kodeWilayah}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Sektor ODP</p>
                                <p class="font-medium">${entity.kodeSektor}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Nomor ODP</p>
                                <p class="font-medium">${entity.nomorODC}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Nama ODP</p>
                                <p class="font-medium">${entity.namaODP}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Feeder</p>
                                <p class="font-medium">${entity.panelFeeder}/${entity.portFeeder}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Distribusi</p>
                                <p class="font-medium">${entity.panelDistribusi}/${entity.portDistribusi}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kapasitas Port</p>
                                <p class="font-medium ${percentage >= 100 ? 'text-red-600' : (percentage >= 75 ? 'text-orange-600' : 'text-green-600')}">
                                    ${used} / ${total} (${percentage.toFixed(1)}%)
                                </p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Hirarki Jaringan Lengkap</h3>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">OLT:</span>
                                    <span>${olt?.name || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Slot/Port OLT:</span>
                                    <span>${odc?.oltSlot || 'N/A'}/${odc?.oltPort || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODC:</span>
                                    <span>${odc?.namaODC || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Feeder:</span>
                                    <span>${entity.panelFeeder}/${entity.portFeeder}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Distribusi:</span>
                                    <span>${entity.panelDistribusi}/${entity.portDistribusi}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODP:</span>
                                    <span>${entity.namaODP}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Pelanggan Terhubung</h3>
                        ${connectedPelanggan.length > 0 ? `
                            <div class="space-y-3">
                                ${connectedPelanggan.map(pelanggan => `
                                    <div class="border rounded-lg p-3">
                                        <p class="font-medium">${pelanggan.name}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                            <div>
                                                <p class="text-gray-600">No. Pelanggan</p>
                                                <p>${pelanggan.customerNumber}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Port ODP</p>
                                                <p>${pelanggan.odpPort}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Jenis ONT</p>
                                                <p>${pelanggan.jenisONT}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Status</p>
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${pelanggan.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                    ${pelanggan.status}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500">Tidak ada pelanggan yang terhubung</p>'}
                    </div>
                `;
            } else if (entityType === 'Pelanggan') {
                const odp = dataCache.ODP.find(o => o.id === entity.odpRef);
                const odc = odp ? dataCache.ODC.find(o => o.id === odp.odcRef) : null;
                const olt = odc ? dataCache.OLT.find(o => o.id === odc.oltRef) : null;
                const paket = dataCache.Paket.find(p => p.id === entity.paketRef);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi Pelanggan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">No. Pelanggan</p>
                                <p class="font-medium">${entity.customerNumber}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Nama</p>
                                <p class="font-medium">${entity.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Username</p>
                                <p class="font-medium">${entity.username}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Paket</p>
                                <p class="font-medium">${paket?.jenis || 'N/A'} - ${paket?.kecepatan || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Jenis ONT</p>
                                <p class="font-medium">${entity.jenisONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">SN ONT</p>
                                <p class="font-medium">${entity.snONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">IP Address</p>
                                <p class="font-medium">${entity.ipAddress}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Status</p>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${entity.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${entity.status}
                                </span>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Alamat</p>
                                <p class="font-medium">${entity.address}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Detail Jaringan Pelanggan</h3>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODP:</span>
                                    <span>${odp?.namaODP || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Port ODP:</span>
                                    <span>${entity.odpPort}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODC:</span>
                                    <span>${odc?.namaODC || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Distribusi:</span>
                                    <span>${odp?.panelDistribusi || 'N/A'}/${odp?.portDistribusi || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Feeder:</span>
                                    <span>${odp?.panelFeeder || 'N/A'}/${odp?.portFeeder || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">OLT:</span>
                                    <span>${olt?.name || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Slot/Port OLT:</span>
                                    <span>${odc?.oltSlot || 'N/A'}/${odc?.oltPort || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi Teknis</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Jenis Perangkat</p>
                                <p class="font-medium">${entity.jenisONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Serial Number</p>
                                <p class="font-medium">${entity.snONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Alamat IP</p>
                                <p class="font-medium">${entity.ipAddress}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kecepatan</p>
                                <p class="font-medium">${paket?.kecepatan || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        function renderAuditLog(data) {
            const tbody = $('audit-log-body');
            tbody.innerHTML = '';
            
            // Urutkan berdasarkan waktu (terbaru dulu)
            const sortedData = [...data].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Batasi hanya 1000 log terbaru
            const limitedData = sortedData.slice(0, 1000);
            
            limitedData.forEach(log => {
                const time = new Date(log.timestamp).toLocaleString('id-ID');
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${time}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.userEmail}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.action}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.entityType}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${JSON.stringify(log.details)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDashboardStats() {
            // Update statistik dashboard
            $('stat-odp').textContent = dataCache.ODP.length;
            $('stat-pelanggan').textContent = dataCache.Pelanggan.length;
            $('stat-olt').textContent = dataCache.OLT.length;
            $('stat-karyawan').textContent = dataCache.Karyawan.length;
            
            // Update network capacity
            updateNetworkCapacity();
        }

        function updateNetworkCapacity() {
            // Calculate ODP capacity
            const totalOdpPorts = dataCache.ODP.reduce((sum, odp) => sum + (odp.totalPorts || 0), 0);
            const usedOdpPorts = dataCache.Pelanggan.filter(p => p.status === 'active').length;
            const odpPercentage = totalOdpPorts > 0 ? (usedOdpPorts / totalOdpPorts) * 100 : 0;
            
            $('odp-capacity-bar').style.width = `${odpPercentage}%`;
            $('odp-capacity-text').textContent = `${odpPercentage.toFixed(1)}%`;
            
            // Update capacity bar color
            const odpBar = $('odp-capacity-bar');
            odpBar.classList.remove('capacity-low', 'capacity-medium', 'capacity-high');
            if (odpPercentage >= 100) {
                odpBar.classList.add('capacity-high');
            } else if (odpPercentage >= 75) {
                odpBar.classList.add('capacity-medium');
            } else {
                odpBar.classList.add('capacity-low');
            }
            
            // Calculate ODC capacity
            const totalOdcPorts = dataCache.ODC.reduce((sum, odc) => sum + (odc.capacity || 0), 0);
            const usedOdcPorts = dataCache.ODP.length;
            const odcPercentage = totalOdcPorts > 0 ? (usedOdcPorts / totalOdcPorts) * 100 : 0;
            
            $('odc-capacity-bar').style.width = `${odcPercentage}%`;
            $('odc-capacity-text').textContent = `${odcPercentage.toFixed(1)}%`;
            
            // Update capacity bar color
            const odcBar = $('odc-capacity-bar');
            odcBar.classList.remove('capacity-low', 'capacity-medium', 'capacity-high');
            if (odcPercentage >= 100) {
                odcBar.classList.add('capacity-high');
            } else if (odcPercentage >= 75) {
                odcBar.classList.add('capacity-medium');
            } else {
                odcBar.classList.add('capacity-low');
            }
            
            // Calculate OLT capacity
            const totalOltPorts = dataCache.OLT.reduce((sum, olt) => sum + (olt.totalPorts || 0), 0);
            const usedOltPorts = dataCache.ODC.length;
            const oltPercentage = totalOltPorts > 0 ? (usedOltPorts / totalOltPorts) * 100 : 0;
            
            $('olt-capacity-bar').style.width = `${oltPercentage}%`;
            $('olt-capacity-text').textContent = `${oltPercentage.toFixed(1)}%`;
            
            // Update capacity bar color
            const oltBar = $('olt-capacity-bar');
            oltBar.classList.remove('capacity-low', 'capacity-medium', 'capacity-high');
            if (oltPercentage >= 100) {
                oltBar.classList.add('capacity-high');
            } else if (oltPercentage >= 75) {
                oltBar.classList.add('capacity-medium');
            } else {
                oltBar.classList.add('capacity-low');
            }
        }

        function getOdpCapacity(odp) {
            const total = odp.totalPorts || 0;
            const used = dataCache.Pelanggan.filter(p => p.odpRef === odp.id && p.status === 'active').length;
            const percentage = total > 0 ? (used / total) * 100 : 0;
            return { used, total, percentage };
        }

        // --- 7. Form Modal & CRUD Operations ---

        function showFormModal(entityType, entityId = null) {
            formEntityType.value = entityType;
            formEntityId.value = entityId || '';
            
            // Set judul form
            formTitle.textContent = entityId ? `Edit ${entityType}` : `Tambah ${entityType}`;
            
            // Generate form fields
            formContent.innerHTML = generateFormFields(entityType, entityId);
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Setup event listeners khusus
            setupFormEventListeners(entityType, entityId);
            
            // Tampilkan modal
            formModal.classList.remove('hidden');
        }

        function setupFormEventListeners(entityType, entityId = null) {
            // Setup GPS untuk OLT, ODC, ODP, Pelanggan
            if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                const gpsBtn = formContent.querySelector('#get-gps-btn');
                if (gpsBtn) {
                    gpsBtn.addEventListener('click', getGpsLocation);
                }
            }
            
            // Setup search untuk ODP di form Pelanggan
            if (entityType === 'Pelanggan') {
                const odpSearch = formContent.querySelector('#odp-search');
                const odpSelect = formContent.querySelector('#odpRef');
                
                if (odpSearch && odpSelect) {
                    odpSearch.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const options = odpSelect.querySelectorAll('option');
                        
                        options.forEach(option => {
                            const text = option.textContent.toLowerCase();
                            if (text.includes(searchTerm) || searchTerm === '') {
                                option.style.display = '';
                            } else {
                                option.style.display = 'none';
                            }
                        });
                    });
                }
                
                // Setup camera scan untuk SN ONT - HANYA untuk form Pelanggan
                const scanBtn = formContent.querySelector('#scan-sn-btn');
                if (scanBtn) {
                    scanBtn.addEventListener('click', simulateCameraScan);
                }
                
                // Validasi port ODP yang sudah terisi
                const odpPortInput = formContent.querySelector('input[name="odpPort"]');
                const odpRefSelect = formContent.querySelector('select[name="odpRef"]');
                
                if (odpPortInput && odpRefSelect) {
                    const validatePortAvailability = () => {
                        const odpId = odpRefSelect.value;
                        const port = parseInt(odpPortInput.value);
                        
                        if (odpId && port) {
                            const odp = dataCache.ODP.find(o => o.id === odpId);
                            const capacity = getOdpCapacity(odp);
                            
                            if (port > capacity.total) {
                                showToast(`Port ${port} melebihi kapasitas ODP (${capacity.total})`, 'warning');
                                odpPortInput.classList.add('border-red-500');
                            } else {
                                odpPortInput.classList.remove('border-red-500');
                            }
                            
                            const existingCustomer = dataCache.Pelanggan.find(p => 
                                p.odpRef === odpId && p.odpPort === port && p.id !== entityId
                            );
                            
                            if (existingCustomer) {
                                showToast(`Port ${port} pada ODP ini sudah terisi oleh pelanggan ${existingCustomer.name}`, 'warning');
                                odpPortInput.classList.add('border-red-500');
                            } else {
                                odpPortInput.classList.remove('border-red-500');
                            }
                        }
                    };
                    
                    odpPortInput.addEventListener('blur', validatePortAvailability);
                    odpRefSelect.addEventListener('change', validatePortAvailability);
                }
            }
            
            // Setup camera scan untuk SN OLT - HANYA untuk form OLT
            if (entityType === 'OLT') {
                const scanBtn = formContent.querySelector('#scan-sn-btn');
                if (scanBtn) {
                    scanBtn.addEventListener('click', simulateCameraScan);
                }
            }
            
            // Validasi slot dan port OLT
            if (entityType === 'ODC') {
                const oltSlotInput = formContent.querySelector('input[name="oltSlot"]');
                const oltPortInput = formContent.querySelector('input[name="oltPort"]');
                const oltRefSelect = formContent.querySelector('select[name="oltRef"]');
                
                if (oltSlotInput && oltPortInput && oltRefSelect) {
                    const validateSlotPortAvailability = () => {
                        const oltId = oltRefSelect.value;
                        const slot = parseInt(oltSlotInput.value);
                        const port = parseInt(oltPortInput.value);
                        
                        if (oltId && slot && port) {
                            const olt = dataCache.OLT.find(o => o.id === oltId);
                            
                            if (olt) {
                                // Validasi slot tidak melebihi total slot
                                if (slot > (olt.totalSlots || 0)) {
                                    showToast(`Slot ${slot} melebihi total slot OLT (${olt.totalSlots || 0})`, 'warning');
                                    oltSlotInput.classList.add('border-red-500');
                                } else {
                                    oltSlotInput.classList.remove('border-red-500');
                                }
                                
                                // Validasi port tidak melebihi total port
                                if (port > (olt.totalPorts || 0)) {
                                    showToast(`Port ${port} melebihi total port OLT (${olt.totalPorts || 0})`, 'warning');
                                    oltPortInput.classList.add('border-red-500');
                                } else {
                                    oltPortInput.classList.remove('border-red-500');
                                }
                                
                                // Validasi slot dan port tidak sudah digunakan
                                const existingODC = dataCache.ODC.find(odc => 
                                    odc.oltRef === oltId && 
                                    odc.oltSlot == slot && 
                                    odc.oltPort == port && 
                                    odc.id !== entityId
                                );
                                
                                if (existingODC) {
                                    showToast(`Slot ${slot} Port ${port} pada OLT ini sudah digunakan oleh ODC ${existingODC.namaODC}`, 'warning');
                                    oltSlotInput.classList.add('border-red-500');
                                    oltPortInput.classList.add('border-red-500');
                                } else {
                                    oltSlotInput.classList.remove('border-red-500');
                                    oltPortInput.classList.remove('border-red-500');
                                }
                            }
                        }
                    };
                    
                    oltSlotInput.addEventListener('blur', validateSlotPortAvailability);
                    oltPortInput.addEventListener('blur', validateSlotPortAvailability);
                    oltRefSelect.addEventListener('change', validateSlotPortAvailability);
                }
            }
            
            // Validasi port ODC
            if (entityType === 'ODP') {
                const odcRefSelect = formContent.querySelector('select[name="odcRef"]');
                const portFeederInput = formContent.querySelector('input[name="portFeeder"]');
                const portDistribusiInput = formContent.querySelector('input[name="portDistribusi"]');
                
                if (odcRefSelect && portFeederInput && portDistribusiInput) {
                    const validatePortAvailability = () => {
                        const odcId = odcRefSelect.value;
                        const portFeeder = parseInt(portFeederInput.value);
                        const portDistribusi = parseInt(portDistribusiInput.value);
                        
                        if (odcId && portFeeder && portDistribusi) {
                            const odc = dataCache.ODC.find(o => o.id === odcId);
                            
                            if (odc) {
                                // Validasi port feeder tidak melebihi kapasitas ODC
                                if (portFeeder > (odc.capacity || 0)) {
                                    showToast(`Port Feeder ${portFeeder} melebihi kapasitas ODC (${odc.capacity || 0})`, 'warning');
                                    portFeederInput.classList.add('border-red-500');
                                } else {
                                    portFeederInput.classList.remove('border-red-500');
                                }
                                
                                // Validasi port feeder tidak sudah digunakan
                                const existingODP = dataCache.ODP.find(odp => 
                                    odp.odcRef === odcId && 
                                    odp.portFeeder == portFeeder && 
                                    odp.id !== entityId
                                );
                                
                                if (existingODP) {
                                    showToast(`Port Feeder ${portFeeder} pada ODC ini sudah digunakan oleh ODP ${existingODP.namaODP}`, 'warning');
                                    portFeederInput.classList.add('border-red-500');
                                } else {
                                    portFeederInput.classList.remove('border-red-500');
                                }
                            }
                        }
                    };
                    
                    portFeederInput.addEventListener('blur', validatePortAvailability);
                    portDistribusiInput.addEventListener('blur', validatePortAvailability);
                    odcRefSelect.addEventListener('change', validatePortAvailability);
                }
            }
            
            // Auto-generate ODP name based on region, sector, and number
            if (entityType === 'ODP') {
                const regionInput = formContent.querySelector('input[name="kodeWilayah"]');
                const sectorInput = formContent.querySelector('input[name="kodeSektor"]');
                const numberInput = formContent.querySelector('input[name="nomorODC"]');
                const nameInput = formContent.querySelector('input[name="namaODP"]');
                
                if (regionInput && sectorInput && numberInput && nameInput) {
                    const updateOdpName = () => {
                        const region = regionInput.value.toUpperCase();
                        const sector = sectorInput.value.toUpperCase();
                        const number = numberInput.value;
                        
                        if (region && sector && number) {
                            nameInput.value = `ODP-${region}-${sector}/${number.padStart(2, '0')}`;
                        }
                    };
                    
                    regionInput.addEventListener('input', updateOdpName);
                    sectorInput.addEventListener('input', updateOdpName);
                    numberInput.addEventListener('input', updateOdpName);
                }
            }
            
            // Auto-generate customer number
            if (entityType === 'Pelanggan' && !entityId) {
                const customerNumberInput = formContent.querySelector('input[name="customerNumber"]');
                
                if (customerNumberInput && settings.autoGenerateNumber) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    
                    // Hitung urutan untuk bulan ini
                    const thisMonthCustomers = dataCache.Pelanggan.filter(p => {
                        const pDate = new Date(p.createdAt);
                        return pDate.getFullYear() === year && pDate.getMonth() === now.getMonth();
                    });
                    
                    const seq = String(thisMonthCustomers.length + 1).padStart(3, '0');
                    customerNumberInput.value = settings.numberFormat
                        .replace('{YYYY}', year)
                        .replace('{MM}', month)
                        .replace('{SEQ}', seq);
                }
            }
        }

        function getGpsLocation() {
            const statusEl = formContent.querySelector('#gps-status');
            const latInput = formContent.querySelector('#location-lat');
            const lngInput = formContent.querySelector('#location-lng');
            
            if (!navigator.geolocation) {
                statusEl.textContent = 'Geolocation tidak didukung browser ini.';
                statusEl.classList.add('text-red-500');
                return;
            }
            
            statusEl.textContent = 'Mencari lokasi...';
            statusEl.classList.remove('text-red-500', 'text-green-500');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    latInput.value = latitude.toFixed(6);
                    lngInput.value = longitude.toFixed(6);
                    
                    statusEl.textContent = `Lokasi berhasil di-set! Akurasi: ${accuracy.toFixed(2)} meter`;
                    statusEl.classList.add('text-green-500');
                    
                    showToast('Lokasi berhasil di-set dengan akurasi tinggi', 'success');
                },
                (error) => {
                    let errorMessage = 'Gagal mendapatkan lokasi: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Akses lokasi ditolak';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Informasi lokasi tidak tersedia';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Permintaan lokasi timeout';
                            break;
                        default:
                            errorMessage += 'Error tidak diketahui';
                    }
                    statusEl.textContent = errorMessage;
                    statusEl.classList.add('text-red-500');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function simulateCameraScan() {
            // Tentukan field mana yang akan diisi berdasarkan entity type
            let fieldToFill;
            const entityType = formEntityType.value;
            
            if (entityType === 'OLT') {
                fieldToFill = formContent.querySelector('input[name="sn"]');
            } else if (entityType === 'Pelanggan') {
                fieldToFill = formContent.querySelector('input[name="snONT"]');
            }
            
            if (!fieldToFill) return;
            
            // Simulasi scan barcode/kamera
            showToast('Membuka kamera untuk scan...', 'warning');
            
            setTimeout(() => {
                // Data contoh hasil scan
                if (entityType === 'OLT') {
                    fieldToFill.value = 'HWTX' + Math.random().toString(36).substr(2, 9).toUpperCase();
                } else if (entityType === 'Pelanggan') {
                    fieldToFill.value = 'ONT' + Math.random().toString(36).substr(2, 9).toUpperCase();
                }
                showToast('Scan berhasil! Serial Number telah diisi.', 'success');
            }, 2000);
        }

        function generateFormFields(entityType, entityId) {
            let fields = '';
            const entity = entityId ? dataCache[entityType].find(e => e.id === entityId) : null;
            
            if (entityType === 'OLT') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">OLT *</label>
                        <input type="text" name="code" value="${entity?.code || ''}" placeholder="GPON / EPON" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type OLT *</label>
                        <input type="text" name="name" value="${entity?.name || ''}" placeholder="ZTE / HWI / EPON" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model *</label>
                        <input type="text" name="model" value="${entity?.model || ''}" placeholder="Huawei MA5608T" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number *</label>
                        <div class="flex space-x-2">
                            <input type="text" name="sn" value="${entity?.sn || ''}" placeholder="HWTX123456789" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                            <button type="button" id="scan-sn-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                <span>Scan</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rak *</label>
                        <input type="text" name="rack" value="${entity?.rack || ''}" placeholder="Rack A-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Slot *</label>
                        <input type="number" name="totalSlots" value="${entity?.totalSlots || 8}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Port *</label>
                        <input type="number" name="totalPorts" value="${entity?.totalPorts || 128}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'ODC') {
                const oltOptions = dataCache.OLT.map(olt => 
                    `<option value="${olt.id}" ${entity?.oltRef === olt.id ? 'selected' : ''}>${olt.name} (${olt.code})</option>`
                ).join('');
                
                fields = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Wilayah *</label>
                        <input type="text" name="kodeWilayah" value="${entity?.kodeWilayah || ''}" placeholder="SBY" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Contoh: SBY, MLG, LMJ</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Sektor *</label>
                        <input type="text" name="kodeSektor" value="${entity?.kodeSektor || ''}" placeholder="FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Contoh: FA, FB, FC</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama ODC *</label>
                        <input type="text" name="namaODC" value="${entity?.namaODC || ''}" placeholder="ODC-SBY-FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Format: ODC-{Wilayah}-{Sektor}</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kapasitas *</label>
                        <input type="number" name="capacity" value="${entity?.capacity || 144}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">OLT *</label>
                        <select name="oltRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih OLT</option>
                            ${oltOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Slot OLT *</label>
                        <input type="number" name="oltSlot" value="${entity?.oltSlot || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port OLT *</label>
                        <input type="number" name="oltPort" value="${entity?.oltPort || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Feeder *</label>
                        <input type="text" name="panelFeeder" value="${entity?.panelFeeder || ''}" placeholder="PF-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Feeder *</label>
                        <input type="number" name="portFeeder" value="${entity?.portFeeder || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Distribusi *</label>
                        <input type="text" name="panelDistribusi" value="${entity?.panelDistribusi || ''}" placeholder="PD-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Distribusi *</label>
                        <input type="number" name="portDistribusi" value="${entity?.portDistribusi || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'ODP') {
                const odcOptions = dataCache.ODC.map(odc => 
                    `<option value="${odc.id}" ${entity?.odcRef === odc.id ? 'selected' : ''}>${odc.namaODC}</option>`
                ).join('');
                
                fields = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Wilayah *</label>
                        <input type="text" name="kodeWilayah" value="${entity?.kodeWilayah || ''}" placeholder="SBY" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Contoh: SBY, MLG, LMJ</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sektor ODP *</label>
                        <input type="text" name="kodeSektor" value="${entity?.kodeSektor || ''}" placeholder="FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Contoh: FA, FB, FC</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor ODP *</label>
                        <input type="text" name="nomorODC" value="${entity?.nomorODC || ''}" placeholder="01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="placeholder-help">Contoh: 01, 02, 03</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama ODP *</label>
                        <input type="text" name="namaODP" value="${entity?.namaODP || ''}" placeholder="ODP-SBY-FA/001" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                        <p class="placeholder-help">Format: ODP-{Wilayah}-{Sektor}-{Nomor} (auto-generate)</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ODC *</label>
                        <select name="odcRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih ODC</option>
                            ${odcOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Feeder *</label>
                        <input type="text" name="panelFeeder" value="${entity?.panelFeeder || ''}" placeholder="PF-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Feeder *</label>
                        <input type="number" name="portFeeder" value="${entity?.portFeeder || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Distribusi *</label>
                        <input type="text" name="panelDistribusi" value="${entity?.panelDistribusi || ''}" placeholder="PD-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Distribusi *</label>
                        <input type="number" name="portDistribusi" value="${entity?.portDistribusi || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Port *</label>
                        <select name="totalPorts" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="8" ${entity?.totalPorts == 8 ? 'selected' : ''}>8 Port</option>
                            <option value="16" ${entity?.totalPorts == 16 ? 'selected' : ''}>16 Port</option>
                            <option value="32" ${entity?.totalPorts == 32 ? 'selected' : ''}>32 Port</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Terpakai</label>
                        <input type="number" name="usedPorts" value="${entity?.usedPorts || 0}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'Pelanggan') {
                const odpOptions = dataCache.ODP.map(odp => {
                    const capacity = getOdpCapacity(odp);
                    return `<option value="${odp.id}" ${entity?.odpRef === odp.id ? 'selected' : ''}>${odp.namaODP} (${capacity.used}/${odp.totalPorts})</option>`;
                }).join('');
                
                const paketOptions = dataCache.Paket.map(paket => 
                    `<option value="${paket.id}" ${entity?.paketRef === paket.id ? 'selected' : ''}>${paket.jenis} - ${paket.kecepatan}</option>`
                ).join('');
                
                // Generate nomor pelanggan otomatis jika mode aktif
                const autoGenerate = settings.autoGenerateNumber || false;
                let customerNumber = entity?.customerNumber || '';
                
                if (!entityId && autoGenerate) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    
                    // Hitung urutan untuk bulan ini
                    const thisMonthCustomers = dataCache.Pelanggan.filter(p => {
                        const pDate = new Date(p.createdAt);
                        return pDate.getFullYear() === year && pDate.getMonth() === now.getMonth();
                    });
                    
                    const seq = String(thisMonthCustomers.length + 1).padStart(3, '0');
                    customerNumber = settings.numberFormat
                        .replace('{YYYY}', year)
                        .replace('{MM}', month)
                        .replace('{SEQ}', seq);
                }
                
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Pelanggan *</label>
                        <input type="text" name="customerNumber" id="customerNumber" value="${customerNumber}" placeholder="PLG-2024-01-001" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        ${autoGenerate ? '<p class="text-xs text-green-600 mt-1">Nomor di-generate otomatis</p>' : ''}
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                        <input type="text" name="name" value="${entity?.name || ''}" placeholder="Budi Santoso" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                        <input type="text" name="username" value="${entity?.username || ''}" placeholder="budi123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 lowercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" name="password" value="${entity?.password || ''}" placeholder="••••••" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat *</label>
                        <textarea name="address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>${entity?.address || ''}</textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Paket Layanan *</label>
                        <select name="paketRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Paket</option>
                            ${paketOptions}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ODP *</label>
                        <input type="text" id="odp-search" placeholder="Cari ODP..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                        <select name="odpRef" id="odpRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih ODP</option>
                            ${odpOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port ODP *</label>
                        <input type="number" name="odpPort" value="${entity?.odpPort || ''}" min="1" max="32" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="text-xs text-gray-500 mt-1">Port yang tersedia akan ditampilkan di sini</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis ONT</label>
                        <div class="flex space-x-2">
                            <input type="text" name="jenisONT" id="jenisONT" value="${entity?.jenisONT || ''}" placeholder="HG8245H" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                            <button type="button" id="scan-sn-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                <span>Scan</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">SN ONT</label>
                        <input type="text" name="snONT" id="snONT" value="${entity?.snONT || ''}" placeholder="ONT123456789" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IP Address</label>
                        <input type="text" name="ipAddress" value="${entity?.ipAddress || ''}" placeholder="192.168.1.100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="active" ${entity?.status === 'active' ? 'selected' : ''}>Aktif</option>
                            <option value="pending" ${entity?.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="inactive" ${entity?.status === 'inactive' ? 'selected' : ''}>Nonaktif</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tagging Lokasi</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'Paket') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Paket *</label>
                        <input type="text" name="jenis" value="${entity?.jenis || ''}" placeholder="Basic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kecepatan *</label>
                        <input type="text" name="kecepatan" value="${entity?.kecepatan || ''}" placeholder="10 Mbps" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Harga *</label>
                        <input type="number" name="harga" value="${entity?.harga || ''}" placeholder="150000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                `;
            } else if (entityType === 'Karyawan') {
                // Disable form untuk tambah karyawan jika bukan admin
                const isDemo = currentUser && currentUser.email === 'demo@ftth.com';
                
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                        <input type="text" name="nama" value="${entity?.nama || ''}" placeholder="Ahmad Fauzi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" ${isDemo && !entityId ? 'disabled' : ''} required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" name="email" value="${entity?.email || ''}" placeholder="ahmad@ftth.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 lowercase" ${isDemo && !entityId ? 'disabled' : ''} required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
                        <select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isDemo && !entityId ? 'disabled' : ''} required>
                            <option value="">Pilih Role</option>
                            <option value="Admin" ${entity?.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Teknisi" ${entity?.role === 'Teknisi' ? 'selected' : ''}>Teknisi</option>
                            <option value="Operator" ${entity?.role === 'Operator' ? 'selected' : ''}>Operator</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isDemo && !entityId ? 'disabled' : ''} required>
                            <option value="Aktif" ${entity?.status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                            <option value="Nonaktif" ${entity?.status === 'Nonaktif' ? 'selected' : ''}>Nonaktif</option>
                        </select>
                    </div>
                    ${isDemo && !entityId ? '<div class="md:col-span-2 text-red-500 text-sm">Akun demo tidak dapat menambah karyawan baru</div>' : ''}
                `;
            }
            
            return fields;
        }

        // Event listener untuk form submission
        entityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveEntity();
        });

        async function saveEntity() {
            const entityType = formEntityType.value;
            const entityId = formEntityId.value;
            const submitButton = entityForm.querySelector('button[type="submit"]');
            const submitSpinner = $('submit-spinner');
            const submitText = $('submit-button-text');
            
            // Cek jika user adalah demo dan mencoba menambah karyawan
            if (entityType === 'Karyawan' && !entityId && currentUser && currentUser.email === 'demo@ftth.com') {
                showToast('Akun demo tidak dapat menambah karyawan baru', 'error');
                return;
            }
            
            // Tampilkan loading state
            submitText.textContent = 'Menyimpan...';
            submitSpinner.classList.remove('hidden');
            submitButton.disabled = true;
            
            try {
                const formData = new FormData(entityForm);
                const data = Object.fromEntries(formData.entries());
                
                // Convert to uppercase for specific fields
                if (entityType === 'OLT') {
                    data.code = data.code ? data.code.toUpperCase() : '';
                    data.name = data.name ? data.name.toUpperCase() : '';
                    data.model = data.model ? data.model.toUpperCase() : '';
                    data.sn = data.sn ? data.sn.toUpperCase() : '';
                    data.rack = data.rack ? data.rack.toUpperCase() : '';
                } else if (entityType === 'ODC') {
                    data.kodeWilayah = data.kodeWilayah ? data.kodeWilayah.toUpperCase() : '';
                    data.kodeSektor = data.kodeSektor ? data.kodeSektor.toUpperCase() : '';
                    data.namaODC = data.namaODC ? data.namaODC.toUpperCase() : '';
                    data.panelFeeder = data.panelFeeder ? data.panelFeeder.toUpperCase() : '';
                    data.panelDistribusi = data.panelDistribusi ? data.panelDistribusi.toUpperCase() : '';
                } else if (entityType === 'ODP') {
                    data.kodeWilayah = data.kodeWilayah ? data.kodeWilayah.toUpperCase() : '';
                    data.kodeSektor = data.kodeSektor ? data.kodeSektor.toUpperCase() : '';
                    data.namaODP = data.namaODP ? data.namaODP.toUpperCase() : '';
                    data.panelFeeder = data.panelFeeder ? data.panelFeeder.toUpperCase() : '';
                    data.panelDistribusi = data.panelDistribusi ? data.panelDistribusi.toUpperCase() : '';
                } else if (entityType === 'Pelanggan') {
                    data.customerNumber = data.customerNumber ? data.customerNumber.toUpperCase() : '';
                    data.name = data.name ? data.name.toUpperCase() : '';
                    data.jenisONT = data.jenisONT ? data.jenisONT.toUpperCase() : '';
                    data.snONT = data.snONT ? data.snONT.toUpperCase() : '';
                } else if (entityType === 'Paket') {
                    data.jenis = data.jenis ? data.jenis.toUpperCase() : '';
                } else if (entityType === 'Karyawan') {
                    data.nama = data.nama ? data.nama.toUpperCase() : '';
                }
                
                // Parse nested objects
                if (data.location && data.location.lat && data.location.lng) {
                    data.location = {
                        lat: parseFloat(data.location.lat),
                        lng: parseFloat(data.location.lng)
                    };
                }
                
                // Parse numbers
                Object.keys(data).forEach(key => {
                    if (!isNaN(data[key]) && data[key] !== '') {
                        data[key] = parseFloat(data[key]);
                    }
                });
                
                // Validasi khusus untuk ODP - cek apakah ada ODC di sektor yang sama
                if (entityType === 'ODP') {
                    const region = data.kodeWilayah;
                    const sector = data.kodeSektor;
                    
                    if (region && sector) {
                        const matchingODC = dataCache.ODC.find(odc => 
                            odc.kodeWilayah === region && odc.kodeSektor === sector
                        );
                        
                        if (!matchingODC) {
                            throw new Error(`Tidak ada ODC dengan wilayah ${region} dan sektor ${sector}. Tidak dapat menambah ODP di sektor ini.`);
                        }
                    }
                }
                
                // Validasi khusus untuk Pelanggan - cek port ODP
                if (entityType === 'Pelanggan') {
                    const odpId = data.odpRef;
                    const port = data.odpPort;
                    
                    if (odpId && port) {
                        const odp = dataCache.ODP.find(o => o.id === odpId);
                        const capacity = getOdpCapacity(odp);
                        
                        if (port > capacity.total) {
                            throw new Error(`Port ${port} melebihi kapasitas ODP (${capacity.total})`);
                        }
                        
                        const existingCustomer = dataCache.Pelanggan.find(p => 
                            p.odpRef === odpId && p.odpPort === port && p.id !== entityId
                        );
                        
                        if (existingCustomer) {
                            throw new Error(`Port ${port} pada ODP ini sudah terisi oleh pelanggan ${existingCustomer.name}`);
                        }
                    }
                }
                
                // Validasi khusus untuk ODC - cek slot dan port OLT
                if (entityType === 'ODC') {
                    const oltId = data.oltRef;
                    const slot = data.oltSlot;
                    const port = data.oltPort;
                    
                    if (oltId && slot && port) {
                        const olt = dataCache.OLT.find(o => o.id === oltId);
                        
                        if (olt) {
                            // Validasi slot tidak melebihi total slot
                            if (slot > (olt.totalSlots || 0)) {
                                throw new Error(`Slot ${slot} melebihi total slot OLT (${olt.totalSlots || 0})`);
                            }
                            
                            // Validasi port tidak melebihi total port
                            if (port > (olt.totalPorts || 0)) {
                                throw new Error(`Port ${port} melebihi total port OLT (${olt.totalPorts || 0})`);
                            }
                            
                            // Validasi slot dan port tidak sudah digunakan
                            const existingODC = dataCache.ODC.find(odc => 
                                odc.oltRef === oltId && 
                                odc.oltSlot == slot && 
                                odc.oltPort == port && 
                                odc.id !== entityId
                            );
                            
                            if (existingODC) {
                                throw new Error(`Slot ${slot} Port ${port} pada OLT ini sudah digunakan oleh ODC ${existingODC.namaODC}`);
                            }
                        }
                    }
                }
                
                // Validasi khusus untuk ODP - cek port ODC
                if (entityType === 'ODP') {
                    const odcId = data.odcRef;
                    const portFeeder = data.portFeeder;
                    
                    if (odcId && portFeeder) {
                        const odc = dataCache.ODC.find(o => o.id === odcId);
                        
                        if (odc) {
                            // Validasi port feeder tidak melebihi kapasitas ODC
                            if (portFeeder > (odc.capacity || 0)) {
                                throw new Error(`Port Feeder ${portFeeder} melebihi kapasitas ODC (${odc.capacity || 0})`);
                            }
                            
                            // Validasi port feeder tidak sudah digunakan
                            const existingODP = dataCache.ODP.find(odp => 
                                odp.odcRef === odcId && 
                                odp.portFeeder == portFeeder && 
                                odp.id !== entityId
                            );
                            
                            if (existingODP) {
                                throw new Error(`Port Feeder ${portFeeder} pada ODC ini sudah digunakan oleh ODP ${existingODP.namaODP}`);
                            }
                        }
                    }
                }
                
                // Tambah timestamp dan user info
                data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                data.updatedBy = currentUser.email;
                
                if (entityId) {
                    // Update existing document
                    await db.collection(entityType).doc(entityId).update(data);
                    showToast(`${entityType} berhasil diperbarui`, 'success');
                } else {
                    // Add new document
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    data.createdBy = currentUser.email;
                    await db.collection(entityType).add(data);
                    showToast(`${entityType} berhasil ditambahkan`, 'success');
                }
                
                // Log audit
                await logAudit(entityId ? 'update' : 'create', entityType, entityId || 'new', data);
                
                // Reload data
                await loadDataFromFirestore(entityType);
                
                // Refresh UI jika di halaman tabel
                if ($('table-title').dataset.entity === entityType) {
                    renderTable(entityType, dataCache[entityType]);
                }
                
                // Refresh peta jika entity memiliki lokasi
                if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                    renderMarkers(entityType, dataCache[entityType]);
                }
                
                // Update dashboard stats
                updateDashboardStats();
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
                // Tutup modal
                formModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving entity:', error);
                showToast(`Gagal menyimpan ${entityType}: ${error.message}`, 'error');
            } finally {
                // Reset loading state
                submitText.textContent = 'Simpan';
                submitSpinner.classList.add('hidden');
                submitButton.disabled = false;
            }
        }

        async function deleteEntity(entityType, entityId) {
            if (!confirm(`Apakah Anda yakin ingin menghapus ${entityType} ini?`)) return;
            
            // Cek jika user adalah demo dan mencoba menghapus karyawan
            if (entityType === 'Karyawan' && currentUser && currentUser.email === 'demo@ftth.com') {
                showToast('Akun demo tidak dapat menghapus karyawan', 'error');
                return;
            }
            
            try {
                await db.collection(entityType).doc(entityId).delete();
                showToast(`${entityType} berhasil dihapus`, 'success');
                
                // Log audit
                await logAudit('delete', entityType, entityId, {});
                
                // Reload data
                await loadDataFromFirestore(entityType);
                
                // Refresh UI jika di halaman tabel
                if ($('table-title').dataset.entity === entityType) {
                    renderTable(entityType, dataCache[entityType]);
                }
                
                // Refresh peta jika entity memiliki lokasi
                if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                    renderMarkers(entityType, dataCache[entityType]);
                }
                
                // Update dashboard stats
                updateDashboardStats();
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
            } catch (error) {
                console.error('Error deleting entity:', error);
                showToast(`Gagal menghapus ${entityType}`, 'error');
            }
        }

        async function logAudit(action, entityType, entityId, details) {
            try {
                // Cek jumlah audit log yang ada
                const snapshot = await db.collection('AuditLog').get();
                const logCount = snapshot.size;
                
                // Jika sudah mencapai 1000, hapus yang paling lama
                if (logCount >= 1000) {
                    const oldestLogs = snapshot.docs
                        .sort((a, b) => new Date(a.data().timestamp) - new Date(b.data().timestamp))
                        .slice(0, logCount - 999); // Hapus cukup untuk membuat ruang
                    
                    const batch = db.batch();
                    oldestLogs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }
                
                // Tambah log baru
                await db.collection('AuditLog').add({
                    userEmail: currentUser.email,
                    action: action,
                    entityType: entityType,
                    entityId: entityId,
                    details: details,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Reload audit log data
                await loadDataFromFirestore('AuditLog');
            } catch (error) {
                console.error('Error logging audit:', error);
            }
        }

        // --- 8. Export & Import ---

        $('export-button').addEventListener('click', () => {
            const entityType = $('table-title').dataset.entity;
            if (!entityType) {
                showToast('Pilih halaman tabel terlebih dahulu', 'warning');
                return;
            }
            
            exportData(entityType);
        });

        function exportData(entityType) {
            try {
                const data = dataCache[entityType];
                if (!data || data.length === 0) {
                    showToast(`Tidak ada data ${entityType} untuk diekspor`, 'warning');
                    return;
                }
                
                // Prepare data for export
                const exportData = data.map(item => {
                    const exportItem = { ...item };
                    delete exportItem.id; // Remove document ID
                    return exportItem;
                });
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, entityType);
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `${entityType}_${timestamp}.xlsx`;
                
                // Write file
                XLSX.writeFile(wb, filename);
                
                showToast(`Data ${entityType} berhasil diekspor`, 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast(`Gagal mengekspor data ${entityType}`, 'error');
            }
        }

        async function processImport() {
            const fileInput = $('import-file');
            const entityTypeSelect = $('import-entity-type');
            const file = fileInput.files[0];
            const entityType = entityTypeSelect.value;
            
            if (!file) {
                showToast('Pilih file untuk diimport', 'warning');
                return;
            }
            
            if (!entityType) {
                showToast('Pilih jenis entitas', 'warning');
                return;
            }
            
            try {
                const data = await readImportFile(file);
                
                if (!data || data.length === 0) {
                    showToast('File tidak mengandung data yang valid', 'warning');
                    return;
                }
                
                // Show confirmation dialog
                const confirmed = confirm(`Apakah Anda yakin ingin mengimport ${data.length} data ${entityType}?`);
                if (!confirmed) return;
                
                // Process import
                let successCount = 0;
                let errorCount = 0;
                
                for (const item of data) {
                    try {
                        // Add metadata
                        item.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        item.createdBy = currentUser.email;
                        
                        await db.collection(entityType).add(item);
                        successCount++;
                    } catch (error) {
                        console.error('Error importing item:', error);
                        errorCount++;
                    }
                }
                
                // Reload data
                await loadDataFromFirestore(entityType);
                
                // Refresh UI if on table page
                if ($('table-title').dataset.entity === entityType) {
                    renderTable(entityType, dataCache[entityType]);
                }
                
                // Refresh map if entity has location
                if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                    renderMarkers(entityType, dataCache[entityType]);
                }
                
                // Update dashboard stats
                updateDashboardStats();
                
                // Show result
                if (errorCount === 0) {
                    showToast(`Import ${successCount} data ${entityType} berhasil`, 'success');
                } else {
                    showToast(`Import selesai: ${successCount} berhasil, ${errorCount} gagal`, 'warning');
                }
                
                // Close modal
                importModal.classList.add('hidden');
                
                // Reset form
                fileInput.value = '';
                entityTypeSelect.value = '';
                
            } catch (error) {
                console.error('Error processing import:', error);
                showToast('Gagal memproses import', 'error');
            }
        }

        function readImportFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first worksheet
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('Gagal membaca file'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // --- 9. Inventory Management ---

        function showInventoryModal(type) {
            $('inventory-form-title').textContent = `Tambah ${type}`;
            $('inventory-type').value = type;
            inventoryModal.classList.remove('hidden');
        }

        async function saveInventoryItem(e) {
            e.preventDefault();
            
            const type = $('inventory-type').value;
            const name = $('inventory-name').value;
            const minStock = parseInt($('inventory-min-stock').value);
            const currentStock = parseInt($('inventory-current-stock').value);
            
            if (!type || !name || isNaN(minStock) || isNaN(currentStock)) {
                showToast('Semua field harus diisi dengan benar', 'error');
                return;
            }
            
            try {
                // Check if item already exists
                const existingItemIndex = dataCache.Inventory.findIndex(item => 
                    item.type === type && item.name === name
                );
                
                if (existingItemIndex !== -1) {
                    // Update existing item
                    await db.collection('Inventory').doc(dataCache.Inventory[existingItemIndex].id).update({
                        minStock,
                        currentStock,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.email
                    });
                    
                    dataCache.Inventory[existingItemIndex] = {
                        ...dataCache.Inventory[existingItemIndex],
                        minStock,
                        currentStock,
                        updatedAt: new Date(),
                        updatedBy: currentUser.email
                    };
                    
                    showToast('Item inventory berhasil diperbarui', 'success');
                } else {
                    // Add new item
                    await db.collection('Inventory').add({
                        type,
                        name,
                        minStock,
                        currentStock,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.email
                    });
                    
                    dataCache.Inventory.push({
                        id: 'temp-id-' + Date.now(),
                        type,
                        name,
                        minStock,
                        currentStock,
                        createdAt: new Date(),
                        createdBy: currentUser.email
                    });
                    
                    showToast('Item inventory berhasil ditambahkan', 'success');
                }
                
                // Reload inventory data
                await loadDataFromFirestore('Inventory');
                
                // Refresh inventory list
                renderInventoryList();
                
                // Close modal
                inventoryModal.classList.add('hidden');
                
                // Reset form
                inventoryForm.reset();
                
            } catch (error) {
                console.error('Error saving inventory item:', error);
                showToast('Gagal menyimpan item inventory', 'error');
            }
        }

        function renderInventoryList() {
            // Render ONT inventory
            const ontList = $('ont-inventory-list');
            const ontItems = dataCache.Inventory.filter(item => item.type === 'ONT');
            
            if (ontItems.length === 0) {
                ontList.innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada item ONT</p>';
            } else {
                ontList.innerHTML = ontItems.map(item => {
                    const stockStatus = getStockStatus(item.currentStock, item.minStock);
                    return `
                        <div class="inventory-item">
                            <div>
                                <p class="font-medium">${item.name}</p>
                                <p class="text-sm text-gray-600">Stok: ${item.currentStock} (Min: ${item.minStock})</p>
                            </div>
                            <div class="${stockStatus.class}">${stockStatus.text}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render Cable inventory
            const cableList = $('cable-inventory-list');
            const cableItems = dataCache.Inventory.filter(item => item.type === 'Kabel');
            
            if (cableItems.length === 0) {
                cableList.innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada item Kabel</p>';
            } else {
                cableList.innerHTML = cableItems.map(item => {
                    const stockStatus = getStockStatus(item.currentStock, item.minStock);
                    return `
                        <div class="inventory-item">
                            <div>
                                <p class="font-medium">${item.name}</p>
                                <p class="text-sm text-gray-600">Stok: ${item.currentStock} (Min: ${item.minStock})</p>
                            </div>
                            <div class="${stockStatus.class}">${stockStatus.text}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render Splitter inventory
            const splitterList = $('splitter-inventory-list');
            const splitterItems = dataCache.Inventory.filter(item => item.type === 'Splitter');
            
            if (splitterItems.length === 0) {
                splitterList.innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada item Splitter</p>';
            } else {
                splitterList.innerHTML = splitterItems.map(item => {
                    const stockStatus = getStockStatus(item.currentStock, item.minStock);
                    return `
                        <div class="inventory-item">
                            <div>
                                <p class="font-medium">${item.name}</p>
                                <p class="text-sm text-gray-600">Stok: ${item.currentStock} (Min: ${item.minStock})</p>
                            </div>
                            <div class="${stockStatus.class}">${stockStatus.text}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render Material inventory
            const materialList = $('material-inventory-list');
            const materialItems = dataCache.Inventory.filter(item => item.type === 'Material');
            
            if (materialItems.length === 0) {
                materialList.innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada item Material</p>';
            } else {
                materialList.innerHTML = materialItems.map(item => {
                    const stockStatus = getStockStatus(item.currentStock, item.minStock);
                    return `
                        <div class="inventory-item">
                            <div>
                                <p class="font-medium">${item.name}</p>
                                <p class="text-sm text-gray-600">Stok: ${item.currentStock} (Min: ${item.minStock})</p>
                            </div>
                            <div class="${stockStatus.class}">${stockStatus.text}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render icons
            lucide.createIcons();
        }

        function getStockStatus(currentStock, minStock) {
            if (currentStock <= 0) {
                return {
                    class: 'stock-low',
                    text: 'Habis'
                };
            } else if (currentStock <= minStock) {
                return {
                    class: 'stock-medium',
                    text: 'Menipis'
                };
            } else {
                return {
                    class: 'stock-high',
                    text: 'Tersedia'
                };
            }
        }

        // --- 10. Offline Support & Sync ---

        function setupOfflineSync() {
            // Deteksi status online/offline
            window.addEventListener('online', () => {
                isOnline = true;
                updateOnlineStatusUI(true);
                processOfflineQueue();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateOnlineStatusUI(false);
            });
        }

        function updateOnlineStatusUI(online) {
            if (online) {
                onlineIndicator.classList.replace('bg-red-500', 'bg-green-500');
                onlineText.textContent = 'Online';
            } else {
                onlineIndicator.classList.replace('bg-green-500', 'bg-red-500');
                onlineText.textContent = 'Offline';
            }
        }

        async function processOfflineQueue() {
            if (offlineQueue.length === 0) return;
            
            showToast('Menyinkronkan data offline...', 'warning');
            
            for (const item of offlineQueue) {
                try {
                    if (item.action === 'create') {
                        await db.collection(item.entityType).add(item.data);
                    } else if (item.action === 'update') {
                        await db.collection(item.entityType).doc(item.entityId).update(item.data);
                    } else if (item.action === 'delete') {
                        await db.collection(item.entityType).doc(item.entityId).delete();
                    }
                    
                    // Hapus dari queue jika berhasil
                    offlineQueue = offlineQueue.filter(i => i !== item);
                } catch (error) {
                    console.error('Error processing offline item:', error);
                }
            }
            
            // Simpan queue yang tersisa
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            updateOfflineQueueUI();
            
            if (offlineQueue.length === 0) {
                showToast('Sinkronisasi offline selesai', 'success');
            } else {
                showToast(`Sinkronisasi sebagian berhasil. ${offlineQueue.length} item gagal.`, 'warning');
            }
        }

        function updateOfflineQueueUI() {
            const queueList = $('offline-queue-list');
            
            if (offlineQueue.length === 0) {
                queueList.textContent = 'Tidak ada item dalam antrian.';
            } else {
                queueList.innerHTML = `
                    <div class="space-y-2">
                        ${offlineQueue.map(item => `
                            <div class="flex items-center justify-between p-2 bg-yellow-50 rounded">
                                <div>
                                    <span class="font-medium">${item.entityType}</span>
                                    <span class="text-sm text-gray-600"> - ${item.action}</span>
                                </div>
                                <span class="text-xs text-yellow-600">Menunggu sinkronisasi</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // --- 11. Settings ---

        function loadSettings() {
            // Load settings dari localStorage
            const savedSettings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            
            // Apply default settings jika tidak ada
            settings = {
                autoGenerateNumber: savedSettings.autoGenerateNumber !== undefined ? savedSettings.autoGenerateNumber : true,
                numberFormat: savedSettings.numberFormat || 'PLG-{YYYY}-{MM}-{SEQ}',
                autoBackup: savedSettings.autoBackup !== undefined ? savedSettings.autoBackup : false,
                backupTime: savedSettings.backupTime || '00:00',
                darkMode: savedSettings.darkMode !== undefined ? savedSettings.darkMode : false,
                language: savedSettings.language || 'id',
                sessionTimeout: savedSettings.sessionTimeout || 15,
                warningTimeout: savedSettings.warningTimeout || 13
            };
            
            // Simpan settings kembali
            localStorage.setItem('appSettings', JSON.stringify(settings));
            
            // Update session timeout variables
            sessionTimeoutMinutes = settings.sessionTimeout;
            warningTimeoutMinutes = settings.warningTimeout;
        }

        function saveSettings() {
            localStorage.setItem('appSettings', JSON.stringify(settings));
        }

        function applySettings() {
            // Apply dark mode
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
                $('dark-mode').checked = true;
            }
            
            // Apply language
            if (settings.language === 'en') {
                // Implementasi bahasa Inggris di sini
            }
            
            // Apply auto generate number
            $('auto-generate-number').checked = settings.autoGenerateNumber;
            $('number-format').value = settings.numberFormat;
            
            // Apply auto backup
            $('auto-backup').checked = settings.autoBackup;
            $('backup-time').value = settings.backupTime;
            
            // Apply session settings
            $('session-timeout').value = settings.sessionTimeout;
            $('warning-timeout').value = settings.warningTimeout;
            
            // Setup backup schedule
            if (settings.autoBackup) {
                scheduleBackup();
            }
        }

        function setupSettings() {
            // Auto generate number
            $('auto-generate-number').addEventListener('change', (e) => {
                settings.autoGenerateNumber = e.target.checked;
                saveSettings();
            });
            
            $('number-format').addEventListener('change', (e) => {
                settings.numberFormat = e.target.value;
                saveSettings();
            });
            
            // Auto backup
            $('auto-backup').addEventListener('change', (e) => {
                settings.autoBackup = e.target.checked;
                saveSettings();
                
                if (settings.autoBackup) {
                    scheduleBackup();
                } else {
                    cancelBackupSchedule();
                }
            });
            
            $('backup-time').addEventListener('change', (e) => {
                settings.backupTime = e.target.value;
                saveSettings();
                
                if (settings.autoBackup) {
                    scheduleBackup();
                }
            });
            
            // Dark mode
            $('dark-mode').addEventListener('change', (e) => {
                settings.darkMode = e.target.checked;
                saveSettings();
                
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            });
            
            // Language
            $('language').addEventListener('change', (e) => {
                settings.language = e.target.value;
                saveSettings();
                
                // Reload halaman untuk menerapkan bahasa
                location.reload();
            });
            
            // Session settings
            $('save-session-settings').addEventListener('click', () => {
                const sessionTimeout = parseInt($('session-timeout').value);
                const warningTimeout = parseInt($('warning-timeout').value);
                
                if (warningTimeout >= sessionTimeout) {
                    showToast('Warning timeout harus lebih kecil dari session timeout', 'error');
                    return;
                }
                
                settings.sessionTimeout = sessionTimeout;
                settings.warningTimeout = warningTimeout;
                saveSettings();
                
                // Update session timeout variables
                sessionTimeoutMinutes = sessionTimeout;
                warningTimeoutMinutes = warningTimeout;
                
                // Reset session timers
                resetSessionTimers();
                
                showToast('Pengaturan sesi berhasil disimpan', 'success');
            });
            
            // Save password
            $('save-password').addEventListener('click', async () => {
                const currentPassword = $('current-password').value;
                const newPassword = $('new-password').value;
                const confirmPassword = $('confirm-password').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showToast('Semua field password harus diisi', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showToast('Password baru dan konfirmasi tidak cocok', 'error');
                    return;
                }
                
                try {
                    // Re-authenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        currentUser.email, 
                        currentPassword
                    );
                    await currentUser.reauthenticateWithCredential(credential);
                    
                    // Update password
                    await currentUser.updatePassword(newPassword);
                    
                    showToast('Password berhasil diperbarui', 'success');
                    
                    // Clear form
                    $('current-password').value = '';
                    $('new-password').value = '';
                    $('confirm-password').value = '';
                } catch (error) {
                    console.error('Error updating password:', error);
                    showToast('Gagal memperbarui password: ' + error.message, 'error');
                }
            });
        }

        let backupInterval;
        
        function scheduleBackup() {
            // Cancel existing schedule
            cancelBackupSchedule();
            
            // Parse backup time
            const [hours, minutes] = settings.backupTime.split(':').map(Number);
            
            // Calculate milliseconds until next backup time
            const now = new Date();
            const backupTime = new Date();
            backupTime.setHours(hours, minutes, 0, 0);
            
            // If backup time has passed today, schedule for tomorrow
            if (backupTime <= now) {
                backupTime.setDate(backupTime.getDate() + 1);
            }
            
            const timeUntilBackup = backupTime - now;
            
            // Schedule backup
            backupInterval = setTimeout(() => {
                performBackup();
                
                // Schedule daily backup
                backupInterval = setInterval(performBackup, 24 * 60 * 60 * 1000); // 24 hours
            }, timeUntilBackup);
            
            console.log(`Backup scheduled for ${backupTime.toLocaleString()}`);
        }
        
        function cancelBackupSchedule() {
            if (backupInterval) {
                clearTimeout(backupInterval);
                clearInterval(backupInterval);
                backupInterval = null;
            }
        }
        
        function performBackup() {
            try {
                // Get all data from cache
                const backupData = {};
                Object.keys(dataCache).forEach(key => {
                    backupData[key] = dataCache[key];
                });
                
                // Add timestamp
                backupData.backupTimestamp = new Date().toISOString();
                
                // Save to localStorage
                localStorage.setItem('ftthBackup_' + new Date().toISOString().split('T')[0], JSON.stringify(backupData));
                
                // Keep only last 7 backups
                const keys = Object.keys(localStorage).filter(key => key.startsWith('ftthBackup_'));
                if (keys.length > 7) {
                    keys.sort().slice(0, keys.length - 7).forEach(key => {
                        localStorage.removeItem(key);
                    });
                }
                
                showToast('Backup data berhasil dilakukan', 'success');
            } catch (error) {
                console.error('Error performing backup:', error);
                showToast('Gagal melakukan backup data', 'error');
            }
        }

        // --- 12. Session Management ---

        function setupSessionManagement() {
            // Set up event listeners for user activity
            const events = [
                'mousedown', 'mousemove', 'keypress', 'scroll', 
                'touchstart', 'click', 'keydown', 'keyup'
            ];
            
            events.forEach(event => {
                document.addEventListener(event, resetSessionTimers, true);
            });
            
            // Set up session warning buttons
            $('extend-session').addEventListener('click', () => {
                hideSessionWarning();
                resetSessionTimers();
                showToast('Sesi diperpanjang', 'success');
            });
            
            $('logout-now').addEventListener('click', () => {
                hideSessionWarning();
                auth.signOut();
            });
            
            // Initialize session timers
            resetSessionTimers();
        }

        function resetSessionTimers() {
            // Clear existing timers
            clearTimeout(sessionTimeout);
            clearTimeout(warningTimeout);
            clearInterval(countdownInterval);
            
            // Set new warning timeout
            warningTimeout = setTimeout(() => {
                showSessionWarning();
            }, warningTimeoutMinutes * 60 * 1000);
            
            // Set new session timeout
            sessionTimeout = setTimeout(() => {
                // Auto logout
                auth.signOut();
                showToast('Sesi berakhir karena tidak ada aktivitas', 'warning');
            }, sessionTimeoutMinutes * 60 * 1000);
        }

        function showSessionWarning() {
            sessionWarning.classList.remove('hidden');
            
            // Start countdown
            let remainingTime = (sessionTimeoutMinutes - warningTimeoutMinutes) * 60; // in seconds
            
            countdownInterval = setInterval(() => {
                remainingTime--;
                
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                
                $('session-countdown').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (remainingTime <= 0) {
                    clearInterval(countdownInterval);
                    hideSessionWarning();
                }
            }, 1000);
        }

        function hideSessionWarning() {
            sessionWarning.classList.add('hidden');
            clearInterval(countdownInterval);
        }

        // --- 13. Update Current Time ---

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            $('current-time').textContent = timeString;
        }

        // --- 14. Responsif & Event Listener Lainnya ---

        window.addEventListener('resize', () => {
            if (window.innerWidth >= 640) {
                sidebar.classList.remove('sidebar-collapsed');
            } else {
                sidebar.classList.add('sidebar-collapsed');
            }
            
            // Refresh peta jika perlu
            if (map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
        });

        // Tutup dropdown user menu jika klik di luar
        document.addEventListener('click', (e) => {
            if (!$('user-menu-button').contains(e.target)) {
                $('user-menu-dropdown').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
