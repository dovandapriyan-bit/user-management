<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTTH Topology Center</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (Peta) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster (untuk ODP) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Leaflet Draw untuk drag & drop -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS untuk Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Kustomisasi Leaflet agar sesuai Tailwind */
        .leaflet-popup-content-wrapper { @apply rounded-lg shadow-lg border-0; }
        .leaflet-popup-content { @apply text-sm; }
        .leaflet-popup-tip { @apply shadow-none; }
        
        /* Sembunyikan scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        
        /* Sidebar transition */
        #sidebar { transition: margin-left 0.3s ease-in-out; }
        #main-content { transition: margin-left 0.3s ease-in-out; }
        .sidebar-collapsed { margin-left: -256px; /* 16rem */ }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Detail Modal */
        .detail-section {
            @apply border-b border-gray-200 pb-4 mb-4;
        }
        .detail-section:last-child {
            @apply border-b-0 pb-0 mb-0;
        }
        
        /* Placeholder text yang redup */
        .placeholder-help {
            @apply text-xs text-gray-400 mt-1;
        }
        
        /* Login form styles */
        .login-container {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        
        /* Dark mode styles */
        body.dark-mode {
            @apply bg-gray-900;
        }
        body.dark-mode .bg-white {
            @apply bg-gray-800 text-white;
        }
        body.dark-mode .bg-gray-50 {
            @apply bg-gray-700;
        }
        body.dark-mode .text-gray-800 {
            @apply text-gray-200;
        }
        body.dark-mode .text-gray-700 {
            @apply text-gray-300;
        }
        body.dark-mode .text-gray-600 {
            @apply text-gray-400;
        }
        body.dark-mode .text-gray-500 {
            @apply text-gray-500;
        }
        body.dark-mode .border-gray-200 {
            @apply border-gray-700;
        }
        body.dark-mode .border-gray-300 {
            @apply border-gray-600;
        }
        body.dark-mode .hover\:bg-gray-100:hover {
            @apply bg-gray-700;
        }
        body.dark-mode .hover\:bg-gray-50:hover {
            @apply bg-gray-700;
        }
        
        /* Custom styles for map filters */
        .filter-container {
            @apply bg-white p-4 rounded-lg shadow-md mb-4;
        }
        .filter-section {
            @apply mb-4 pb-4 border-b border-gray-200;
        }
        .filter-section:last-child {
            @apply border-b-0 pb-0 mb-0;
        }
        .filter-title {
            @apply font-semibold text-gray-700 mb-2;
        }
        .filter-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .filter-select {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .filter-button {
            @apply px-3 py-1 rounded text-sm text-white font-medium;
        }
        .filter-button.active {
            @apply opacity-100;
        }
        .filter-button.inactive {
            @apply opacity-50;
        }
        .search-result {
            @apply p-2 border-b border-gray-200 hover:bg-gray-50 cursor-pointer;
        }
        .search-result:last-child {
            @apply border-b-0;
        }
        .search-result-title {
            @apply font-medium text-gray-800;
        }
        .search-result-detail {
            @apply text-sm text-gray-600;
        }
        
        /* Custom styles for session timeout warning */
        .session-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            max-width: 350px;
        }
        
        /* Custom styles for capacity indicators */
        .capacity-indicator {
            height: 8px;
            border-radius: 4px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .capacity-bar {
            height: 100%;
            transition: width 0.3s ease;
        }
        .capacity-low {
            background-color: #10b981;
        }
        .capacity-medium {
            background-color: #f59e0b;
        }
        .capacity-high {
            background-color: #ef4444;
        }
        
        /* Custom styles for drag marker */
        .marker-dragging {
            opacity: 0.7;
        }
        
        /* Custom styles for connection lines */
        .connection-line {
            stroke: #3b82f6;
            stroke-width: 3;
            stroke-opacity: 0.7;
            fill: none;
        }
        .connection-line-feeder {
            stroke: #10b981;
        }
        .connection-line-distribution {
            stroke: #f59e0b;
        }
        .connection-line-customer {
            stroke: #8b5cf6;
            stroke-dasharray: 5, 5;
        }
        
        /* Custom styles for toggle buttons */
        .toggle-button {
            @apply px-4 py-2 rounded-md text-white font-medium transition-all duration-300 transform hover:scale-105;
        }
        .toggle-button.active {
            @apply shadow-lg;
        }
        .toggle-button.inactive {
            @apply opacity-60;
        }
        
        /* Custom styles for dashboard cards */
        .dashboard-card {
            @apply bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 cursor-pointer;
        }
        .dashboard-card:hover {
            @apply transform -translate-y-1;
        }
        
        /* Custom styles for inventory management */
        .inventory-item {
            @apply flex items-center justify-between p-3 border-b border-gray-200;
        }
        .inventory-item:last-child {
            @apply border-b-0;
        }
        .stock-low {
            @apply text-red-600 font-medium;
        }
        .stock-medium {
            @apply text-yellow-600 font-medium;
        }
        .stock-high {
            @apply text-green-600 font-medium;
        }

        /* Enhanced styles for map controls */
        .map-toggle-btn {
            @apply px-4 py-2 rounded-full text-white font-medium transition-all duration-300 transform hover:scale-105 shadow-md;
        }
        .map-toggle-btn.active {
            @apply ring-2 ring-white ring-opacity-50;
        }
        .map-toggle-btn.inactive {
            @apply opacity-60;
        }
        
        /* Enhanced search field styles */
        .search-field {
            @apply w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300;
        }
        
        /* Material form styles */
        .material-item {
            @apply flex items-center space-x-2 mb-2 p-2 border border-gray-200 rounded-md;
        }
        
        /* Camera preview */
        .camera-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .camera-video {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
        }
        .camera-controls {
            @apply flex space-x-4 mt-4;
        }
        .camera-btn {
            @apply px-4 py-2 rounded-lg text-white font-medium;
        }

        /* NEW: Enhanced SN Validation Styles */
        .sn-validation {
            @apply text-xs mt-1;
        }
        .sn-valid {
            @apply text-green-600;
        }
        .sn-invalid {
            @apply text-red-600;
        }

        /* NEW: Auto-number generation styles */
        .auto-number-preview {
            @apply text-xs text-blue-600 mt-1;
        }

        /* NEW: Enhanced offline mode styles */
        .offline-indicator {
            transition: all 0.3s ease;
        }
        .offline-queue-item {
            @apply bg-yellow-50 border border-yellow-200 rounded p-2 mb-2;
        }
        .sync-progress {
            @apply w-full bg-gray-200 rounded-full h-2;
        }
        .sync-progress-bar {
            @apply bg-blue-600 h-2 rounded-full transition-all duration-300;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center login-container">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-600">FTTH Center</h1>
                <p class="text-gray-600 mt-2">Silakan login untuk melanjutkan</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin@ftth.com">
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                    <span id="login-button-text">Login</span>
                    <div id="login-spinner" class="loader w-5 h-5 border-2 border-t-blue-200 ml-2 hidden"></div>
                </button>
                
                <div id="login-error" class="text-red-600 text-sm text-center hidden"></div>
            </form>
        </div>
    </div>

    <!-- 2. OVERLAY LOADING APLIKASI -->
    <div id="app-loader" class="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center hidden">
        <div class="loader"></div>
        <p class="text-gray-700 mt-4 text-lg">Memuat aplikasi...</p>
    </div>

    <!-- 3. SHELL APLIKASI UTAMA (Hidden by default) -->
    <div id="app-shell" class="hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-30">
            <div class="flex items-center justify-between p-4 border-b">
                <h1 class="text-xl font-bold text-blue-600">FTTH Center</h1>
                <button id="sidebar-close-btn" class="sm:hidden p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <nav class="py-4">
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="map">
                    <i data-lucide="map" class="w-5 h-5 mr-3"></i> Peta Jaringan
                </a>
                <div class="px-6 py-2 text-xs font-semibold text-gray-400 uppercase">Aset Jaringan</div>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="OLT">
                    <i data-lucide="server" class="w-5 h-5 mr-3"></i> OLT
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="ODC">
                    <i data-lucide="server-cog" class="w-5 h-5 mr-3"></i> ODC
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="ODP">
                    <i data-lucide="box" class="w-5 h-5 mr-3"></i> ODP
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="Pelanggan">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i> Pelanggan
                </a>
                <div class="px-6 py-2 text-xs font-semibold text-gray-400 uppercase">Manajemen</div>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="Paket">
                    <i data-lucide="package" class="w-5 h-5 mr-3"></i> Paket Layanan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="Karyawan">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i> Karyawan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="inventory">
                    <i data-lucide="package-2" class="w-5 h-5 mr-3"></i> Inventory
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="pengaturan">
                    <i data-lucide="settings" class="w-5 h-5 mr-3"></i> Pengaturan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="audit">
                    <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Audit Log
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="ml-0 sm:ml-64 relative min-h-screen">
            <!-- Top Navbar -->
            <header class="sticky top-0 bg-white shadow-md z-20">
                <div class="flex items-center justify-between h-16 px-4 sm:px-8">
                    <button id="sidebar-open-btn" class="p-2 -ml-2 rounded-md sm:hidden">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    
                    <div class="flex items-center space-x-4">
                        <!-- NEW: Enhanced Offline Indicator -->
                        <div id="online-status" class="flex items-center space-x-2 offline-indicator">
                            <span id="online-indicator" class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span id="online-text" class="text-sm font-medium text-gray-700">Online</span>
                            <span id="offline-queue-count" class="hidden bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </div>
                        <div class="relative" id="user-menu-button">
                            <button class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100">
                                <img src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="User" class="w-8 h-8 rounded-full">
                                <div class="hidden md:block text-left">
                                    <div id="user-email" class="text-sm font-semibold">Admin FTTH</div>
                                    <div id="user-role" class="text-xs text-gray-500">Administrator</div>
                                </div>
                            </button>
                            <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content Area -->
            <div class="p-4 sm:p-8">
                
                <!-- Page: Dashboard -->
                <div id="page-dashboard" class="page-content">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                        <div class="text-sm text-gray-600">
                            <span id="current-time" class="font-medium"></span>
                        </div>
                    </div>
                    
                    <!-- Enhanced Dashboard Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="dashboard-card bg-gradient-to-r from-blue-500 to-blue-600 text-white" data-entity="ODP">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-blue-100">Total ODP</div>
                                    <div id="stat-odp" class="text-3xl font-bold">0</div>
                                </div>
                                <div class="bg-blue-400 p-3 rounded-full">
                                    <i data-lucide="box" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card bg-gradient-to-r from-green-500 to-green-600 text-white" data-entity="Pelanggan">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-green-100">Total Pelanggan</div>
                                    <div id="stat-pelanggan" class="text-3xl font-bold">0</div>
                                </div>
                                <div class="bg-green-400 p-3 rounded-full">
                                    <i data-lucide="users" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card bg-gradient-to-r from-red-500 to-red-600 text-white" data-entity="OLT">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-red-100">Total OLT</div>
                                    <div id="stat-olt" class="text-3xl font-bold">0</div>
                                </div>
                                <div class="bg-red-400 p-3 rounded-full">
                                    <i data-lucide="server" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card bg-gradient-to-r from-purple-500 to-purple-600 text-white" data-entity="Karyawan">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-purple-100">Karyawan</div>
                                    <div id="stat-karyawan" class="text-3xl font-bold">0</div>
                                </div>
                                <div class="bg-purple-400 p-3 rounded-full">
                                    <i data-lucide="user-check" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network Status Card -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Status Jaringan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-2">Utilisasi Port ODP</div>
                                <div class="flex items-center">
                                    <div class="flex-1 mr-2">
                                        <div class="capacity-indicator">
                                            <div id="odp-capacity-bar" class="capacity-bar capacity-low" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <span id="odp-capacity-text" class="text-sm font-medium">0%</span>
                                </div>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-2">Utilisasi Port ODC</div>
                                <div class="flex items-center">
                                    <div class="flex-1 mr-2">
                                        <div class="capacity-indicator">
                                            <div id="odc-capacity-bar" class="capacity-bar capacity-low" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <span id="odc-capacity-text" class="text-sm font-medium">0%</span>
                                </div>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-2">Utilisasi Port OLT</div>
                                <div class="flex items-center">
                                    <div class="flex-1 mr-2">
                                        <div class="capacity-indicator">
                                            <div id="olt-capacity-bar" class="capacity-bar capacity-low" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <span id="olt-capacity-text" class="text-sm font-medium">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Enhanced Offline Queue Section -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">Antrian Sinkronisasi Offline</h3>
                            <button id="sync-offline-data" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span>Sinkronisasi</span>
                            </button>
                        </div>
                        <div id="sync-progress" class="hidden mb-4">
                            <div class="sync-progress">
                                <div id="sync-progress-bar" class="sync-progress-bar" style="width: 0%"></div>
                            </div>
                            <div id="sync-status" class="text-sm text-gray-600 mt-1">Menyinkronkan data...</div>
                        </div>
                        <div id="offline-queue-list" class="text-gray-600">Tidak ada item dalam antrian.</div>
                    </div>
                    
                    <div class="mt-8 bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200">
                        <div class="flex items-center">
                            <i data-lucide="shield-check" class="w-6 h-6 text-blue-600 mr-3"></i>
                            <h3 class="text-lg font-semibold text-blue-800">Mode Administrator</h3>
                        </div>
                        <p class="mt-2 text-blue-700">Anda login sebagai Administrator dengan akses penuh ke semua fitur sistem.</p>
                    </div>
                </div>

                <!-- Page: Peta Jaringan -->
                <div id="page-map" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Peta Jaringan</h2>
                    
                    <!-- Enhanced Filter Container -->
                    <div class="filter-container">
                        <!-- Enhanced Toggle Buttons -->
                        <div class="flex flex-wrap gap-3 mb-4">
                            <button id="toggle-olt" class="map-toggle-btn bg-red-500 active">
                                <i data-lucide="server" class="w-4 h-4 inline mr-2"></i>OLT
                            </button>
                            <button id="toggle-odc" class="map-toggle-btn bg-blue-500 active">
                                <i data-lucide="server-cog" class="w-4 h-4 inline mr-2"></i>ODC
                            </button>
                            <button id="toggle-odp" class="map-toggle-btn bg-green-500 active">
                                <i data-lucide="box" class="w-4 h-4 inline mr-2"></i>ODP
                            </button>
                            <button id="toggle-pelanggan" class="map-toggle-btn bg-yellow-500 active">
                                <i data-lucide="user" class="w-4 h-4 inline mr-2"></i>Pelanggan
                            </button>
                            <button id="toggle-connections" class="map-toggle-btn bg-purple-500 inactive">
                                <i data-lucide="git-branch" class="w-4 h-4 inline mr-2"></i>Koneksi
                            </button>
                            <button id="clear-connections" class="map-toggle-btn bg-gray-500 inactive">
                                <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>Hapus Koneksi
                            </button>
                        </div>
                        
                        <!-- Enhanced Search Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Device Type Filter -->
                            <div>
                                <label class="filter-title">Jenis Perangkat</label>
                                <select id="device-type-filter" class="search-field">
                                    <option value="">Semua Perangkat</option>
                                    <option value="OLT">OLT</option>
                                    <option value="ODC">ODC</option>
                                    <option value="ODP">ODP</option>
                                    <option value="Pelanggan">Pelanggan</option>
                                </select>
                            </div>
                            
                            <!-- Region Code Filter -->
                            <div>
                                <label class="filter-title">Kode Wilayah</label>
                                <input type="text" id="region-code-filter" class="search-field" placeholder="Contoh: SBY">
                            </div>
                            
                            <!-- Sector Code Filter -->
                            <div>
                                <label class="filter-title">Kode Sektor</label>
                                <input type="text" id="sector-code-filter" class="search-field" placeholder="Contoh: FA">
                            </div>
                            
                            <!-- ONT SN Filter -->
                            <div>
                                <label class="filter-title">SN ONT</label>
                                <input type="text" id="ont-sn-filter" class="search-field" placeholder="Contoh: ONT123456789">
                            </div>
                        </div>
                        
                        <!-- Apply Filters Button -->
                        <div class="mt-4 flex justify-end">
                            <button id="apply-filters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mr-2 flex items-center">
                                <i data-lucide="filter" class="w-4 h-4 mr-2"></i>Terapkan Filter
                            </button>
                            <button id="reset-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 flex items-center">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>Reset Filter
                            </button>
                        </div>
                    </div>
                    
                    <div id="map-container" class="w-full h-[70vh] rounded-lg shadow-md z-10"></div>
                </div>

                <!-- Page: Tabel Entitas (Dinamis) -->
                <div id="page-table" class="page-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="table-title" class="text-3xl font-bold text-gray-800">Manajemen Aset</h2>
                        <div class="flex space-x-2">
                            <button id="import-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-green-700">
                                <i data-lucide="upload" class="w-5 h-5"></i>
                                <span>Import</span>
                            </button>
                            <button id="export-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-green-700">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <span>Export</span>
                            </button>
                            <button id="add-new-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-blue-700">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Tambah Baru</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Section -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="table-search" placeholder="Cari data..." class="search-field">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr id="table-header-row">
                                        <!-- Header dinamis di-inject di sini -->
                                    </tr>
                                </thead>
                                <tbody id="table-body" class="divide-y">
                                    <!-- Data dinamis di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <div class="text-sm text-gray-700">
                                Menampilkan <span id="showing-from">0</span> hingga <span id="showing-to">0</span> dari <span id="total-records">0</span> data
                            </div>
                            <div class="flex space-x-2">
                                <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50" disabled>
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                </button>
                                <span id="page-info" class="px-3 py-1">Halaman 1</span>
                                <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50" disabled>
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Inventory -->
                <div id="page-inventory" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Inventory Management</h2>
                    
                    <!-- Enhanced Inventory Controls -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="inventory-search" placeholder="Cari SN ONT..." class="search-field">
                            </div>
                            <div class="flex space-x-2">
                                <select id="inventory-type-filter" class="filter-select">
                                    <option value="">Semua Jenis</option>
                                    <option value="ONT">ONT</option>
                                    <option value="SPLITTER">Splitter</option>
                                    <option value="KABEL">Kabel</option>
                                    <option value="ODP">ODP</option>
                                    <option value="LAINNYA">Lainnya</option>
                                </select>
                                <button id="add-inventory-masuk" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-green-700">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                    <span>Masuk</span>
                                </button>
                                <button id="add-inventory-keluar" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-red-700">
                                    <i data-lucide="minus" class="w-5 h-5"></i>
                                    <span>Keluar</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jenis</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Merk</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">SN</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">QTY</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Satuan</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nama Petugas</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body" class="divide-y">
                                    <!-- Data inventory akan di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Pengaturan -->
                <div id="page-pengaturan" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Pengaturan Sistem</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Mode Generate Nomor -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Mode Generate Nomor</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Generate Nomor Internet Otomatis</p>
                                        <p class="text-sm text-gray-600">Aktifkan untuk membuat nomor internet otomatis saat tambah pelanggan</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-generate-number" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Format Nomor Internet</label>
                                    <input type="text" id="number-format" value="PLG-{YYYY}-{MM}-{SEQ}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Variabel: {YYYY} = Tahun, {MM} = Bulan, {SEQ} = Urutan</p>
                                </div>
                            </div>
                        </div>

                        <!-- Backup Otomatis -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Backup Otomatis</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Aktifkan Backup Otomatis</p>
                                        <p class="text-sm text-gray-600">Backup data setiap hari</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-backup" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Waktu Backup</label>
                                    <select id="backup-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="00:00">00:00</option>
                                        <option value="01:00">01:00</option>
                                        <option value="02:00">02:00</option>
                                        <option value="03:00">03:00</option>
                                        <option value="04:00">04:00</option>
                                        <option value="05:00">05:00</option>
                                        <option value="06:00">06:00</option>
                                        <option value="07:00">07:00</option>
                                        <option value="08:00">08:00</option>
                                        <option value="09:00">09:00</option>
                                        <option value="10:00">10:00</option>
                                        <option value="11:00">11:00</option>
                                        <option value="12:00">12:00</option>
                                        <option value="13:00">13:00</option>
                                        <option value="14:00">14:00</option>
                                        <option value="15:00">15:00</option>
                                        <option value="16:00">16:00</option>
                                        <option value="17:00">17:00</option>
                                        <option value="18:00">18:00</option>
                                        <option value="19:00">19:00</option>
                                        <option value="20:00">20:00</option>
                                        <option value="21:00">21:00</option>
                                        <option value="22:00">22:00</option>
                                        <option value="23:00">23:00</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Session Management -->
                        <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4">Manajemen Sesi</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Timeout Sesi (menit)</label>
                                    <input type="number" id="session-timeout" value="15" min="5" max="60" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Warning Timeout (menit)</label>
                                    <input type="number" id="warning-timeout" value="13" min="1" max="59" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex items-end">
                                    <button id="save-session-settings" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                        Simpan Pengaturan
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Enhanced SN Validation Settings -->
                        <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4">Validasi Serial Number</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Validasi SN Otomatis</p>
                                        <p class="text-sm text-gray-600">Aktifkan validasi format serial number</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="sn-validation" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Format SN OLT</label>
                                    <input type="text" id="sn-olt-format" value="^[A-Z]{4}[0-9]{9}$" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Regex pattern untuk validasi SN OLT</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Format SN ONT</label>
                                    <input type="text" id="sn-ont-format" value="^ONT[A-Z0-9]{7}$" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Regex pattern untuk validasi SN ONT</p>
                                </div>
                            </div>
                        </div>

                        <!-- Ubah Password -->
                        <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4">Ubah Password</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Saat Ini</label>
                                    <input type="password" id="current-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Baru</label>
                                    <input type="password" id="new-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Password Baru</label>
                                    <input type="password" id="confirm-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="mt-4">
                                <button id="save-password" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                    Simpan Password
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Audit Log -->
                <div id="page-audit" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Audit Log</h2>
                    
                    <!-- Filter Section -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                <input type="date" id="audit-date-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pengguna</label>
                                <select id="audit-user-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Pengguna</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Aksi</label>
                                <select id="audit-action-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Aksi</option>
                                    <option value="create">Tambah</option>
                                    <option value="update">Edit</option>
                                    <option value="delete">Hapus</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Entitas</label>
                                <select id="audit-entity-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Entitas</option>
                                    <option value="OLT">OLT</option>
                                    <option value="ODC">ODC</option>
                                    <option value="ODP">ODP</option>
                                    <option value="Pelanggan">Pelanggan</option>
                                    <option value="Paket">Paket</option>
                                    <option value="Karyawan">Karyawan</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="apply-audit-filters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mr-2">Terapkan Filter</button>
                            <button id="reset-audit-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">Reset Filter</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pengguna</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Entitas</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Detail</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-log-body" class="divide-y">
                                    <!-- Data log dinamis di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL FORM (Dinamis) -->
    <div id="form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="entity-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="form-title" class="text-2xl font-bold text-gray-800">Form Entitas</h2>
                <button type="button" id="close-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="form-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Konten form dinamis di-inject di sini -->
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <input type="hidden" id="form-entity-type">
                <input type="hidden" id="form-entity-id">
                <button type="button" id="cancel-modal-button" class="bg-gray-200 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 flex items-center">
                    <span id="submit-button-text">Simpan</span>
                    <div id="submit-spinner" class="loader w-5 h-5 border-2 border-t-blue-200 ml-2 hidden"></div>
                </button>
            </div>
        </form>
    </div>

    <!-- MODAL DETAIL (View Detail) -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="detail-title" class="text-2xl font-bold text-gray-800">Detail Data</h2>
                <button type="button" id="close-detail-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="detail-content">
                <!-- Konten detail di-inject di sini -->
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button type="button" id="close-detail-modal-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL IMPORT -->
    <div id="import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Import Data</h2>
                <button type="button" id="close-import-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih File</label>
                <input type="file" id="import-file" accept=".csv,.xlsx,.xls" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-xs text-gray-500 mt-1">Format yang didukung: CSV, Excel (.xlsx, .xls)</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Entitas</label>
                <select id="import-entity-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Pilih Jenis Entitas</option>
                    <option value="OLT">OLT</option>
                    <option value="ODC">ODC</option>
                    <option value="ODP">ODP</option>
                    <option value="Pelanggan">Pelanggan</option>
                    <option value="Paket">Paket</option>
                    <option value="Karyawan">Karyawan</option>
                </select>
            </div>
            
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-import-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="button" id="process-import-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                    Import
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL INVENTORY MASUK -->
    <div id="inventory-masuk-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="inventory-masuk-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Form Inventory Masuk</h2>
                <button type="button" id="close-inventory-masuk-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal *</label>
                    <input type="datetime-local" id="inventory-masuk-tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis *</label>
                    <select id="inventory-masuk-jenis" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Jenis</option>
                        <option value="ONT">ONT</option>
                        <option value="SPLITTER">Splitter</option>
                        <option value="KABEL">Kabel</option>
                        <option value="ODP">ODP</option>
                        <option value="LAINNYA">Lainnya</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Merk *</label>
                    <input type="text" id="inventory-masuk-merk" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
                    <div class="flex space-x-2">
                        <input type="text" id="inventory-masuk-sn" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                        <button type="button" id="scan-inventory-masuk-sn-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            <span>Scan</span>
                        </button>
                    </div>
                    <!-- NEW: SN Validation Message -->
                    <div id="inventory-masuk-sn-validation" class="sn-validation"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity *</label>
                    <input type="number" id="inventory-masuk-qty" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Satuan *</label>
                    <input type="text" id="inventory-masuk-satuan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100" readonly>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Petugas *</label>
                    <input type="text" id="inventory-masuk-petugas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button type="button" id="cancel-inventory-masuk-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                    Simpan
                </button>
            </div>
        </form>
    </div>

    <!-- MODAL INVENTORY KELUAR -->
    <div id="inventory-keluar-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="inventory-keluar-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Form Inventory Keluar</h2>
                <button type="button" id="close-inventory-keluar-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal *</label>
                    <input type="datetime-local" id="inventory-keluar-tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis *</label>
                    <select id="inventory-keluar-jenis" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Jenis</option>
                        <option value="ONT">ONT</option>
                        <option value="SPLITTER">Splitter</option>
                        <option value="KABEL">Kabel</option>
                        <option value="ODP">ODP</option>
                        <option value="LAINNYA">Lainnya</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Order *</label>
                    <select id="inventory-keluar-order" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Order</option>
                        <option value="PSB">PSB</option>
                        <option value="GGN">GGN</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Merk *</label>
                    <input type="text" id="inventory-keluar-merk" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
                    <div class="flex space-x-2">
                        <input type="text" id="inventory-keluar-sn" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                        <button type="button" id="scan-inventory-keluar-sn-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            <span>Scan</span>
                        </button>
                    </div>
                    <!-- NEW: SN Validation Message -->
                    <div id="inventory-keluar-sn-validation" class="sn-validation"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity *</label>
                    <input type="number" id="inventory-keluar-qty" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Satuan *</label>
                    <input type="text" id="inventory-keluar-satuan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100" readonly>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teknisi *</label>
                    <select id="inventory-keluar-teknisi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Teknisi</option>
                        <!-- Options akan diisi dari data teknisi -->
                    </select>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button type="button" id="cancel-inventory-keluar-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                    Simpan
                </button>
            </div>
        </form>
    </div>

    <!-- NOTIFICATION TOAST -->
    <div id="notification-toast" class="fixed top-5 top-5 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden transition-opacity duration-300">
        <span id="toast-message"></span>
    </div>

    <!-- SESSION WARNING MODAL -->
    <div id="session-warning" class="session-warning hidden">
        <div class="flex items-center mb-4">
            <i data-lucide="alert-circle" class="w-6 h-6 text-yellow-500 mr-3"></i>
            <h3 class="text-lg font-semibold">Sesi Akan Berakhir</h3>
        </div>
        <p class="text-gray-600 mb-4">Sesi Anda akan berakhir dalam <span id="session-countdown">2:00</span> menit karena tidak ada aktivitas. Apakah Anda ingin melanjutkan sesi?</p>
        <div class="flex justify-end space-x-2">
            <button id="extend-session" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Lanjutkan Sesi</button>
            <button id="logout-now" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Logout</button>
        </div>
    </div>

    <!-- CAMERA PREVIEW -->
    <div id="camera-preview" class="camera-preview hidden">
        <video id="camera-video" class="camera-video" autoplay></video>
        <div class="camera-controls">
            <button id="capture-btn" class="camera-btn bg-green-500">Capture</button>
            <button id="cancel-camera-btn" class="camera-btn bg-red-500">Batal</button>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- SCRIPT UTAMA APLIKASI -->
    <!-- ====================================================================== -->
    <script>
        // --- Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyXLfovZUAPzPfm1LakEFPPgwGegaQr4o",
            authDomain: "user-management-bccb1.firebaseapp.com",
            projectId: "user-management-bccb1",
            storageBucket: "user-management-bccb1.firebasestorage.app",
            messagingSenderId: "22188892577",
            appId: "1:22188892577:web:d8c7ebe3e00e1974956be0",
            measurementId: "G-4SEKELHMTF"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Variabel Global & State ---
        let currentUser = null;
        let userId = null;
        let userRole = null;
        let isOnline = navigator.onLine;
        let map;
        let markerLayers = {
            OLT: L.layerGroup(),
            ODC: L.layerGroup(),
            ODP: L.markerClusterGroup(),
            Pelanggan: L.markerClusterGroup()
        };
        let connectionLines = [];
        let selectedMarker = null;
        let draggedMarker = null;
        let cameraStream = null;
        
        // Data cache untuk aplikasi
        let dataCache = {
            OLT: [],
            ODC: [],
            ODP: [],
            Pelanggan: [],
            Paket: [],
            Karyawan: [],
            AuditLog: [],
            Inventory: [],
            InventoryTransaksi: []
        };
        
        let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
        let settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
        let currentPage = 1;
        let itemsPerPage = 10;
        let filteredData = [];
        
        // Session management variables
        let sessionTimeout;
        let warningTimeout;
        let countdownInterval;
        let sessionTimeoutMinutes = 15;
        let warningTimeoutMinutes = 13;

        // NEW: Enhanced settings for new features
        settings.snValidation = settings.snValidation !== undefined ? settings.snValidation : true;
        settings.snOltFormat = settings.snOltFormat || '^[A-Z]{4}[0-9]{9}$';
        settings.snOntFormat = settings.snOntFormat || '^ONT[A-Z0-9]{7}$';

        // --- Selektor DOM ---
        const $ = document.getElementById.bind(document);
        const $$ = document.querySelectorAll.bind(document);
        
        const loginScreen = $('login-screen');
        const loginForm = $('login-form');
        const appLoader = $('app-loader');
        const appShell = $('app-shell');
        const sidebar = $('sidebar');
        const onlineIndicator = $('online-indicator');
        const onlineText = $('online-text');
        const formModal = $('form-modal');
        const entityForm = $('entity-form');
        const formTitle = $('form-title');
        const formContent = $('form-content');
        const formEntityType = $('form-entity-type');
        const formEntityId = $('form-entity-id');
        const detailModal = $('detail-modal');
        const detailTitle = $('detail-title');
        const detailContent = $('detail-content');
        const importModal = $('import-modal');
        const inventoryMasukModal = $('inventory-masuk-modal');
        const inventoryMasukForm = $('inventory-masuk-form');
        const inventoryKeluarModal = $('inventory-keluar-modal');
        const inventoryKeluarForm = $('inventory-keluar-form');
        const toast = $('notification-toast');
        const toastMessage = $('toast-message');
        const sessionWarning = $('session-warning');
        const cameraPreview = $('camera-preview');
        const cameraVideo = $('camera-video');

        // --- 1. Inisialisasi Aplikasi ---
        
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupAuthStateListener();
            setupOfflineSync();
            updateOnlineStatusUI(isOnline);
            loadSettings();
            applySettings();
            setupSessionManagement();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // NEW: Initialize enhanced features
            initializeEnhancedFeatures();
        });

        // NEW: Initialize Enhanced Features
        function initializeEnhancedFeatures() {
            // Setup SN validation for existing forms
            setupSNValidation();
            
            // Setup auto-number generation
            setupAutoNumberGeneration();
            
            // Setup enhanced offline mode
            setupEnhancedOfflineMode();
            
            // Update offline queue UI
            updateOfflineQueueUI();
        }

        // NEW: Enhanced SN Validation System
        function setupSNValidation() {
            // This will be called when forms are loaded to add validation
            console.log('SN Validation system initialized');
        }

        // NEW: Enhanced Auto-Number Generation
        function setupAutoNumberGeneration() {
            // This will handle auto-number generation for various entities
            console.log('Auto-number generation system initialized');
        }

        // NEW: Enhanced Offline Mode
        function setupEnhancedOfflineMode() {
            // Enhanced offline functionality
            console.log('Enhanced offline mode initialized');
            
            // Setup sync button
            $('sync-offline-data').addEventListener('click', processOfflineQueue);
        }

        // --- 2. Autentikasi Firebase ---
        
        function setupAuthStateListener() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User sudah login
                    currentUser = user;
                    userId = user.uid;
                    userRole = 'Administrator'; // Default role
                    
                    // Update UI dengan info user
                    $('user-email').textContent = user.email;
                    $('user-role').textContent = userRole;
                    
                    // Sembunyikan login screen, tampilkan aplikasi
                    loginScreen.classList.add('hidden');
                    appLoader.classList.remove('hidden');
                    
                    // Inisialisasi aplikasi
                    initAppUI();
                } else {
                    // User belum login
                    currentUser = null;
                    userId = null;
                    userRole = null;
                    
                    // Tampilkan login screen, sembunyikan aplikasi
                    loginScreen.classList.remove('hidden');
                    appShell.classList.add('hidden');
                    appLoader.classList.add('hidden');
                }
            });
        }

        // Event listener untuk form login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = $('login-email').value;
            const password = $('login-password').value;
            const loginError = $('login-error');
            const loginButtonText = $('login-button-text');
            const loginSpinner = $('login-spinner');
            
            // Tampilkan loading state
            loginButtonText.textContent = 'Logging in...';
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state listener akan menangani transisi ke aplikasi
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = getAuthErrorMessage(error.code);
                loginError.classList.remove('hidden');
            } finally {
                // Reset loading state
                loginButtonText.textContent = 'Login';
                loginSpinner.classList.add('hidden');
            }
        });

        // Event listener untuk logout
        $('logout-button').addEventListener('click', () => {
            auth.signOut();
        });

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'Format email tidak valid';
                case 'auth/user-disabled':
                    return 'Akun ini telah dinonaktifkan';
                case 'auth/user-not-found':
                    return 'Akun tidak ditemukan';
                case 'auth/wrong-password':
                    return 'Password salah';
                case 'auth/too-many-requests':
                    return 'Terlalu banyak percobaan login. Coba lagi nanti';
                default:
                    return 'Terjadi kesalahan saat login';
            }
        }

        // --- 3. Inisialisasi UI Aplikasi ---
        
        function initAppUI() {
            // Setup UI
            appLoader.classList.add('hidden');
            appShell.classList.remove('hidden');
            
            // Inisialisasi Peta
            initMap();
            
            // Setup Navigasi
            setupNavigation();

            // Setup User Menu
            $('user-menu-button').addEventListener('click', () => {
                $('user-menu-dropdown').classList.toggle('hidden');
            });

            // Setup Modal Detail
            $('close-detail-button').addEventListener('click', () => detailModal.classList.add('hidden'));
            $('close-detail-modal-button').addEventListener('click', () => detailModal.classList.add('hidden'));

            // Setup Modal Import
            $('close-import-modal-button').addEventListener('click', () => importModal.classList.add('hidden'));
            $('cancel-import-button').addEventListener('click', () => importModal.classList.add('hidden'));
            $('process-import-button').addEventListener('click', processImport);
            
            // Setup Import Button
            $('import-button').addEventListener('click', () => {
                importModal.classList.remove('hidden');
            });
            
            // Setup Inventory Masuk/Keluar Modals
            setupInventoryModals();
            
            // Setup Dashboard Cards
            setupDashboardCards();
            
            // Setup Settings
            setupSettings();

            // Setup Camera Controls
            setupCameraControls();

            // Muat semua data dari Firebase atau cache lokal
            if (isOnline) {
                loadAllData();
            } else {
                loadLocalData();
            }

            // Tampilkan dashboard sebagai default
            showPage('dashboard');
        }

        // Setup Inventory Modals
        function setupInventoryModals() {
            // Inventory Masuk Modal
            $('add-inventory-masuk').addEventListener('click', () => {
                showInventoryMasukModal();
            });
            
            $('close-inventory-masuk-modal-button').addEventListener('click', () => {
                inventoryMasukModal.classList.add('hidden');
            });
            
            $('cancel-inventory-masuk-button').addEventListener('click', () => {
                inventoryMasukModal.classList.add('hidden');
            });
            
            inventoryMasukForm.addEventListener('submit', saveInventoryMasuk);
            
            // Inventory Keluar Modal
            $('add-inventory-keluar').addEventListener('click', () => {
                showInventoryKeluarModal();
            });
            
            $('close-inventory-keluar-modal-button').addEventListener('click', () => {
                inventoryKeluarModal.classList.add('hidden');
            });
            
            $('cancel-inventory-keluar-button').addEventListener('click', () => {
                inventoryKeluarModal.classList.add('hidden');
            });
            
            inventoryKeluarForm.addEventListener('submit', saveInventoryKeluar);
            
            // Setup scan buttons
            $('scan-inventory-masuk-sn-btn').addEventListener('click', () => {
                startCameraScan('inventory-masuk-sn');
            });
            
            $('scan-inventory-keluar-sn-btn').addEventListener('click', () => {
                startCameraScan('inventory-keluar-sn');
            });
            
            // Setup auto-fill tanggal
            setupAutoFillTanggal();
            
            // Setup jenis change untuk auto-match satuan
            setupAutoMatchSatuan();
            
            // Setup inventory search dan filter
            setupInventorySearchFilter();
            
            // NEW: Setup SN validation for inventory forms
            setupInventorySNValidation();
        }

        // NEW: Setup SN Validation for Inventory Forms
        function setupInventorySNValidation() {
            const snMasukInput = $('inventory-masuk-sn');
            const snKeluarInput = $('inventory-keluar-sn');
            
            if (snMasukInput) {
                snMasukInput.addEventListener('blur', () => {
                    validateSN(snMasukInput.value, 'inventory-masuk-sn-validation', 'inventory');
                });
            }
            
            if (snKeluarInput) {
                snKeluarInput.addEventListener('blur', () => {
                    validateSN(snKeluarInput.value, 'inventory-keluar-sn-validation', 'inventory');
                });
            }
        }

        // NEW: Enhanced SN Validation Function
        function validateSN(snValue, validationElementId, type = 'general') {
            if (!settings.snValidation) return true;
            
            const validationElement = $(validationElementId);
            if (!validationElement) return true;
            
            if (!snValue) {
                validationElement.textContent = '';
                validationElement.className = 'sn-validation';
                return true;
            }
            
            let pattern;
            let message = '';
            
            switch(type) {
                case 'olt':
                    pattern = new RegExp(settings.snOltFormat);
                    message = 'Format SN OLT: 4 huruf + 9 angka (contoh: HWTX123456789)';
                    break;
                case 'ont':
                    pattern = new RegExp(settings.snOntFormat);
                    message = 'Format SN ONT: diawali ONT + 9 karakter alfanumerik (contoh: ONT123ABC456)';
                    break;
                case 'inventory':
                    // Generic inventory SN validation
                    pattern = /^[A-Z0-9]{8,16}$/;
                    message = 'Format SN: 8-16 karakter alfanumerik (huruf besar & angka)';
                    break;
                default:
                    pattern = /^[A-Z0-9]{6,20}$/;
                    message = 'Format SN: 6-20 karakter alfanumerik (huruf besar & angka)';
            }
            
            const isValid = pattern.test(snValue);
            
            if (isValid) {
                validationElement.textContent = '✓ Format SN valid';
                validationElement.className = 'sn-validation sn-valid';
            } else {
                validationElement.textContent = `✗ Format SN tidak valid. ${message}`;
                validationElement.className = 'sn-validation sn-invalid';
            }
            
            return isValid;
        }

        function setupAutoFillTanggal() {
            // Auto-fill tanggal untuk form masuk dan keluar
            const now = new Date();
            const localDateTime = now.toISOString().slice(0, 16);
            
            $('inventory-masuk-tanggal').value = localDateTime;
            $('inventory-keluar-tanggal').value = localDateTime;
        }

        function setupAutoMatchSatuan() {
            // Auto-match satuan berdasarkan jenis
            const jenisMasuk = $('inventory-masuk-jenis');
            const jenisKeluar = $('inventory-keluar-jenis');
            const satuanMasuk = $('inventory-masuk-satuan');
            const satuanKeluar = $('inventory-keluar-satuan');
            
            const satuanMap = {
                'ONT': 'Unit',
                'SPLITTER': 'Unit',
                'KABEL': 'Meter',
                'ODP': 'Unit',
                'LAINNYA': 'Unit'
            };
            
            jenisMasuk.addEventListener('change', (e) => {
                const jenis = e.target.value;
                satuanMasuk.value = satuanMap[jenis] || 'Unit';
            });
            
            jenisKeluar.addEventListener('change', (e) => {
                const jenis = e.target.value;
                satuanKeluar.value = satuanMap[jenis] || 'Unit';
            });
        }

        function setupInventorySearchFilter() {
            // Setup search untuk SN ONT
            const searchInput = $('inventory-search');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterInventoryTable(searchTerm);
            });
            
            // Setup filter jenis
            const typeFilter = $('inventory-type-filter');
            typeFilter.addEventListener('change', (e) => {
                const jenis = e.target.value;
                filterInventoryTableByType(jenis);
            });
        }

        function showInventoryMasukModal() {
            // Reset form
            inventoryMasukForm.reset();
            
            // Auto-fill tanggal
            setupAutoFillTanggal();
            
            // Auto-fill petugas dengan user saat ini
            $('inventory-masuk-petugas').value = currentUser.email;
            
            // Tampilkan modal
            inventoryMasukModal.classList.remove('hidden');
        }

        function showInventoryKeluarModal() {
            // Reset form
            inventoryKeluarForm.reset();
            
            // Auto-fill tanggal
            setupAutoFillTanggal();
            
            // Load data teknisi untuk dropdown
            loadTeknisiData();
            
            // Tampilkan modal
            inventoryKeluarModal.classList.remove('hidden');
        }

        function loadTeknisiData() {
            const teknisiSelect = $('inventory-keluar-teknisi');
            teknisiSelect.innerHTML = '<option value="">Pilih Teknisi</option>';
            
            // Filter hanya teknisi dari data karyawan
            const teknisiList = dataCache.Karyawan.filter(k => k.role === 'Teknisi' && k.status === 'Aktif');
            
            teknisiList.forEach(teknisi => {
                const option = document.createElement('option');
                option.value = teknisi.id;
                option.textContent = teknisi.nama;
                teknisiSelect.appendChild(option);
            });
        }

        async function saveInventoryMasuk(e) {
            e.preventDefault();
            
            const tanggal = $('inventory-masuk-tanggal').value;
            const jenis = $('inventory-masuk-jenis').value;
            const merk = $('inventory-masuk-merk').value;
            const sn = $('inventory-masuk-sn').value;
            const qty = parseInt($('inventory-masuk-qty').value);
            const satuan = $('inventory-masuk-satuan').value;
            const petugas = $('inventory-masuk-petugas').value;
            
            // NEW: Validate SN if provided
            if (sn && !validateSN(sn, 'inventory-masuk-sn-validation', 'inventory')) {
                showToast('Format Serial Number tidak valid', 'error');
                return;
            }
            
            if (!tanggal || !jenis || !merk || !qty || !satuan || !petugas) {
                showToast('Semua field bertanda * harus diisi', 'error');
                return;
            }
            
            try {
                const transaksiData = {
                    tanggal: new Date(tanggal),
                    jenis,
                    merk,
                    sn,
                    qty,
                    satuan,
                    petugas,
                    tipe: 'MASUK',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.email
                };
                
                if (isOnline) {
                    // Simpan ke Firebase
                    await db.collection('InventoryTransaksi').add(transaksiData);
                    
                    // Update cache
                    dataCache.InventoryTransaksi.push({
                        id: 'temp-id-' + Date.now(),
                        ...transaksiData
                    });
                    
                    showToast('Data inventory masuk berhasil disimpan', 'success');
                } else {
                    // NEW: Enhanced offline mode - save to queue
                    offlineQueue.push({
                        action: 'create',
                        entityType: 'InventoryTransaksi',
                        data: transaksiData,
                        timestamp: new Date().getTime()
                    });
                    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                    updateOfflineQueueUI();
                    showToast('Data disimpan dalam antrian offline', 'warning');
                }
                
                // Refresh tabel inventory
                renderInventoryTable();
                
                // Tutup modal
                inventoryMasukModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving inventory masuk:', error);
                showToast('Gagal menyimpan data inventory masuk', 'error');
            }
        }

        async function saveInventoryKeluar(e) {
            e.preventDefault();
            
            const tanggal = $('inventory-keluar-tanggal').value;
            const jenis = $('inventory-keluar-jenis').value;
            const order = $('inventory-keluar-order').value;
            const merk = $('inventory-keluar-merk').value;
            const sn = $('inventory-keluar-sn').value;
            const qty = parseInt($('inventory-keluar-qty').value);
            const satuan = $('inventory-keluar-satuan').value;
            const teknisiId = $('inventory-keluar-teknisi').value;
            
            // NEW: Validate SN if provided
            if (sn && !validateSN(sn, 'inventory-keluar-sn-validation', 'inventory')) {
                showToast('Format Serial Number tidak valid', 'error');
                return;
            }
            
            if (!tanggal || !jenis || !order || !merk || !qty || !satuan || !teknisiId) {
                showToast('Semua field bertanda * harus diisi', 'error');
                return;
            }
            
            try {
                // Dapatkan nama teknisi
                const teknisi = dataCache.Karyawan.find(k => k.id === teknisiId);
                const teknisiNama = teknisi ? teknisi.nama : 'Unknown';
                
                const transaksiData = {
                    tanggal: new Date(tanggal),
                    jenis,
                    order,
                    merk,
                    sn,
                    qty,
                    satuan,
                    teknisi: teknisiNama,
                    tipe: 'KELUAR',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.email
                };
                
                if (isOnline) {
                    // Simpan ke Firebase
                    await db.collection('InventoryTransaksi').add(transaksiData);
                    
                    // Update cache
                    dataCache.InventoryTransaksi.push({
                        id: 'temp-id-' + Date.now(),
                        ...transaksiData
                    });
                    
                    showToast('Data inventory keluar berhasil disimpan', 'success');
                } else {
                    // NEW: Enhanced offline mode - save to queue
                    offlineQueue.push({
                        action: 'create',
                        entityType: 'InventoryTransaksi',
                        data: transaksiData,
                        timestamp: new Date().getTime()
                    });
                    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                    updateOfflineQueueUI();
                    showToast('Data disimpan dalam antrian offline', 'warning');
                }
                
                // Refresh tabel inventory
                renderInventoryTable();
                
                // Tutup modal
                inventoryKeluarModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving inventory keluar:', error);
                showToast('Gagal menyimpan data inventory keluar', 'error');
            }
        }

        function renderInventoryTable() {
            const tbody = $('inventory-table-body');
            tbody.innerHTML = '';
            
            if (dataCache.InventoryTransaksi.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            Tidak ada data transaksi inventory
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Urutkan berdasarkan tanggal (terbaru dulu)
            const sortedData = [...dataCache.InventoryTransaksi].sort((a, b) => 
                new Date(b.tanggal) - new Date(a.tanggal)
            );
            
            sortedData.forEach(transaksi => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const tanggal = new Date(transaksi.tanggal).toLocaleDateString('id-ID');
                const statusBadge = transaksi.tipe === 'MASUK' ? 
                    '<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Masuk</span>' :
                    '<span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Keluar</span>';
                
                const namaPetugas = transaksi.tipe === 'MASUK' ? transaksi.petugas : transaksi.teknisi;
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${tanggal}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.jenis}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.merk}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.sn || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.qty}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.satuan}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${namaPetugas}</td>
                    <td class="px-4 py-3 text-sm">${statusBadge}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center space-x-2">
                            <button class="view-inventory-btn text-green-600 hover:text-green-800 p-1" data-id="${transaksi.id}" title="Lihat Detail">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-inventory-btn text-red-600 hover:text-red-800 p-1" data-id="${transaksi.id}" title="Hapus">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Setup event listeners untuk tombol aksi
            $$('.view-inventory-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    // Implementasi view detail inventory
                    showToast('Fitur view detail inventory dalam pengembangan', 'info');
                });
            });
            
            $$('.delete-inventory-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    deleteInventoryTransaksi(id);
                });
            });
        }

        function filterInventoryTable(searchTerm) {
            if (!searchTerm) {
                renderInventoryTable();
                return;
            }
            
            const filtered = dataCache.InventoryTransaksi.filter(transaksi => 
                transaksi.sn && transaksi.sn.toLowerCase().includes(searchTerm)
            );
            
            renderFilteredInventoryTable(filtered);
        }

        function filterInventoryTableByType(jenis) {
            if (!jenis) {
                renderInventoryTable();
                return;
            }
            
            const filtered = dataCache.InventoryTransaksi.filter(transaksi => 
                transaksi.jenis === jenis
            );
            
            renderFilteredInventoryTable(filtered);
        }

        function renderFilteredInventoryTable(data) {
            const tbody = $('inventory-table-body');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            Tidak ada data yang sesuai dengan filter
                        </td>
                    </tr>
                `;
                return;
            }
            
            data.forEach(transaksi => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const tanggal = new Date(transaksi.tanggal).toLocaleDateString('id-ID');
                const statusBadge = transaksi.tipe === 'MASUK' ? 
                    '<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Masuk</span>' :
                    '<span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Keluar</span>';
                
                const namaPetugas = transaksi.tipe === 'MASUK' ? transaksi.petugas : transaksi.teknisi;
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${tanggal}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.jenis}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.merk}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.sn || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.qty}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${transaksi.satuan}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${namaPetugas}</td>
                    <td class="px-4 py-3 text-sm">${statusBadge}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center space-x-2">
                            <button class="view-inventory-btn text-green-600 hover:text-green-800 p-1" data-id="${transaksi.id}" title="Lihat Detail">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-inventory-btn text-red-600 hover:text-red-800 p-1" data-id="${transaksi.id}" title="Hapus">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Setup event listeners untuk tombol aksi
            $$('.view-inventory-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    showToast('Fitur view detail inventory dalam pengembangan', 'info');
                });
            });
            
            $$('.delete-inventory-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    deleteInventoryTransaksi(id);
                });
            });
        }

        async function deleteInventoryTransaksi(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus transaksi inventory ini?')) return;
            
            try {
                if (isOnline) {
                    await db.collection('InventoryTransaksi').doc(id).delete();
                    
                    // Hapus dari cache
                    dataCache.InventoryTransaksi = dataCache.InventoryTransaksi.filter(t => t.id !== id);
                    
                    showToast('Transaksi inventory berhasil dihapus', 'success');
                } else {
                    // NEW: Enhanced offline mode - add to delete queue
                    const transaksi = dataCache.InventoryTransaksi.find(t => t.id === id);
                    if (transaksi) {
                        offlineQueue.push({
                            action: 'delete',
                            entityType: 'InventoryTransaksi',
                            entityId: id,
                            timestamp: new Date().getTime()
                        });
                        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                        
                        // Remove from local cache immediately for better UX
                        dataCache.InventoryTransaksi = dataCache.InventoryTransaksi.filter(t => t.id !== id);
                        
                        updateOfflineQueueUI();
                        showToast('Transaksi dihapus dari cache lokal, akan dihapus dari server saat online', 'warning');
                    }
                }
                
                // Refresh tabel
                renderInventoryTable();
                
            } catch (error) {
                console.error('Error deleting inventory transaction:', error);
                showToast('Gagal menghapus transaksi inventory', 'error');
            }
        }

        // --- 4. Navigasi & UI Interactivity ---

        function setupNavigation() {
            // Kontrol Sidebar
            $('sidebar-open-btn').addEventListener('click', () => sidebar.classList.remove('sidebar-collapsed'));
            $('sidebar-close-btn').addEventListener('click', () => sidebar.classList.add('sidebar-collapsed'));
            
            if (window.innerWidth < 640) {
                 sidebar.classList.add('sidebar-collapsed');
            }
            
            // Navigasi Halaman
            $$('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    const entity = link.dataset.entity;
                    
                    if (entity) {
                        loadTablePage(entity);
                    }
                    showPage(page);
                    
                    if (window.innerWidth < 640) {
                        sidebar.classList.add('sidebar-collapsed');
                    }
                });
            });

            // Kontrol Modal
            $('close-modal-button').addEventListener('click', () => formModal.classList.add('hidden'));
            $('cancel-modal-button').addEventListener('click', () => formModal.classList.add('hidden'));
            $('add-new-button').addEventListener('click', () => {
                const currentEntity = $('table-title').dataset.entity;
                if (currentEntity) {
                    showFormModal(currentEntity);
                }
            });
        }

        function setupDashboardCards() {
            $$('.dashboard-card').forEach(card => {
                card.addEventListener('click', () => {
                    const entity = card.dataset.entity;
                    if (entity) {
                        loadTablePage(entity);
                        showPage('table');
                    }
                });
            });
        }

        function showPage(pageId) {
            $$('.page-content').forEach(page => page.classList.add('hidden'));
            $(pageId === 'table' ? 'page-table' : `page-${pageId}`).classList.remove('hidden');
            
            if (pageId === 'map') {
                // Perlu me-refresh peta jika ukurannya berubah saat disembunyikan
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
            } else if (pageId === 'inventory') {
                // Load data transaksi inventory saat halaman inventory dibuka
                if (isOnline) {
                    loadDataFromFirestore('InventoryTransaksi').then(() => {
                        renderInventoryTable();
                    });
                } else {
                    renderInventoryTable();
                }
            }
        }

        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            if (type === 'error') {
                toast.classList.replace('bg-gray-900', 'bg-red-600');
            } else if (type === 'warning') {
                toast.classList.replace('bg-gray-900', 'bg-yellow-600');
            } else {
                toast.classList.replace('bg-red-600', 'bg-gray-900');
                toast.classList.replace('bg-yellow-600', 'bg-gray-900');
            }
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // --- 5. Logika Peta (Leaflet) ---

        function initMap() {
            map = L.map('map-container').setView([-6.2088, 106.8456], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Tambahkan semua layer group ke peta
            Object.values(markerLayers).forEach(layer => layer.addTo(map));
            
            // Setup event listeners untuk toggle layer
            setupMapControls();
            
            // Setup filter controls
            setupMapFilters();
        }

        function setupMapControls() {
            // Toggle OLT
            $('toggle-olt').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.OLT)) {
                    map.removeLayer(markerLayers.OLT);
                    $('toggle-olt').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.OLT);
                    $('toggle-olt').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle ODC
            $('toggle-odc').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.ODC)) {
                    map.removeLayer(markerLayers.ODC);
                    $('toggle-odc').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.ODC);
                    $('toggle-odc').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle ODP
            $('toggle-odp').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.ODP)) {
                    map.removeLayer(markerLayers.ODP);
                    $('toggle-odp').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.ODP);
                    $('toggle-odp').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle Pelanggan
            $('toggle-pelanggan').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.Pelanggan)) {
                    map.removeLayer(markerLayers.Pelanggan);
                    $('toggle-pelanggan').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.Pelanggan);
                    $('toggle-pelanggan').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle Connections
            $('toggle-connections').addEventListener('click', () => {
                if (connectionLines.length > 0) {
                    clearConnectionLines();
                    $('toggle-connections').classList.replace('active', 'inactive');
                } else {
                    showAllConnections();
                    $('toggle-connections').classList.replace('inactive', 'active');
                }
            });
            
            // Clear Connections
            $('clear-connections').addEventListener('click', () => {
                clearConnectionLines();
                $('toggle-connections').classList.replace('active', 'inactive');
            });
        }

        function setupMapFilters() {
            // Device type filter
            $('device-type-filter').addEventListener('change', (e) => {
                const deviceType = e.target.value;
                
                // Clear all markers
                Object.values(markerLayers).forEach(layer => layer.clearLayers());
                
                if (deviceType) {
                    // Render only selected device type
                    renderMarkers(deviceType, dataCache[deviceType]);
                } else {
                    // Render all device types
                    Object.keys(markerLayers).forEach(entityType => {
                        renderMarkers(entityType, dataCache[entityType]);
                    });
                }
            });
            
            // Region code filter
            $('region-code-filter').addEventListener('input', (e) => {
                const regionCode = e.target.value.toUpperCase();
                
                // Clear all markers
                Object.values(markerLayers).forEach(layer => layer.clearLayers());
                
                // Filter and render markers based on region code
                Object.keys(markerLayers).forEach(entityType => {
                    const filteredData = dataCache[entityType].filter(item => {
                        if (entityType === 'OLT' || entityType === 'ODC' || entityType === 'ODP') {
                            return item.kodeWilayah && item.kodeWilayah.toUpperCase().includes(regionCode);
                        } else if (entityType === 'Pelanggan') {
                            // For customers, check if their ODP matches the region
                            const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                            return odp && odp.kodeWilayah && odp.kodeWilayah.toUpperCase().includes(regionCode);
                        }
                        return false;
                    });
                    
                    renderMarkers(entityType, filteredData);
                });
            });
            
            // Sector code filter
            $('sector-code-filter').addEventListener('input', (e) => {
                const sectorCode = e.target.value.toUpperCase();
                
                // Clear all markers
                Object.values(markerLayers).forEach(layer => layer.clearLayers());
                
                // Filter and render markers based on sector code
                Object.keys(markerLayers).forEach(entityType => {
                    const filteredData = dataCache[entityType].filter(item => {
                        if (entityType === 'OLT' || entityType === 'ODC' || entityType === 'ODP') {
                            return item.kodeSektor && item.kodeSektor.toUpperCase().includes(sectorCode);
                        } else if (entityType === 'Pelanggan') {
                            // For customers, check if their ODP matches the sector
                            const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                            return odp && odp.kodeSektor && odp.kodeSektor.toUpperCase().includes(sectorCode);
                        }
                        return false;
                    });
                    
                    renderMarkers(entityType, filteredData);
                });
            });
            
            // ONT SN filter
            $('ont-sn-filter').addEventListener('input', (e) => {
                const ontSN = e.target.value.toUpperCase();
                
                // Clear all markers
                Object.values(markerLayers).forEach(layer => layer.clearLayers());
                
                // Filter and render markers based on ONT SN
                Object.keys(markerLayers).forEach(entityType => {
                    const filteredData = dataCache[entityType].filter(item => {
                        if (entityType === 'OLT') {
                            return item.sn && item.sn.toUpperCase().includes(ontSN);
                        } else if (entityType === 'Pelanggan') {
                            return item.snONT && item.snONT.toUpperCase().includes(ontSN);
                        }
                        return false;
                    });
                    
                    renderMarkers(entityType, filteredData);
                });
            });
            
            // Apply filters button
            $('apply-filters').addEventListener('click', () => {
                showToast('Filter diterapkan', 'success');
            });
            
            // Reset filters button
            $('reset-filters').addEventListener('click', () => {
                resetMapFilters();
            });
        }

        function resetMapFilters() {
            // Reset all filter inputs
            $('device-type-filter').value = '';
            $('region-code-filter').value = '';
            $('sector-code-filter').value = '';
            $('ont-sn-filter').value = '';
            
            // Render all markers
            Object.keys(markerLayers).forEach(entityType => {
                markerLayers[entityType].clearLayers();
                renderMarkers(entityType, dataCache[entityType]);
            });
        }

        function renderMarkers(entity, data) {
            const layer = markerLayers[entity];
            layer.clearLayers();

            data.forEach(item => {
                if (!item.location || !item.location.lat || !item.location.lng) return;

                const latLng = [item.location.lat, item.location.lng];
                let marker;

                // Kustomisasi marker berdasarkan entity
                if (entity === 'OLT') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'olt-marker',
                            html: '<div class="w-8 h-8 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="server" class="w-4 h-4 text-white"></i></div>',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        }),
                        id: item.id,
                        draggable: true
                    });
                } else if (entity === 'ODC') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'odc-marker',
                            html: '<div class="w-8 h-8 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="server-cog" class="w-4 h-4 text-white"></i></div>',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        }),
                        id: item.id,
                        draggable: true
                    });
                } else if (entity === 'ODP') {
                    const capacity = getOdpCapacity(item);
                    const color = capacity.percentage >= 100 ? 'red' : (capacity.percentage >= 75 ? 'orange' : 'green');
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'odp-marker',
                            html: `<div class="w-8 h-8 bg-${color}-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="box" class="w-4 h-4 text-white"></i></div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        }),
                        id: item.id,
                        draggable: true
                    });
                } else if (entity === 'Pelanggan') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'pelanggan-marker',
                            html: '<div class="w-6 h-6 bg-green-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="user" class="w-3 h-3 text-white"></i></div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        }),
                        id: item.id,
                        draggable: true
                    });
                }

                if (marker) {
                    marker.bindPopup(createPopupContent(entity, item));
                    
                    // Add drag event
                    marker.on('dragstart', function(e) {
                        draggedMarker = {
                            entity: entity,
                            id: item.id,
                            originalPosition: item.location
                        };
                        this._icon.classList.add('marker-dragging');
                    });
                    
                    marker.on('dragend', async function(e) {
                        this._icon.classList.remove('marker-dragging');
                        
                        const newPosition = e.target.getLatLng();
                        const newLocation = {
                            lat: newPosition.lat,
                            lng: newPosition.lng
                        };
                        
                        try {
                            if (isOnline) {
                                // Update in database
                                await db.collection(entity).doc(item.id).update({
                                    location: newLocation,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedBy: currentUser.email
                                });
                                
                                // Update in cache
                                const index = dataCache[entity].findIndex(i => i.id === item.id);
                                if (index !== -1) {
                                    dataCache[entity][index].location = newLocation;
                                }
                                
                                // Log audit
                                await logAudit('update', entity, item.id, { 
                                    location: { 
                                        from: draggedMarker.originalPosition, 
                                        to: newLocation 
                                    } 
                                });
                                
                                showToast(`Lokasi ${entity} berhasil diperbarui`, 'success');
                            } else {
                                // NEW: Enhanced offline mode - add to queue
                                offlineQueue.push({
                                    action: 'update',
                                    entityType: entity,
                                    entityId: item.id,
                                    data: {
                                        location: newLocation,
                                        updatedAt: new Date(),
                                        updatedBy: currentUser.email
                                    },
                                    timestamp: new Date().getTime()
                                });
                                localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                                
                                // Update local cache immediately
                                const index = dataCache[entity].findIndex(i => i.id === item.id);
                                if (index !== -1) {
                                    dataCache[entity][index].location = newLocation;
                                }
                                
                                updateOfflineQueueUI();
                                showToast('Perubahan lokasi disimpan dalam antrian offline', 'warning');
                            }
                            
                            // Update popup content
                            this.setPopupContent(createPopupContent(entity, {
                                ...item,
                                location: newLocation
                            }));
                        } catch (error) {
                            console.error('Error updating marker position:', error);
                            showToast('Gagal memperbarui lokasi', 'error');
                            
                            // Revert to original position
                            this.setLatLng(draggedMarker.originalPosition);
                        }
                        
                        draggedMarker = null;
                    });
                    
                    marker.on('click', () => {
                        selectedMarker = { entity, item };
                        showConnections(entity, item);
                    });
                    layer.addLayer(marker);
                }
            });
            
            // Render ulang ikon
            lucide.createIcons();
        }
        
        function createPopupContent(entity, item) {
            let content = `<div class="font-bold text-base mb-1">${item.namaODP || item.namaODC || item.name || item.code}</div>`;
            
            if (entity === 'OLT') {
                content += `<p>Model: ${item.model || 'N/A'}</p>`;
                content += `<p>Slot: ${item.totalSlots || 0}, Port: ${item.totalPorts || 0}</p>`;
                
                // Tambahkan data ODC yang terhubung
                const connectedODCs = dataCache.ODC.filter(odc => odc.oltRef === item.id);
                if (connectedODCs.length > 0) {
                    content += `<div class="mt-2 border-t pt-2"><p class="font-semibold">ODC Terhubung:</p>`;
                    connectedODCs.forEach(odc => {
                        content += `<p class="text-sm">- ${odc.namaODC} (Slot ${odc.oltSlot}/Port ${odc.oltPort})</p>`;
                    });
                    content += `</div>`;
                }
            } else if (entity === 'ODC') {
                content += `<p>Kapasitas: ${item.capacity || 0}</p>`;
                
                // Tambahkan data OLT yang terhubung
                const olt = dataCache.OLT.find(o => o.id === item.oltRef);
                if (olt) {
                    content += `<p>OLT: ${olt.name} (${olt.code})</p>`;
                }
                
                // Tambahkan data ODP yang terhubung
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === item.id);
                if (connectedODPs.length > 0) {
                    content += `<div class="mt-2 border-t pt-2"><p class="font-semibold">ODP Terhubung:</p>`;
                    connectedODPs.forEach(odp => {
                        content += `<p class="text-sm">- ${odp.namaODP}</p>`;
                    });
                    content += `</div>`;
                }
            } else if (entity === 'ODP') {
                const { used, total, percentage } = getOdpCapacity(item);
                content += `<p>Kapasitas: ${used} / ${total} (${percentage.toFixed(1)}%)</p>`;
                
                // Tambahkan data ODC yang terhubung
                const odc = dataCache.ODC.find(o => o.id === item.odcRef);
                if (odc) {
                    content += `<p>ODC: ${odc.namaODC}</p>`;
                }
                
                // Tambahkan data pelanggan yang terhubung
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === item.id);
                if (connectedPelanggan.length > 0) {
                    content += `<div class="mt-2 border-t pt-2"><p class="font-semibold">Pelanggan Terhubung:</p>`;
                    connectedPelanggan.forEach(pelanggan => {
                        content += `<p class="text-sm">- ${pelanggan.name} (Port ${pelanggan.odpPort})</p>`;
                    });
                    content += `</div>`;
                }
            } else if (entity === 'Pelanggan') {
                content += `<p>Alamat: ${item.address || 'N/A'}</p>`;
                content += `<p>Status: <span class="font-semibold ${item.status === 'active' ? 'text-green-600' : (item.status === 'pending' ? 'text-yellow-600' : 'text-gray-500')}">${item.status}</span></p>`;
                
                // Tambahkan data ODP yang terhubung
                const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                if (odp) {
                    content += `<p>ODP: ${odp.namaODP} (Port ${item.odpPort})</p>`;
                }
                
                // Tambahkan data ODC yang terhubung
                if (odp) {
                    const odc = dataCache.ODC.find(o => o.id === odp.odcRef);
                    if (odc) {
                        content += `<p>ODC: ${odc.namaODC}</p>`;
                    }
                }
            }
            
            if (item.location) {
                content += `<p class="text-xs text-gray-500">${item.location.lat.toFixed(4)}, ${item.location.lng.toFixed(4)}</p>`;
            }
            return content;
        }

        function showConnections(entity, item) {
            // Hapus koneksi yang ada
            clearConnectionLines();
            
            if (entity === 'OLT') {
                // Tampilkan koneksi ke ODC
                const connectedODCs = dataCache.ODC.filter(odc => odc.oltRef === item.id);
                connectedODCs.forEach(odc => {
                    if (odc.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [odc.location.lat, odc.location.lng],
                            '#EF4444', // Red for OLT-ODC
                            'OLT-ODC'
                        );
                    }
                });
            } else if (entity === 'ODC') {
                // Tampilkan koneksi ke OLT
                const olt = dataCache.OLT.find(o => o.id === item.oltRef);
                if (olt && olt.location) {
                    drawConnectionLine(
                        [item.location.lat, item.location.lng],
                        [olt.location.lat, olt.location.lng],
                        '#EF4444', // Red for OLT-ODC
                        'ODC-OLT'
                    );
                }
                
                // Tampilkan koneksi ke ODP
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === item.id);
                connectedODPs.forEach(odp => {
                    if (odp.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [odp.location.lat, odp.location.lng],
                            '#3B82F6', // Blue for ODC-ODP
                            'ODC-ODP'
                        );
                    }
                });
            } else if (entity === 'ODP') {
                // Tampilkan koneksi ke ODC
                const odc = dataCache.ODC.find(o => o.id === item.odcRef);
                if (odc && odc.location) {
                    drawConnectionLine(
                        [item.location.lat, item.location.lng],
                        [odc.location.lat, odc.location.lng],
                        '#3B82F6', // Blue for ODC-ODP
                        'ODP-ODC'
                    );
                }
                
                // Tampilkan koneksi ke Pelanggan
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === item.id);
                connectedPelanggan.forEach(pelanggan => {
                    if (pelanggan.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [pelanggan.location.lat, pelanggan.location.lng],
                            '#10B981', // Green for ODP-Pelanggan
                            'ODP-Pelanggan'
                        );
                    }
                });
            } else if (entity === 'Pelanggan') {
                // Tampilkan koneksi ke ODP
                const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                if (odp && odp.location) {
                    drawConnectionLine(
                        [item.location.lat, item.location.lng],
                        [odp.location.lat, odp.location.lng],
                        '#10B981', // Green for ODP-Pelanggan
                        'Pelanggan-ODP'
                    );
                }
                
                // Tampilkan koneksi ke ODC
                if (odp) {
                    const odc = dataCache.ODC.find(o => o.id === odp.odcRef);
                    if (odc && odc.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [odc.location.lat, odc.location.lng],
                            '#3B82F6', // Blue for ODC-ODP
                            'Pelanggan-ODC'
                        );
                    }
                }
            }
        }

        function showAllConnections() {
            // Hapus koneksi yang ada
            clearConnectionLines();
            
            // Tampilkan semua koneksi OLT-ODC
            dataCache.OLT.forEach(olt => {
                if (!olt.location) return;
                
                const connectedODCs = dataCache.ODC.filter(odc => odc.oltRef === olt.id);
                connectedODCs.forEach(odc => {
                    if (odc.location) {
                        drawConnectionLine(
                            [olt.location.lat, olt.location.lng],
                            [odc.location.lat, odc.location.lng],
                            '#EF4444', // Red for OLT-ODC
                            'OLT-ODC'
                        );
                    }
                });
            });
            
            // Tampilkan semua koneksi ODC-ODP
            dataCache.ODC.forEach(odc => {
                if (!odc.location) return;
                
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === odc.id);
                connectedODPs.forEach(odp => {
                    if (odp.location) {
                        drawConnectionLine(
                            [odc.location.lat, odc.location.lng],
                            [odp.location.lat, odp.location.lng],
                            '#3B82F6', // Blue for ODC-ODP
                            'ODC-ODP'
                        );
                    }
                });
            });
            
            // Tampilkan semua koneksi ODP-Pelanggan
            dataCache.ODP.forEach(odp => {
                if (!odp.location) return;
                
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === odp.id);
                connectedPelanggan.forEach(pelanggan => {
                    if (pelanggan.location) {
                        drawConnectionLine(
                            [odp.location.lat, odp.location.lng],
                            [pelanggan.location.lat, pelanggan.location.lng],
                            '#10B981', // Green for ODP-Pelanggan
                            'ODP-Pelanggan'
                        );
                    }
                });
            });
        }

        function drawConnectionLine(startLatLng, endLatLng, color, type) {
            const polyline = L.polyline([startLatLng, endLatLng], {
                color: color,
                weight: 4,
                opacity: 0.8,
                smoothFactor: 1
            }).addTo(map);
            
            connectionLines.push(polyline);
        }

        function clearConnectionLines() {
            connectionLines.forEach(line => {
                map.removeLayer(line);
            });
            connectionLines = [];
        }

        // --- 6. Logika Data & Tampilan ---

        async function loadAllData() {
            try {
                // Load semua data dari Firebase
                await Promise.all([
                    loadDataFromFirestore('OLT'),
                    loadDataFromFirestore('ODC'),
                    loadDataFromFirestore('ODP'),
                    loadDataFromFirestore('Pelanggan'),
                    loadDataFromFirestore('Paket'),
                    loadDataFromFirestore('Karyawan'),
                    loadDataFromFirestore('AuditLog'),
                    loadDataFromFirestore('Inventory'),
                    loadDataFromFirestore('InventoryTransaksi')
                ]);
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
                // Update UI dengan data
                renderMarkers('OLT', dataCache.OLT);
                renderMarkers('ODC', dataCache.ODC);
                renderMarkers('ODP', dataCache.ODP);
                renderMarkers('Pelanggan', dataCache.Pelanggan);
                
                renderAuditLog(dataCache.AuditLog);
                updateDashboardStats();
                renderInventoryTable();
                
                showToast('Data berhasil dimuat', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Gagal memuat data', 'error');
                
                // Jika gagal memuat dari Firebase, coba dari localStorage
                loadLocalData();
            }
        }

        function loadLocalData() {
            try {
                // Load data dari localStorage
                const localData = JSON.parse(localStorage.getItem('ftthLocalData') || '{}');
                
                Object.keys(localData).forEach(key => {
                    if (dataCache.hasOwnProperty(key)) {
                        dataCache[key] = localData[key] || [];
                    }
                });
                
                // Update UI dengan data lokal
                renderMarkers('OLT', dataCache.OLT);
                renderMarkers('ODC', dataCache.ODC);
                renderMarkers('ODP', dataCache.ODP);
                renderMarkers('Pelanggan', dataCache.Pelanggan);
                
                renderAuditLog(dataCache.AuditLog);
                updateDashboardStats();
                renderInventoryTable();
                
                showToast('Data berhasil dimuat dari cache lokal', 'success');
            } catch (error) {
                console.error('Error loading local data:', error);
                showToast('Gagal memuat data lokal', 'error');
            }
        }

        function saveLocalData() {
            try {
                // Simpan data ke localStorage
                const dataToSave = {};
                Object.keys(dataCache).forEach(key => {
                    dataToSave[key] = dataCache[key];
                });
                
                localStorage.setItem('ftthLocalData', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Error saving local data:', error);
            }
        }

        async function loadDataFromFirestore(entityType) {
            try {
                const snapshot = await db.collection(entityType).get();
                dataCache[entityType] = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error(`Error loading ${entityType}:`, error);
                dataCache[entityType] = [];
            }
        }

        function loadTablePage(entity) {
            $('table-title').textContent = `Manajemen ${entity}`;
            $('table-title').dataset.entity = entity;
            
            // Setup search dan filter
            setupTableSearch(entity);
            
            // Reset pagination
            currentPage = 1;
            
            // Render tabel
            renderTable(entity, dataCache[entity]);
        }

        function setupTableSearch(entity) {
            const searchInput = $('table-search');
            
            // Clear previous event listeners
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            // Add new event listeners
            newSearchInput.addEventListener('input', () => {
                filterTableData(entity, newSearchInput.value);
            });
            
            // Setup pagination
            setupPagination();
        }

        function filterTableData(entity, searchTerm) {
            let data = [...dataCache[entity]];
            
            // Filter berdasarkan search term
            if (searchTerm) {
                data = data.filter(item => {
                    // Cari di semua properti
                    return Object.values(item).some(value => {
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(searchTerm.toLowerCase());
                        }
                        return false;
                    });
                });
            }
            
            // Simpan data yang sudah difilter
            filteredData = data;
            
            // Reset pagination
            currentPage = 1;
            
            // Render tabel dengan data yang sudah difilter
            renderTable(entity, filteredData);
        }

        function setupPagination() {
            const prevButton = $('prev-page');
            const nextButton = $('next-page');
            
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    const entity = $('table-title').dataset.entity;
                    renderTable(entity, filteredData.length > 0 ? filteredData : dataCache[entity]);
                }
            });
            
            nextButton.addEventListener('click', () => {
                const entity = $('table-title').dataset.entity;
                const data = filteredData.length > 0 ? filteredData : dataCache[entity];
                const totalPages = Math.ceil(data.length / itemsPerPage);
                
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable(entity, data);
                }
            });
        }

        function renderTable(entity, data) {
            const tableHeader = $('table-header-row');
            const tableBody = $('table-body');
            
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            let headers = [];
            
            // Definisikan header tabel berdasarkan entity
            if (entity === 'OLT') headers = ['OLT', 'Type', 'Model', 'SN', 'Rak', 'Slot/Port', 'Lokasi', 'Aksi'];
            else if (entity === 'ODC') headers = ['Kode Wilayah', 'Kode Sektor', 'Nama ODC', 'Kapasitas', 'OLT', 'Slot/Port OLT', 'Panel Feeder', 'Panel Distribusi', 'Aksi'];
            else if (entity === 'ODP') headers = ['Kode Wilayah', 'Kode Sektor', 'Nomor ODP', 'Nama ODP', 'Panel Feeder', 'Port Feeder', 'Panel Distribusi', 'Port Distribusi', 'Kapasitas', 'Aksi'];
            else if (entity === 'Pelanggan') headers = ['No. Pelanggan', 'Nama', 'Username', 'Paket', 'ODP', 'Port', 'Status', 'Aksi'];
            else if (entity === 'Paket') headers = ['Jenis Paket', 'Kecepatan', 'Harga', 'Aksi'];
            else if (entity === 'Karyawan') headers = ['Nama', 'Email', 'Role', 'Status', 'Aksi'];
            
            // Render header
            headers.forEach(h => {
                tableHeader.innerHTML += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`;
            });

            // Pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);
            
            // Update pagination info
            $('showing-from').textContent = data.length > 0 ? startIndex + 1 : 0;
            $('showing-to').textContent = Math.min(endIndex, data.length);
            $('total-records').textContent = data.length;
            $('page-info').textContent = `Halaman ${currentPage}`;
            
            // Update pagination buttons
            const totalPages = Math.ceil(data.length / itemsPerPage);
            $('prev-page').disabled = currentPage === 1;
            $('next-page').disabled = currentPage === totalPages || totalPages === 0;

            // Render data
            paginatedData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                let rowHtml = '';
                if (entity === 'OLT') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.code}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.model || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.sn || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.rack || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.totalSlots || 0} Slot / ${item.totalPorts || 0} Port</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.location ? `${item.location.lat.toFixed(4)}, ${item.location.lng.toFixed(4)}` : 'N/A'}</td>
                    `;
                } else if (entity === 'ODC') {
                    const olt = dataCache.OLT.find(o => o.id === item.oltRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeWilayah}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeSektor}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.namaODC}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.capacity || 0}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${olt?.name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.oltSlot || 'N/A'}/${item.oltPort || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelFeeder || 'N/A'}/${item.portFeeder || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelDistribusi || 'N/A'}/${item.portDistribusi || 'N/A'}</td>
                    `;
                } else if (entity === 'ODP') {
                    const { used, total, percentage } = getOdpCapacity(item);
                    const odc = dataCache.ODC.find(o => o.id === item.odcRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeWilayah}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeSektor}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.nomorODC}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.namaODP}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelFeeder || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.portFeeder || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelDistribusi || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.portDistribusi || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            <div class="flex items-center">
                                <span class="font-medium ${percentage >= 100 ? 'text-red-600' : (percentage >= 75 ? 'text-orange-600' : 'text-green-600')}">
                                    ${used} / ${total}
                                </span>
                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full ${percentage >= 100 ? 'bg-red-500' : (percentage >= 75 ? 'bg-orange-500' : 'bg-green-500')}" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </td>
                    `;
                } else if (entity === 'Pelanggan') {
                    const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                    const paket = dataCache.Paket.find(p => p.id === item.paketRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.customerNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.username}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${paket?.jenis || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${odp?.namaODP || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.odpPort || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.status === 'active' ? 'bg-green-100 text-green-800' : (item.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800')}">
                                ${item.status}
                            </span>
                        </td>
                    `;
                } else if (entity === 'Paket') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.jenis}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kecepatan}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">Rp ${item.harga?.toLocaleString('id-ID') || 0}</td>
                    `;
                } else if (entity === 'Karyawan') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.nama}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.email}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.role}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${item.status}
                            </span>
                        </td>
                    `;
                }
                
                // Tombol aksi
                rowHtml += `
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center space-x-2">
                            <button class="view-btn text-green-600 hover:text-green-800 p-1" data-id="${item.id}" title="Lihat Detail">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button class="edit-btn text-blue-600 hover:text-blue-800 p-1" data-id="${item.id}" title="Edit">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-btn text-red-600 hover:text-red-800 p-1" data-id="${item.id}" title="Hapus">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                row.innerHTML = rowHtml;
                tableBody.appendChild(row);
            });

            // Render ulang ikon
            lucide.createIcons();

            // Tambahkan event listener untuk tombol aksi
            $$('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    showDetailModal(entity, id);
                });
            });

            $$('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    showFormModal(entity, id);
                });
            });

            $$('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    deleteEntity(entity, id);
                });
            });
        }

        function showDetailModal(entityType, entityId) {
            const entity = dataCache[entityType].find(e => e.id === entityId);
            if (!entity) return;
            
            detailTitle.textContent = `Detail ${entityType}`;
            detailContent.innerHTML = generateDetailContent(entityType, entity);
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Tampilkan modal
            detailModal.classList.remove('hidden');
        }

        function generateDetailContent(entityType, entity) {
            let content = '';
            
            if (entityType === 'OLT') {
                const connectedODCs = dataCache.ODC.filter(odc => odc.oltRef === entity.id);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi OLT</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">OLT</p>
                                <p class="font-medium">${entity.code}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Type OLT</p>
                                <p class="font-medium">${entity.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Model</p>
                                <p class="font-medium">${entity.model}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Serial Number</p>
                                <p class="font-medium">${entity.sn}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Rak</p>
                                <p class="font-medium">${entity.rack}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kapasitas</p>
                                <p class="font-medium">${entity.totalSlots} Slot / ${entity.totalPorts} Port</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Koneksi ke ODC</h3>
                        ${connectedODCs.length > 0 ? `
                            <div class="space-y-3">
                                ${connectedODCs.map(odc => `
                                    <div class="border rounded-lg p-3">
                                        <p class="font-medium">${odc.namaODC}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                            <div>
                                                <p class="text-gray-600">Slot/Port OLT</p>
                                                <p>${odc.oltSlot}/${odc.oltPort}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Panel Feeder</p>
                                                <p>${odc.panelFeeder}/${odc.portFeeder}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500">Tidak ada ODC yang terhubung</p>'}
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Rangkuman Jaringan</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="font-medium">OLT ${entity.name} terhubung ke:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                ${connectedODCs.map(odc => `
                                    <li>ODC ${odc.namaODC} melalui Slot ${odc.oltSlot} Port ${odc.oltPort}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            } else if (entityType === 'ODC') {
                const olt = dataCache.OLT.find(o => o.id === entity.oltRef);
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === entity.id);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi ODC</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Kode Wilayah</p>
                                <p class="font-medium">${entity.kodeWilayah}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kode Sektor</p>
                                <p class="font-medium">${entity.kodeSektor}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Nama ODC</p>
                                <p class="font-medium">${entity.namaODC}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kapasitas</p>
                                <p class="font-medium">${entity.capacity}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">OLT</p>
                                <p class="font-medium">${olt?.name || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Slot/Port OLT</p>
                                <p class="font-medium">${entity.oltSlot}/${entity.oltPort}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Feeder</p>
                                <p class="font-medium">${entity.panelFeeder}/${entity.portFeeder}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Distribusi</p>
                                <p class="font-medium">${entity.panelDistribusi}/${entity.portDistribusi}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Koneksi ke ODP</h3>
                        ${connectedODPs.length > 0 ? `
                            <div class="space-y-3">
                                ${connectedODPs.map(odp => `
                                    <div class="border rounded-lg p-3">
                                        <p class="font-medium">${odp.namaODP}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                            <div>
                                                <p class="text-gray-600">Panel Feeder</p>
                                                <p>${odp.panelFeeder}/${odp.portFeeder}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Panel Distribusi</p>
                                                <p>${odp.panelDistribusi}/${odp.portDistribusi}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Kapasitas</p>
                                                <p>${getOdpCapacity(odp).used}/${odp.totalPorts}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500">Tidak ada ODP yang terhubung</p>'}
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Rangkuman Hirarki Jaringan</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="font-medium">ODC ${entity.namaODC} terhubung dari:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                <li>OLT ${olt?.name || 'N/A'} melalui Slot ${entity.oltSlot} Port ${entity.oltPort}</li>
                                <li>Panel Feeder ${entity.panelFeeder} Port ${entity.portFeeder}</li>
                            </ul>
                            <p class="font-medium mt-3">Dan terhubung ke:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                ${connectedODPs.map(odp => `
                                    <li>ODP ${odp.namaODP} melalui Panel Distribusi ${odp.panelDistribusi} Port ${odp.portDistribusi}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            } else if (entityType === 'ODP') {
                const odc = dataCache.ODC.find(o => o.id === entity.odcRef);
                const olt = odc ? dataCache.OLT.find(o => o.id === odc.oltRef) : null;
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === entity.id);
                const { used, total, percentage } = getOdpCapacity(entity);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi ODP</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Kode Wilayah</p>
                                <p class="font-medium">${entity.kodeWilayah}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Sektor ODP</p>
                                <p class="font-medium">${entity.kodeSektor}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Nomor ODP</p>
                                <p class="font-medium">${entity.nomorODC}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Nama ODP</p>
                                <p class="font-medium">${entity.namaODP}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Feeder</p>
                                <p class="font-medium">${entity.panelFeeder}/${entity.portFeeder}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Distribusi</p>
                                <p class="font-medium">${entity.panelDistribusi}/${entity.portDistribusi}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kapasitas Port</p>
                                <p class="font-medium ${percentage >= 100 ? 'text-red-600' : (percentage >= 75 ? 'text-orange-600' : 'text-green-600')}">
                                    ${used} / ${total} (${percentage.toFixed(1)}%)
                                </p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Hirarki Jaringan Lengkap</h3>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">OLT:</span>
                                    <span>${olt?.name || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Slot/Port OLT:</span>
                                    <span>${odc?.oltSlot || 'N/A'}/${odc?.oltPort || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODC:</span>
                                    <span>${odc?.namaODC || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Feeder:</span>
                                    <span>${entity.panelFeeder}/${entity.portFeeder}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Distribusi:</span>
                                    <span>${entity.panelDistribusi}/${entity.portDistribusi}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODP:</span>
                                    <span>${entity.namaODP}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Pelanggan Terhubung</h3>
                        ${connectedPelanggan.length > 0 ? `
                            <div class="space-y-3">
                                ${connectedPelanggan.map(pelanggan => `
                                    <div class="border rounded-lg p-3">
                                        <p class="font-medium">${pelanggan.name}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                            <div>
                                                <p class="text-gray-600">No. Pelanggan</p>
                                                <p>${pelanggan.customerNumber}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Port ODP</p>
                                                <p>${pelanggan.odpPort}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Jenis ONT</p>
                                                <p>${pelanggan.jenisONT}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Status</p>
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${pelanggan.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                    ${pelanggan.status}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500">Tidak ada pelanggan yang terhubung</p>'}
                    </div>
                `;
            } else if (entityType === 'Pelanggan') {
                const odp = dataCache.ODP.find(o => o.id === entity.odpRef);
                const odc = odp ? dataCache.ODC.find(o => o.id === odp.odcRef) : null;
                const olt = odc ? dataCache.OLT.find(o => o.id === odc.oltRef) : null;
                const paket = dataCache.Paket.find(p => p.id === entity.paketRef);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi Pelanggan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">No. Pelanggan</p>
                                <p class="font-medium">${entity.customerNumber}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Nama</p>
                                <p class="font-medium">${entity.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Username</p>
                                <p class="font-medium">${entity.username}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Paket</p>
                                <p class="font-medium">${paket?.jenis || 'N/A'} - ${paket?.kecepatan || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Jenis ONT</p>
                                <p class="font-medium">${entity.jenisONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">SN ONT</p>
                                <p class="font-medium">${entity.snONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">IP Address</p>
                                <p class="font-medium">${entity.ipAddress}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Status</p>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${entity.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${entity.status}
                                </span>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Alamat</p>
                                <p class="font-medium">${entity.address}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Detail Jaringan Pelanggan</h3>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODP:</span>
                                    <span>${odp?.namaODP || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Port ODP:</span>
                                    <span>${entity.odpPort}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODC:</span>
                                    <span>${odc?.namaODC || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Distribusi:</span>
                                    <span>${odp?.panelDistribusi || 'N/A'}/${odp?.portDistribusi || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Feeder:</span>
                                    <span>${odp?.panelFeeder || 'N/A'}/${odp?.portFeeder || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">OLT:</span>
                                    <span>${olt?.name || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Slot/Port OLT:</span>
                                    <span>${odc?.oltSlot || 'N/A'}/${odc?.oltPort || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi Teknis</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Jenis Perangkat</p>
                                <p class="font-medium">${entity.jenisONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Serial Number</p>
                                <p class="font-medium">${entity.snONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Alamat IP</p>
                                <p class="font-medium">${entity.ipAddress}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kecepatan</p>
                                <p class="font-medium">${paket?.kecepatan || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        // TASK 2: FIX AUDIT LOG DATES
        function renderAuditLog(data) {
            const tbody = $('audit-log-body');
            tbody.innerHTML = '';
            
            // Urutkan berdasarkan waktu (terbaru dulu)
            const sortedData = [...data].sort((a, b) => {
                const timeA = getTimestamp(a);
                const timeB = getTimestamp(b);
                return new Date(timeB) - new Date(timeA);
            });
            
            // Batasi hanya 1000 log terbaru
            const limitedData = sortedData.slice(0, 1000);
            
            limitedData.forEach(log => {
                const timestamp = getTimestamp(log);
                const time = new Date(timestamp).toLocaleString('id-ID');
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${time}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.userEmail}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.action}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.entityType}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${JSON.stringify(log.details)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Helper function untuk mendapatkan timestamp dari berbagai format Firebase
        function getTimestamp(log) {
            // Cek berbagai kemungkinan format timestamp Firebase
            if (log.timestamp && log.timestamp.seconds) {
                // Format Firebase Timestamp {seconds: ..., nanoseconds: ...}
                return new Date(log.timestamp.seconds * 1000);
            } else if (log.timestamp && typeof log.timestamp.toDate === 'function') {
                // Format Firebase Timestamp object
                return log.timestamp.toDate();
            } else if (log.timestamp) {
                // Format Date string atau number
                return new Date(log.timestamp);
            } else if (log.createdAt) {
                // Fallback ke createdAt
                return getTimestamp({ timestamp: log.createdAt });
            } else {
                // Fallback ke waktu sekarang
                return new Date();
            }
        }

        function updateDashboardStats() {
            // Update statistik dashboard
            $('stat-odp').textContent = dataCache.ODP.length;
            $('stat-pelanggan').textContent = dataCache.Pelanggan.length;
            $('stat-olt').textContent = dataCache.OLT.length;
            $('stat-karyawan').textContent = dataCache.Karyawan.length;
            
            // Update network capacity
            updateNetworkCapacity();
        }

        function updateNetworkCapacity() {
            // Calculate ODP capacity
            const totalOdpPorts = dataCache.ODP.reduce((sum, odp) => sum + (odp.totalPorts || 0), 0);
            const usedOdpPorts = dataCache.Pelanggan.filter(p => p.status === 'active').length;
            const odpPercentage = totalOdpPorts > 0 ? (usedOdpPorts / totalOdpPorts) * 100 : 0;
            
            $('odp-capacity-bar').style.width = `${odpPercentage}%`;
            $('odp-capacity-text').textContent = `${odpPercentage.toFixed(1)}%`;
            
            // Update capacity bar color
            const odpBar = $('odp-capacity-bar');
            odpBar.classList.remove('capacity-low', 'capacity-medium', 'capacity-high');
            if (odpPercentage >= 100) {
                odpBar.classList.add('capacity-high');
            } else if (odpPercentage >= 75) {
                odpBar.classList.add('capacity-medium');
            } else {
                odpBar.classList.add('capacity-low');
            }
            
            // Calculate ODC capacity
            const totalOdcPorts = dataCache.ODC.reduce((sum, odc) => sum + (odc.capacity || 0), 0);
            const usedOdcPorts = dataCache.ODP.length;
            const odcPercentage = totalOdcPorts > 0 ? (usedOdcPorts / totalOdcPorts) * 100 : 0;
            
            $('odc-capacity-bar').style.width = `${odcPercentage}%`;
            $('odc-capacity-text').textContent = `${odcPercentage.toFixed(1)}%`;
            
            // Update capacity bar color
            const odcBar = $('odc-capacity-bar');
            odcBar.classList.remove('capacity-low', 'capacity-medium', 'capacity-high');
            if (odcPercentage >= 100) {
                odcBar.classList.add('capacity-high');
            } else if (odcPercentage >= 75) {
                odcBar.classList.add('capacity-medium');
            } else {
                odcBar.classList.add('capacity-low');
            }
            
            // Calculate OLT capacity
            const totalOltPorts = dataCache.OLT.reduce((sum, olt) => sum + (olt.totalPorts || 0), 0);
            const usedOltPorts = dataCache.ODC.length;
            const oltPercentage = totalOltPorts > 0 ? (usedOltPorts / totalOltPorts) * 100 : 0;
            
            $('olt-capacity-bar').style.width = `${oltPercentage}%`;
            $('olt-capacity-text').textContent = `${oltPercentage.toFixed(1)}%`;
            
            // Update capacity bar color
            const oltBar = $('olt-capacity-bar');
            oltBar.classList.remove('capacity-low', 'capacity-medium', 'capacity-high');
            if (oltPercentage >= 100) {
                oltBar.classList.add('capacity-high');
            } else if (oltPercentage >= 75) {
                oltBar.classList.add('capacity-medium');
            } else {
                oltBar.classList.add('capacity-low');
            }
        }

        function getOdpCapacity(odp) {
            const total = odp.totalPorts || 0;
            const used = dataCache.Pelanggan.filter(p => p.odpRef === odp.id && p.status === 'active').length;
            const percentage = total > 0 ? (used / total) * 100 : 0;
            return { used, total, percentage };
        }

        // --- 7. Form Modal & CRUD Operations ---

        function showFormModal(entityType, entityId = null) {
            formEntityType.value = entityType;
            formEntityId.value = entityId || '';
            
            // Set judul form
            formTitle.textContent = entityId ? `Edit ${entityType}` : `Tambah ${entityType}`;
            
            // Generate form fields
            formContent.innerHTML = generateFormFields(entityType, entityId);
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Setup event listeners khusus
            setupFormEventListeners(entityType, entityId);
            
            // Tampilkan modal
            formModal.classList.remove('hidden');
        }

        function setupFormEventListeners(entityType, entityId = null) {
            // Setup GPS untuk OLT, ODC, ODP, Pelanggan
            if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                const gpsBtn = formContent.querySelector('#get-gps-btn');
                if (gpsBtn) {
                    gpsBtn.addEventListener('click', getGpsLocation);
                }
            }
            
            // Setup search untuk ODP di form Pelanggan
            if (entityType === 'Pelanggan') {
                const odpSearch = formContent.querySelector('#odp-search');
                const odpSelect = formContent.querySelector('#odpRef');
                
                if (odpSearch && odpSelect) {
                    odpSearch.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const options = odpSelect.querySelectorAll('option');
                        
                        options.forEach(option => {
                            const text = option.textContent.toLowerCase();
                            if (text.includes(searchTerm) || searchTerm === '') {
                                option.style.display = '';
                            } else {
                                option.style.display = 'none';
                            }
                        });
                    });
                }
                
                // Setup camera scan untuk SN ONT - HANYA untuk form Pelanggan
                const scanBtn = formContent.querySelector('#scan-sn-btn');
                if (scanBtn) {
                    scanBtn.addEventListener('click', () => startCameraScan('snONT'));
                }
                
                // Validasi port ODP yang sudah terisi
                const odpPortInput = formContent.querySelector('input[name="odpPort"]');
                const odpRefSelect = formContent.querySelector('select[name="odpRef"]');
                
                if (odpPortInput && odpRefSelect) {
                    const validatePortAvailability = () => {
                        const odpId = odpRefSelect.value;
                        const port = parseInt(odpPortInput.value);
                        
                        if (odpId && port) {
                            const odp = dataCache.ODP.find(o => o.id === odpId);
                            const capacity = getOdpCapacity(odp);
                            
                            if (port > capacity.total) {
                                showToast(`Port ${port} melebihi kapasitas ODP (${capacity.total})`, 'warning');
                                odpPortInput.classList.add('border-red-500');
                            } else {
                                odpPortInput.classList.remove('border-red-500');
                            }
                            
                            const existingCustomer = dataCache.Pelanggan.find(p => 
                                p.odpRef === odpId && p.odpPort === port && p.id !== entityId
                            );
                            
                            if (existingCustomer) {
                                showToast(`Port ${port} pada ODP ini sudah terisi oleh pelanggan ${existingCustomer.name}`, 'warning');
                                odpPortInput.classList.add('border-red-500');
                            } else {
                                odpPortInput.classList.remove('border-red-500');
                            }
                        }
                    };
                    
                    odpPortInput.addEventListener('blur', validatePortAvailability);
                    odpRefSelect.addEventListener('change', validatePortAvailability);
                }
                
                // Setup material fields
                setupMaterialFields(entityId);
            }
            
            // Setup camera scan untuk SN OLT - HANYA untuk form OLT
            if (entityType === 'OLT') {
                const scanBtn = formContent.querySelector('#scan-sn-btn');
                if (scanBtn) {
                    scanBtn.addEventListener('click', () => startCameraScan('sn'));
                }
            }
            
            // NEW: Setup SN validation for OLT and Pelanggan forms
            if (entityType === 'OLT') {
                const snInput = formContent.querySelector('input[name="sn"]');
                if (snInput) {
                    snInput.addEventListener('blur', () => {
                        validateSN(snInput.value, 'sn-validation-olt', 'olt');
                    });
                }
            }
            
            if (entityType === 'Pelanggan') {
                const snOntInput = formContent.querySelector('input[name="snONT"]');
                if (snOntInput) {
                    snOntInput.addEventListener('blur', () => {
                        validateSN(snOntInput.value, 'sn-validation-ont', 'ont');
                    });
                }
            }
            
            // NEW: Setup auto-number generation for Pelanggan
            if (entityType === 'Pelanggan' && !entityId) {
                const customerNumberInput = formContent.querySelector('input[name="customerNumber"]');
                if (customerNumberInput && settings.autoGenerateNumber) {
                    // Generate preview
                    generateAutoNumberPreview(customerNumberInput);
                    
                    // Add event listener for manual input to clear auto-generation
                    customerNumberInput.addEventListener('input', () => {
                        const preview = formContent.querySelector('.auto-number-preview');
                        if (preview) {
                            preview.style.display = 'none';
                        }
                    });
                }
            }
            
            // Validasi slot dan port OLT
            if (entityType === 'ODC') {
                const oltSlotInput = formContent.querySelector('input[name="oltSlot"]');
                const oltPortInput = formContent.querySelector('input[name="oltPort"]');
                const oltRefSelect = formContent.querySelector('select[name="oltRef"]');
                
                if (oltSlotInput && oltPortInput && oltRefSelect) {
                    const validateSlotPortAvailability = () => {
                        const oltId = oltRefSelect.value;
                        const slot = parseInt(oltSlotInput.value);
                        const port = parseInt(oltPortInput.value);
                        
                        if (oltId && slot && port) {
                            const olt = dataCache.OLT.find(o => o.id === oltId);
                            
                            if (olt) {
                                // Validasi slot tidak melebihi total slot
                                if (slot > (olt.totalSlots || 0)) {
                                    showToast(`Slot ${slot} melebihi total slot OLT (${olt.totalSlots || 0})`, 'warning');
                                    oltSlotInput.classList.add('border-red-500');
                                } else {
                                    oltSlotInput.classList.remove('border-red-500');
                                }
                                
                                // Validasi port tidak melebihi total port
                                if (port > (olt.totalPorts || 0)) {
                                    showToast(`Port ${port} melebihi total port OLT (${olt.totalPorts || 0})`, 'warning');
                                    oltPortInput.classList.add('border-red-500');
                                } else {
                                    oltPortInput.classList.remove('border-red-500');
                                }
                                
                                // Validasi slot dan port tidak sudah digunakan
                                const existingODC = dataCache.ODC.find(odc => 
                                    odc.oltRef === oltId && 
                                    odc.oltSlot == slot && 
                                    odc.oltPort == port && 
                                    odc.id !== entityId
                                );
                                
                                if (existingODC) {
                                    showToast(`Slot ${slot} Port ${port} pada OLT ini sudah digunakan oleh ODC ${existingODC.namaODC}`, 'warning');
                                    oltSlotInput.classList.add('border-red-500');
                                    oltPortInput.classList.add('border-red-500');
                                } else {
                                    oltSlotInput.classList.remove('border-red-500');
                                    oltPortInput.classList.remove('border-red-500');
                                }
                            }
                        }
                    };
                    
                    oltSlotInput.addEventListener('blur', validateSlotPortAvailability);
                    oltPortInput.addEventListener('blur', validateSlotPortAvailability);
                    oltRefSelect.addEventListener('change', validateSlotPortAvailability);
                }
            }
            
            // Validasi port ODC
            if (entityType === 'ODP') {
                const odcRefSelect = formContent.querySelector('select[name="odcRef"]');
                const portFeederInput = formContent.querySelector('input[name="portFeeder"]');
                const portDistribusiInput = formContent.querySelector('input[name="portDistribusi"]');
                
                if (odcRefSelect && portFeederInput && portDistribusiInput) {
                    const validatePortAvailability = () => {
                        const odcId = odcRefSelect.value;
                        const portFeeder = parseInt(portFeederInput.value);
                        const portDistribusi = parseInt(portDistribusiInput.value);
                        
                        if (odcId && portFeeder && portDistribusi) {
                            const odc = dataCache.ODC.find(o => o.id === odcId);
                            
                            if (odc) {
                                // Validasi port feeder tidak melebihi kapasitas ODC
                                if (portFeeder > (odc.capacity || 0)) {
                                    showToast(`Port Feeder ${portFeeder} melebihi kapasitas ODC (${odc.capacity || 0})`, 'warning');
                                    portFeederInput.classList.add('border-red-500');
                                } else {
                                    portFeederInput.classList.remove('border-red-500');
                                }
                                
                                // Validasi port feeder tidak sudah digunakan
                                const existingODP = dataCache.ODP.find(odp => 
                                    odp.odcRef === odcId && 
                                    odp.portFeeder == portFeeder && 
                                    odp.id !== entityId
                                );
                                
                                if (existingODP) {
                                    showToast(`Port Feeder ${portFeeder} pada ODC ini sudah digunakan oleh ODP ${existingODP.namaODP}`, 'warning');
                                    portFeederInput.classList.add('border-red-500');
                                } else {
                                    portFeederInput.classList.remove('border-red-500');
                                }
                            }
                        }
                    };
                    
                    portFeederInput.addEventListener('blur', validatePortAvailability);
                    portDistribusiInput.addEventListener('blur', validatePortAvailability);
                    odcRefSelect.addEventListener('change', validatePortAvailability);
                }
            }
            
            // Auto-generate ODP name based on region, sector, and number
            if (entityType === 'ODP') {
                const regionInput = formContent.querySelector('input[name="kodeWilayah"]');
                const sectorInput = formContent.querySelector('input[name="kodeSektor"]');
                const numberInput = formContent.querySelector('input[name="nomorODC"]');
                const nameInput = formContent.querySelector('input[name="namaODP"]');
                
                if (regionInput && sectorInput && numberInput && nameInput) {
                    const updateOdpName = () => {
                        const region = regionInput.value.toUpperCase();
                        const sector = sectorInput.value.toUpperCase();
                        const number = numberInput.value;
                        
                        if (region && sector && number) {
                            nameInput.value = `ODP-${region}-${sector}/${number.padStart(2, '0')}`;
                        }
                    };
                    
                    regionInput.addEventListener('input', updateOdpName);
                    sectorInput.addEventListener('input', updateOdpName);
                    numberInput.addEventListener('input', updateOdpName);
                }
            }
            
            // Auto-generate customer number
            if (entityType === 'Pelanggan' && !entityId) {
                const customerNumberInput = formContent.querySelector('input[name="customerNumber"]');
                
                if (customerNumberInput && settings.autoGenerateNumber) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    
                    // Hitung urutan untuk bulan ini
                    const thisMonthCustomers = dataCache.Pelanggan.filter(p => {
                        const pDate = new Date(p.createdAt);
                        return pDate.getFullYear() === year && pDate.getMonth() === now.getMonth();
                    });
                    
                    const seq = String(thisMonthCustomers.length + 1).padStart(3, '0');
                    customerNumberInput.value = settings.numberFormat
                        .replace('{YYYY}', year)
                        .replace('{MM}', month)
                        .replace('{SEQ}', seq);
                }
            }
            
            // --- NEW: STRICT ODP VALIDATION ---
            if (entityType === 'ODP') {
                const regionInput = formContent.querySelector('input[name="kodeWilayah"]');
                const sectorInput = formContent.querySelector('input[name="kodeSektor"]');
                const odcRefSelect = formContent.querySelector('select[name="odcRef"]');
                
                if (regionInput && sectorInput && odcRefSelect) {
                    const validateOdpMatchOdc = () => {
                        const region = regionInput.value.toUpperCase();
                        const sector = sectorInput.value.toUpperCase();
                        const odcId = odcRefSelect.value;
                        
                        if (region && sector && odcId) {
                            const odc = dataCache.ODC.find(o => o.id === odcId);
                            
                            if (odc) {
                                const odcRegion = odc.kodeWilayah.toUpperCase();
                                const odcSector = odc.kodeSektor.toUpperCase();
                                
                                if (region !== odcRegion || sector !== odcSector) {
                                    showToast(`ERROR: ODP-${region}-${sector} tidak match dengan ODC-${odcRegion}-${odcSector}. Harus sama!`, 'error');
                                    regionInput.classList.add('border-red-500');
                                    sectorInput.classList.add('border-red-500');
                                    odcRefSelect.classList.add('border-red-500');
                                    return false;
                                } else {
                                    regionInput.classList.remove('border-red-500');
                                    sectorInput.classList.remove('border-red-500');
                                    odcRefSelect.classList.remove('border-red-500');
                                    return true;
                                }
                            }
                        }
                        return true;
                    };
                    
                    regionInput.addEventListener('blur', validateOdpMatchOdc);
                    sectorInput.addEventListener('blur', validateOdpMatchOdc);
                    odcRefSelect.addEventListener('change', validateOdpMatchOdc);
                }
            }
        }

        // NEW: Auto-number generation function
        function generateAutoNumberPreview(inputElement) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            
            // Hitung urutan untuk bulan ini
            const thisMonthCustomers = dataCache.Pelanggan.filter(p => {
                const pDate = new Date(p.createdAt);
                return pDate.getFullYear() === year && pDate.getMonth() === now.getMonth();
            });
            
            const seq = String(thisMonthCustomers.length + 1).padStart(3, '0');
            const generatedNumber = settings.numberFormat
                .replace('{YYYY}', year)
                .replace('{MM}', month)
                .replace('{SEQ}', seq);
            
            // Add preview element
            const preview = document.createElement('div');
            preview.className = 'auto-number-preview';
            preview.textContent = `Nomor akan di-generate: ${generatedNumber}`;
            
            inputElement.parentNode.appendChild(preview);
            
            // Auto-fill if empty
            if (!inputElement.value) {
                inputElement.value = generatedNumber;
            }
        }

        function setupMaterialFields(entityId) {
            const materialsContainer = formContent.querySelector('#materials-container');
            if (!materialsContainer) return;
            
            const addMaterialBtn = formContent.querySelector('#add-material-btn');
            const materialTemplate = formContent.querySelector('#material-template');
            
            if (addMaterialBtn && materialTemplate) {
                addMaterialBtn.addEventListener('click', () => {
                    const newMaterial = materialTemplate.cloneNode(true);
                    newMaterial.classList.remove('hidden');
                    newMaterial.id = '';
                    
                    // Setup remove button
                    const removeBtn = newMaterial.querySelector('.remove-material-btn');
                    removeBtn.addEventListener('click', () => {
                        newMaterial.remove();
                    });
                    
                    // Setup camera scan for SN
                    const scanBtn = newMaterial.querySelector('.scan-material-btn');
                    if (scanBtn) {
                        scanBtn.addEventListener('click', () => {
                            const snField = newMaterial.querySelector('input[name="materialSn"]');
                            startCameraScan(null, snField);
                        });
                    }
                    
                    materialsContainer.appendChild(newMaterial);
                });
                
                // Setup initial materials if editing
                if (entityId) {
                    const entity = dataCache.Pelanggan.find(e => e.id === entityId);
                    if (entity && entity.materials) {
                        entity.materials.forEach((material, index) => {
                            if (index === 0) {
                                // Update first material
                                const firstMaterial = materialsContainer.querySelector('.material-item');
                                if (firstMaterial) {
                                    firstMaterial.querySelector('select[name="materialType"]').value = material.type || '';
                                    firstMaterial.querySelector('input[name="materialName"]').value = material.name || '';
                                    firstMaterial.querySelector('input[name="materialQty"]').value = material.quantity || 1;
                                    firstMaterial.querySelector('input[name="materialUnit"]').value = material.unit || '';
                                    firstMaterial.querySelector('input[name="materialSn"]').value = material.sn || '';
                                }
                            } else {
                                // Add additional materials
                                const newMaterial = materialTemplate.cloneNode(true);
                                newMaterial.classList.remove('hidden');
                                newMaterial.id = '';
                                
                                newMaterial.querySelector('select[name="materialType"]').value = material.type || '';
                                newMaterial.querySelector('input[name="materialName"]').value = material.name || '';
                                newMaterial.querySelector('input[name="materialQty"]').value = material.quantity || 1;
                                newMaterial.querySelector('input[name="materialUnit"]').value = material.unit || '';
                                newMaterial.querySelector('input[name="materialSn"]').value = material.sn || '';
                                
                                // Setup remove button
                                const removeBtn = newMaterial.querySelector('.remove-material-btn');
                                removeBtn.addEventListener('click', () => {
                                    newMaterial.remove();
                                });
                                
                                // Setup camera scan for SN
                                const scanBtn = newMaterial.querySelector('.scan-material-btn');
                                if (scanBtn) {
                                    scanBtn.addEventListener('click', () => {
                                        const snField = newMaterial.querySelector('input[name="materialSn"]');
                                        startCameraScan(null, snField);
                                    });
                                }
                                
                                materialsContainer.appendChild(newMaterial);
                            }
                        });
                    }
                }
            }
        }

        function getGpsLocation() {
            const statusEl = formContent.querySelector('#gps-status');
            const latInput = formContent.querySelector('#location-lat');
            const lngInput = formContent.querySelector('#location-lng');
            
            if (!navigator.geolocation) {
                statusEl.textContent = 'Geolocation tidak didukung browser ini.';
                statusEl.classList.add('text-red-500');
                return;
            }
            
            statusEl.textContent = 'Mencari lokasi...';
            statusEl.classList.remove('text-red-500', 'text-green-500');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    latInput.value = latitude.toFixed(6);
                    lngInput.value = longitude.toFixed(6);
                    
                    statusEl.textContent = `Lokasi berhasil di-set! Akurasi: ${accuracy.toFixed(2)} meter`;
                    statusEl.classList.add('text-green-500');
                    
                    showToast('Lokasi berhasil di-set dengan akurasi tinggi', 'success');
                },
                (error) => {
                    let errorMessage = 'Gagal mendapatkan lokasi: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Akses lokasi ditolak';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Informasi lokasi tidak tersedia';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Permintaan lokasi timeout';
                            break;
                        default:
                            errorMessage += 'Error tidak diketahui';
                    }
                    statusEl.textContent = errorMessage;
                    statusEl.classList.add('text-red-500');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function setupCameraControls() {
            $('capture-btn').addEventListener('click', captureImage);
            $('cancel-camera-btn').addEventListener('click', stopCamera);
        }

        function startCameraScan(fieldName = null, targetField = null) {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function(stream) {
                        cameraStream = stream;
                        cameraVideo.srcObject = stream;
                        cameraPreview.classList.remove('hidden');
                        
                        // Store target field info
                        cameraVideo.dataset.targetField = fieldName;
                        if (targetField) {
                            cameraVideo.dataset.targetElement = targetField.name || '';
                        }
                    })
                    .catch(function(error) {
                        console.error('Error accessing camera:', error);
                        showToast('Tidak dapat mengakses kamera', 'error');
                    });
            } else {
                showToast('Browser tidak mendukung akses kamera', 'error');
            }
        }

        function captureImage() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
            
            // Here you would typically send the image to a barcode scanning service
            // For now, we'll simulate barcode detection
            simulateBarcodeDetection();
            
            stopCamera();
        }

        function simulateBarcodeDetection() {
            const fieldName = cameraVideo.dataset.targetField;
            const targetElement = cameraVideo.dataset.targetElement;
            
            let targetField;
            if (targetElement) {
                targetField = formContent.querySelector(`[name="${targetElement}"]`);
            } else if (fieldName) {
                if (fieldName === 'inventory-masuk-sn') {
                    targetField = $('inventory-masuk-sn');
                } else if (fieldName === 'inventory-keluar-sn') {
                    targetField = $('inventory-keluar-sn');
                } else {
                    targetField = formContent.querySelector(`[name="${fieldName}"]`);
                }
            }
            
            if (targetField) {
                // Generate random serial number based on field type
                if (fieldName === 'sn' || targetElement === 'sn') {
                    targetField.value = 'HWTX' + Math.random().toString(36).substr(2, 9).toUpperCase();
                } else if (fieldName === 'snONT' || targetElement === 'snONT') {
                    targetField.value = 'ONT' + Math.random().toString(36).substr(2, 9).toUpperCase();
                } else if (fieldName === 'inventory-masuk-sn' || fieldName === 'inventory-keluar-sn') {
                    targetField.value = 'SN' + Math.random().toString(36).substr(2, 9).toUpperCase();
                } else {
                    targetField.value = 'SN' + Math.random().toString(36).substr(2, 9).toUpperCase();
                }
                showToast('Scan berhasil! Serial Number telah diisi.', 'success');
                
                // Trigger validation after scan
                if (targetField.name === 'sn') {
                    validateSN(targetField.value, 'sn-validation-olt', 'olt');
                } else if (targetField.name === 'snONT') {
                    validateSN(targetField.value, 'sn-validation-ont', 'ont');
                } else if (fieldName === 'inventory-masuk-sn') {
                    validateSN(targetField.value, 'inventory-masuk-sn-validation', 'inventory');
                } else if (fieldName === 'inventory-keluar-sn') {
                    validateSN(targetField.value, 'inventory-keluar-sn-validation', 'inventory');
                }
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraPreview.classList.add('hidden');
        }

        function generateFormFields(entityType, entityId) {
            let fields = '';
            const entity = entityId ? dataCache[entityType].find(e => e.id === entityId) : null;
            
            if (entityType === 'OLT') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">OLT *</label>
                        <input type="text" name="code" value="${entity?.code || ''}" placeholder="GPON / EPON" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type OLT *</label>
                        <input type="text" name="name" value="${entity?.name || ''}" placeholder="ZTE / HWI / EPON" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model *</label>
                        <input type="text" name="model" value="${entity?.model || ''}" placeholder="Huawei MA5608T" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number *</label>
                        <div class="flex space-x-2">
                            <input type="text" name="sn" value="${entity?.sn || ''}" placeholder="HWTX123456789" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                            <button type="button" id="scan-sn-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                <span>Scan</span>
                            </button>
                        </div>
                        <!-- NEW: SN Validation Message -->
                        <div id="sn-validation-olt" class="sn-validation"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rak *</label>
                        <input type="text" name="rack" value="${entity?.rack || ''}" placeholder="Rack A-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Slot *</label>
                        <input type="number" name="totalSlots" value="${entity?.totalSlots || 8}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Port *</label>
                        <input type="number" name="totalPorts" value="${entity?.totalPorts || 128}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'ODC') {
                const oltOptions = dataCache.OLT.map(olt => 
                    `<option value="${olt.id}" ${entity?.oltRef === olt.id ? 'selected' : ''}>${olt.name} (${olt.code})</option>`
                ).join('');
                
                fields = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Wilayah *</label>
                        <input type="text" name="kodeWilayah" value="${entity?.kodeWilayah || ''}" placeholder="SBY" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Contoh: SBY, MLG, LMJ</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Sektor *</label>
                        <input type="text" name="kodeSektor" value="${entity?.kodeSektor || ''}" placeholder="FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Contoh: FA, FB, FC</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama ODC *</label>
                        <input type="text" name="namaODC" value="${entity?.namaODC || ''}" placeholder="ODC-SBY-FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Format: ODC-{Wilayah}-{Sektor}</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kapasitas *</label>
                        <input type="number" name="capacity" value="${entity?.capacity || 144}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">OLT *</label>
                        <select name="oltRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih OLT</option>
                            ${oltOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Slot OLT *</label>
                        <input type="number" name="oltSlot" value="${entity?.oltSlot || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port OLT *</label>
                        <input type="number" name="oltPort" value="${entity?.oltPort || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Feeder *</label>
                        <input type="text" name="panelFeeder" value="${entity?.panelFeeder || ''}" placeholder="PF-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Feeder *</label>
                        <input type="number" name="portFeeder" value="${entity?.portFeeder || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Distribusi *</label>
                        <input type="text" name="panelDistribusi" value="${entity?.panelDistribusi || ''}" placeholder="PD-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Distribusi *</label>
                        <input type="number" name="portDistribusi" value="${entity?.portDistribusi || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'ODP') {
                const odcOptions = dataCache.ODC.map(odc => 
                    `<option value="${odc.id}" ${entity?.odcRef === odc.id ? 'selected' : ''}>${odc.namaODC} (${odc.kodeWilayah}-${odc.kodeSektor})</option>`
                ).join('');
                
                fields = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Wilayah *</label>
                        <input type="text" name="kodeWilayah" value="${entity?.kodeWilayah || ''}" placeholder="SBY" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Contoh: SBY, MLG, LMJ</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sektor ODP *</label>
                        <input type="text" name="kodeSektor" value="${entity?.kodeSektor || ''}" placeholder="FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        <p class="placeholder-help">Contoh: FA, FB, FC</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor ODP *</label>
                        <input type="text" name="nomorODC" value="${entity?.nomorODC || ''}" placeholder="01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="placeholder-help">Contoh: 01, 02, 03</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama ODP *</label>
                        <input type="text" name="namaODP" value="${entity?.namaODP || ''}" placeholder="ODP-SBY-FA/001" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                        <p class="placeholder-help">Format: ODP-{Wilayah}-{Sektor}-{Nomor} (auto-generate)</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ODC *</label>
                        <select name="odcRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih ODC</option>
                            ${odcOptions}
                        </select>
                        <p class="placeholder-help text-red-500 font-semibold">WARNING: Kode Wilayah & Sektor HARUS match dengan ODC terpilih!</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Feeder *</label>
                        <input type="text" name="panelFeeder" value="${entity?.panelFeeder || ''}" placeholder="PF-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Feeder *</label>
                        <input type="number" name="portFeeder" value="${entity?.portFeeder || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Distribusi *</label>
                        <input type="text" name="panelDistribusi" value="${entity?.panelDistribusi || ''}" placeholder="PD-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Distribusi *</label>
                        <input type="number" name="portDistribusi" value="${entity?.portDistribusi || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Port *</label>
                        <select name="totalPorts" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="8" ${entity?.totalPorts == 8 ? 'selected' : ''}>8 Port</option>
                            <option value="16" ${entity?.totalPorts == 16 ? 'selected' : ''}>16 Port</option>
                            <option value="32" ${entity?.totalPorts == 32 ? 'selected' : ''}>32 Port</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Terpakai</label>
                        <input type="number" name="usedPorts" value="${entity?.usedPorts || 0}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'Pelanggan') {
                const odpOptions = dataCache.ODP.map(odp => {
                    const capacity = getOdpCapacity(odp);
                    return `<option value="${odp.id}" ${entity?.odpRef === odp.id ? 'selected' : ''}>${odp.namaODP} (${capacity.used}/${odp.totalPorts})</option>`;
                }).join('');
                
                const paketOptions = dataCache.Paket.map(paket => 
                    `<option value="${paket.id}" ${entity?.paketRef === paket.id ? 'selected' : ''}>${paket.jenis} - ${paket.kecepatan}</option>`
                ).join('');
                
                // Generate nomor pelanggan otomatis jika mode aktif
                const autoGenerate = settings.autoGenerateNumber || false;
                let customerNumber = entity?.customerNumber || '';
                
                if (!entityId && autoGenerate) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    
                    // Hitung urutan untuk bulan ini
                    const thisMonthCustomers = dataCache.Pelanggan.filter(p => {
                        const pDate = new Date(p.createdAt);
                        return pDate.getFullYear() === year && pDate.getMonth() === now.getMonth();
                    });
                    
                    const seq = String(thisMonthCustomers.length + 1).padStart(3, '0');
                    customerNumber = settings.numberFormat
                        .replace('{YYYY}', year)
                        .replace('{MM}', month)
                        .replace('{SEQ}', seq);
                }
                
                // Material fields template
                const materialTemplate = `
                    <div class="material-item hidden" id="material-template">
                        <div class="grid grid-cols-12 gap-2 w-full">
                            <div class="col-span-3">
                                <select name="materialType" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    <option value="">Jenis</option>
                                    <option value="ONT">ONT</option>
                                    <option value="Kabel">Kabel</option>
                                    <option value="Splitter">Splitter</option>
                                    <option value="Lainnya">Lainnya</option>
                                </select>
                            </div>
                            <div class="col-span-3">
                                <input type="text" name="materialName" placeholder="Nama" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                            </div>
                            <div class="col-span-1">
                                <input type="number" name="materialQty" value="1" min="1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                            </div>
                            <div class="col-span-2">
                                <input type="text" name="materialUnit" placeholder="Satuan" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                            </div>
                            <div class="col-span-2">
                                <div class="flex space-x-1">
                                    <input type="text" name="materialSn" placeholder="SN" class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                    <button type="button" class="scan-material-btn bg-blue-500 text-white p-1 rounded text-xs">
                                        <i data-lucide="camera" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-span-1">
                                <button type="button" class="remove-material-btn bg-red-500 text-white p-1 rounded text-xs w-full">
                                    <i data-lucide="x" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Pelanggan *</label>
                        <input type="text" name="customerNumber" id="customerNumber" value="${customerNumber}" placeholder="PLG-2024-01-001" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        ${autoGenerate && !entityId ? '<p class="text-xs text-green-600 mt-1">Nomor di-generate otomatis</p>' : ''}
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                        <input type="text" name="name" value="${entity?.name || ''}" placeholder="Budi Santoso" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                        <input type="text" name="username" value="${entity?.username || ''}" placeholder="budi123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 lowercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" name="password" value="${entity?.password || ''}" placeholder="••••••" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat *</label>
                        <textarea name="address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>${entity?.address || ''}</textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Paket Layanan *</label>
                        <select name="paketRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Paket</option>
                            ${paketOptions}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ODP *</label>
                        <input type="text" id="odp-search" placeholder="Cari ODP..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                        <select name="odpRef" id="odpRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih ODP</option>
                            ${odpOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port ODP *</label>
                        <input type="number" name="odpPort" value="${entity?.odpPort || ''}" min="1" max="32" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="text-xs text-gray-500 mt-1">Port yang tersedia akan ditampilkan di sini</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis ONT</label>
                        <div class="flex space-x-2">
                            <input type="text" name="jenisONT" id="jenisONT" value="${entity?.jenisONT || ''}" placeholder="HG8245H" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                            <button type="button" id="scan-sn-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                <span>Scan</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">SN ONT</label>
                        <input type="text" name="snONT" id="snONT" value="${entity?.snONT || ''}" placeholder="ONT123456789" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                        <!-- NEW: SN Validation Message -->
                        <div id="sn-validation-ont" class="sn-validation"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IP Address</label>
                        <input type="text" name="ipAddress" value="${entity?.ipAddress || ''}" placeholder="192.168.1.100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="active" ${entity?.status === 'active' ? 'selected' : ''}>Aktif</option>
                            <option value="pending" ${entity?.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="inactive" ${entity?.status === 'inactive' ? 'selected' : ''}>Nonaktif</option>
                        </select>
                    </div>
                    
                    <!-- Material Section -->
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">Material yang Digunakan</h3>
                            <button type="button" id="add-material-btn" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 flex items-center space-x-1">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span>Tambah</span>
                            </button>
                        </div>
                        
                        <div id="materials-container" class="space-y-2">
                            <!-- First material item -->
                            <div class="material-item">
                                <div class="grid grid-cols-12 gap-2 w-full">
                                    <div class="col-span-3">
                                        <select name="materialType" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                            <option value="">Jenis</option>
                                            <option value="ONT" ${entity?.materials?.[0]?.type === 'ONT' ? 'selected' : ''}>ONT</option>
                                            <option value="Kabel" ${entity?.materials?.[0]?.type === 'Kabel' ? 'selected' : ''}>Kabel</option>
                                            <option value="Splitter" ${entity?.materials?.[0]?.type === 'Splitter' ? 'selected' : ''}>Splitter</option>
                                            <option value="Lainnya" ${entity?.materials?.[0]?.type === 'Lainnya' ? 'selected' : ''}>Lainnya</option>
                                        </select>
                                    </div>
                                    <div class="col-span-3">
                                        <input type="text" name="materialName" value="${entity?.materials?.[0]?.name || ''}" placeholder="Nama" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div class="col-span-1">
                                        <input type="number" name="materialQty" value="${entity?.materials?.[0]?.quantity || 1}" min="1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div class="col-span-2">
                                        <input type="text" name="materialUnit" value="${entity?.materials?.[0]?.unit || ''}" placeholder="Satuan</option>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (entityType === 'Paket') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Paket *</label>
                        <input type="text" name="jenis" value="${entity?.jenis || ''}" placeholder="Basic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kecepatan *</label>
                        <input type="text" name="kecepatan" value="${entity?.kecepatan || ''}" placeholder="10 Mbps" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Harga *</label>
                        <input type="number" name="harga" value="${entity?.harga || ''}" placeholder="150000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                `;
            } else if (entityType === 'Karyawan') {
                // Disable form untuk tambah karyawan jika bukan admin
                const isDemo = currentUser && currentUser.email === 'demo@ftth.com';
                
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                        <input type="text" name="nama" value="${entity?.nama || ''}" placeholder="Ahmad Fauzi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" ${isDemo && !entityId ? 'disabled' : ''} required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" name="email" value="${entity?.email || ''}" placeholder="ahmad@ftth.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 lowercase" ${isDemo && !entityId ? 'disabled' : ''} required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
                        <select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isDemo && !entityId ? 'disabled' : ''} required>
                            <option value="">Pilih Role</option>
                            <option value="Admin" ${entity?.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Teknisi" ${entity?.role === 'Teknisi' ? 'selected' : ''}>Teknisi</option>
                            <option value="Operator" ${entity?.role === 'Operator' ? 'selected' : ''}>Operator</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isDemo && !entityId ? 'disabled' : ''} required>
                            <option value="Aktif" ${entity?.status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                            <option value="Nonaktif" ${entity?.status === 'Nonaktif' ? 'selected' : ''}>Nonaktif</option>
                        </select>
                    </div>
                    ${isDemo && !entityId ? '<div class="md:col-span-2 text-red-500 text-sm">Akun demo tidak dapat menambah karyawan baru</div>' : ''}
                `;
            }
            
            return fields;
        }

        // Event listener untuk form submission
        entityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveEntity();
        });

        async function saveEntity() {
            const entityType = formEntityType.value;
            const entityId = formEntityId.value;
            const submitButton = entityForm.querySelector('button[type="submit"]');
            const submitSpinner = $('submit-spinner');
            const submitText = $('submit-button-text');
            
            // Cek jika user adalah demo dan mencoba menambah karyawan
            if (entityType === 'Karyawan' && !entityId && currentUser && currentUser.email === 'demo@ftth.com') {
                showToast('Akun demo tidak dapat menambah karyawan baru', 'error');
                return;
            }
            
            // --- NEW: STRICT ODP VALIDATION ---
            if (entityType === 'ODP') {
                const regionInput = formContent.querySelector('input[name="kodeWilayah"]');
                const sectorInput = formContent.querySelector('input[name="kodeSektor"]');
                const odcRefSelect = formContent.querySelector('select[name="odcRef"]');
                
                if (regionInput && sectorInput && odcRefSelect) {
                    const region = regionInput.value.toUpperCase();
                    const sector = sectorInput.value.toUpperCase();
                    const odcId = odcRefSelect.value;
                    
                    if (region && sector && odcId) {
                        const odc = dataCache.ODC.find(o => o.id === odcId);
                        
                        if (odc) {
                            const odcRegion = odc.kodeWilayah.toUpperCase();
                            const odcSector = odc.kodeSektor.toUpperCase();
                            
                            if (region !== odcRegion || sector !== odcSector) {
                                showToast(`VALIDATION FAILED: ODP-${region}-${sector} tidak match dengan ODC-${odcRegion}-${odcSector}. Input ditolak!`, 'error');
                                return;
                            }
                        }
                    }
                }
            }
            
            // NEW: Validate SN for OLT and Pelanggan
            if (entityType === 'OLT') {
                const snInput = formContent.querySelector('input[name="sn"]');
                if (snInput && !validateSN(snInput.value, 'sn-validation-olt', 'olt')) {
                    showToast('Format Serial Number OLT tidak valid', 'error');
                    return;
                }
            }
            
            if (entityType === 'Pelanggan') {
                const snOntInput = formContent.querySelector('input[name="snONT"]');
                if (snOntInput && snOntInput.value && !validateSN(snOntInput.value, 'sn-validation-ont', 'ont')) {
                    showToast('Format Serial Number ONT tidak valid', 'error');
                    return;
                }
            }
            
            // Tampilkan loading state
            submitText.textContent = 'Menyimpan...';
            submitSpinner.classList.remove('hidden');
            submitButton.disabled = true;
            
            try {
                const formData = new FormData(entityForm);
                const data = Object.fromEntries(formData.entries());
                
                // Convert to uppercase for specific fields
                if (entityType === 'OLT') {
                    data.code = data.code ? data.code.toUpperCase() : '';
                    data.name = data.name ? data.name.toUpperCase() : '';
                    data.model = data.model ? data.model.toUpperCase() : '';
                    data.sn = data.sn ? data.sn.toUpperCase() : '';
                    data.rack = data.rack ? data.rack.toUpperCase() : '';
                } else if (entityType === 'ODC') {
                    data.kodeWilayah = data.kodeWilayah ? data.kodeWilayah.toUpperCase() : '';
                    data.kodeSektor = data.kodeSektor ? data.kodeSektor.toUpperCase() : '';
                    data.namaODC = data.namaODC ? data.namaODC.toUpperCase() : '';
                    data.panelFeeder = data.panelFeeder ? data.panelFeeder.toUpperCase() : '';
                    data.panelDistribusi = data.panelDistribusi ? data.panelDistribusi.toUpperCase() : '';
                } else if (entityType === 'ODP') {
                    data.kodeWilayah = data.kodeWilayah ? data.kodeWilayah.toUpperCase() : '';
                    data.kodeSektor = data.kodeSektor ? data.kodeSektor.toUpperCase() : '';
                    data.namaODP = data.namaODP ? data.namaODP.toUpperCase() : '';
                    data.panelFeeder = data.panelFeeder ? data.panelFeeder.toUpperCase() : '';
                    data.panelDistribusi = data.panelDistribusi ? data.panelDistribusi.toUpperCase() : '';
                } else if (entityType === 'Pelanggan') {
                    data.customerNumber = data.customerNumber ? data.customerNumber.toUpperCase() : '';
                    data.name = data.name ? data.name.toUpperCase() : '';
                    data.jenisONT = data.jenisONT ? data.jenisONT.toUpperCase() : '';
                    data.snONT = data.snONT ? data.snONT.toUpperCase() : '';
                    
                    // Process materials
                    const materials = [];
                    const materialTypes = formData.getAll('materialType');
                    const materialNames = formData.getAll('materialName');
                    const materialQtys = formData.getAll('materialQty');
                    const materialUnits = formData.getAll('materialUnit');
                    const materialSns = formData.getAll('materialSn');
                    
                    for (let i = 0; i < materialTypes.length; i++) {
                        if (materialTypes[i] && materialNames[i]) {
                            materials.push({
                                type: materialTypes[i],
                                name: materialNames[i],
                                quantity: parseInt(materialQtys[i]) || 1,
                                unit: materialUnits[i] || '',
                                sn: materialSns[i] || ''
                            });
                            
                            // Update inventory stock
                            if (entityType === 'Pelanggan' && !entityId) {
                                await updateInventoryStock(materialTypes[i], materialNames[i], -(parseInt(materialQtys[i]) || 1));
                            }
                        }
                    }
                    
                    if (materials.length > 0) {
                        data.materials = materials;
                    }
                } else if (entityType === 'Paket') {
                    data.jenis = data.jenis ? data.jenis.toUpperCase() : '';
                } else if (entityType === 'Karyawan') {
                    data.nama = data.nama ? data.nama.toUpperCase() : '';
                }
                
                // Parse nested objects
                if (data.location && data.location.lat && data.location.lng) {
                    data.location = {
                        lat: parseFloat(data.location.lat),
                        lng: parseFloat(data.location.lng)
                    };
                }
                
                // Parse numbers
                Object.keys(data).forEach(key => {
                    if (!isNaN(data[key]) && data[key] !== '') {
                        data[key] = parseFloat(data[key]);
                    }
                });
                
                // Validasi khusus untuk ODP - cek apakah ada ODC di sektor yang sama
                if (entityType === 'ODP') {
                    const region = data.kodeWilayah;
                    const sector = data.kodeSektor;
                    
                    if (region && sector) {
                        const matchingODC = dataCache.ODC.find(odc => 
                            odc.kodeWilayah === region && odc.kodeSektor === sector
                        );
                        
                        if (!matchingODC) {
                            throw new Error(`Tidak ada ODC dengan wilayah ${region} dan sektor ${sector}. Tidak dapat menambah ODP di sektor ini.`);
                        }
                    }
                }
                
                // Validasi khusus untuk Pelanggan - cek port ODP
                if (entityType === 'Pelanggan') {
                    const odpId = data.odpRef;
                    const port = data.odpPort;
                    
                    if (odpId && port) {
                        const odp = dataCache.ODP.find(o => o.id === odpId);
                        const capacity = getOdpCapacity(odp);
                        
                        if (port > capacity.total) {
                            throw new Error(`Port ${port} melebihi kapasitas ODP (${capacity.total})`);
                        }
                        
                        const existingCustomer = dataCache.Pelanggan.find(p => 
                            p.odpRef === odpId && p.odpPort === port && p.id !== entityId
                        );
                        
                        if (existingCustomer) {
                            throw new Error(`Port ${port} pada ODP ini sudah terisi oleh pelanggan ${existingCustomer.name}`);
                        }
                    }
                }
                
                // Validasi khusus untuk ODC - cek slot dan port OLT
                if (entityType === 'ODC') {
                    const oltId = data.oltRef;
                    const slot = data.oltSlot;
                    const port = data.oltPort;
                    
                    if (oltId && slot && port) {
                        const olt = dataCache.OLT.find(o => o.id === oltId);
                        
                        if (olt) {
                            // Validasi slot tidak melebihi total slot
                            if (slot > (olt.totalSlots || 0)) {
                                throw new Error(`Slot ${slot} melebihi total slot OLT (${olt.totalSlots || 0})`);
                            }
                            
                            // Validasi port tidak melebihi total port
                            if (port > (olt.totalPorts || 0)) {
                                throw new Error(`Port ${port} melebihi total port OLT (${olt.totalPorts || 0})`);
                            }
                            
                            // Validasi slot dan port tidak sudah digunakan
                            const existingODC = dataCache.ODC.find(odc => 
                                odc.oltRef === oltId && 
                                odc.oltSlot == slot && 
                                odc.oltPort == port && 
                                odc.id !== entityId
                            );
                            
                            if (existingODC) {
                                throw new Error(`Slot ${slot} Port ${port} pada OLT ini sudah digunakan oleh ODC ${existingODC.namaODC}`);
                            }
                        }
                    }
                }
                
                // Validasi khusus untuk ODP - cek port ODC
                if (entityType === 'ODP') {
                    const odcId = data.odcRef;
                    const portFeeder = data.portFeeder;
                    
                    if (odcId && portFeeder) {
                        const odc = dataCache.ODC.find(o => o.id === odcId);
                        
                        if (odc) {
                            // Validasi port feeder tidak melebihi kapasitas ODC
                            if (portFeeder > (odc.capacity || 0)) {
                                throw new Error(`Port Feeder ${portFeeder} melebihi kapasitas ODC (${odc.capacity || 0})`);
                            }
                            
                            // Validasi port feeder tidak sudah digunakan
                            const existingODP = dataCache.ODP.find(odp => 
                                odp.odcRef === odcId && 
                                odp.portFeeder == portFeeder && 
                                odp.id !== entityId
                            );
                            
                            if (existingODP) {
                                throw new Error(`Port Feeder ${portFeeder} pada ODC ini sudah digunakan oleh ODP ${existingODP.namaODP}`);
                            }
                        }
                    }
                }
                
                // Tambah timestamp dan user info
                data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                data.updatedBy = currentUser.email;
                
                if (isOnline) {
                    if (entityId) {
                        // Update existing document
                        await db.collection(entityType).doc(entityId).update(data);
                        showToast(`${entityType} berhasil diperbarui`, 'success');
                    } else {
                        // Add new document
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        data.createdBy = currentUser.email;
                        await db.collection(entityType).add(data);
                        showToast(`${entityType} berhasil ditambahkan`, 'success');
                    }
                    
                    // Log audit
                    await logAudit(entityId ? 'update' : 'create', entityType, entityId || 'new', data);
                    
                    // Reload data
                    await loadDataFromFirestore(entityType);
                } else {
                    // NEW: Enhanced offline mode - save to queue
                    if (entityId) {
                        offlineQueue.push({
                            action: 'update',
                            entityType: entityType,
                            entityId: entityId,
                            data: data,
                            timestamp: new Date().getTime()
                        });
                        showToast('Perubahan disimpan dalam antrian offline', 'warning');
                    } else {
                        data.createdAt = new Date();
                        data.createdBy = currentUser.email;
                        offlineQueue.push({
                            action: 'create',
                            entityType: entityType,
                            data: data,
                            timestamp: new Date().getTime()
                        });
                        showToast('Data baru disimpan dalam antrian offline', 'warning');
                    }
                    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                    updateOfflineQueueUI();
                }
                
                // Refresh UI jika di halaman tabel
                if ($('table-title').dataset.entity === entityType) {
                    renderTable(entityType, dataCache[entityType]);
                }
                
                // Refresh peta jika entity memiliki lokasi
                if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                    renderMarkers(entityType, dataCache[entityType]);
                }
                
                // Update dashboard stats
                updateDashboardStats();
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
                // Tutup modal
                formModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving entity:', error);
                showToast(`Gagal menyimpan ${entityType}: ${error.message}`, 'error');
            } finally {
                // Reset loading state
                submitText.textContent = 'Simpan';
                submitSpinner.classList.add('hidden');
                submitButton.disabled = false;
            }
        }

        async function updateInventoryStock(type, name, quantity) {
            try {
                // Find the inventory item
                const inventoryItem = dataCache.Inventory.find(item => 
                    item.type === type && item.name === name
                );
                
                if (inventoryItem) {
                    // Update stock
                    const newStock = (inventoryItem.currentStock || 0) + quantity;
                    
                    if (isOnline) {
                        await db.collection('Inventory').doc(inventoryItem.id).update({
                            currentStock: newStock,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedBy: currentUser.email
                        });
                    } else {
                        // NEW: Enhanced offline mode - add to queue
                        offlineQueue.push({
                            action: 'update',
                            entityType: 'Inventory',
                            entityId: inventoryItem.id,
                            data: {
                                currentStock: newStock,
                                updatedAt: new Date(),
                                updatedBy: currentUser.email
                            },
                            timestamp: new Date().getTime()
                        });
                        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                        updateOfflineQueueUI();
                    }
                    
                    // Update cache
                    inventoryItem.currentStock = newStock;
                    
                    // Refresh inventory list
                    renderInventoryList();
                    
                    showToast(`Stok ${name} diperbarui: ${newStock}`, 'success');
                }
            } catch (error) {
                console.error('Error updating inventory stock:', error);
                showToast('Gagal memperbarui stok inventory', 'error');
            }
        }

        async function deleteEntity(entityType, entityId) {
            if (!confirm(`Apakah Anda yakin ingin menghapus ${entityType} ini?`)) return;
            
            // Cek jika user adalah demo dan mencoba menghapus karyawan
            if (entityType === 'Karyawan' && currentUser && currentUser.email === 'demo@ftth.com') {
                showToast('Akun demo tidak dapat menghapus karyawan', 'error');
                return;
            }
            
            try {
                if (isOnline) {
                    await db.collection(entityType).doc(entityId).delete();
                    showToast(`${entityType} berhasil dihapus`, 'success');
                    
                    // Log audit
                    await logAudit('delete', entityType, entityId, {});
                    
                    // Reload data
                    await loadDataFromFirestore(entityType);
                } else {
                    // NEW: Enhanced offline mode - add to delete queue
                    offlineQueue.push({
                        action: 'delete',
                        entityType: entityType,
                        entityId: entityId,
                        timestamp: new Date().getTime()
                    });
                    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                    
                    // Remove from local cache immediately for better UX
                    dataCache[entityType] = dataCache[entityType].filter(item => item.id !== entityId);
                    
                    updateOfflineQueueUI();
                    showToast('Data dihapus dari cache lokal, akan dihapus dari server saat online', 'warning');
                }
                
                // Refresh UI jika di halaman tabel
                if ($('table-title').dataset.entity === entityType) {
                    renderTable(entityType, dataCache[entityType]);
                }
                
                // Refresh peta jika entity memiliki lokasi
                if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                    renderMarkers(entityType, dataCache[entityType]);
                }
                
                // Update dashboard stats
                updateDashboardStats();
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
            } catch (error) {
                console.error('Error deleting entity:', error);
                showToast(`Gagal menghapus ${entityType}`, 'error');
            }
        }

        async function logAudit(action, entityType, entityId, details) {
            try {
                if (!isOnline) return; // Skip audit logging in offline mode
                
                // Cek jumlah audit log yang ada
                const snapshot = await db.collection('AuditLog').get();
                const logCount = snapshot.size;
                
                // Jika sudah mencapai 1000, hapus yang paling lama
                if (logCount >= 1000) {
                    const oldestLogs = snapshot.docs
                        .sort((a, b) => new Date(a.data().timestamp) - new Date(b.data().timestamp))
                        .slice(0, logCount - 999); // Hapus cukup untuk membuat ruang
                    
                    const batch = db.batch();
                    oldestLogs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }
                
                // Tambah log baru
                await db.collection('AuditLog').add({
                    userEmail: currentUser.email,
                    action: action,
                    entityType: entityType,
                    entityId: entityId,
                    details: details,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Reload audit log data
                await loadDataFromFirestore('AuditLog');
            } catch (error) {
                console.error('Error logging audit:', error);
            }
        }

        // --- 8. Export & Import ---

        $('export-button').addEventListener('click', () => {
            const entityType = $('table-title').dataset.entity;
            if (!entityType) {
                showToast('Pilih halaman tabel terlebih dahulu', 'warning');
                return;
            }
            
            exportData(entityType);
        });

        function exportData(entityType) {
            try {
                const data = dataCache[entityType];
                if (!data || data.length === 0) {
                    showToast(`Tidak ada data ${entityType} untuk diekspor`, 'warning');
                    return;
                }
                
                // Prepare data for export
                const exportData = data.map(item => {
                    const exportItem = { ...item };
                    delete exportItem.id; // Remove document ID
                    return exportItem;
                });
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, entityType);
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `${entityType}_${timestamp}.xlsx`;
                
                // Write file
                XLSX.writeFile(wb, filename);
                
                showToast(`Data ${entityType} berhasil diekspor`, 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast(`Gagal mengekspor data ${entityType}`, 'error');
            }
        }

        async function processImport() {
            const fileInput = $('import-file');
            const entityTypeSelect = $('import-entity-type');
            const file = fileInput.files[0];
            const entityType = entityTypeSelect.value;
            
            if (!file) {
                showToast('Pilih file untuk diimport', 'warning');
                return;
            }
            
            if (!entityType) {
                showToast('Pilih jenis entitas', 'warning');
                return;
            }
            
            try {
                const data = await readImportFile(file);
                
                if (!data || data.length === 0) {
                    showToast('File tidak mengandung data yang valid', 'warning');
                    return;
                }
                
                // Show confirmation dialog
                const confirmed = confirm(`Apakah Anda yakin ingin mengimport ${data.length} data ${entityType}?`);
                if (!confirmed) return;
                
                // Process import
                let successCount = 0;
                let errorCount = 0;
                
                for (const item of data) {
                    try {
                        // Add metadata
                        item.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        item.createdBy = currentUser.email;
                        
                        if (isOnline) {
                            await db.collection(entityType).add(item);
                        } else {
                            // NEW: Enhanced offline mode - save to queue
                            offlineQueue.push({
                                action: 'create',
                                entityType: entityType,
                                data: item,
                                timestamp: new Date().getTime()
                            });
                        }
                        successCount++;
                    } catch (error) {
                        console.error('Error importing item:', error);
                        errorCount++;
                    }
                }
                
                if (isOnline) {
                    // Reload data
                    await loadDataFromFirestore(entityType);
                    
                    // Refresh UI if on table page
                    if ($('table-title').dataset.entity === entityType) {
                        renderTable(entityType, dataCache[entityType]);
                    }
                    
                    // Refresh map if entity has location
                    if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                        renderMarkers(entityType, dataCache[entityType]);
                    }
                    
                    // Update dashboard stats
                    updateDashboardStats();
                    
                    // Show result
                    if (errorCount === 0) {
                        showToast(`Import ${successCount} data ${entityType} berhasil`, 'success');
                    } else {
                        showToast(`Import selesai: ${successCount} berhasil, ${errorCount} gagal`, 'warning');
                    }
                } else {
                    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                    updateOfflineQueueUI();
                    showToast(`Import ${successCount} data ${entityType} disimpan dalam antrian offline`, 'warning');
                }
                
                // Close modal
                importModal.classList.add('hidden');
                
                // Reset form
                fileInput.value = '';
                entityTypeSelect.value = '';
                
            } catch (error) {
                console.error('Error processing import:', error);
                showToast('Gagal memproses import', 'error');
            }
        }

        function readImportFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first worksheet
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('Gagal membaca file'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // --- 9. Offline Support & Sync ---

        function setupOfflineSync() {
            // Deteksi status online/offline
            window.addEventListener('online', () => {
                isOnline = true;
                updateOnlineStatusUI(true);
                processOfflineQueue();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateOnlineStatusUI(false);
            });
        }

        function updateOnlineStatusUI(online) {
            const offlineQueueCount = $('offline-queue-count');
            
            if (online) {
                onlineIndicator.classList.replace('bg-red-500', 'bg-green-500');
                onlineText.textContent = 'Online';
                offlineQueueCount.classList.add('hidden');
            } else {
                onlineIndicator.classList.replace('bg-green-500', 'bg-red-500');
                onlineText.textContent = 'Offline';
                if (offlineQueue.length > 0) {
                    offlineQueueCount.textContent = offlineQueue.length;
                    offlineQueueCount.classList.remove('hidden');
                }
            }
        }

        // NEW: Enhanced offline queue processing with progress
        async function processOfflineQueue() {
            if (offlineQueue.length === 0) return;
            
            const syncProgress = $('sync-progress');
            const syncProgressBar = $('sync-progress-bar');
            const syncStatus = $('sync-status');
            
            syncProgress.classList.remove('hidden');
            syncStatus.textContent = 'Menyinkronkan data...';
            
            let processed = 0;
            const total = offlineQueue.length;
            
            for (const item of [...offlineQueue]) { // Create a copy to avoid modification during iteration
                try {
                    if (item.action === 'create') {
                        await db.collection(item.entityType).add(item.data);
                    } else if (item.action === 'update') {
                        await db.collection(item.entityType).doc(item.entityId).update(item.data);
                    } else if (item.action === 'delete') {
                        await db.collection(item.entityType).doc(item.entityId).delete();
                    }
                    
                    // Remove from queue if successful
                    offlineQueue = offlineQueue.filter(i => i !== item);
                    processed++;
                    
                    // Update progress
                    const progress = (processed / total) * 100;
                    syncProgressBar.style.width = `${progress}%`;
                    syncStatus.textContent = `Menyinkronkan data... ${processed}/${total}`;
                    
                } catch (error) {
                    console.error('Error processing offline item:', error);
                    // Keep item in queue for retry
                }
            }
            
            // Save remaining queue
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            updateOfflineQueueUI();
            
            // Hide progress
            syncProgress.classList.add('hidden');
            
            if (offlineQueue.length === 0) {
                showToast('Sinkronisasi offline selesai', 'success');
                // Reload all data to ensure consistency
                await loadAllData();
            } else {
                showToast(`Sinkronisasi sebagian berhasil. ${offlineQueue.length} item gagal.`, 'warning');
            }
        }

        function updateOfflineQueueUI() {
            const queueCount = $('offline-queue-count');
            const queueList = $('offline-queue-list');
            
            if (offlineQueue.length > 0) {
                queueCount.textContent = offlineQueue.length;
                queueCount.classList.remove('hidden');
                
                // Update queue list
                queueList.innerHTML = '';
                offlineQueue.forEach((item, index) => {
                    const queueItem = document.createElement('div');
                    queueItem.className = 'offline-queue-item';
                    queueItem.innerHTML = `
                        <div class="font-medium">${item.action.toUpperCase()} ${item.entityType}</div>
                        <div class="text-xs text-gray-600">${new Date(item.timestamp).toLocaleString('id-ID')}</div>
                    `;
                    queueList.appendChild(queueItem);
                });
            } else {
                queueCount.classList.add('hidden');
                queueList.innerHTML = '<p class="text-gray-600">Tidak ada item dalam antrian.</p>';
            }
        }

        // --- 10. Settings Management ---

        function setupSettings() {
            // Load settings from localStorage
            loadSettings();
            
            // Setup settings event listeners
            setupSettingsEventListeners();
        }

        function loadSettings() {
            // Load settings from localStorage
            const savedSettings = localStorage.getItem('appSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
            
            // Apply settings to UI
            applySettings();
        }

        function applySettings() {
            // Apply auto-generate number setting
            if ($('auto-generate-number')) {
                $('auto-generate-number').checked = settings.autoGenerateNumber !== false;
            }
            
            // Apply number format
            if ($('number-format')) {
                $('number-format').value = settings.numberFormat || 'PLG-{YYYY}-{MM}-{SEQ}';
            }
            
            // Apply SN validation settings
            if ($('sn-validation')) {
                $('sn-validation').checked = settings.snValidation !== false;
            }
            
            if ($('sn-olt-format')) {
                $('sn-olt-format').value = settings.snOltFormat || '^[A-Z]{4}[0-9]{9}$';
            }
            
            if ($('sn-ont-format')) {
                $('sn-ont-format').value = settings.snOntFormat || '^ONT[A-Z0-9]{7}$';
            }
            
            // Apply dark mode if enabled
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
                if ($('dark-mode')) {
                    $('dark-mode').checked = true;
                }
            }
            
            // Apply session timeout settings
            if ($('session-timeout')) {
                $('session-timeout').value = settings.sessionTimeout || 15;
            }
            
            if ($('warning-timeout')) {
                $('warning-timeout').value = settings.warningTimeout || 13;
            }
        }

        function setupSettingsEventListeners() {
            // Auto-generate number toggle
            if ($('auto-generate-number')) {
                $('auto-generate-number').addEventListener('change', (e) => {
                    settings.autoGenerateNumber = e.target.checked;
                    saveSettings();
                });
            }
            
            // Number format input
            if ($('number-format')) {
                $('number-format').addEventListener('change', (e) => {
                    settings.numberFormat = e.target.value;
                    saveSettings();
                });
            }
            
            // SN validation toggle
            if ($('sn-validation')) {
                $('sn-validation').addEventListener('change', (e) => {
                    settings.snValidation = e.target.checked;
                    saveSettings();
                });
            }
            
            // SN format inputs
            if ($('sn-olt-format')) {
                $('sn-olt-format').addEventListener('change', (e) => {
                    settings.snOltFormat = e.target.value;
                    saveSettings();
                });
            }
            
            if ($('sn-ont-format')) {
                $('sn-ont-format').addEventListener('change', (e) => {
                    settings.snOntFormat = e.target.value;
                    saveSettings();
                });
            }
            
            // Dark mode toggle
            if ($('dark-mode')) {
                $('dark-mode').addEventListener('change', (e) => {
                    settings.darkMode = e.target.checked;
                    saveSettings();
                    applySettings();
                });
            }
            
            // Session timeout settings
            if ($('save-session-settings')) {
                $('save-session-settings').addEventListener('click', () => {
                    settings.sessionTimeout = parseInt($('session-timeout').value) || 15;
                    settings.warningTimeout = parseInt($('warning-timeout').value) || 13;
                    saveSettings();
                    setupSessionManagement();
                    showToast('Pengaturan sesi berhasil disimpan', 'success');
                });
            }
            
            // Password change
            if ($('save-password')) {
                $('save-password').addEventListener('click', changePassword);
            }
        }

        function saveSettings() {
            localStorage.setItem('appSettings', JSON.stringify(settings));
        }

        async function changePassword() {
            const currentPassword = $('current-password').value;
            const newPassword = $('new-password').value;
            const confirmPassword = $('confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Semua field password harus diisi', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Password baru dan konfirmasi password tidak cocok', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Password baru harus minimal 6 karakter', 'error');
                return;
            }
            
            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Update password
                await currentUser.updatePassword(newPassword);
                
                showToast('Password berhasil diubah', 'success');
                
                // Clear password fields
                $('current-password').value = '';
                $('new-password').value = '';
                $('confirm-password').value = '';
                
            } catch (error) {
                console.error('Error changing password:', error);
                showToast('Gagal mengubah password: ' + error.message, 'error');
            }
        }

        // --- 11. Session Management ---

        function setupSessionManagement() {
            // Reset session timer on user activity
            document.addEventListener('mousemove', resetSessionTimer);
            document.addEventListener('keypress', resetSessionTimer);
            document.addEventListener('click', resetSessionTimer);
            document.addEventListener('scroll', resetSessionTimer);
            
            // Start session timer
            resetSessionTimer();
        }

        function resetSessionTimer() {
            // Clear existing timeouts
            clearTimeout(sessionTimeout);
            clearTimeout(warningTimeout);
            clearInterval(countdownInterval);
            
            // Hide warning modal
            sessionWarning.classList.add('hidden');
            
            // Set new timeouts
            const warningTime = (settings.warningTimeout || 13) * 60 * 1000; // Convert to milliseconds
            const sessionTime = (settings.sessionTimeout || 15) * 60 * 1000; // Convert to milliseconds
            
            warningTimeout = setTimeout(showSessionWarning, warningTime);
            sessionTimeout = setTimeout(logoutDueToInactivity, sessionTime);
        }

        function showSessionWarning() {
            sessionWarning.classList.remove('hidden');
            
            let timeLeft = (settings.sessionTimeout - settings.warningTimeout) * 60; // Convert to seconds
            $('session-countdown').textContent = formatTime(timeLeft);
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                $('session-countdown').textContent = formatTime(timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    logoutDueToInactivity();
                }
            }, 1000);
            
            // Setup warning modal buttons
            $('extend-session').addEventListener('click', resetSessionTimer);
            $('logout-now').addEventListener('click', () => {
                clearInterval(countdownInterval);
                auth.signOut();
            });
        }

        function logoutDueToInactivity() {
            showToast('Sesi berakhir karena tidak ada aktivitas', 'warning');
            auth.signOut();
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // --- 12. Utility Functions ---

        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            $('current-time').textContent = now.toLocaleDateString('id-ID', options);
        }

        // Initialize the application
        console.log('FTTH Topology Center initialized successfully');
    </script>
</body>
</html>
