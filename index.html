<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Manajemen Jaringan Fiber Optik</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #475569;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            --border-color: #e2e8f0;
            --sidebar-width: 260px;
            --navbar-height: 60px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--dark-color);
            background-color: var(--light-color);
            overflow-x: hidden;
        }
        
        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Navbar */
        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--navbar-height);
            padding: 0 20px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .navbar-brand i {
            font-size: 24px;
        }
        
        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .online-status {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .online-status.online {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        
        .online-status.offline {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        
        .online-status i {
            font-size: 10px;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 500;
        }
        
        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            width: 200px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            display: none;
        }
        
        .user-dropdown.active {
            display: block;
        }
        
        .user-dropdown-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .user-dropdown-item:hover {
            background-color: var(--light-color);
        }
        
        .user-dropdown-item i {
            width: 20px;
            color: var(--secondary-color);
        }
        
        .user-dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 5px 0;
        }
        
        /* Main Content Area */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            transition: transform 0.3s;
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
            position: absolute;
            height: 100%;
            z-index: 999;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            z-index: 998;
            font-size: 18px;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-menu {
            padding: 10px 0;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--secondary-color);
        }
        
        .sidebar-item:hover {
            background-color: var(--light-color);
        }
        
        .sidebar-item.active {
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
            border-left: 3px solid var(--primary-color);
        }
        
        .sidebar-item i {
            width: 20px;
            font-size: 18px;
        }
        
        /* Content Area */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-header {
            padding: 20px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
        }
        
        .content-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .content-subtitle {
            color: var(--secondary-color);
            font-size: 14px;
        }
        
        .content-body {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--secondary-color);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab:hover {
            color: var(--primary-color);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
            height: 100%;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Map Container */
        .map-container {
            height: 100%;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-control {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 10px;
            width: 200px;
        }
        
        .map-control-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .map-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .legend-icon i {
            font-size: 16px;
        }
        
        .map-filters {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-label {
            font-size: 12px;
            font-weight: 500;
        }
        
        .filter-select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
        }
        
        .floating-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            z-index: 500;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Table Container */
        .table-container {
            padding: 20px;
            overflow: auto;
            height: 100%;
        }
        
        .table-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .btn-secondary {
            background-color: white;
            color: var(--secondary-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--light-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .data-table th {
            background-color: var(--light-color);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        .data-table tr:hover {
            background-color: rgba(37, 99, 235, 0.05);
        }
        
        .table-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .pagination-info {
            color: var(--secondary-color);
            font-size: 14px;
        }
        
        .pagination-controls {
            display: flex;
            gap: 5px;
        }
        
        .pagination-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background-color: white;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover {
            background-color: var(--light-color);
        }
        
        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        
        .modal.active .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--light-color);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background-color: var(--border-color);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-label.required::after {
            content: " *";
            color: var(--danger-color);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-hint {
            margin-top: 5px;
            font-size: 12px;
            color: var(--secondary-color);
        }
        
        .form-error {
            margin-top: 5px;
            font-size: 12px;
            color: var(--danger-color);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .gps-capture {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--light-color);
            border-radius: 6px;
            margin-top: 5px;
        }
        
        .gps-status {
            flex: 1;
            font-size: 12px;
        }
        
        .gps-status.success {
            color: var(--success-color);
        }
        
        .gps-status.error {
            color: var(--danger-color);
        }
        
        .gps-status.waiting {
            color: var(--warning-color);
        }
        
        /* Photo Upload */
        .photo-upload {
            margin-top: 10px;
        }
        
        .photo-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            background-color: var(--light-color);
        }
        
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: var(--secondary-color);
        }
        
        .photo-placeholder i {
            font-size: 32px;
        }
        
        .photo-input {
            display: none;
        }
        
        /* Slide Over */
        .slide-over {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100%;
            background-color: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1500;
            transform: translateX(100%);
            transition: transform 0.3s;
            overflow-y: auto;
        }
        
        .slide-over.active {
            transform: translateX(0);
        }
        
        .slide-over-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .slide-over-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .slide-over-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--light-color);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            transition: all 0.2s;
        }
        
        .slide-over-close:hover {
            background-color: var(--border-color);
        }
        
        .slide-over-body {
            padding: 20px;
        }
        
        .detail-section {
            margin-bottom: 25px;
        }
        
        .detail-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-item {
            display: flex;
            margin-bottom: 10px;
        }
        
        .detail-label {
            width: 120px;
            font-weight: 500;
            color: var(--secondary-color);
        }
        
        .detail-value {
            flex: 1;
        }
        
        .detail-photo {
            width: 100%;
            height: 200px;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .detail-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Capacity Indicator */
        .capacity-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .capacity-bar {
            flex: 1;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .capacity-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .capacity-fill.low {
            background-color: var(--success-color);
        }
        
        .capacity-fill.medium {
            background-color: var(--warning-color);
        }
        
        .capacity-fill.high {
            background-color: var(--danger-color);
        }
        
        .capacity-text {
            font-size: 12px;
            font-weight: 500;
            min-width: 50px;
            text-align: right;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-badge.active {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        
        .status-badge.inactive {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        
        .status-badge.pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px;
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast.success .toast-icon {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
        }
        
        .toast.error .toast-icon {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }
        
        .toast.warning .toast-icon {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning-color);
        }
        
        .toast.info .toast-icon {
            background-color: rgba(37, 99, 235, 0.2);
            color: var(--primary-color);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 14px;
            color: var(--secondary-color);
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 18px;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .login-card {
            width: 100%;
            max-width: 400px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .login-header {
            padding: 30px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
        }
        
        .login-logo {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .login-subtitle {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .login-footer {
            padding: 20px 30px;
            background-color: var(--light-color);
            text-align: center;
            font-size: 14px;
            color: var(--secondary-color);
        }
        
        .login-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100%;
                z-index: 999;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .search-box {
                width: 100%;
            }
            
            .table-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                justify-content: space-between;
            }
            
            .slide-over {
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .modal-content {
                width: 95%;
                max-height: 95vh;
            }
            
            .map-controls {
                right: 10px;
                top: 10px;
            }
            
            .map-control {
                width: 160px;
            }
        }
        
        /* Print Styles */
        @media print {
            .navbar, .sidebar, .tabs, .map-controls, .floating-button, .action-buttons, .pagination-controls {
                display: none !important;
            }
            
            .content {
                margin: 0;
            }
            
            .data-table {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-network-wired"></i>
                </div>
                <h1 class="login-title">Dnt Network Topology</h1>
                <p class="login-subtitle">Sistem Manajemen Jaringan Fiber Optik</p>
            </div>
            <div class="login-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label required">Email</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="email@contoh.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Password</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <span id="loginButtonText">Masuk</span>
                        <div id="loginSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
            </div>
            <div class="login-footer">
                <p>Belum punya akun? <a href="#" class="login-link" id="showRegisterForm">Daftar</a></p>
                <p style="margin-top: 10px;"><a href="#" class="login-link" id="showResetForm">Lupa password?</a></p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-brand">
                <i class="fas fa-network-wired"></i>
                <span>FTTH Topology Center</span>
            </div>
            <div class="navbar-actions">
                <div id="onlineStatus" class="online-status online">
                    <i class="fas fa-circle"></i>
                    <span>Online</span>
                </div>
                <div class="user-menu">
                    <div id="userAvatar" class="user-avatar">U</div>
                    <div id="userDropdown" class="user-dropdown">
                        <div class="user-dropdown-item">
                            <i class="fas fa-user"></i>
                            <span id="userName">User</span>
                        </div>
                        <div class="user-dropdown-item">
                            <i class="fas fa-shield-alt"></i>
                            <span id="userRole">Role</span>
                        </div>
                        <div class="user-dropdown-divider"></div>
                        <div class="user-dropdown-item" id="settingsBtn">
                            <i class="fas fa-cog"></i>
                            <span>Pengaturan</span>
                        </div>
                        <div class="user-dropdown-item" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Keluar</span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h3>Menu Navigasi</h3>
                </div>
                <div class="sidebar-menu">
                    <div class="sidebar-item active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="sidebar-item" data-page="olt">
                        <i class="fas fa-server"></i>
                        <span>OLT</span>
                    </div>
                    <div class="sidebar-item" data-page="odc">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>ODC</span>
                    </div>
                    <div class="sidebar-item" data-page="feeder">
                        <i class="fas fa-project-diagram"></i>
                        <span>Feeder Panel</span>
                    </div>
                    <div class="sidebar-item" data-page="distrib">
                        <i class="fas fa-sitemap"></i>
                        <span>Distribusi Panel</span>
                    </div>
                    <div class="sidebar-item" data-page="odp">
                        <i class="fas fa-ethernet"></i>
                        <span>ODP</span>
                    </div>
                    <div class="sidebar-item" data-page="pelanggan">
                        <i class="fas fa-users"></i>
                        <span>Pelanggan</span>
                    </div>
                    <div class="sidebar-item" data-page="material">
                        <i class="fas fa-boxes"></i>
                        <span>Material</span>
                    </div>
                    <div class="sidebar-item" data-page="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Laporan</span>
                    </div>
                    <div class="sidebar-item" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>Pengaturan</span>
                    </div>
                </div>
            </aside>

            <!-- Sidebar Toggle Button -->
            <button id="sidebarToggle" class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>

            <!-- Content Area -->
            <div class="content">
                <!-- Content Header -->
                <div class="content-header">
                    <h1 class="content-title" id="pageTitle">Dashboard</h1>
                    <p class="content-subtitle" id="pageSubtitle">Ringkasan jaringan FTTH</p>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" data-tab="map">
                        <i class="fas fa-map"></i>
                        <span>Peta</span>
                    </div>
                    <div class="tab" data-tab="table">
                        <i class="fas fa-table"></i>
                        <span>Tabel</span>
                    </div>
                    <div class="tab" data-tab="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Laporan</span>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="content-body">
                    <!-- Map Tab -->
                    <div id="mapTab" class="tab-content active">
                        <div class="map-container">
                            <div id="map"></div>
                            <div class="map-controls">
                                <div class="map-control">
                                    <div class="map-control-title">Legenda</div>
                                    <div class="map-legend">
                                        <div class="legend-item">
                                            <div class="legend-icon" style="color: #ef4444;">
                                                <i class="fas fa-diamond"></i>
                                            </div>
                                            <span>OLT</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-icon" style="color: #3b82f6;">
                                                <i class="fas fa-square"></i>
                                            </div>
                                            <span>ODC</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-icon" style="color: #8b5cf6;">
                                                <i class="fas fa-map-pin"></i>
                                            </div>
                                            <span>Feeder</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-icon" style="color: #f97316;">
                                                <i class="fas fa-hexagon"></i>
                                            </div>
                                            <span>Distribusi</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-icon" style="color: #f59e0b;">
                                                <i class="fas fa-circle"></i>
                                            </div>
                                            <span>ODP</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-icon" style="color: #10b981;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <span>Pelanggan</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="map-control">
                                    <div class="map-control-title">Filter</div>
                                    <div class="map-filters">
                                        <div class="filter-group">
                                            <label class="filter-label">Tampilkan</label>
                                            <select id="mapFilter" class="filter-select">
                                                <option value="all">Semua</option>
                                                <option value="olt">OLT</option>
                                                <option value="odc">ODC</option>
                                                <option value="feeder">Feeder</option>
                                                <option value="distrib">Distribusi</option>
                                                <option value="odp">ODP</option>
                                                <option value="pelanggan">Pelanggan</option>
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label class="filter-label">Kapasitas ODP</label>
                                            <select id="capacityFilter" class="filter-select">
                                                <option value="all">Semua</option>
                                                <option value="available">Tersedia (>50%)</option>
                                                <option value="medium">Sedang (25-50%)</option>
                                                <option value="full">Penuh (<25%)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button id="addEntityBtn" class="floating-button">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Table Tab -->
                    <div id="tableTab" class="tab-content">
                        <div class="table-container">
                            <div class="table-actions">
                                <div class="search-box">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" id="tableSearch" class="search-input" placeholder="Cari...">
                                </div>
                                <div class="action-buttons">
                                    <button id="exportBtn" class="btn btn-secondary">
                                        <i class="fas fa-download"></i>
                                        <span>Export</span>
                                    </button>
                                    <button id="addTableBtn" class="btn btn-primary">
                                        <i class="fas fa-plus"></i>
                                        <span>Tambah</span>
                                    </button>
                                </div>
                            </div>
                            <div id="tableContent">
                                <!-- Table will be dynamically generated -->
                            </div>
                            <div class="table-pagination">
                                <div class="pagination-info">
                                    Menampilkan <span id="startRecord">1</span> - <span id="endRecord">10</span> dari <span id="totalRecords">0</span> data
                                </div>
                                <div class="pagination-controls" id="paginationControls">
                                    <!-- Pagination buttons will be dynamically generated -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div id="reportsTab" class="tab-content">
                        <div class="table-container">
                            <div class="table-actions">
                                <div class="action-buttons">
                                    <button id="generateReportBtn" class="btn btn-primary">
                                        <i class="fas fa-file-alt"></i>
                                        <span>Generate Laporan</span>
                                    </button>
                                </div>
                            </div>
                            <div id="reportsContent">
                                <!-- Reports content will be dynamically generated -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Modal Title</h2>
                <button id="modalClose" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be dynamically generated -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <!-- Modal footer will be dynamically generated -->
            </div>
        </div>
    </div>

    <!-- Slide Over -->
    <div id="slideOver" class="slide-over">
        <div class="slide-over-header">
            <h2 class="slide-over-title" id="slideOverTitle">Detail</h2>
            <button id="slideOverClose" class="slide-over-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="slide-over-body" id="slideOverBody">
            <!-- Slide over content will be dynamically generated -->
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container">
        <!-- Toast notifications will be dynamically added here -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
            authDomain: "dnt-network-7.firebaseapp.com",
            projectId: "dnt-network-7",
            storageBucket: "dnt-network-7.firebasestorage.app",
            messagingSenderId: "761179668371",
            appId: "1:761179668371:web:7d1468d0298041d4783266",
            measurementId: "G-CD3EQ350R4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global Variables
        let map;
        let markers = {};
        let polylines = {};
        let currentPage = 'dashboard';
        let currentTab = 'map';
        let currentUser = null;
        let userData = null;
        let offlineQueue = [];
        let isOnline = navigator.onLine;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkAuthState();
        });

        // Initialize App
        function initializeApp() {
            // Check online status
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();

            // Load offline queue from localStorage
            const savedQueue = localStorage.getItem('offlineQueue');
            if (savedQueue) {
                offlineQueue = JSON.parse(savedQueue);
            }

            // Initialize map when page loads
            setTimeout(() => {
                if (document.getElementById('map')) {
                    initializeMap();
                }
            }, 100);
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // User dropdown
            document.getElementById('userAvatar').addEventListener('click', function() {
                document.getElementById('userDropdown').classList.toggle('active');
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });

            // Sidebar menu items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    navigateToPage(page);
                });
            });

            // Tab items
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // Modal close
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });

            // Slide over close
            document.getElementById('slideOverClose').addEventListener('click', closeSlideOver);

            // Add entity button
            document.getElementById('addEntityBtn').addEventListener('click', function() {
                openAddEntityModal();
            });

            // Add table button
            document.getElementById('addTableBtn').addEventListener('click', function() {
                openAddEntityModal();
            });

            // Export button
            document.getElementById('exportBtn').addEventListener('click', handleExport);

            // Generate report button
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);

            // Table search
            document.getElementById('tableSearch').addEventListener('input', function() {
                filterTable(this.value);
            });

            // Map filters
            document.getElementById('mapFilter').addEventListener('change', function() {
                filterMap(this.value, document.getElementById('capacityFilter').value);
            });

            document.getElementById('capacityFilter').addEventListener('change', function() {
                filterMap(document.getElementById('mapFilter').value, this.value);
            });

            // Settings button
            document.getElementById('settingsBtn').addEventListener('click', function() {
                navigateToPage('settings');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-menu')) {
                    document.getElementById('userDropdown').classList.remove('active');
                }
            });
        }

        // Check Authentication State
        function checkAuthState() {
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    showApp();
                } else {
                    hideApp();
                }
            });
        }

        // Load User Data
        function loadUserData(userId) {
            db.collection('users').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        userData = doc.data();
                        updateUserUI();
                    } else {
                        // If user document doesn't exist, create it
                        const defaultUserData = {
                            uid: userId,
                            email: currentUser.email,
                            name: currentUser.displayName || currentUser.email.split('@')[0],
                            role: 'Viewer', // Default role
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        db.collection('users').doc(userId).set(defaultUserData)
                            .then(() => {
                                userData = defaultUserData;
                                updateUserUI();
                            })
                            .catch(error => {
                                console.error('Error creating user document:', error);
                                showToast('error', 'Error', 'Gagal membuat data pengguna');
                            });
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    showToast('error', 'Error', 'Gagal memuat data pengguna');
                });
        }

        // Update User UI
        function updateUserUI() {
            if (userData) {
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userRole').textContent = userData.role;
                document.getElementById('userAvatar').textContent = userData.name.charAt(0).toUpperCase();
            }
        }

        // Show App
        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            
            // Initialize map if not already initialized
            if (!map) {
                setTimeout(initializeMap, 100);
            }
            
            // Load initial data
            loadDashboardData();
        }

        // Hide App
        function hideApp() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        // Handle Login
        function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Show loading state
            document.getElementById('loginButtonText').style.display = 'none';
            document.getElementById('loginSpinner').style.display = 'inline-block';
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showToast('success', 'Berhasil', 'Login berhasil');
                })
                .catch(error => {
                    console.error('Login error:', error);
                    showToast('error', 'Error', getErrorMessage(error));
                    
                    // Reset loading state
                    document.getElementById('loginButtonText').style.display = 'inline';
                    document.getElementById('loginSpinner').style.display = 'none';
                });
        }

        // Handle Logout
        function handleLogout() {
            auth.signOut()
                .then(() => {
                    showToast('info', 'Info', 'Anda telah keluar');
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    showToast('error', 'Error', 'Gagal keluar');
                });
        }

        // Get Error Message
        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                    return 'Pengguna tidak ditemukan';
                case 'auth/wrong-password':
                    return 'Password salah';
                case 'auth/email-already-in-use':
                    return 'Email sudah digunakan';
                case 'auth/weak-password':
                    return 'Password terlalu lemah';
                case 'auth/invalid-email':
                    return 'Email tidak valid';
                case 'auth/user-disabled':
                    return 'Akun dinonaktifkan';
                case 'auth/too-many-requests':
                    return 'Terlalu banyak percobaan login. Coba lagi nanti';
                default:
                    return error.message || 'Terjadi kesalahan';
            }
        }

        // Update Online Status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusElement = document.getElementById('onlineStatus');
            
            if (isOnline) {
                statusElement.classList.remove('offline');
                statusElement.classList.add('online');
                statusElement.innerHTML = '<i class="fas fa-circle"></i><span>Online</span>';
                
                // Process offline queue if online
                if (offlineQueue.length > 0) {
                    processOfflineQueue();
                }
            } else {
                statusElement.classList.remove('online');
                statusElement.classList.add('offline');
                statusElement.innerHTML = '<i class="fas fa-circle"></i><span>Offline</span>';
            }
        }

        // Navigate to Page
        function navigateToPage(page) {
            // Update active sidebar item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.sidebar-item[data-page="${page}"]`).classList.add('active');
            
            // Update page title
            const titles = {
                dashboard: { title: 'Dashboard', subtitle: 'Ringkasan jaringan FTTH' },
                olt: { title: 'OLT', subtitle: 'Manajemen Optical Line Terminal' },
                odc: { title: 'ODC', subtitle: 'Manajemen Optical Distribution Cabinet' },
                feeder: { title: 'Feeder Panel', subtitle: 'Manajemen Feeder Panel' },
                distrib: { title: 'Distribusi Panel', subtitle: 'Manajemen Panel Distribusi' },
                odp: { title: 'ODP', subtitle: 'Manajemen Optical Distribution Point' },
                pelanggan: { title: 'Pelanggan', subtitle: 'Manajemen Data Pelanggan' },
                material: { title: 'Material', subtitle: 'Manajemen Inventaris Material' },
                reports: { title: 'Laporan', subtitle: 'Laporan Jaringan FTTH' },
                settings: { title: 'Pengaturan', subtitle: 'Pengaturan Aplikasi' }
            };
            
            if (titles[page]) {
                document.getElementById('pageTitle').textContent = titles[page].title;
                document.getElementById('pageSubtitle').textContent = titles[page].subtitle;
            }
            
            // Update current page
            currentPage = page;
            
            // Load page data
            loadPageData(page);
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }

        // Load Page Data
        function loadPageData(page) {
            switch (page) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'olt':
                    loadOLTData();
                    break;
                case 'odc':
                    loadODCData();
                    break;
                case 'feeder':
                    loadFeederData();
                    break;
                case 'distrib':
                    loadDistribData();
                    break;
                case 'odp':
                    loadODPData();
                    break;
                case 'pelanggan':
                    loadPelangganData();
                    break;
                case 'material':
                    loadMaterialData();
                    break;
                case 'reports':
                    loadReportsData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }

        // Switch Tab
        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // Update current tab
            currentTab = tabName;
            
            // Refresh tab content
            if (tabName === 'map' && map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            } else if (tabName === 'table') {
                loadTableData();
            } else if (tabName === 'reports') {
                loadReportsData();
            }
        }

        // Initialize Map
        function initializeMap() {
            // Create map
            map = L.map('map').setView([-6.2088, 106.8456], 12); // Jakarta coordinates
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Load map data
            loadMapData();
        }

        // Load Map Data
        function loadMapData() {
            if (!map) return;
            
            // Clear existing markers and polylines
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            Object.values(polylines).forEach(polyline => map.removeLayer(polyline));
            markers = {};
            polylines = {};
            
            // Load OLT data
            db.collection('OLT').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const olt = { id: doc.id, ...doc.data() };
                        if (olt.location) {
                            addOLTMarker(olt);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading OLT data:', error);
                });
            
            // Load ODC data
            db.collection('ODC').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const odc = { id: doc.id, ...doc.data() };
                        if (odc.location) {
                            addODCMarker(odc);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading ODC data:', error);
                });
            
            // Load Feeder Panel data
            db.collection('FeederPanel').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const feeder = { id: doc.id, ...doc.data() };
                        if (feeder.location) {
                            addFeederMarker(feeder);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading Feeder Panel data:', error);
                });
            
            // Load Distrib Panel data
            db.collection('DistribPanel').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const distrib = { id: doc.id, ...doc.data() };
                        if (distrib.location) {
                            addDistribMarker(distrib);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading Distrib Panel data:', error);
                });
            
            // Load ODP data
            db.collection('ODP').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const odp = { id: doc.id, ...doc.data() };
                        if (odp.location) {
                            addODPMarker(odp);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading ODP data:', error);
                });
            
            // Load Pelanggan data
            db.collection('Pelanggan').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const pelanggan = { id: doc.id, ...doc.data() };
                        if (pelanggan.location) {
                            addPelangganMarker(pelanggan);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading Pelanggan data:', error);
                });
        }

        // Add OLT Marker
        function addOLTMarker(olt) {
            const icon = L.divIcon({
                html: '<i class="fas fa-diamond" style="color: #ef4444; font-size: 20px;"></i>',
                iconSize: [20, 20],
                className: 'custom-div-icon'
            });
            
            const marker = L.marker([olt.location.lat, olt.location.lng], { icon })
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #ef4444;">OLT: ${olt.name}</h3>
                        <p style="margin: 5px 0;"><strong>Kode:</strong> ${olt.code}</p>
                        <p style="margin: 5px 0;"><strong>Lokasi Rak:</strong> ${olt.rack_location}</p>
                        <p style="margin: 5px 0;"><strong>Model:</strong> ${olt.model}</p>
                        <p style="margin: 5px 0;"><strong>Total Slot:</strong> ${olt.total_slots}</p>
                        <p style="margin: 5px 0;"><strong>Port/Slot:</strong> ${olt.ports_per_slot}</p>
                        <button class="btn btn-primary btn-sm" onclick="showEntityDetail('OLT', '${olt.id}')">Detail</button>
                    </div>
                `);
            
            markers[`olt_${olt.id}`] = marker;
        }

        // Add ODC Marker
        function addODCMarker(odc) {
            const icon = L.divIcon({
                html: '<i class="fas fa-square" style="color: #3b82f6; font-size: 18px;"></i>',
                iconSize: [18, 18],
                className: 'custom-div-icon'
            });
            
            const marker = L.marker([odc.location.lat, odc.location.lng], { icon })
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #3b82f6;">ODC: ${odc.name}</h3>
                        <p style="margin: 5px 0;"><strong>Kode:</strong> ${odc.code}</p>
                        <p style="margin: 5px 0;"><strong>Alamat:</strong> ${odc.address}</p>
                        <p style="margin: 5px 0;"><strong>OLT:</strong> ${odc.oltRef || '-'}</p>
                        <button class="btn btn-primary btn-sm" onclick="showEntityDetail('ODC', '${odc.id}')">Detail</button>
                    </div>
                `);
            
            markers[`odc_${odc.id}`] = marker;
        }

        // Add Feeder Marker
        function addFeederMarker(feeder) {
            const icon = L.divIcon({
                html: '<i class="fas fa-map-pin" style="color: #8b5cf6; font-size: 18px;"></i>',
                iconSize: [18, 18],
                className: 'custom-div-icon'
            });
            
            const marker = L.marker([feeder.location.lat, feeder.location.lng], { icon })
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #8b5cf6;">Feeder Panel: ${feeder.name}</h3>
                        <p style="margin: 5px 0;"><strong>Kode:</strong> ${feeder.code}</p>
                        <p style="margin: 5px 0;"><strong>Total Port:</strong> ${feeder.total_ports}</p>
                        <button class="btn btn-primary btn-sm" onclick="showEntityDetail('FeederPanel', '${feeder.id}')">Detail</button>
                    </div>
                `);
            
            markers[`feeder_${feeder.id}`] = marker;
        }

        // Add Distrib Marker
        function addDistribMarker(distrib) {
            const icon = L.divIcon({
                html: '<i class="fas fa-hexagon" style="color: #f97316; font-size: 18px;"></i>',
                iconSize: [18, 18],
                className: 'custom-div-icon'
            });
            
            const marker = L.marker([distrib.location.lat, distrib.location.lng], { icon })
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #f97316;">Distribusi Panel: ${distrib.name}</h3>
                        <p style="margin: 5px 0;"><strong>Kode:</strong> ${distrib.code}</p>
                        <p style="margin: 5px 0;"><strong>Total Port:</strong> ${distrib.total_ports}</p>
                        <p style="margin: 5px 0;"><strong>Splitter:</strong> ${distrib.splitterType}</p>
                        <button class="btn btn-primary btn-sm" onclick="showEntityDetail('DistribPanel', '${distrib.id}')">Detail</button>
                    </div>
                `);
            
            markers[`distrib_${distrib.id}`] = marker;
        }

        // Add ODP Marker
        function addODPMarker(odp) {
            const capacityPercent = odp.totalPorts > 0 ? (odp.usedPorts / odp.totalPorts) * 100 : 0;
            let color = '#10b981'; // Green
            
            if (capacityPercent >= 75) {
                color = '#ef4444'; // Red
            } else if (capacityPercent >= 50) {
                color = '#f59e0b'; // Amber
            }
            
            const icon = L.divIcon({
                html: `<i class="fas fa-circle" style="color: ${color}; font-size: 16px;"></i>`,
                iconSize: [16, 16],
                className: 'custom-div-icon'
            });
            
            const marker = L.marker([odp.location.lat, odp.location.lng], { icon })
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: ${color};">ODP: ${odp.name}</h3>
                        <p style="margin: 5px 0;"><strong>Kode:</strong> ${odp.code}</p>
                        <p style="margin: 5px 0;"><strong>Total Port:</strong> ${odp.totalPorts}</p>
                        <p style="margin: 5px 0;"><strong>Port Terpakai:</strong> ${odp.usedPorts}</p>
                        <div style="margin: 10px 0;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; height: 8px; background-color: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${capacityPercent}%; background-color: ${color};"></div>
                                </div>
                                <span style="font-size: 12px; font-weight: 500;">${Math.round(capacityPercent)}%</span>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEntityDetail('ODP', '${odp.id}')">Detail</button>
                    </div>
                `);
            
            markers[`odp_${odp.id}`] = marker;
        }

        // Add Pelanggan Marker
        function addPelangganMarker(pelanggan) {
            const icon = L.divIcon({
                html: '<i class="fas fa-user" style="color: #10b981; font-size: 14px;"></i>',
                iconSize: [14, 14],
                className: 'custom-div-icon'
            });
            
            const marker = L.marker([pelanggan.location.lat, pelanggan.location.lng], { icon })
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #10b981;">Pelanggan: ${pelanggan.name}</h3>
                        <p style="margin: 5px 0;"><strong>No. Pelanggan:</strong> ${pelanggan.customerNumber}</p>
                        <p style="margin: 5px 0;"><strong>Alamat:</strong> ${pelanggan.address}</p>
                        <p style="margin: 5px 0;"><strong>ODP:</strong> ${pelanggan.odpRef || '-'}</p>
                        <p style="margin: 5px 0;"><strong>Port ODP:</strong> ${pelanggan.odpPort || '-'}</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> <span class="status-badge ${pelanggan.status}">${pelanggan.status}</span></p>
                        ${pelanggan.photoUrl ? `<img src="${pelanggan.photoUrl}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-top: 10px;">` : ''}
                        <button class="btn btn-primary btn-sm" onclick="showEntityDetail('Pelanggan', '${pelanggan.id}')" style="margin-top: 10px;">Detail</button>
                    </div>
                `);
            
            markers[`pelanggan_${pelanggan.id}`] = marker;
            
            // Draw connection line if ODP exists
            if (pelanggan.odpRef) {
                db.collection('ODP').doc(pelanggan.odpRef).get()
                    .then(doc => {
                        if (doc.exists) {
                            const odp = { id: doc.id, ...doc.data() };
                            if (odp.location) {
                                const polyline = L.polyline(
                                    [[pelanggan.location.lat, pelanggan.location.lng], [odp.location.lat, odp.location.lng]],
                                    { color: '#10b981', weight: 2, opacity: 0.7 }
                                ).addTo(map);
                                
                                polylines[`pelanggan_${pelanggan.id}_odp`] = polyline;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading ODP for connection:', error);
                    });
            }
        }

        // Filter Map
        function filterMap(entityType, capacityFilter) {
            // Show/hide markers based on filter
            Object.keys(markers).forEach(key => {
                const [type, id] = key.split('_');
                
                if (entityType === 'all') {
                    map.addLayer(markers[key]);
                } else if (type === entityType.toLowerCase()) {
                    map.addLayer(markers[key]);
                } else {
                    map.removeLayer(markers[key]);
                }
            });
            
            // Additional filtering for ODP capacity
            if (entityType === 'all' || entityType === 'odp') {
                Object.keys(markers).forEach(key => {
                    const [type, id] = key.split('_');
                    
                    if (type === 'odp') {
                        db.collection('ODP').doc(id).get()
                            .then(doc => {
                                if (doc.exists) {
                                    const odp = { id: doc.id, ...doc.data() };
                                    const capacityPercent = odp.totalPorts > 0 ? (odp.usedPorts / odp.totalPorts) * 100 : 0;
                                    
                                    let show = true;
                                    if (capacityFilter === 'available' && capacityPercent <= 50) {
                                        show = false;
                                    } else if (capacityFilter === 'medium' && (capacityPercent <= 25 || capacityPercent > 50)) {
                                        show = false;
                                    } else if (capacityFilter === 'full' && capacityPercent > 25) {
                                        show = false;
                                    }
                                    
                                    if (show) {
                                        map.addLayer(markers[key]);
                                    } else {
                                        map.removeLayer(markers[key]);
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error filtering ODP:', error);
                            });
                    }
                });
            }
        }

        // Load Dashboard Data
        function loadDashboardData() {
            // This would typically load summary data for the dashboard
            // For now, we'll just switch to the map tab
            switchTab('map');
        }

        // Load OLT Data
        function loadOLTData() {
            switchTab('table');
            loadTableData('OLT');
        }

        // Load ODC Data
        function loadODCData() {
            switchTab('table');
            loadTableData('ODC');
        }

        // Load Feeder Data
        function loadFeederData() {
            switchTab('table');
            loadTableData('FeederPanel');
        }

        // Load Distrib Data
        function loadDistribData() {
            switchTab('table');
            loadTableData('DistribPanel');
        }

        // Load ODP Data
        function loadODPData() {
            switchTab('table');
            loadTableData('ODP');
        }

        // Load Pelanggan Data
        function loadPelangganData() {
            switchTab('table');
            loadTableData('Pelanggan');
        }

        // Load Material Data
        function loadMaterialData() {
            switchTab('table');
            loadTableData('Material');
        }

        // Load Reports Data
        function loadReportsData() {
            switchTab('reports');
            
            const reportsContent = document.getElementById('reportsContent');
            reportsContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-top: 0; color: var(--primary-color);">Ringkasan Jaringan</h3>
                        <div style="margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Total OLT:</span>
                                <span id="reportTotalOLT">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Total ODC:</span>
                                <span id="reportTotalODC">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Total ODP:</span>
                                <span id="reportTotalODP">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Total Pelanggan:</span>
                                <span id="reportTotalPelanggan">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-top: 0; color: var(--primary-color);">Kapasitas ODP</h3>
                        <div style="margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Tersedia (>50%):</span>
                                <span id="reportODPAvailable">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Sedang (25-50%):</span>
                                <span id="reportODPMedium">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Penuh (<25%):</span>
                                <span id="reportODPFull">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-top: 0; color: var(--primary-color);">Material</h3>
                        <div style="margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Total Splitter:</span>
                                <span id="reportTotalSplitter">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Total Kabel:</span>
                                <span id="reportTotalCable">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Total Pigtail:</span>
                                <span id="reportTotalPigtail">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load report data
            db.collection('OLT').get()
                .then(snapshot => {
                    document.getElementById('reportTotalOLT').textContent = snapshot.size;
                })
                .catch(error => {
                    console.error('Error loading OLT report:', error);
                });
            
            db.collection('ODC').get()
                .then(snapshot => {
                    document.getElementById('reportTotalODC').textContent = snapshot.size;
                })
                .catch(error => {
                    console.error('Error loading ODC report:', error);
                });
            
            db.collection('ODP').get()
                .then(snapshot => {
                    document.getElementById('reportTotalODP').textContent = snapshot.size;
                    
                    let available = 0, medium = 0, full = 0;
                    snapshot.forEach(doc => {
                        const odp = doc.data();
                        const capacityPercent = odp.totalPorts > 0 ? (odp.usedPorts / odp.totalPorts) * 100 : 0;
                        
                        if (capacityPercent <= 50) {
                            available++;
                        } else if (capacityPercent <= 75) {
                            medium++;
                        } else {
                            full++;
                        }
                    });
                    
                    document.getElementById('reportODPAvailable').textContent = available;
                    document.getElementById('reportODPMedium').textContent = medium;
                    document.getElementById('reportODPFull').textContent = full;
                })
                .catch(error => {
                    console.error('Error loading ODP report:', error);
                });
            
            db.collection('Pelanggan').get()
                .then(snapshot => {
                    document.getElementById('reportTotalPelanggan').textContent = snapshot.size;
                })
                .catch(error => {
                    console.error('Error loading Pelanggan report:', error);
                });
            
            db.collection('Material').where('type', '==', 'splitter').get()
                .then(snapshot => {
                    let total = 0;
                    snapshot.forEach(doc => {
                        total += doc.data().quantity_onhand || 0;
                    });
                    document.getElementById('reportTotalSplitter').textContent = total;
                })
                .catch(error => {
                    console.error('Error loading Splitter report:', error);
                });
            
            db.collection('Material').where('type', '==', 'cable').get()
                .then(snapshot => {
                    let total = 0;
                    snapshot.forEach(doc => {
                        total += doc.data().quantity_onhand || 0;
                    });
                    document.getElementById('reportTotalCable').textContent = total;
                })
                .catch(error => {
                    console.error('Error loading Cable report:', error);
                });
            
            db.collection('Material').where('type', '==', 'pigtail').get()
                .then(snapshot => {
                    let total = 0;
                    snapshot.forEach(doc => {
                        total += doc.data().quantity_onhand || 0;
                    });
                    document.getElementById('reportTotalPigtail').textContent = total;
                })
                .catch(error => {
                    console.error('Error loading Pigtail report:', error);
                });
        }

        // Load Settings Data
        function loadSettingsData() {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');
            
            modalTitle.textContent = 'Pengaturan';
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Nama Pengguna</label>
                    <input type="text" id="settingsName" class="form-input" value="${userData ? userData.name : ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="settingsEmail" class="form-input" value="${currentUser ? currentUser.email : ''}" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Peran</label>
                    <select id="settingsRole" class="form-select" ${userData && userData.role === 'Admin' ? '' : 'disabled'}>
                        <option value="Viewer" ${userData && userData.role === 'Viewer' ? 'selected' : ''}>Viewer</option>
                        <option value="Technician" ${userData && userData.role === 'Technician' ? 'selected' : ''}>Technician</option>
                        <option value="Planner" ${userData && userData.role === 'Planner' ? 'selected' : ''}>Planner</option>
                        <option value="Admin" ${userData && userData.role === 'Admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Batas Akurasi GPS (meter)</label>
                    <input type="number" id="settingsGPSAccuracy" class="form-input" value="20">
                </div>
                <div class="form-group">
                    <label class="form-label">Batas Jarak ODP ke Pelanggan (meter)</label>
                    <input type="number" id="settingsODPDistance" class="form-input" value="100">
                </div>
            `;
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Batal</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">Simpan</button>
            `;
            
            openModal();
        }

        // Save Settings
        function saveSettings() {
            const name = document.getElementById('settingsName').value;
            const role = document.getElementById('settingsRole').value;
            const gpsAccuracy = document.getElementById('settingsGPSAccuracy').value;
            const odpDistance = document.getElementById('settingsODPDistance').value;
            
            // Update user profile
            currentUser.updateProfile({
                displayName: name
            })
                .then(() => {
                    // Update user document in Firestore
                    return db.collection('users').doc(currentUser.uid).update({
                        name: name,
                        role: role,
                        gpsAccuracyThreshold: parseInt(gpsAccuracy),
                        odpDistanceThreshold: parseInt(odpDistance),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    // Update local user data
                    userData.name = name;
                    userData.role = role;
                    userData.gpsAccuracyThreshold = parseInt(gpsAccuracy);
                    userData.odpDistanceThreshold = parseInt(odpDistance);
                    
                    updateUserUI();
                    closeModal();
                    showToast('success', 'Berhasil', 'Pengaturan berhasil disimpan');
                })
                .catch(error => {
                    console.error('Error saving settings:', error);
                    showToast('error', 'Error', 'Gagal menyimpan pengaturan');
                });
        }

        // Load Table Data
        function loadTableData(collection) {
            const tableContent = document.getElementById('tableContent');
            
            // Show loading
            tableContent.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';
            
            // Determine which collection to load
            const collectionName = collection || getCurrentCollection();
            
            db.collection(collectionName).get()
                .then(snapshot => {
                    let html = `
                        <table class="data-table">
                            <thead>
                                <tr>
                    `;
                    
                    // Generate table headers based on collection
                    const headers = getTableHeaders(collectionName);
                    headers.forEach(header => {
                        html += `<th>${header}</th>`;
                    });
                    
                    html += `
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // Generate table rows
                    snapshot.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        html += generateTableRow(collectionName, data);
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    tableContent.innerHTML = html;
                    
                    // Update pagination info
                    document.getElementById('startRecord').textContent = '1';
                    document.getElementById('endRecord').textContent = snapshot.size;
                    document.getElementById('totalRecords').textContent = snapshot.size;
                })
                .catch(error => {
                    console.error(`Error loading ${collectionName} data:`, error);
                    tableContent.innerHTML = `<p style="text-align: center; color: var(--danger-color);">Gagal memuat data: ${error.message}</p>`;
                });
        }

        // Get Current Collection
        function getCurrentCollection() {
            switch (currentPage) {
                case 'olt': return 'OLT';
                case 'odc': return 'ODC';
                case 'feeder': return 'FeederPanel';
                case 'distrib': return 'DistribPanel';
                case 'odp': return 'ODP';
                case 'pelanggan': return 'Pelanggan';
                case 'material': return 'Material';
                default: return 'OLT';
            }
        }

        // Get Table Headers
        function getTableHeaders(collection) {
            switch (collection) {
                case 'OLT':
                    return ['Kode', 'Nama', 'Lokasi Rak', 'Model', 'Total Slot', 'Port/Slot'];
                case 'ODC':
                    return ['Kode', 'Nama', 'Alamat', 'OLT', 'Slot OLT', 'Port OLT'];
                case 'FeederPanel':
                    return ['Kode', 'Nama', 'Total Port'];
                case 'DistribPanel':
                    return ['Kode', 'Nama', 'Feeder Panel', 'Port Feeder', 'Splitter', 'Total Port'];
                case 'ODP':
                    return ['Kode', 'Nama', 'ODC', 'Total Port', 'Port Terpakai', 'Kapasitas'];
                case 'Pelanggan':
                    return ['No. Pelanggan', 'Nama', 'Alamat', 'ODP', 'Port ODP', 'Status'];
                case 'Material':
                    return ['Tipe', 'Model', 'Spesifikasi', 'Jumlah', 'Satuan'];
                default:
                    return ['ID', 'Nama'];
            }
        }

        // Generate Table Row
        function generateTableRow(collection, data) {
            let html = `<tr>`;
            
            switch (collection) {
                case 'OLT':
                    html += `
                        <td>${data.code || '-'}</td>
                        <td>${data.name || '-'}</td>
                        <td>${data.rack_location || '-'}</td>
                        <td>${data.model || '-'}</td>
                        <td>${data.total_slots || '-'}</td>
                        <td>${data.ports_per_slot || '-'}</td>
                    `;
                    break;
                case 'ODC':
                    html += `
                        <td>${data.code || '-'}</td>
                        <td>${data.name || '-'}</td>
                        <td>${data.address || '-'}</td>
                        <td>${data.oltRef || '-'}</td>
                        <td>${data.oltSlot || '-'}</td>
                        <td>${data.oltPort || '-'}</td>
                    `;
                    break;
                case 'FeederPanel':
                    html += `
                        <td>${data.code || '-'}</td>
                        <td>${data.name || '-'}</td>
                        <td>${data.total_ports || '-'}</td>
                    `;
                    break;
                case 'DistribPanel':
                    html += `
                        <td>${data.code || '-'}</td>
                        <td>${data.name || '-'}</td>
                        <td>${data.feederPanelRef || '-'}</td>
                        <td>${data.feederPort || '-'}</td>
                        <td>${data.splitterType || '-'}</td>
                        <td>${data.total_ports || '-'}</td>
                    `;
                    break;
                case 'ODP':
                    const capacityPercent = data.totalPorts > 0 ? Math.round((data.usedPorts / data.totalPorts) * 100) : 0;
                    let capacityClass = 'low';
                    if (capacityPercent >= 75) capacityClass = 'high';
                    else if (capacityPercent >= 50) capacityClass = 'medium';
                    
                    html += `
                        <td>${data.code || '-'}</td>
                        <td>${data.name || '-'}</td>
                        <td>${data.odcRef || '-'}</td>
                        <td>${data.totalPorts || '-'}</td>
                        <td>${data.usedPorts || '-'}</td>
                        <td>
                            <div class="capacity-indicator">
                                <div class="capacity-bar">
                                    <div class="capacity-fill ${capacityClass}" style="width: ${capacityPercent}%;"></div>
                                </div>
                                <span class="capacity-text">${capacityPercent}%</span>
                            </div>
                        </td>
                    `;
                    break;
                case 'Pelanggan':
                    html += `
                        <td>${data.customerNumber || '-'}</td>
                        <td>${data.name || '-'}</td>
                        <td>${data.address || '-'}</td>
                        <td>${data.odpRef || '-'}</td>
                        <td>${data.odpPort || '-'}</td>
                        <td><span class="status-badge ${data.status || 'inactive'}">${data.status || 'inactive'}</span></td>
                    `;
                    break;
                case 'Material':
                    html += `
                        <td>${data.type || '-'}</td>
                        <td>${data.model || '-'}</td>
                        <td>${data.spec || '-'}</td>
                        <td>${data.quantity_onhand || '-'}</td>
                        <td>${data.unit || '-'}</td>
                    `;
                    break;
            }
            
            html += `
                <td>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-primary btn-sm" onclick="showEntityDetail('${collection}', '${data.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="editEntity('${collection}', '${data.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteEntity('${collection}', '${data.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            `;
            
            return html;
        }

        // Filter Table
        function filterTable(searchTerm) {
            const rows = document.querySelectorAll('.data-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Open Add Entity Modal
        function openAddEntityModal() {
            const collection = getCurrentCollection();
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');
            
            modalTitle.textContent = `Tambah ${getEntityName(collection)}`;
            modalBody.innerHTML = generateEntityForm(collection, 'add');
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Batal</button>
                <button type="button" class="btn btn-primary" onclick="saveEntity('${collection}', 'add')">Simpan</button>
            `;
            
            openModal();
            
            // Setup GPS capture if needed
            if (['OLT', 'ODC', 'FeederPanel', 'DistribPanel', 'ODP', 'Pelanggan'].includes(collection)) {
                setupGPSCapture();
            }
            
            // Setup photo upload if needed
            if (collection === 'Pelanggan') {
                setupPhotoUpload();
            }
        }

        // Edit Entity
        function editEntity(collection, id) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');
            
            modalTitle.textContent = `Edit ${getEntityName(collection)}`;
            
            // Show loading
            modalBody.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';
            openModal();
            
            // Get entity data
            db.collection(collection).doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = { id: doc.id, ...doc.data() };
                        modalBody.innerHTML = generateEntityForm(collection, 'edit', data);
                        modalFooter.innerHTML = `
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Batal</button>
                            <button type="button" class="btn btn-primary" onclick="saveEntity('${collection}', 'edit', '${id}')">Simpan</button>
                        `;
                        
                        // Setup GPS capture if needed
                        if (['OLT', 'ODC', 'FeederPanel', 'DistribPanel', 'ODP', 'Pelanggan'].includes(collection)) {
                            setupGPSCapture(data.location);
                        }
                        
                        // Setup photo upload if needed
                        if (collection === 'Pelanggan') {
                            setupPhotoUpload(data.photoUrl);
                        }
                    } else {
                        modalBody.innerHTML = `<p style="text-align: center; color: var(--danger-color);">Data tidak ditemukan</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading entity data:', error);
                    modalBody.innerHTML = `<p style="text-align: center; color: var(--danger-color);">Gagal memuat data: ${error.message}</p>`;
                });
        }

        // Delete Entity
        function deleteEntity(collection, id) {
            if (confirm(`Apakah Anda yakin ingin menghapus ${getEntityName(collection)} ini?`)) {
                db.collection(collection).doc(id).delete()
                    .then(() => {
                        showToast('success', 'Berhasil', `${getEntityName(collection)} berhasil dihapus`);
                        loadTableData(collection);
                        
                        // Update map if needed
                        if (['OLT', 'ODC', 'FeederPanel', 'DistribPanel', 'ODP', 'Pelanggan'].includes(collection)) {
                            loadMapData();
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting entity:', error);
                        showToast('error', 'Error', `Gagal menghapus ${getEntityName(collection)}: ${error.message}`);
                    });
            }
        }

        // Show Entity Detail
        function showEntityDetail(collection, id) {
            const slideOverTitle = document.getElementById('slideOverTitle');
            const slideOverBody = document.getElementById('slideOverBody');
            
            slideOverTitle.textContent = `Detail ${getEntityName(collection)}`;
            
            // Show loading
            slideOverBody.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';
            openSlideOver();
            
            // Get entity data
            db.collection(collection).doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = { id: doc.id, ...doc.data() };
                        slideOverBody.innerHTML = generateEntityDetail(collection, data);
                    } else {
                        slideOverBody.innerHTML = `<p style="text-align: center; color: var(--danger-color);">Data tidak ditemukan</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading entity detail:', error);
                    slideOverBody.innerHTML = `<p style="text-align: center; color: var(--danger-color);">Gagal memuat data: ${error.message}</p>`;
                });
        }

        // Generate Entity Form
        function generateEntityForm(collection, mode, data = {}) {
            let html = '';
            
            switch (collection) {
                case 'OLT':
                    html = `
                        <div class="form-group">
                            <label class="form-label required">Kode</label>
                            <input type="text" id="oltCode" class="form-input" value="${data.code || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Nama</label>
                            <input type="text" id="oltName" class="form-input" value="${data.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Lokasi Rak</label>
                            <input type="text" id="oltRackLocation" class="form-input" value="${data.rack_location || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Model</label>
                            <input type="text" id="oltModel" class="form-input" value="${data.model || ''}" required>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label required">Total Slot</label>
                                    <input type="number" id="oltTotalSlots" class="form-input" value="${data.total_slots || ''}" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label required">Port per Slot</label>
                                    <input type="number" id="oltPortsPerSlot" class="form-input" value="${data.ports_per_slot || ''}" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Catatan</label>
                            <textarea id="oltNotes" class="form-textarea">${data.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lokasi GPS</label>
                            <div id="gpsCapture" class="gps-capture">
                                <button type="button" id="captureGPSBtn" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Ambil Lokasi</span>
                                </button>
                                <div id="gpsStatus" class="gps-status">Belum ada lokasi</div>
                            </div>
                            <input type="hidden" id="oltLocation">
                        </div>
                    `;
                    break;
                    
                case 'ODC':
                    html = `
                        <div class="form-group">
                            <label class="form-label required">Kode</label>
                            <input type="text" id="odcCode" class="form-input" value="${data.code || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Nama</label>
                            <input type="text" id="odcName" class="form-input" value="${data.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Alamat</label>
                            <input type="text" id="odcAddress" class="form-input" value="${data.address || ''}" required>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Feeder Panel</label>
                                    <select id="odcFeederPanel" class="form-select">
                                        <option value="">Pilih Feeder Panel</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Port Feeder</label>
                                    <input type="number" id="odcFeederPort" class="form-input" value="${data.feederPort || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Distribusi Panel</label>
                                    <select id="odcDistribPanel" class="form-select">
                                        <option value="">Pilih Distribusi Panel</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Port Distribusi</label>
                                    <input type="number" id="odcDistribPort" class="form-input" value="${data.distribPort || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">OLT</label>
                                    <select id="odcOLT" class="form-select">
                                        <option value="">Pilih OLT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Slot OLT</label>
                                    <input type="number" id="odcOLTSlot" class="form-input" value="${data.oltSlot || ''}">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Port OLT</label>
                                    <input type="number" id="odcOLTPort" class="form-input" value="${data.oltPort || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Catatan</label>
                            <textarea id="odcNotes" class="form-textarea">${data.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lokasi GPS</label>
                            <div id="gpsCapture" class="gps-capture">
                                <button type="button" id="captureGPSBtn" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Ambil Lokasi</span>
                                </button>
                                <div id="gpsStatus" class="gps-status">Belum ada lokasi</div>
                            </div>
                            <input type="hidden" id="odcLocation">
                        </div>
                    `;
                    
                    // Load OLT options
                    loadOLTOptions('odcOLT', data.oltRef);
                    break;
                    
                case 'FeederPanel':
                    html = `
                        <div class="form-group">
                            <label class="form-label required">Kode</label>
                            <input type="text" id="feederCode" class="form-input" value="${data.code || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Nama</label>
                            <input type="text" id="feederName" class="form-input" value="${data.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Total Port</label>
                            <input type="number" id="feederTotalPorts" class="form-input" value="${data.total_ports || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Catatan</label>
                            <textarea id="feederNotes" class="form-textarea">${data.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lokasi GPS</label>
                            <div id="gpsCapture" class="gps-capture">
                                <button type="button" id="captureGPSBtn" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Ambil Lokasi</span>
                                </button>
                                <div id="gpsStatus" class="gps-status">Belum ada lokasi</div>
                            </div>
                            <input type="hidden" id="feederLocation">
                        </div>
                    `;
                    break;
                    
                case 'DistribPanel':
                    html = `
                        <div class="form-group">
                            <label class="form-label required">Kode</label>
                            <input type="text" id="distribCode" class="form-input" value="${data.code || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Nama</label>
                            <input type="text" id="distribName" class="form-input" value="${data.name || ''}" required>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Feeder Panel</label>
                                    <select id="distribFeederPanel" class="form-select">
                                        <option value="">Pilih Feeder Panel</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Port Feeder</label>
                                    <input type="number" id="distribFeederPort" class="form-input" value="${data.feederPort || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label required">Tipe Splitter</label>
                                    <select id="distribSplitterType" class="form-select" required>
                                        <option value="">Pilih Tipe Splitter</option>
                                        <option value="1:2" ${data.splitterType === '1:2' ? 'selected' : ''}>1:2</option>
                                        <option value="1:4" ${data.splitterType === '1:4' ? 'selected' : ''}>1:4</option>
                                        <option value="1:8" ${data.splitterType === '1:8' ? 'selected' : ''}>1:8</option>
                                        <option value="1:16" ${data.splitterType === '1:16' ? 'selected' : ''}>1:16</option>
                                        <option value="1:32" ${data.splitterType === '1:32' ? 'selected' : ''}>1:32</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label required">Total Port</label>
                                    <input type="number" id="distribTotalPorts" class="form-input" value="${data.total_ports || ''}" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Catatan</label>
                            <textarea id="distribNotes" class="form-textarea">${data.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lokasi GPS</label>
                            <div id="gpsCapture" class="gps-capture">
                                <button type="button" id="captureGPSBtn" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Ambil Lokasi</span>
                                </button>
                                <div id="gpsStatus" class="gps-status">Belum ada lokasi</div>
                            </div>
                            <input type="hidden" id="distribLocation">
                        </div>
                    `;
                    
                    // Load Feeder Panel options
                    loadFeederPanelOptions('distribFeederPanel', data.feederPanelRef);
                    break;
                    
                case 'ODP':
                    html = `
                        <div class="form-group">
                            <label class="form-label required">Kode</label>
                            <input type="text" id="odpCode" class="form-input" value="${data.code || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Nama</label>
                            <input type="text" id="odpName" class="form-input" value="${data.name || ''}" required>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">ODC</label>
                                    <select id="odpODC" class="form-select">
                                        <option value="">Pilih ODC</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Panel Distribusi</label>
                                    <select id="odpPanelDist" class="form-select">
                                        <option value="">Pilih Panel Distribusi</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Port Panel</label>
                                    <input type="number" id="odpPanelDistPort" class="form-input" value="${data.panelDistPort || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label required">Total Port</label>
                                    <input type="number" id="odpTotalPorts" class="form-input" value="${data.totalPorts || ''}" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label">Tipe Splitter</label>
                                    <select id="odpSplitterType" class="form-select">
                                        <option value="">Pilih Tipe Splitter</option>
                                        <option value="1:2" ${data.splitterType === '1:2' ? 'selected' : ''}>1:2</option>
                                        <option value="1:4" ${data.splitterType === '1:4' ? 'selected' : ''}>1:4</option>
                                        <option value="1:8" ${data.splitterType === '1:8' ? 'selected' : ''}>1:8</option>
                                        <option value="1:16" ${data.splitterType === '1:16' ? 'selected' : ''}>1:16</option>
                                        <option value="1:32" ${data.splitterType === '1:32' ? 'selected' : ''}>1:32</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Catatan</label>
                            <textarea id="odpNotes" class="form-textarea">${data.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lokasi GPS</label>
                            <div id="gpsCapture" class="gps-capture">
                                <button type="button" id="captureGPSBtn" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Ambil Lokasi</span>
                                </button>
                                <div id="gpsStatus" class="gps-status">Belum ada lokasi</div>
                            </div>
                            <input type="hidden" id="odpLocation">
                        </div>
                    `;
                    
                    // Load ODC options
                    loadODCOptions('odpODC', data.odcRef);
                    // Load Distrib Panel options
                    loadDistribPanelOptions('odpPanelDist', data.panelDistRef);
                    break;
                    
                case 'Pelanggan':
                    html = `
                        <div class="form-group">
                            <label class="form-label required">Nama</label>
                            <input type="text" id="pelangganName" class="form-input" value="${data.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">No. Pelanggan</label>
                            <input type="text" id="pelangganCustomerNumber" class="form-input" value="${data.customerNumber || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Alamat</label>
                            <input type="text" id="pelangganAddress" class="form-input" value="${data.address || ''}" required>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label required">ODP</label>
                                    <select id="pelangganODP" class="form-select" required>
                                        <option value="">Pilih ODP</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label required">Port ODP</label>
                                    <input type="number" id="pelangganODPPort" class="form-input" value="${data.odpPort || ''}" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="pelangganStatus" class="form-select">
                                <option value="active" ${data.status === 'active' ? 'selected' : ''}>Aktif</option>
                                <option value="inactive" ${data.status === 'inactive' ? 'selected' : ''}>Tidak Aktif</option>
                                <option value="pending" ${data.status === 'pending' ? 'selected' : ''}>Menunggu</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Foto</label>
                            <div class="photo-upload">
                                <div id="photoPreview" class="photo-preview">
                                    <div class="photo-placeholder">
                                        <i class="fas fa-camera"></i>
                                        <span>Klik untuk mengunggah foto</span>
                                    </div>
                                </div>
                                <input type="file" id="photoInput" class="photo-input" accept="image/*">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lokasi GPS</label>
                            <div id="gpsCapture" class="gps-capture">
                                <button type="button" id="captureGPSBtn" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Ambil Lokasi</span>
                                </button>
                                <div id="gpsStatus" class="gps-status">Belum ada lokasi</div>
                            </div>
                            <input type="hidden" id="pelangganLocation">
                        </div>
                    `;
                    
                    // Load ODP options
                    loadODPOptions('pelangganODP', data.odpRef);
                    break;
                    
                case 'Material':
                    html = `
                        <div class="form-group">
                            <label class="form-label required">Tipe</label>
                            <select id="materialType" class="form-select" required>
                                <option value="">Pilih Tipe</option>
                                <option value="splitter" ${data.type === 'splitter' ? 'selected' : ''}>Splitter</option>
                                <option value="cable" ${data.type === 'cable' ? 'selected' : ''}>Kabel</option>
                                <option value="pigtail" ${data.type === 'pigtail' ? 'selected' : ''}>Pigtail</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Model</label>
                            <input type="text" id="materialModel" class="form-input" value="${data.model || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Spesifikasi</label>
                            <textarea id="materialSpec" class="form-textarea">${data.spec || ''}</textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label required">Jumlah</label>
                                    <input type="number" id="materialQuantity" class="form-input" value="${data.quantity_onhand || ''}" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label required">Satuan</label>
                                    <input type="text" id="materialUnit" class="form-input" value="${data.unit || ''}" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Catatan</label>
                            <textarea id="materialNotes" class="form-textarea">${data.notes || ''}</textarea>
                        </div>
                    `;
                    break;
            }
            
            return html;
        }

        // Generate Entity Detail
        function generateEntityDetail(collection, data) {
            let html = '';
            
            switch (collection) {
                case 'OLT':
                    html = `
                        <div class="detail-section">
                            <h3 class="detail-section-title">Informasi Umum</h3>
                            <div class="detail-item">
                                <div class="detail-label">Kode:</div>
                                <div class="detail-value">${data.code || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Nama:</div>
                                <div class="detail-value">${data.name || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Lokasi Rak:</div>
                                <div class="detail-value">${data.rack_location || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Model:</div>
                                <div class="detail-value">${data.model || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Slot:</div>
                                <div class="detail-value">${data.total_ports || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Port/Slot:</div>
                                <div class="detail-value">${data.ports_per_slot || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Catatan:</div>
                                <div class="detail-value">${data.notes || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Lokasi GPS</h3>
                            <div class="detail-item">
                                <div class="detail-label">Latitude:</div>
                                <div class="detail-value">${data.location ? data.location.lat : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Longitude:</div>
                                <div class="detail-value">${data.location ? data.location.lng : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Akurasi:</div>
                                <div class="detail-value">${data.location ? data.location.accuracy + ' m' : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Waktu:</div>
                                <div class="detail-value">${data.location ? new Date(data.location.ts).toLocaleString() : '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">ODC Terhubung</h3>
                            <div id="oltODCs">
                                <div class="spinner-container"><div class="spinner"></div></div>
                            </div>
                        </div>
                    `;
                    
                    // Load connected ODCs
                    loadConnectedODCs(data.id, 'oltODCs');
                    break;
                    
                case 'ODC':
                    html = `
                        <div class="detail-section">
                            <h3 class="detail-section-title">Informasi Umum</h3>
                            <div class="detail-item">
                                <div class="detail-label">Kode:</div>
                                <div class="detail-value">${data.code || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Nama:</div>
                                <div class="detail-value">${data.name || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Alamat:</div>
                                <div class="detail-value">${data.address || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Catatan:</div>
                                <div class="detail-value">${data.notes || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Koneksi</h3>
                            <div class="detail-item">
                                <div class="detail-label">OLT:</div>
                                <div class="detail-value">${data.oltRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Slot OLT:</div>
                                <div class="detail-value">${data.oltSlot || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Port OLT:</div>
                                <div class="detail-value">${data.oltPort || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Feeder Panel:</div>
                                <div class="detail-value">${data.feederPanelRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Port Feeder:</div>
                                <div class="detail-value">${data.feederPort || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Distribusi Panel:</div>
                                <div class="detail-value">${data.distribPanelRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Port Distribusi:</div>
                                <div class="detail-value">${data.distribPort || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Lokasi GPS</h3>
                            <div class="detail-item">
                                <div class="detail-label">Latitude:</div>
                                <div class="detail-value">${data.location ? data.location.lat : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Longitude:</div>
                                <div class="detail-value">${data.location ? data.location.lng : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Akurasi:</div>
                                <div class="detail-value">${data.location ? data.location.accuracy + ' m' : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Waktu:</div>
                                <div class="detail-value">${data.location ? new Date(data.location.ts).toLocaleString() : '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">ODP Terhubung</h3>
                            <div id="odcODPs">
                                <div class="spinner-container"><div class="spinner"></div></div>
                            </div>
                        </div>
                    `;
                    
                    // Load connected ODPs
                    loadConnectedODPs(data.id, 'odcODPs');
                    break;
                    
                case 'FeederPanel':
                    html = `
                        <div class="detail-section">
                            <h3 class="detail-section-title">Informasi Umum</h3>
                            <div class="detail-item">
                                <div class="detail-label">Kode:</div>
                                <div class="detail-value">${data.code || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Nama:</div>
                                <div class="detail-value">${data.name || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Port:</div>
                                <div class="detail-value">${data.total_ports || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Catatan:</div>
                                <div class="detail-value">${data.notes || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Lokasi GPS</h3>
                            <div class="detail-item">
                                <div class="detail-label">Latitude:</div>
                                <div class="detail-value">${data.location ? data.location.lat : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Longitude:</div>
                                <div class="detail-value">${data.location ? data.location.lng : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Akurasi:</div>
                                <div class="detail-value">${data.location ? data.location.accuracy + ' m' : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Waktu:</div>
                                <div class="detail-value">${data.location ? new Date(data.location.ts).toLocaleString() : '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">ODC Terhubung</h3>
                            <div id="feederODCs">
                                <div class="spinner-container"><div class="spinner"></div></div>
                            </div>
                        </div>
                    `;
                    
                    // Load connected ODCs
                    loadConnectedODCsByFeeder(data.id, 'feederODCs');
                    break;
                    
                case 'DistribPanel':
                    html = `
                        <div class="detail-section">
                            <h3 class="detail-section-title">Informasi Umum</h3>
                            <div class="detail-item">
                                <div class="detail-label">Kode:</div>
                                <div class="detail-value">${data.code || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Nama:</div>
                                <div class="detail-value">${data.name || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Port:</div>
                                <div class="detail-value">${data.total_ports || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Tipe Splitter:</div>
                                <div class="detail-value">${data.splitterType || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Catatan:</div>
                                <div class="detail-value">${data.notes || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Koneksi</h3>
                            <div class="detail-item">
                                <div class="detail-label">Feeder Panel:</div>
                                <div class="detail-value">${data.feederPanelRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Port Feeder:</div>
                                <div class="detail-value">${data.feederPort || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Lokasi GPS</h3>
                            <div class="detail-item">
                                <div class="detail-label">Latitude:</div>
                                <div class="detail-value">${data.location ? data.location.lat : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Longitude:</div>
                                <div class="detail-value">${data.location ? data.location.lng : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Akurasi:</div>
                                <div class="detail-value">${data.location ? data.location.accuracy + ' m' : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Waktu:</div>
                                <div class="detail-value">${data.location ? new Date(data.location.ts).toLocaleString() : '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">ODP Terhubung</h3>
                            <div id="distribODPs">
                                <div class="spinner-container"><div class="spinner"></div></div>
                            </div>
                        </div>
                    `;
                    
                    // Load connected ODPs
                    loadConnectedODPsByDistrib(data.id, 'distribODPs');
                    break;
                    
                case 'ODP':
                    const capacityPercent = data.totalPorts > 0 ? Math.round((data.usedPorts / data.totalPorts) * 100) : 0;
                    let capacityClass = 'low';
                    if (capacityPercent >= 75) capacityClass = 'high';
                    else if (capacityPercent >= 50) capacityClass = 'medium';
                    
                    html = `
                        <div class="detail-section">
                            <h3 class="detail-section-title">Informasi Umum</h3>
                            <div class="detail-item">
                                <div class="detail-label">Kode:</div>
                                <div class="detail-value">${data.code || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Nama:</div>
                                <div class="detail-value">${data.name || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Port:</div>
                                <div class="detail-value">${data.totalPorts || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Port Terpakai:</div>
                                <div class="detail-value">${data.usedPorts || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Kapasitas:</div>
                                <div class="detail-value">
                                    <div class="capacity-indicator">
                                        <div class="capacity-bar">
                                            <div class="capacity-fill ${capacityClass}" style="width: ${capacityPercent}%;"></div>
                                        </div>
                                        <span class="capacity-text">${capacityPercent}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Tipe Splitter:</div>
                                <div class="detail-value">${data.splitterType || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Catatan:</div>
                                <div class="detail-value">${data.notes || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Koneksi</h3>
                            <div class="detail-item">
                                <div class="detail-label">ODC:</div>
                                <div class="detail-value">${data.odcRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Panel Distribusi:</div>
                                <div class="detail-value">${data.panelDistRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Port Panel:</div>
                                <div class="detail-value">${data.panelDistPort || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Lokasi GPS</h3>
                            <div class="detail-item">
                                <div class="detail-label">Latitude:</div>
                                <div class="detail-value">${data.location ? data.location.lat : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Longitude:</div>
                                <div class="detail-value">${data.location ? data.location.lng : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Akurasi:</div>
                                <div class="detail-value">${data.location ? data.location.accuracy + ' m' : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Waktu:</div>
                                <div class="detail-value">${data.location ? new Date(data.location.ts).toLocaleString() : '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Port Mapping</h3>
                            <div id="odpPortMapping">
                                <div class="spinner-container"><div class="spinner"></div></div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Pelanggan Terhubung</h3>
                            <div id="odpPelanggan">
                                <div class="spinner-container"><div class="spinner"></div></div>
                            </div>
                        </div>
                    `;
                    
                    // Load port mapping
                    loadPortMapping(data.id, 'odpPortMapping');
                    // Load connected customers
                    loadConnectedPelanggan(data.id, 'odpPelanggan');
                    break;
                    
                case 'Pelanggan':
                    html = `
                        <div class="detail-section">
                            <h3 class="detail-section-title">Informasi Pelanggan</h3>
                            <div class="detail-item">
                                <div class="detail-label">No. Pelanggan:</div>
                                <div class="detail-value">${data.customerNumber || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Nama:</div>
                                <div class="detail-value">${data.name || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Alamat:</div>
                                <div class="detail-value">${data.address || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Status:</div>
                                <div class="detail-value">
                                    <span class="status-badge ${data.status || 'inactive'}">${data.status || 'inactive'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Koneksi</h3>
                            <div class="detail-item">
                                <div class="detail-label">ODP:</div>
                                <div class="detail-value">${data.odpRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Port ODP:</div>
                                <div class="detail-value">${data.odpPort || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ODC:</div>
                                <div class="detail-value">${data.odcRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Panel Distribusi:</div>
                                <div class="detail-value">${data.distribPanelRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Feeder Panel:</div>
                                <div class="detail-value">${data.feederPanelRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">OLT:</div>
                                <div class="detail-value">${data.oltRef || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Slot OLT:</div>
                                <div class="detail-value">${data.oltSlot || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Port OLT:</div>
                                <div class="detail-value">${data.oltPort || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Lokasi GPS</h3>
                            <div class="detail-item">
                                <div class="detail-label">Latitude:</div>
                                <div class="detail-value">${data.location ? data.location.lat : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Longitude:</div>
                                <div class="detail-value">${data.location ? data.location.lng : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Akurasi:</div>
                                <div class="detail-value">${data.location ? data.location.accuracy + ' m' : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Waktu:</div>
                                <div class="detail-value">${data.location ? new Date(data.location.ts).toLocaleString() : '-'}</div>
                            </div>
                        </div>
                        ${data.photoUrl ? `
                        <div class="detail-section">
                            <h3 class="detail-section-title">Foto</h3>
                            <div class="detail-photo">
                                <img src="${data.photoUrl}" alt="Foto Pelanggan">
                            </div>
                        </div>
                        ` : ''}
                        <div class="detail-section">
                            <h3 class="detail-section-title">Jalur Koneksi</h3>
                            <div id="pelangganPath">
                                <div class="spinner-container"><div class="spinner"></div></div>
                            </div>
                        </div>
                    `;
                    
                    // Load connection path
                    loadConnectionPath(data, 'pelangganPath');
                    break;
                    
                case 'Material':
                    html = `
                        <div class="detail-section">
                            <h3 class="detail-section-title">Informasi Material</h3>
                            <div class="detail-item">
                                <div class="detail-label">Tipe:</div>
                                <div class="detail-value">${data.type || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Model:</div>
                                <div class="detail-value">${data.model || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Spesifikasi:</div>
                                <div class="detail-value">${data.spec || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Jumlah:</div>
                                <div class="detail-value">${data.quantity_onhand || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Satuan:</div>
                                <div class="detail-value">${data.unit || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Catatan:</div>
                                <div class="detail-value">${data.notes || '-'}</div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3 class="detail-section-title">Riwayat Penggunaan</h3>
                            <div id="materialUsage">
                                <div class="spinner-container"><div class="spinner"></div></div>
                            </div>
                        </div>
                    `;
                    
                    // Load material usage history
                    loadMaterialUsage(data.id, 'materialUsage');
                    break;
            }
            
            return html;
        }

        // Save Entity
        function saveEntity(collection, mode, id) {
            let entityData = {};
            
            switch (collection) {
                case 'OLT':
                    entityData = {
                        code: document.getElementById('oltCode').value,
                        name: document.getElementById('oltName').value,
                        rack_location: document.getElementById('oltRackLocation').value,
                        model: document.getElementById('oltModel').value,
                        total_slots: parseInt(document.getElementById('oltTotalSlots').value),
                        ports_per_slot: parseInt(document.getElementById('oltPortsPerSlot').value),
                        notes: document.getElementById('oltNotes').value,
                        location: document.getElementById('oltLocation').value ? JSON.parse(document.getElementById('oltLocation').value) : null
                    };
                    break;
                    
                case 'ODC':
                    entityData = {
                        code: document.getElementById('odcCode').value,
                        name: document.getElementById('odcName').value,
                        address: document.getElementById('odcAddress').value,
                        feederPanelRef: document.getElementById('odcFeederPanel').value,
                        feederPort: parseInt(document.getElementById('odcFeederPort').value) || null,
                        distribPanelRef: document.getElementById('odcDistribPanel').value,
                        distribPort: parseInt(document.getElementById('odcDistribPort').value) || null,
                        oltRef: document.getElementById('odcOLT').value,
                        oltSlot: parseInt(document.getElementById('odcOLTSlot').value) || null,
                        oltPort: parseInt(document.getElementById('odcOLTPort').value) || null,
                        notes: document.getElementById('odcNotes').value,
                        location: document.getElementById('odcLocation').value ? JSON.parse(document.getElementById('odcLocation').value) : null
                    };
                    break;
                    
                case 'FeederPanel':
                    entityData = {
                        code: document.getElementById('feederCode').value,
                        name: document.getElementById('feederName').value,
                        total_ports: parseInt(document.getElementById('feederTotalPorts').value),
                        notes: document.getElementById('feederNotes').value,
                        location: document.getElementById('feederLocation').value ? JSON.parse(document.getElementById('feederLocation').value) : null
                    };
                    break;
                    
                case 'DistribPanel':
                    entityData = {
                        code: document.getElementById('distribCode').value,
                        name: document.getElementById('distribName').value,
                        feederPanelRef: document.getElementById('distribFeederPanel').value,
                        feederPort: parseInt(document.getElementById('distribFeederPort').value) || null,
                        splitterType: document.getElementById('distribSplitterType').value,
                        total_ports: parseInt(document.getElementById('distribTotalPorts').value),
                        notes: document.getElementById('distribNotes').value,
                        location: document.getElementById('distribLocation').value ? JSON.parse(document.getElementById('distribLocation').value) : null
                    };
                    break;
                    
                case 'ODP':
                    entityData = {
                        code: document.getElementById('odpCode').value,
                        name: document.getElementById('odpName').value,
                        odcRef: document.getElementById('odpODC').value,
                        panelDistRef: document.getElementById('odpPanelDist').value,
                        panelDistPort: parseInt(document.getElementById('odpPanelDistPort').value) || null,
                        totalPorts: parseInt(document.getElementById('odpTotalPorts').value),
                        splitterType: document.getElementById('odpSplitterType').value,
                        notes: document.getElementById('odpNotes').value,
                        location: document.getElementById('odpLocation').value ? JSON.parse(document.getElementById('odpLocation').value) : null
                    };
                    
                    // Initialize portMapping if creating new ODP
                    if (mode === 'add') {
                        entityData.usedPorts = 0;
                        entityData.portMapping = {};
                        
                        // Create available ports
                        for (let i = 1; i <= entityData.totalPorts; i++) {
                            entityData.portMapping[i] = {
                                status: 'available',
                                pelangganRef: null,
                                assignedAt: null
                            };
                        }
                    }
                    break;
                    
                case 'Pelanggan':
                    entityData = {
                        name: document.getElementById('pelangganName').value,
                        customerNumber: document.getElementById('pelangganCustomerNumber').value,
                        address: document.getElementById('pelangganAddress').value,
                        odpRef: document.getElementById('pelangganODP').value,
                        odpPort: parseInt(document.getElementById('pelangganODPPort').value),
                        status: document.getElementById('pelangganStatus').value,
                        location: document.getElementById('pelangganLocation').value ? JSON.parse(document.getElementById('pelangganLocation').value) : null
                    };
                    
                    // Auto-fill chain fields
                    if (entityData.odpRef) {
                        return db.collection('ODP').doc(entityData.odpRef).get()
                            .then(doc => {
                                if (doc.exists) {
                                    const odp = { id: doc.id, ...doc.data() };
                                    entityData.odcRef = odp.odcRef;
                                    entityData.panelDistRef = odp.panelDistRef;
                                    
                                    // Get ODC details
                                    return db.collection('ODC').doc(odp.odcRef).get();
                                } else {
                                    throw new Error('ODP tidak ditemukan');
                                }
                            })
                            .then(doc => {
                                if (doc.exists) {
                                    const odc = { id: doc.id, ...doc.data() };
                                    entityData.feederPanelRef = odc.feederPanelRef;
                                    entityData.oltRef = odc.oltRef;
                                    entityData.oltSlot = odc.oltSlot;
                                    entityData.oltPort = odc.oltPort;
                                    
                                    // Get Distrib Panel details
                                    return db.collection('DistribPanel').doc(odp.panelDistRef).get();
                                } else {
                                    throw new Error('ODC tidak ditemukan');
                                }
                            })
                            .then(doc => {
                                if (doc.exists) {
                                    const distrib = { id: doc.id, ...doc.data() };
                                    entityData.distribPanelRef = distrib.id;
                                    
                                    // Check if photo needs to be uploaded
                                    const photoInput = document.getElementById('photoInput');
                                    if (photoInput.files && photoInput.files[0]) {
                                        return uploadPhoto(photoInput.files[0])
                                            .then(photoUrl => {
                                                entityData.photoUrl = photoUrl;
                                                return savePelangganWithTransaction(collection, mode, id, entityData);
                                            });
                                    } else {
                                        return savePelangganWithTransaction(collection, mode, id, entityData);
                                    }
                                } else {
                                    throw new Error('Panel Distribusi tidak ditemukan');
                                }
                            })
                            .catch(error => {
                                console.error('Error saving pelanggan:', error);
                                showToast('error', 'Error', `Gagal menyimpan pelanggan: ${error.message}`);
                            });
                    } else {
                        showToast('error', 'Error', 'ODP harus dipilih');
                        return;
                    }
                    break;
                    
                case 'Material':
                    entityData = {
                        type: document.getElementById('materialType').value,
                        model: document.getElementById('materialModel').value,
                        spec: document.getElementById('materialSpec').value,
                        quantity_onhand: parseInt(document.getElementById('materialQuantity').value),
                        unit: document.getElementById('materialUnit').value,
                        notes: document.getElementById('materialNotes').value
                    };
                    break;
            }
            
            // Add common fields
            entityData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
            
            if (mode === 'add') {
                entityData.createdBy = currentUser.uid;
                entityData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                
                // Add to offline queue if offline
                if (!isOnline) {
                    addToOfflineQueue('create', collection, entityData);
                    showToast('info', 'Offline', 'Data akan disinkronkan saat online');
                    closeModal();
                    return;
                }
                
                // Save to Firestore
                db.collection(collection).add(entityData)
                    .then(docRef => {
                        showToast('success', 'Berhasil', `${getEntityName(collection)} berhasil ditambahkan`);
                        closeModal();
                        loadTableData(collection);
                        
                        // Update map if needed
                        if (['OLT', 'ODC', 'FeederPanel', 'DistribPanel', 'ODP', 'Pelanggan'].includes(collection)) {
                            loadMapData();
                        }
                        
                        // Log audit
                        logAudit('create', collection, docRef.id, null, entityData);
                    })
                    .catch(error => {
                        console.error('Error saving entity:', error);
                        showToast('error', 'Error', `Gagal menyimpan ${getEntityName(collection)}: ${error.message}`);
                    });
            } else if (mode === 'edit' && id) {
                // Get previous data for audit
                db.collection(collection).doc(id).get()
                    .then(doc => {
                        if (doc.exists) {
                            const previousData = doc.data();
                            
                            // Add to offline queue if offline
                            if (!isOnline) {
                                addToOfflineQueue('update', collection, { id, ...entityData });
                                showToast('info', 'Offline', 'Data akan disinkronkan saat online');
                                closeModal();
                                return;
                            }
                            
                            // Update in Firestore
                            return db.collection(collection).doc(id).update(entityData)
                                .then(() => {
                                    showToast('success', 'Berhasil', `${getEntityName(collection)} berhasil diperbarui`);
                                    closeModal();
                                    loadTableData(collection);
                                    
                                    // Update map if needed
                                    if (['OLT', 'ODC', 'FeederPanel', 'DistribPanel', 'ODP', 'Pelanggan'].includes(collection)) {
                                        loadMapData();
                                    }
                                    
                                    // Log audit
                                    logAudit('update', collection, id, previousData, entityData);
                                });
                        } else {
                            throw new Error('Data tidak ditemukan');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating entity:', error);
                        showToast('error', 'Error', `Gagal memperbarui ${getEntityName(collection)}: ${error.message}`);
                    });
            }
        }

        // Save Pelanggan with Transaction
        function savePelangganWithTransaction(collection, mode, id, entityData) {
            if (mode === 'add') {
                // Use transaction to claim port
                return db.runTransaction(transaction => {
                    // Get ODP document
                    const odpRef = db.collection('ODP').doc(entityData.odpRef);
                    return transaction.get(odpRef)
                        .then(odpDoc => {
                            if (!odpDoc.exists) {
                                throw new Error('ODP tidak ditemukan');
                            }
                            
                            const odp = odpDoc.data();
                            
                            // Check if port is available
                            if (!odp.portMapping || !odp.portMapping[entityData.odpPort] || odp.portMapping[entityData.odpPort].status !== 'available') {
                                throw new Error('Port sudah digunakan atau tidak tersedia');
                            }
                            
                            // Update ODP port mapping
                            const updatedPortMapping = { ...odp.portMapping };
                            updatedPortMapping[entityData.odpPort] = {
                                status: 'used',
                                pelangganRef: null, // Will be updated after creating pelanggan
                                assignedAt: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            // Update ODP
                            transaction.update(odpRef, {
                                portMapping: updatedPortMapping,
                                usedPorts: odp.usedPorts + 1,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Create Pelanggan
                            const pelangganRef = db.collection('Pelanggan').doc();
                            transaction.set(pelangganRef, entityData);
                            
                            // Update ODP port mapping with pelanggan reference
                            updatedPortMapping[entityData.odpPort].pelangganRef = pelangganRef.id;
                            transaction.update(odpRef, { portMapping: updatedPortMapping });
                            
                            return pelangganRef.id;
                        });
                })
                .then(pelangganId => {
                    showToast('success', 'Berhasil', 'Pelanggan berhasil ditambahkan');
                    closeModal();
                    loadTableData(collection);
                    loadMapData();
                    
                    // Log audit
                    logAudit('create', collection, pelangganId, null, entityData);
                })
                .catch(error => {
                    console.error('Error saving pelanggan:', error);
                    showToast('error', 'Error', `Gagal menyimpan pelanggan: ${error.message}`);
                });
            } else if (mode === 'edit' && id) {
                // For editing, we need to handle port changes if any
                return db.collection('Pelanggan').doc(id).get()
                    .then(doc => {
                        if (doc.exists) {
                            const previousData = doc.data();
                            
                            // If ODP or port changed, we need to handle port release/claim
                            if (previousData.odpRef !== entityData.odpRef || previousData.odpPort !== entityData.odpPort) {
                                return db.runTransaction(transaction => {
                                    // Release previous port
                                    const prevOdpRef = db.collection('ODP').doc(previousData.odpRef);
                                    return transaction.get(prevOdpRef)
                                        .then(prevOdpDoc => {
                                            if (prevOdpDoc.exists) {
                                                const prevOdp = prevOdpDoc.data();
                                                const updatedPrevPortMapping = { ...prevOdp.portMapping };
                                                updatedPrevPortMapping[previousData.odpPort] = {
                                                    status: 'available',
                                                    pelangganRef: null,
                                                    assignedAt: null
                                                };
                                                
                                                transaction.update(prevOdpRef, {
                                                    portMapping: updatedPrevPortMapping,
                                                    usedPorts: prevOdp.usedPorts - 1,
                                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                                });
                                            }
                                            
                                            // Claim new port
                                            const newOdpRef = db.collection('ODP').doc(entityData.odpRef);
                                            return transaction.get(newOdpRef)
                                                .then(newOdpDoc => {
                                                    if (!newOdpDoc.exists) {
                                                        throw new Error('ODP tidak ditemukan');
                                                    }
                                                    
                                                    const newOdp = newOdpDoc.data();
                                                    
                                                    // Check if port is available
                                                    if (!newOdp.portMapping || !newOdp.portMapping[entityData.odpPort] || newOdp.portMapping[entityData.odpPort].status !== 'available') {
                                                        throw new Error('Port sudah digunakan atau tidak tersedia');
                                                    }
                                                    
                                                    // Update new ODP port mapping
                                                    const updatedNewPortMapping = { ...newOdp.portMapping };
                                                    updatedNewPortMapping[entityData.odpPort] = {
                                                        status: 'used',
                                                        pelangganRef: id,
                                                        assignedAt: firebase.firestore.FieldValue.serverTimestamp()
                                                    };
                                                    
                                                    transaction.update(newOdpRef, {
                                                        portMapping: updatedNewPortMapping,
                                                        usedPorts: newOdp.usedPorts + 1,
                                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                                    });
                                                    
                                                    // Update Pelanggan
                                                    transaction.update(db.collection('Pelanggan').doc(id), entityData);
                                                    
                                                    return id;
                                                });
                                        });
                                });
                            } else {
                                // No port change, just update pelanggan
                                return db.collection('Pelanggan').doc(id).update(entityData)
                                    .then(() => id);
                            }
                        } else {
                            throw new Error('Pelanggan tidak ditemukan');
                        }
                    })
                    .then(pelangganId => {
                        showToast('success', 'Berhasil', 'Pelanggan berhasil diperbarui');
                        closeModal();
                        loadTableData(collection);
                        loadMapData();
                        
                        // Log audit
                        db.collection('Pelanggan').doc(id).get()
                            .then(doc => {
                                if (doc.exists) {
                                    logAudit('update', collection, id, doc.data(), entityData);
                                }
                            });
                    })
                    .catch(error => {
                        console.error('Error updating pelanggan:', error);
                        showToast('error', 'Error', `Gagal memperbarui pelanggan: ${error.message}`);
                    });
            }
        }

        // Setup GPS Capture
        function setupGPSCapture(existingLocation = null) {
            const captureBtn = document.getElementById('captureGPSBtn');
            const gpsStatus = document.getElementById('gpsStatus');
            
            if (existingLocation) {
                gpsStatus.textContent = `Lokasi tersimpan (Akurasi: ${existingLocation.accuracy}m)`;
                gpsStatus.classList.add('success');
                
                // Set location input
                const locationInput = document.getElementById(`${getCurrentEntityPrefix()}Location`);
                if (locationInput) {
                    locationInput.value = JSON.stringify(existingLocation);
                }
            }
            
            captureBtn.addEventListener('click', function() {
                if (!navigator.geolocation) {
                    showToast('error', 'Error', 'Geolocation tidak didukung browser ini');
                    return;
                }
                
                // Update UI
                captureBtn.disabled = true;
                gpsStatus.textContent = 'Mendapatkan lokasi...';
                gpsStatus.classList.remove('success', 'error');
                gpsStatus.classList.add('waiting');
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            ts: new Date().toISOString(),
                            deviceId: navigator.userAgent || 'unknown'
                        };
                        
                        // Check accuracy threshold
                        const threshold = userData && userData.gpsAccuracyThreshold ? userData.gpsAccuracyThreshold : 20;
                        
                        if (location.accuracy > threshold) {
                            gpsStatus.textContent = `Akurasi rendah: ${Math.round(location.accuracy)}m (diperlukan ${threshold}m)`;
                            gpsStatus.classList.remove('waiting', 'success');
                            gpsStatus.classList.add('error');
                            captureBtn.disabled = false;
                            
                            showToast('warning', 'Peringatan', `Akurasi GPS rendah (${Math.round(location.accuracy)}m). Disarankan untuk mengambil ulang lokasi.`);
                        } else {
                            gpsStatus.textContent = `Lokasi berhasil (Akurasi: ${Math.round(location.accuracy)}m)`;
                            gpsStatus.classList.remove('waiting', 'error');
                            gpsStatus.classList.add('success');
                            captureBtn.disabled = false;
                            
                            // Set location input
                            const locationInput = document.getElementById(`${getCurrentEntityPrefix()}Location`);
                            if (locationInput) {
                                locationInput.value = JSON.stringify(location);
                            }
                            
                            showToast('success', 'Berhasil', 'Lokasi GPS berhasil ditangkap');
                        }
                    },
                    error => {
                        gpsStatus.textContent = `Gagal: ${error.message}`;
                        gpsStatus.classList.remove('waiting', 'success');
                        gpsStatus.classList.add('error');
                        captureBtn.disabled = false;
                        
                        showToast('error', 'Error', `Gagal mendapatkan lokasi: ${error.message}`);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Setup Photo Upload
        function setupPhotoUpload(existingPhotoUrl = null) {
            const photoPreview = document.getElementById('photoPreview');
            const photoInput = document.getElementById('photoInput');
            
            if (existingPhotoUrl) {
                photoPreview.innerHTML = `<img src="${existingPhotoUrl}" alt="Foto Pelanggan">`;
            }
            
            photoPreview.addEventListener('click', function() {
                photoInput.click();
            });
            
            photoInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        photoPreview.innerHTML = `<img src="${e.target.result}" alt="Foto Pelanggan">`;
                    };
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }

        // Upload Photo
        function uploadPhoto(file) {
            return new Promise((resolve, reject) => {
                const storageRef = storage.ref();
                const photoRef = storageRef.child(`pelanggan_photos/${currentUser.uid}/${Date.now()}_${file.name}`);
                
                const uploadTask = photoRef.put(file);
                
                uploadTask.on('state_changed',
                    snapshot => {
                        // Progress indicator could be added here
                    },
                    error => {
                        reject(error);
                    },
                    () => {
                        uploadTask.snapshot.ref.getDownloadURL()
                            .then(downloadURL => {
                                resolve(downloadURL);
                            })
                            .catch(error => {
                                reject(error);
                            });
                    }
                );
            });
        }

        // Load OLT Options
        function loadOLTOptions(selectId, selectedValue) {
            const select = document.getElementById(selectId);
            
            db.collection('OLT').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const olt = { id: doc.id, ...doc.data() };
                        const option = document.createElement('option');
                        option.value = olt.id;
                        option.textContent = `${olt.code} - ${olt.name}`;
                        
                        if (selectedValue === olt.id) {
                            option.selected = true;
                        }
                        
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading OLT options:', error);
                });
        }

        // Load ODC Options
        function loadODCOptions(selectId, selectedValue) {
            const select = document.getElementById(selectId);
            
            db.collection('ODC').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const odc = { id: doc.id, ...doc.data() };
                        const option = document.createElement('option');
                        option.value = odc.id;
                        option.textContent = `${odc.code} - ${odc.name}`;
                        
                        if (selectedValue === odc.id) {
                            option.selected = true;
                        }
                        
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading ODC options:', error);
                });
        }

        // Load Feeder Panel Options
        function loadFeederPanelOptions(selectId, selectedValue) {
            const select = document.getElementById(selectId);
            
            db.collection('FeederPanel').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const feeder = { id: doc.id, ...doc.data() };
                        const option = document.createElement('option');
                        option.value = feeder.id;
                        option.textContent = `${feeder.code} - ${feeder.name}`;
                        
                        if (selectedValue === feeder.id) {
                            option.selected = true;
                        }
                        
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading Feeder Panel options:', error);
                });
        }

        // Load Distrib Panel Options
        function loadDistribPanelOptions(selectId, selectedValue) {
            const select = document.getElementById(selectId);
            
            db.collection('DistribPanel').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const distrib = { id: doc.id, ...doc.data() };
                        const option = document.createElement('option');
                        option.value = distrib.id;
                        option.textContent = `${distrib.code} - ${distrib.name}`;
                        
                        if (selectedValue === distrib.id) {
                            option.selected = true;
                        }
                        
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading Distrib Panel options:', error);
                });
        }

        // Load ODP Options
        function loadODPOptions(selectId, selectedValue) {
            const select = document.getElementById(selectId);
            
            db.collection('ODP').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const odp = { id: doc.id, ...doc.data() };
                        const capacityPercent = odp.totalPorts > 0 ? Math.round((odp.usedPorts / odp.totalPorts) * 100) : 0;
                        
                        // Only show ODPs with available ports
                        if (capacityPercent < 100) {
                            const option = document.createElement('option');
                            option.value = odp.id;
                            option.textContent = `${odp.code} - ${odp.name} (${odp.totalPorts - odp.usedPorts} port tersedia)`;
                            
                            if (selectedValue === odp.id) {
                                option.selected = true;
                            }
                            
                            select.appendChild(option);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading ODP options:', error);
                });
        }

        // Load Connected ODCs
        function loadConnectedODCs(oltId, containerId) {
            const container = document.getElementById(containerId);
            
            db.collection('ODC').where('oltRef', '==', oltId).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<p style="color: var(--secondary-color);">Tidak ada ODC terhubung</p>';
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    snapshot.forEach(doc => {
                        const odc = { id: doc.id, ...doc.data() };
                        html += `
                            <div style="padding: 10px; background-color: var(--light-color); border-radius: 6px;">
                                <div style="font-weight: 500;">${odc.code} - ${odc.name}</div>
                                <div style="font-size: 12px; color: var(--secondary-color);">Slot: ${odc.oltSlot || '-'}, Port: ${odc.oltPort || '-'}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading connected ODCs:', error);
                    container.innerHTML = '<p style="color: var(--danger-color);">Gagal memuat data</p>';
                });
        }

        // Load Connected ODPs
        function loadConnectedODPs(odcId, containerId) {
            const container = document.getElementById(containerId);
            
            db.collection('ODP').where('odcRef', '==', odcId).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<p style="color: var(--secondary-color);">Tidak ada ODP terhubung</p>';
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    snapshot.forEach(doc => {
                        const odp = { id: doc.id, ...doc.data() };
                        const capacityPercent = odp.totalPorts > 0 ? Math.round((odp.usedPorts / odp.totalPorts) * 100) : 0;
                        
                        html += `
                            <div style="padding: 10px; background-color: var(--light-color); border-radius: 6px;">
                                <div style="font-weight: 500;">${odp.code} - ${odp.name}</div>
                                <div style="font-size: 12px; color: var(--secondary-color);">Kapasitas: ${odp.usedPorts}/${odp.totalPorts} (${capacityPercent}%)</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading connected ODPs:', error);
                    container.innerHTML = '<p style="color: var(--danger-color);">Gagal memuat data</p>';
                });
        }

        // Load Connected ODCs by Feeder
        function loadConnectedODCsByFeeder(feederId, containerId) {
            const container = document.getElementById(containerId);
            
            db.collection('ODC').where('feederPanelRef', '==', feederId).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<p style="color: var(--secondary-color);">Tidak ada ODC terhubung</p>';
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    snapshot.forEach(doc => {
                        const odc = { id: doc.id, ...doc.data() };
                        html += `
                            <div style="padding: 10px; background-color: var(--light-color); border-radius: 6px;">
                                <div style="font-weight: 500;">${odc.code} - ${odc.name}</div>
                                <div style="font-size: 12px; color: var(--secondary-color);">Port: ${odc.feederPort || '-'}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading connected ODCs:', error);
                    container.innerHTML = '<p style="color: var(--danger-color);">Gagal memuat data</p>';
                });
        }

        // Load Connected ODPs by Distrib
        function loadConnectedODPsByDistrib(distribId, containerId) {
            const container = document.getElementById(containerId);
            
            db.collection('ODP').where('panelDistRef', '==', distribId).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<p style="color: var(--secondary-color);">Tidak ada ODP terhubung</p>';
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    snapshot.forEach(doc => {
                        const odp = { id: doc.id, ...doc.data() };
                        const capacityPercent = odp.totalPorts > 0 ? Math.round((odp.usedPorts / odp.totalPorts) * 100) : 0;
                        
                        html += `
                            <div style="padding: 10px; background-color: var(--light-color); border-radius: 6px;">
                                <div style="font-weight: 500;">${odp.code} - ${odp.name}</div>
                                <div style="font-size: 12px; color: var(--secondary-color);">Port: ${odp.panelDistPort || '-'}, Kapasitas: ${odp.usedPorts}/${odp.totalPorts} (${capacityPercent}%)</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading connected ODPs:', error);
                    container.innerHTML = '<p style="color: var(--danger-color);">Gagal memuat data</p>';
                });
        }

        // Load Port Mapping
        function loadPortMapping(odpId, containerId) {
            const container = document.getElementById(containerId);
            
            db.collection('ODP').doc(odpId).get()
                .then(doc => {
                    if (doc.exists) {
                        const odp = { id: doc.id, ...doc.data() };
                        
                        if (!odp.portMapping || Object.keys(odp.portMapping).length === 0) {
                            container.innerHTML = '<p style="color: var(--secondary-color);">Tidak ada port mapping</p>';
                            return;
                        }
                        
                        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">';
                        
                        Object.keys(odp.portMapping).sort((a, b) => parseInt(a) - parseInt(b)).forEach(portNum => {
                            const port = odp.portMapping[portNum];
                            const statusClass = port.status === 'available' ? 'success' : 'danger';
                            
                            html += `
                                <div style="padding: 10px; background-color: var(--light-color); border-radius: 6px; text-align: center;">
                                    <div style="font-weight: 500;">Port ${portNum}</div>
                                    <div style="font-size: 12px;">
                                        <span class="status-badge ${port.status}">${port.status}</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p style="color: var(--danger-color);">ODP tidak ditemukan</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading port mapping:', error);
                    container.innerHTML = '<p style="color: var(--danger-color);">Gagal memuat data</p>';
                });
        }

        // Load Connected Pelanggan
        function loadConnectedPelanggan(odpId, containerId) {
            const container = document.getElementById(containerId);
            
            db.collection('Pelanggan').where('odpRef', '==', odpId).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<p style="color: var(--secondary-color);">Tidak ada pelanggan terhubung</p>';
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    snapshot.forEach(doc => {
                        const pelanggan = { id: doc.id, ...doc.data() };
                        html += `
                            <div style="padding: 10px; background-color: var(--light-color); border-radius: 6px;">
                                <div style="font-weight: 500;">${pelanggan.name}</div>
                                <div style="font-size: 12px; color: var(--secondary-color);">No: ${pelanggan.customerNumber}, Port: ${pelanggan.odpPort}</div>
                                <div style="font-size: 12px;">
                                    <span class="status-badge ${pelanggan.status}">${pelanggan.status}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading connected pelanggan:', error);
                    container.innerHTML = '<p style="color: var(--danger-color);">Gagal memuat data</p>';
                });
        }

        // Load Connection Path
        function loadConnectionPath(pelanggan, containerId) {
            const container = document.getElementById(containerId);
            
            // Get the full connection path
            const path = [];
            
            // Add Pelanggan
            path.push({
                name: pelanggan.name,
                type: 'Pelanggan',
                id: pelanggan.id
            });
            
            // Add ODP
            if (pelanggan.odpRef) {
                path.push({
                    name: `ODP: ${pelanggan.odpRef}`,
                    type: 'ODP',
                    id: pelanggan.odpRef
                });
            }
            
            // Add ODC
            if (pelanggan.odcRef) {
                path.push({
                    name: `ODC: ${pelanggan.odcRef}`,
                    type: 'ODC',
                    id: pelanggan.odcRef
                });
            }
            
            // Add OLT
            if (pelanggan.oltRef) {
                path.push({
                    name: `OLT: ${pelanggan.oltRef}`,
                    type: 'OLT',
                    id: pelanggan.oltRef
                });
            }
            
            // Generate HTML
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            path.forEach((item, index) => {
                html += `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: 500;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${item.name}</div>
                            <div style="font-size: 12px; color: var(--secondary-color);">${item.type}</div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showEntityDetail('${item.type}', '${item.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                `;
                
                // Add arrow between items
                if (index < path.length - 1) {
                    html += `
                        <div style="display: flex; justify-content: center;">
                            <i class="fas fa-arrow-down" style="color: var(--primary-color);"></i>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Load Material Usage
        function loadMaterialUsage(materialId, containerId) {
            const container = document.getElementById(containerId);
            
            // This would typically query audit logs for material usage
            // For now, we'll just show a placeholder
            container.innerHTML = '<p style="color: var(--secondary-color);">Riwayat penggunaan material akan ditampilkan di sini</p>';
        }

        // Handle Export
        function handleExport() {
            const collection = getCurrentCollection();
            
            // Show loading
            showToast('info', 'Info', 'Mengekspor data...');
            
            db.collection(collection).get()
                .then(snapshot => {
                    let csv = '';
                    
                    // Get headers
                    const headers = getTableHeaders(collection);
                    csv += headers.join(',') + '\n';
                    
                    // Get data
                    snapshot.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        const row = [];
                        
                        headers.forEach(header => {
                            // Map header to field
                            let value = '';
                            
                            switch (collection) {
                                case 'OLT':
                                    if (header === 'Kode') value = data.code || '';
                                    else if (header === 'Nama') value = data.name || '';
                                    else if (header === 'Lokasi Rak') value = data.rack_location || '';
                                    else if (header === 'Model') value = data.model || '';
                                    else if (header === 'Total Slot') value = data.total_slots || '';
                                    else if (header === 'Port/Slot') value = data.ports_per_slot || '';
                                    break;
                                case 'ODC':
                                    if (header === 'Kode') value = data.code || '';
                                    else if (header === 'Nama') value = data.name || '';
                                    else if (header === 'Alamat') value = data.address || '';
                                    else if (header === 'OLT') value = data.oltRef || '';
                                    else if (header === 'Slot OLT') value = data.oltSlot || '';
                                    else if (header === 'Port OLT') value = data.oltPort || '';
                                    break;
                                case 'FeederPanel':
                                    if (header === 'Kode') value = data.code || '';
                                    else if (header === 'Nama') value = data.name || '';
                                    else if (header === 'Total Port') value = data.total_ports || '';
                                    break;
                                case 'DistribPanel':
                                    if (header === 'Kode') value = data.code || '';
                                    else if (header === 'Nama') value = data.name || '';
                                    else if (header === 'Feeder Panel') value = data.feederPanelRef || '';
                                    else if (header === 'Port Feeder') value = data.feederPort || '';
                                    else if (header === 'Splitter') value = data.splitterType || '';
                                    else if (header === 'Total Port') value = data.total_ports || '';
                                    break;
                                case 'ODP':
                                    if (header === 'Kode') value = data.code || '';
                                    else if (header === 'Nama') value = data.name || '';
                                    else if (header === 'ODC') value = data.odcRef || '';
                                    else if (header === 'Total Port') value = data.totalPorts || '';
                                    else if (header === 'Port Terpakai') value = data.usedPorts || '';
                                    else if (header === 'Kapasitas') {
                                        const capacityPercent = data.totalPorts > 0 ? Math.round((data.usedPorts / data.totalPorts) * 100) : 0;
                                        value = `${capacityPercent}%`;
                                    }
                                    break;
                                case 'Pelanggan':
                                    if (header === 'No. Pelanggan') value = data.customerNumber || '';
                                    else if (header === 'Nama') value = data.name || '';
                                    else if (header === 'Alamat') value = data.address || '';
                                    else if (header === 'ODP') value = data.odpRef || '';
                                    else if (header === 'Port ODP') value = data.odpPort || '';
                                    else if (header === 'Status') value = data.status || '';
                                    break;
                                case 'Material':
                                    if (header === 'Tipe') value = data.type || '';
                                    else if (header === 'Model') value = data.model || '';
                                    else if (header === 'Spesifikasi') value = data.spec || '';
                                    else if (header === 'Jumlah') value = data.quantity_onhand || '';
                                    else if (header === 'Satuan') value = data.unit || '';
                                    break;
                            }
                            
                            // Escape commas and quotes
                            value = String(value).replace(/"/g, '""');
                            if (value.includes(',')) {
                                value = `"${value}"`;
                            }
                            
                            row.push(value);
                        });
                        
                        csv += row.join(',') + '\n';
                    });
                    
                    // Create download link
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${collection}_${new Date().toISOString().slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast('success', 'Berhasil', 'Data berhasil diekspor');
                })
                .catch(error => {
                    console.error('Error exporting data:', error);
                    showToast('error', 'Error', `Gagal mengekspor data: ${error.message}`);
                });
        }

        // Generate Report
        function generateReport() {
            showToast('info', 'Info', 'Membuat laporan...');
            
            // This would typically generate a comprehensive report
            // For now, we'll just export the current data
            handleExport();
        }

        // Add to Offline Queue
        function addToOfflineQueue(action, collection, data) {
            const operation = {
                id: Date.now().toString(),
                action: action,
                collection: collection,
                data: data,
                timestamp: new Date().toISOString()
            };
            
            offlineQueue.push(operation);
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
        }

        // Process Offline Queue
        function processOfflineQueue() {
            if (offlineQueue.length === 0) return;
            
            showToast('info', 'Sinkronisasi', `Memproses ${offlineQueue.length} operasi offline...`);
            
            // Process operations in order
            const processNext = () => {
                if (offlineQueue.length === 0) {
                    showToast('success', 'Sinkronisasi', 'Semua operasi offline berhasil disinkronkan');
                    return;
                }
                
                const operation = offlineQueue[0];
                
                let promise;
                
                if (operation.action === 'create') {
                    promise = db.collection(operation.collection).add(operation.data);
                } else if (operation.action === 'update') {
                    const { id, ...data } = operation.data;
                    promise = db.collection(operation.collection).doc(id).update(data);
                } else if (operation.action === 'delete') {
                    promise = db.collection(operation.collection).doc(operation.data.id).delete();
                }
                
                if (promise) {
                    promise
                        .then(() => {
                            // Remove processed operation
                            offlineQueue.shift();
                            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                            
                            // Process next
                            processNext();
                        })
                        .catch(error => {
                            console.error('Error processing offline operation:', error);
                            showToast('error', 'Error', `Gagal memproses operasi: ${error.message}`);
                        });
                }
            };
            
            processNext();
        }

        // Log Audit
        function logAudit(action, entityType, entityId, before, after) {
            const auditData = {
                action: action,
                entityType: entityType,
                entityId: entityId,
                before: before,
                after: after,
                userId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                gpsLocation: null // Could capture current GPS if needed
            };
            
            db.collection('AuditLog').add(auditData)
                .catch(error => {
                    console.error('Error logging audit:', error);
                });
        }

        // Get Entity Name
        function getEntityName(collection) {
            switch (collection) {
                case 'OLT': return 'OLT';
                case 'ODC': return 'ODC';
                case 'FeederPanel': return 'Feeder Panel';
                case 'DistribPanel': return 'Panel Distribusi';
                case 'ODP': return 'ODP';
                case 'Pelanggan': return 'Pelanggan';
                case 'Material': return 'Material';
                default: return 'Entitas';
            }
        }

        // Get Current Entity Prefix
        function getCurrentEntityPrefix() {
            switch (getCurrentCollection()) {
                case 'OLT': return 'olt';
                case 'ODC': return 'odc';
                case 'FeederPanel': return 'feeder';
                case 'DistribPanel': return 'distrib';
                case 'ODP': return 'odp';
                case 'Pelanggan': return 'pelanggan';
                case 'Material': return 'material';
                default: return '';
            }
        }

        // Modal Functions
        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Slide Over Functions
        function openSlideOver() {
            document.getElementById('slideOver').classList.add('active');
        }

        function closeSlideOver() {
            document.getElementById('slideOver').classList.remove('active');
        }

        // Toast Notification
        function showToast(type, title, message) {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '';
            switch (type) {
                case 'success': icon = 'fa-check-circle'; break;
                case 'error': icon = 'fa-exclamation-circle'; break;
                case 'warning': icon = 'fa-exclamation-triangle'; break;
                case 'info': icon = 'fa-info-circle'; break;
            }
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto hide after 5 seconds
            const autoHideTimeout = setTimeout(() => {
                hideToast(toast);
            }, 5000);
            
            // Close button
            toast.querySelector('.toast-close').addEventListener('click', () => {
                clearTimeout(autoHideTimeout);
                hideToast(toast);
            });
        }

        function hideToast(toast) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }

        // Create Demo Data
        function createDemoData() {
            // This function would create realistic demo data
            // For now, we'll just create a few sample records
            
            // Demo OLT
            const demoOLT = {
                code: 'OLT-001',
                name: 'OLT Jakarta Pusat',
                rack_location: 'Rack A-01',
                model: 'Huawei MA5800',
                total_slots: 16,
                ports_per_slot: 16,
                location: {
                    lat: -6.2088,
                    lng: 106.8456,
                    accuracy: 10,
                    ts: new Date().toISOString(),
                    deviceId: 'demo-device'
                },
                notes: 'OLT utama untuk area Jakarta Pusat',
                createdBy: 'demo-user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Demo ODC
            const demoODC = {
                code: 'ODC-001',
                name: 'ODC Menteng',
                address: 'Jl. Menteng Raya No. 123',
                oltRef: '',
                oltSlot: 1,
                oltPort: 1,
                location: {
                    lat: -6.1944,
                    lng: 106.8229,
                    accuracy: 10,
                    ts: new Date().toISOString(),
                    deviceId: 'demo-device'
                },
                notes: 'ODC untuk area Menteng',
                createdBy: 'demo-user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Demo ODP
            const demoODP = {
                code: 'ODP-001',
                name: 'ODP Menteng 1',
                odcRef: '',
                totalPorts: 16,
                usedPorts: 5,
                portMapping: {},
                splitterType: '1:16',
                location: {
                    lat: -6.1950,
                    lng: 106.8230,
                    accuracy: 10,
                    ts: new Date().toISOString(),
                    deviceId: 'demo-device'
                },
                notes: 'ODP untuk cluster Menteng 1',
                createdBy: 'demo-user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Initialize port mapping
            for (let i = 1; i <= demoODP.totalPorts; i++) {
                demoODP.portMapping[i] = {
                    status: i <= 5 ? 'used' : 'available',
                    pelangganRef: i <= 5 ? `pelanggan-${i}` : null,
                    assignedAt: i <= 5 ? firebase.firestore.FieldValue.serverTimestamp() : null
                };
            }
            
            // Demo Pelanggan
            const demoPelanggan = [
                {
                    name: 'Ahmad Wijaya',
                    customerNumber: 'CUST-001',
                    address: 'Jl. Menteng Raya No. 45',
                    odpRef: '',
                    odpPort: 1,
                    status: 'active',
                    location: {
                        lat: -6.1951,
                        lng: 106.8231,
                        accuracy: 10,
                        ts: new Date().toISOString(),
                        deviceId: 'demo-device'
                    },
                    createdBy: 'demo-user',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    name: 'Siti Nurhaliza',
                    customerNumber: 'CUST-002',
                    address: 'Jl. Menteng Raya No. 67',
                    odpRef: '',
                    odpPort: 2,
                    status: 'active',
                    location: {
                        lat: -6.1952,
                        lng: 106.8232,
                        accuracy: 10,
                        ts: new Date().toISOString(),
                        deviceId: 'demo-device'
                    },
                    createdBy: 'demo-user',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];
            
            // Create demo users
            const demoUsers = [
                {
                    uid: 'admin-user',
                    email: 'admin@ftth.com',
                    name: 'Admin User',
                    role: 'Admin',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    uid: 'planner-user',
                    email: 'planner@ftth.com',
                    name: 'Planner User',
                    role: 'Planner',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    uid: 'technician-user',
                    email: 'technician@ftth.com',
                    name: 'Technician User',
                    role: 'Technician',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    uid: 'viewer-user',
                    email: 'viewer@ftth.com',
                    name: 'Viewer User',
                    role: 'Viewer',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];
            
            // Add demo data to Firestore
            db.collection('OLT').add(demoOLT)
                .then(oltRef => {
                    demoODC.oltRef = oltRef.id;
                    return db.collection('ODC').add(demoODC);
                })
                .then(odcRef => {
                    demoODP.odcRef = odcRef.id;
                    return db.collection('ODP').add(demoODP);
                })
                .then(odpRef => {
                    demoPelanggan.forEach(pelanggan => {
                        pelanggan.odpRef = odpRef.id;
                        db.collection('Pelanggan').add(pelanggan);
                    });
                    
                    // Add demo users
                    demoUsers.forEach(user => {
                        db.collection('users').doc(user.uid).set(user);
                    });
                    
                    showToast('success', 'Berhasil', 'Data demo berhasil dibuat');
                })
                .catch(error => {
                    console.error('Error creating demo data:', error);
                    showToast('error', 'Error', `Gagal membuat data demo: ${error.message}`);
                });
        }

        // Check if demo data exists
        function checkDemoData() {
            db.collection('OLT').limit(1).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        // No data exists, create demo data
                        createDemoData();
                    }
                })
                .catch(error => {
                    console.error('Error checking demo data:', error);
                });
        }

        // Initialize demo data after login
        auth.onAuthStateChanged(function(user) {
            if (user) {
                // Check if demo data exists
                setTimeout(checkDemoData, 2000);
            }
        });
    </script>
</body>
</html>
