<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTTH Network Management System v2.0</title>

    <!-- Tambahkan di HEAD, setelah Firebase scripts -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
    // Init EmailJS dengan Public Key Anda
    emailjs.init("vbjhrBXWJrdgku8--");
</script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (Peta) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS untuk Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- ⭐⭐ TAMBAH INI ⭐⭐ -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
    emailjs.init("vbjhrBXWJrdgku8--"); // Ganti dengan Public Key Anda
</script>
   
    <style>
        /* Custom styles */
        .leaflet-popup-content-wrapper { 
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            border: 0; /* border-0 */
        }
        .leaflet-popup-content { 
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
        }
        .leaflet-popup-tip { 
            box-shadow: none; /* shadow-none */
        }

        /* PERBAIKI TOMBOL TAMBAH BARU - PASTIKAN HORIZONTAL */
#add-new-button {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.1rem !important;
}

/* Force horizontal layout untuk semua tombol dengan icon */
.flex.items-center.space-x-2 {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 0.1rem !important;
}

/* Pastikan icon dan text sejajar */
#add-new-button i {
    margin-right: 0.5rem !important;
    margin-bottom: 1rem !important;
}

        /* PERBAIKI TOMBOL DI TABLE HEADER */
#import-button,
#export-button,
#add-new-button {
    padding: 0.1rem 1rem !important;
    font-size: 0.880rem !important;
    height: 2rem !important;
}

/* Kurangi padding dan ukuran font tombol */
.bg-blue-600.text-white.font-bold.py-2.px-4.rounded-lg {
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
    font-size: 0.875rem !important;
}

/* Tombol yang terlalu gemuk */
.hover\:bg-blue-700 {
    padding: 0.5rem 1rem !important;
}

/* CARD DASHBOARD - UJUNG LEBIH BULAT */
.dashboard-card {
    border-radius: 10px !important;
}

/* CARD DASHBOARD - TULISAN JANGAN TEPAT DI UJUNG */
.dashboard-card > div {
    padding: 1.10rem !important;
}
        
        /* Sidebar transition */
        #sidebar { transition: margin-left 0.3s ease-in-out; }
        #main-content { transition: margin-left 0.3s ease-in-out; }
        .sidebar-collapsed { margin-left: -256px; }

        /* PERMANENT SIDEBAR FIX */
.nav-link {
    display: flex !important;
    align-items: center !important;
    padding: 0.75rem 1.5rem !important;
}

.nav-link i {
    width: 1.25rem !important;
    height: 1.25rem !important;
    margin-right: 0.75rem !important;
    flex-shrink: 0 !important;
}

.nav-link span {
    white-space: nowrap !important;
    flex: 1 !important;
}
        
        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ticket status badges */
       .status-badge {
        padding: 0.5rem 0.5rem; /* px-2 py-1 */
        border-radius: 9999px; /* rounded-full */
        font-size: 0.75rem; /* text-xs */
        line-height: 1rem;
        font-weight: 500; /* font-medium */
        }
        .status-open { background-color: #FEE2E2; color: #991B1B; } /* bg-red-100 text-red-800 */
        .status-progress { background-color: #FEF3C7; color: #92400E; } /* bg-yellow-100 text-yellow-800 */
        .status-pending { background-color: #FED7AA; color: #9A3412; } /* bg-orange-100 text-orange-800 */
        .status-closed { background-color: #D1FAE5; color: #065F46; } /* bg-green-100 text-green-800 */

        /* ONT status badges */
        .ont-status-gudang { background-color: #DBEAFE; color: #1E40AF; } /* bg-blue-100 text-blue-800 */
        .ont-status-terpasang { background-color: #D1FAE5; color: #065F46; } /* bg-green-100 text-green-800 */
        .ont-status-rusak { background-color: #FEE2E2; color: #991B1B; } /* bg-red-100 text-red-800 */
        .ont-status-ganti-ont { background-color: #FED7AA; color: #9A3412; } /* bg-orange-100 text-orange-800 */
        .ont-status-on-progress { background-color: #E9D5FF; color: #6B21A8; } /* bg-purple-100 text-purple-800 */
        
        /* Capacity indicators */
        .capacity-indicator {
            height: 8px;
            border-radius: 4px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .capacity-bar {
            height: 100%;
            transition: width 0.3s ease;
        }
        .capacity-low { background-color: #10b981; }
        .capacity-medium { background-color: #f59e0b; }
        .capacity-high { background-color: #ef4444; }
        
        /* TTR Status Indicators */
        .ttr-good { background-color: #10b981; }
        .ttr-warning { background-color: #f59e0b; }
        .ttr-overdue { background-color: #ef4444; }
        
        /* Dark mode styles */
        /* Dark mode styles */
        body.dark-mode {
            background-color: #111827; /* bg-gray-900 */
        }
        body.dark-mode .bg-white {
            background-color: #1F2937; /* bg-gray-800 */
            color: #FFFFFF; /* text-white */
        }
        body.dark-mode .bg-gray-50 {
            background-color: #374151; /* bg-gray-700 */
        }
        body.dark-mode .text-gray-800 {
            color: #E5E7EB; /* text-gray-200 */
        }
        body.dark-mode .text-gray-700 {
            color: #D1D5DB; /* text-gray-300 */
        }
        body.dark-mode .text-gray-600 {
            color: #9CA3AF; /* text-gray-400 */
        }
        body.dark-mode .border-gray-200 {
            border-color: #374151; /* border-gray-700 */
        }
        body.dark-mode .border-gray-300 {
            border-color: #4B5563; /* border-gray-600 */
        }
        
        /* Session warning */
        .session-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            max-width: 350px;
        }
        
        /* Connection lines */
        .connection-line {
            stroke: #3b82f6;
            stroke-width: 3;
            stroke-opacity: 0.7;
            fill: none;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        
        /* Role-based UI elements */
        .admin-only { display: none; }
        .role-admin .admin-only { display: block; }
        .role-admin .admin-only-flex { display: flex; }
        
        .teknisi-only { display: none; }
        .role-teknisi .teknisi-only { display: block; }
        .role-teknisi .teknisi-only-flex { display: flex; }
        
        .operator-only { display: none; }
        .role-operator .operator-only { display: block; }
        .role-operator .operator-only-flex { display: flex; }
        
        .gudang-only { display: none; }
        .role-gudang .gudang-only { display: block; }
        .role-gudang .gudang-only-flex { display: flex; }
        
        /* NEW STYLES FOR ENHANCED FEATURES */
        .owner-only { display: none; }
        .role-owner .owner-only { display: block; }
        .role-owner .owner-only-flex { display: flex; }
        
        /* Enhanced dropdown styles */
        .enhanced-dropdown {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Form validation styles */
.form-error {
    color: #EF4444; /* text-red-500 */
    font-size: 0.75rem; /* text-xs */
    line-height: 1rem;
    margin-top: 0.25rem; /* mt-1 */
}

.input-error {
    border-color: #EF4444; /* border-red-500 */
    box-shadow: 0 0 0 2px #FEE2E2; /* ring-2 ring-red-200 */
}

.error-message {
    background-color: #FEF2F2; /* bg-red-50 */
    border: 1px solid #FECACA; /* border border-red-200 */
    color: #B91C1C; /* text-red-700 */
    padding: 0.75rem 1rem; /* py-3 px-4 */
    border-radius: 0.5rem; /* rounded-lg */
    margin-bottom: 1rem; /* mb-4 */
}

.form-success {
    color: #10B981; /* text-green-500 */
    font-size: 0.75rem; /* text-xs */
    line-height: 1rem;
    margin-top: 0.25rem; /* mt-1 */
}
        
        /* Sidebar scroll */
        .sidebar-scroll {
            height: calc(100vh - 64px);
            overflow-y: auto;
        }
        
        /* Inventory status indicators */
.inventory-status-high { background-color: #D1FAE5; color: #065F46; } /* bg-green-100 text-green-800 */
.inventory-status-medium { background-color: #FEF3C7; color: #92400E; } /* bg-yellow-100 text-yellow-800 */
.inventory-status-low { background-color: #FED7AA; color: #9A3412; } /* bg-orange-100 text-orange-800 */
.inventory-status-out { background-color: #FEE2E2; color: #991B1B; } /* bg-red-100 text-red-800 */

/* Backup/Restore styles */
.backup-section {
    background-color: #FFFFFF; /* bg-white */
    padding: 1.5rem; /* p-6 */
    border-radius: 0.5rem; /* rounded-lg */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
    margin-bottom: 1.5rem; /* mb-6 */
}

.dashboard-card {
    padding: 1.5rem; /* p-6 */
    border-radius: 0.5rem; /* rounded-lg */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
    transition: box-shadow 0.3s; /* transition-shadow duration-300 */
    cursor: pointer;
    background: linear-gradient(135deg, var(--color-from), var(--color-to)); /* Ini sudah benar */
}

.dashboard-card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* hover:shadow-lg */
}
        
        /* Toast notification styles */
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        .toast-warning { background-color: #f59e0b; }
        .toast-info { background-color: #3b82f6; }

        #notification-toast {
    z-index: 9999;
    pointer-events: auto;
}

/* Animasi untuk toast */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Pastikan toast di atas modal */
.z-50 {
    z-index: 50;
}
        
        /* Mobile responsive improvements */
        @media (max-width: 640px) {
            .mobile-stack {
                flex-direction: column;
            }
            .mobile-full {
                width: 100%;
            }
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* NEW: Enhanced dashboard cards */
        .dashboard-card {
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            transition: box-shadow 0.3s; /* transition-shadow duration-300 */
            cursor: pointer;
            background: linear-gradient(135deg, var(--color-from), var(--color-to));
        }

.dashboard-card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* hover:shadow-lg */
}
        
        /* NEW: Custom dropdown scroll */
        .dropdown-scroll {
            max-height: 150px;
            overflow-y: auto;
        }
        
        /* NEW: Warning modal */
        .warning-modal {
            background: rgba(0, 0, 0, 0.5);
        }
        
        /* NEW: Notification toast positioning */
        #notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: rgb(255, 2, 2);
            transition: opacity 0.3s ease;
        }

        /* DETAIL MODAL STYLING */
#detail-modal .bg-white {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

#detail-content .bg-white {
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- MODAL DETAIL ELEGAN -->
<div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
    <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 id="detail-title" class="text-2xl font-bold text-gray-800">Detail Data</h2>
            <button type="button" id="close-detail-modal" class="p-1 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div id="detail-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Konten detail akan di-inject di sini -->
        </div>

        <div class="mt-8 flex justify-end">
            <button type="button" id="close-detail-button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                Tutup
            </button>
        </div>
    </div>
</div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-800">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-600">FTTH Network v2.0</h1>
                <p class="text-gray-600 mt-2">Silakan login untuk melanjutkan</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin@ftth.com">
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                    <span id="login-button-text">Login</span>
                    <div id="login-spinner" class="loader w-5 h-5 border-2 border-t-blue-200 ml-2 hidden"></div>
                </button>
                
                <div id="login-error" class="text-red-600 text-sm text-center hidden"></div>
            </form>
        </div>
    </div>

    <!-- App Loader -->
    <div id="app-loader" class="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center hidden">
        <div class="loader"></div>
        <p class="text-gray-700 mt-4 text-lg">Memuat aplikasi...</p>
    </div>

    <!-- Main App Shell -->
    <div id="app-shell" class="hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-30">
            <div class="flex items-center justify-between p-4 border-b">
                <h1 class="text-xl font-bold text-blue-600">FTTH TOPOLOGY v2.0</h1>
                <button id="sidebar-close-btn" class="sm:hidden p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <nav class="py-4 sidebar-scroll">
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="map">
                    <i data-lucide="map" class="w-5 h-5 mr-3"></i> Peta Jaringan
                </a>
                <div class="px-6 py-2 text-xs font-semibold text-gray-400 uppercase">Aset Jaringan</div>
                
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only operator-only owner-only" data-page="table" data-entity="OLT">
                    <i data-lucide="server" class="w-5 h-5 mr-3"></i> OLT
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only operator-only owner-only" data-page="table" data-entity="ODC">
                    <i data-lucide="server-cog" class="w-5 h-5 mr-3"></i> ODC
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only operator-only owner-only" data-page="table" data-entity="ODP">
                    <i data-lucide="box" class="w-5 h-5 mr-3"></i> ODP
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only operator-only owner-only" data-page="table" data-entity="Pelanggan">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i> Pelanggan
                </a>
                <div class="px-6 py-2 text-xs font-semibold text-gray-400 uppercase">Manajemen</div>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only operator-only owner-only" data-page="table" data-entity="Paket">
                    <i data-lucide="package" class="w-5 h-5 mr-3"></i> Paket Layanan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only owner-only" data-page="table" data-entity="Karyawan">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i> Karyawan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only gudang-only owner-only" data-page="inventory">
                    <i data-lucide="package-2" class="w-5 h-5 mr-3"></i> Inventory
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only operator-only teknisi-only owner-only" data-page="tickets">
                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-3"></i> Manajemen Gangguan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only gudang-only teknisi-only owner-only" data-page="ont-tracking">
                    <i data-lucide="monitor" class="w-5 h-5 mr-3"></i> ONT Tracking
                </a>
                <div class="px-6 py-2 text-xs font-semibold text-gray-400 uppercase">Sistem</div>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only owner-only" data-page="pengaturan">
                    <i data-lucide="settings" class="w-5 h-5 mr-3"></i> Pengaturan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only owner-only" data-page="backup-restore">
                    <i data-lucide="database" class="w-5 h-5 mr-3"></i> Backup & Restore
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 admin-only owner-only" data-page="audit">
                    <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Audit Log
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="ml-0 sm:ml-64 relative min-h-screen">
            <!-- Top Navbar -->
            <header class="sticky top-0 bg-white shadow-md z-20">
                <div class="flex items-center justify-between h-16 px-4 sm:px-8">
                    <button id="sidebar-open-btn" class="p-2 -ml-2 rounded-md sm:hidden">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Online Status Indicator -->
                        <div id="online-status" class="flex items-center space-x-2">
                            <span id="online-indicator" class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span id="online-text" class="text-sm font-medium text-gray-700">Online</span>
                            <span id="offline-queue-count" class="hidden bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </div>
                        <div class="relative" id="user-menu-button">
                            <button class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100">
                                <img src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="User" class="w-8 h-8 rounded-full">
                                <div class="hidden md:block text-left">
                                    <div id="user-name" class="text-sm font-semibold">Nama Lengkap</div>
                                    <div id="user-email" class="text-sm font-semibold">Admin FTTH</div>
                                    <div id="user-role" class="text-xs text-gray-500">Administrator</div>
                                </div>
                            </button>
                            <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content Area -->
            <div class="p-4 sm:p-8">
                
                <!-- Page: Dashboard -->
                <div id="page-dashboard" class="page-content">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                        <div class="text-sm text-gray-600">
                            <span id="current-time" class="font-medium"></span>
                        </div>
                    </div>
                    
                    <!-- Dashboard Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="dashboard-card cursor-pointer" data-entity="ODP" style="--color-from: #3b82f6; --color-to: #1d4ed8;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-white opacity-90">Total ODP</div>
                                    <div id="stat-odp" class="text-3xl font-bold text-white">0</div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i data-lucide="box" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card cursor-pointer" data-entity="Pelanggan" style="--color-from: #10b981; --color-to: #047857;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-white opacity-90">Total Pelanggan</div>
                                    <div id="stat-pelanggan" class="text-3xl font-bold text-white">0</div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i data-lucide="users" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card cursor-pointer" data-entity="OLT" style="--color-from: #8b5cf6; --color-to: #7c3aed;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-white opacity-90">Total OLT</div>
                                    <div id="stat-olt" class="text-3xl font-bold text-white">0</div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i data-lucide="server" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card cursor-pointer" data-entity="Karyawan" style="--color-from: #f59e0b; --color-to: #d97706;">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-white opacity-90">Karyawan</div>
                                    <div id="stat-karyawan" class="text-3xl font-bold text-white">0</div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i data-lucide="user-check" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tickets and ONT Status Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Status Gangguan</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Open</span>
                                    <span id="ticket-open" class="font-bold text-red-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">In Progress</span>
                                    <span id="ticket-progress" class="font-bold text-yellow-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Pending</span>
                                    <span id="ticket-pending" class="font-bold text-orange-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Closed</span>
                                    <span id="ticket-closed" class="font-bold text-green-600">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Status ONT</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Gudang</span>
                                    <span id="ont-gudang" class="font-bold text-blue-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Terpasang</span>
                                    <span id="ont-terpasang" class="font-bold text-green-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Rusak</span>
                                    <span id="ont-rusak" class="font-bold text-red-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">On Progress</span>
                                    <span id="ont-progress" class="font-bold text-purple-600">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TTR Monitoring Section -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">TTR Monitoring (Time to Repair)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-green-600" id="ttr-good">0</div>
                                <div class="text-sm text-gray-600">TTR < 1.5 jam</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-yellow-600" id="ttr-warning">0</div>
                                <div class="text-sm text-gray-600">TTR 1.5 - 3 jam</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-red-600" id="ttr-overdue">0</div>
                                <div class="text-sm text-gray-600">TTR > 3 jam (OVERDUE)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network Status Card -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Status Jaringan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-2">Utilisasi Port ODP</div>
                                <div class="flex items-center">
                                    <div class="flex-1 mr-2">
                                        <div class="capacity-indicator">
                                            <div id="odp-capacity-bar" class="capacity-bar capacity-low" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <span id="odp-capacity-text" class="text-sm font-medium">0%</span>
                                </div>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-2">Utilisasi Port ODC</div>
                                <div class="flex items-center">
                                    <div class="flex-1 mr-2">
                                        <div class="capacity-indicator">
                                            <div id="odc-capacity-bar" class="capacity-bar capacity-low" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <span id="odc-capacity-text" class="text-sm font-medium">0%</span>
                                </div>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-500 mb-2">Utilisasi Port OLT</div>
                                <div class="flex items-center">
                                    <div class="flex-1 mr-2">
                                        <div class="capacity-indicator">
                                            <div id="olt-capacity-bar" class="capacity-bar capacity-low" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <span id="olt-capacity-text" class="text-sm font-medium">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Offline Queue Section -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">Antrian Sinkronisasi Offline</h3>
                            <button id="sync-offline-data" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span>Sinkronisasi</span>
                            </button>
                        </div>
                        <div id="sync-progress" class="hidden mb-4">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="sync-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div id="sync-status" class="text-sm text-gray-600 mt-1">Menyinkronkan data...</div>
                        </div>
                        <div id="offline-queue-list" class="text-gray-600">Tidak ada item dalam antrian.</div>
                    </div>
                </div>

                <!-- Page: Peta Jaringan -->
                <div id="page-map" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Peta Jaringan</h2>
                    
                    <!-- Filter Container -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <!-- Toggle Buttons -->
                        <div class="flex flex-wrap gap-3 mb-4">
                            <button id="toggle-olt" class="px-4 py-2 bg-red-500 text-white rounded-md active">
                                <i data-lucide="server" class="w-4 h-4 inline mr-2"></i>OLT
                            </button>
                            <button id="toggle-odc" class="px-4 py-2 bg-blue-500 text-white rounded-md active">
                                <i data-lucide="server-cog" class="w-4 h-4 inline mr-2"></i>ODC
                            </button>
                            <button id="toggle-odp" class="px-4 py-2 bg-green-500 text-white rounded-md active">
                                <i data-lucide="box" class="w-4 h-4 inline mr-2"></i>ODP
                            </button>
                            <button id="toggle-pelanggan" class="px-4 py-2 bg-yellow-500 text-white rounded-md active">
                                <i data-lucide="user" class="w-4 h-4 inline mr-2"></i>Pelanggan
                            </button>
                            <button id="toggle-connections" class="px-4 py-2 bg-purple-500 text-white rounded-md inactive">
                                <i data-lucide="git-branch" class="w-4 h-4 inline mr-2"></i>Koneksi
                            </button>
                            <button id="clear-connections" class="px-4 py-2 bg-gray-500 text-white rounded-md inactive">
                                <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>Hapus Koneksi
                            </button>
                        </div>
                        
                        <!-- Search Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Device Type Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Perangkat</label>
                                <select id="device-type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Perangkat</option>
                                    <option value="OLT">OLT</option>
                                    <option value="ODC">ODC</option>
                                    <option value="ODP">ODP</option>
                                    <option value="Pelanggan">Pelanggan</option>
                                </select>
                            </div>
                            
                            <!-- Region Code Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kode Wilayah</label>
                                <input type="text" id="region-code-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: SBY">
                            </div>
                            
                            <!-- Sector Code Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kode Sektor</label>
                                <input type="text" id="sector-code-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: FA">
                            </div>
                            
                            <!-- ONT SN Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">SN ONT</label>
                                <input type="text" id="ont-sn-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: ONT123456789">
                            </div>
                        </div>
                        
                        <!-- Apply Filters Button -->
                        <div class="mt-4 flex justify-end">
                            <button id="apply-filters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mr-2 flex items-center">
                                <i data-lucide="filter" class="w-4 h-4 mr-2"></i>Terapkan Filter
                            </button>
                            <button id="reset-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 flex items-center">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>Reset Filter
                            </button>
                        </div>
                    </div>
                    
                    <div id="map-container" class="w-full h-[70vh] rounded-lg shadow-md z-10"></div>
                </div>

                <!-- Page: Tabel Entitas (Dinamis) -->
                <div id="page-table" class="page-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="table-title" class="text-3xl font-bold text-gray-800">Manajemen Aset</h2>
                        <div class="flex space-x-2">
                            <button id="import-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-green-700 admin-only">
                                <i data-lucide="upload" class="w-5 h-5"></i>
                                <span>Import</span>
                            </button>
                            <button id="export-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-green-700">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <span>Export</span>
                            </button>
                            <button id="add-new-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-blue-700 admin-only operator-only">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Tambah Baru</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Section -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="table-search" placeholder="Cari data..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr id="table-header-row">
                                        <!-- Header dinamis di-inject di sini -->
                                    </tr>
                                </thead>
                                <tbody id="table-body" class="divide-y">
                                    <!-- Data dinamis di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <div class="text-sm text-gray-700">
                                Menampilkan <span id="showing-from">0</span> hingga <span id="showing-to">0</span> dari <span id="total-records">0</span> data
                            </div>
                            <div class="flex space-x-2">
                                <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50" disabled>
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                </button>
                                <span id="page-info" class="px-3 py-1">Halaman 1</span>
                                <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50" disabled>
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Inventory -->
                <div id="page-inventory" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Inventory Management</h2>
                    
                    <!-- Inventory Dashboard -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- Stock Overview Cards -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Total Items</div>
                                    <div id="total-items" class="text-3xl font-bold text-gray-800">0</div>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <i data-lucide="package" class="w-8 h-8 text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Low Stock Items</div>
                                    <div id="low-stock-items" class="text-3xl font-bold text-red-600">0</div>
                                </div>
                                <div class="bg-red-100 p-3 rounded-full">
                                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Out of Stock</div>
                                    <div id="out-of-stock" class="text-3xl font-bold text-orange-600">0</div>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-full">
                                    <i data-lucide="x-circle" class="w-8 h-8 text-orange-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Recent Transactions</div>
                                    <div id="recent-transactions" class="text-3xl font-bold text-green-600">0</div>
                                </div>
                                <div class="bg-green-100 p-3 rounded-full">
                                    <i data-lucide="trending-up" class="w-8 h-8 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Inventory Controls -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="inventory-search" placeholder="Cari berdasarkan nama, SN, atau jenis..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div class="flex space-x-2">
                                <select id="inventory-type-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Jenis</option>
                                    <option value="ONT">ONT</option>
                                    <option value="SPLITTER">Splitter</option>
                                    <option value="KABEL">Kabel</option>
                                    <option value="ODP">ODP</option>
                                    <option value="LAINNYA">Lainnya</option>
                                </select>
                                <select id="inventory-status-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Status</option>
                                    <option value="high">Stock Tinggi</option>
                                    <option value="medium">Stock Sedang</option>
                                    <option value="low">Stock Rendah</option>
                                    <option value="out">Habis</option>
                                </select>
                                <button id="add-inventory-masuk" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center space-x-2 gudang-only">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span>Masuk</span>
                                </button>
                                <button id="add-inventory-keluar" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 flex items-center space-x-2 gudang-only">
                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                    <span>Keluar</span>
                                </button>
                                <button id="export-inventory" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 flex items-center space-x-2">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    <span>Export</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Inventory Table -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terakhir Update</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body" class="divide-y">
                                <!-- Data inventory akan di-inject di sini -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Stock Level Legend -->
                    <div class="mt-4 flex items-center justify-between">
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="flex items-center space-x-1">
                                <div class="w-3 h-3 bg-green-500 rounded"></div>
                                <span>Stock Tinggi (>75%)</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <div class="w-3 h-3 bg-yellow-500 rounded"></div>
                                <span>Stock Sedang (25-75%)</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <div class="w-3 h-3 bg-red-500 rounded"></div>
                                <span>Stock Rendah (<25%)</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <div class="w-3 h-3 bg-gray-500 rounded"></div>
                                <span>Habis (0)</span>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">
                            Total: <span id="inventory-total-count">0</span> items
                        </div>
                    </div>
                </div>

                <!-- Page: Manajemen Gangguan -->
                <div id="page-tickets" class="page-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Manajemen Gangguan</h2>
                        <button id="add-ticket-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-blue-700 admin-only operator-only">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span>Buat Ticket Baru</span>
                        </button>
                    </div>
                    
                    <!-- Ticket Filters -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="ticket-status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Status</option>
                                    <option value="open">Open</option>
                                    <option value="progress">In Progress</option>
                                    <option value="pending">Pending</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lapor</label>
                                <input type="date" id="ticket-date-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Teknisi</label>
                                <select id="ticket-teknisi-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Teknisi</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                                <input type="text" id="ticket-search" placeholder="Cari nomor ticket..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="apply-ticket-filters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mr-2">Terapkan Filter</button>
                            <button id="reset-ticket-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">Reset Filter</button>
                        </div>
                    </div>
                    
                    <!-- Tickets Table -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No. Ticket</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No. Internet</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jenis Gangguan</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Teknisi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tanggal Lapor</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Durasi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">TTR Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tickets-table-body" class="divide-y">
                                    <!-- Data tickets akan di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: ONT Tracking -->
                <div id="page-ont-tracking" class="page-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">ONT Tracking</h2>
                        <button id="add-ont-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-blue-700 admin-only gudang-only">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span>Tambah ONT</span>
                        </button>
                    </div>
                    
                    <!-- ONT Filters -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="ont-status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Status</option>
                                    <option value="gudang">Gudang</option>
                                    <option value="terpasang">Terpasang</option>
                                    <option value="rusak">Rusak</option>
                                    <option value="ganti-ont">Ganti ONT</option>
                                    <option value="on-progress">On Progress</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Teknisi</label>
                                <select id="ont-teknisi-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Teknisi</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Ambil</label>
                                <input type="date" id="ont-date-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                                <input type="text" id="ont-search" placeholder="Cari serial number..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="apply-ont-filters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mr-2">Terapkan Filter</button>
                            <button id="reset-ont-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">Reset Filter</button>
                        </div>
                    </div>
                    
                    <!-- ONT Table -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Serial Number</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Teknisi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tanggal Ambil</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tanggal Kembali</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Durasi Pinjaman</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="ont-table-body" class="divide-y">
                                    <!-- Data ONT akan di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Backup & Restore -->
                <div id="page-backup-restore" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Backup & Restore Data</h2>
                    
                    <!-- Backup Section -->
                    <div class="backup-section">
                        <h3 class="text-xl font-semibold mb-4">Backup Data</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Data untuk Backup</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="OLT" checked>
                                        <span class="ml-2">OLT</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="ODC" checked>
                                        <span class="ml-2">ODC</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="ODP" checked>
                                        <span class="ml-2">ODP</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="Pelanggan" checked>
                                        <span class="ml-2">Pelanggan</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="Paket" checked>
                                        <span class="ml-2">Paket Layanan</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="Karyawan" checked>
                                        <span class="ml-2">Karyawan</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="Tickets" checked>
                                        <span class="ml-2">Tickets Gangguan</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="ONTTracking" checked>
                                        <span class="ml-2">ONT Tracking</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="Inventory" checked>
                                        <span class="ml-2">Inventory</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="backup-checkbox" data-entity="AuditLog" checked>
                                        <span class="ml-2">Audit Log</span>
                                    </label>
                                </div>
                            </div>
                            <div class="flex flex-col justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 mb-4">Backup akan mengekspor data terpilih ke file JSON yang dapat diunduh.</p>
                                    <div class="flex items-center space-x-2">
                                        <button id="select-all-backup" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 text-sm">
                                            Pilih Semua
                                        </button>
                                        <button id="deselect-all-backup" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 text-sm">
                                            Batal Semua
                                        </button>
                                    </div>
                                </div>
                                <button id="backup-data" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 flex items-center justify-center space-x-2">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                    <span>Generate Backup</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Restore Section -->
                    <div class="backup-section">
                        <h3 class="text-xl font-semibold mb-4">Restore Data</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload File Backup</label>
                                <input type="file" id="restore-file" accept=".json" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Hanya file JSON yang didukung</p>
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mode Restore</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="restore-mode" value="merge" checked class="mr-2">
                                            <span>Gabungkan dengan data existing</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="restore-mode" value="replace" class="mr-2">
                                            <span>Ganti semua data existing</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 mb-4">Restore akan mengimpor data dari file backup ke sistem.</p>
                                    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">
                                        <p class="text-sm font-medium">PERINGATAN: Restore data akan mempengaruhi data existing di sistem.</p>
                                    </div>
                                </div>
                                <button id="restore-data" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center space-x-2">
                                    <i data-lucide="upload" class="w-5 h-5"></i>
                                    <span>Restore Data</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backup History -->
                    <div class="backup-section">
                        <h3 class="text-xl font-semibold mb-4">Riwayat Backup</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jenis Data</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ukuran</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="backup-history-body">
                                    <tr>
                                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                            <div class="flex flex-col items-center">
                                                <i data-lucide="database" class="w-12 h-12 text-gray-300 mb-2"></i>
                                                <p class="text-lg font-medium">Belum ada riwayat backup</p>
                                                <p class="text-sm">Lakukan backup pertama Anda</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Pengaturan -->
                <div id="page-pengaturan" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Pengaturan Sistem</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Mode Generate Nomor -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Mode Generate Nomor</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Generate Nomor Internet Otomatis</p>
                                        <p class="text-sm text-gray-600">Aktifkan untuk membuat nomor internet otomatis saat tambah pelanggan</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-generate-number" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Format Nomor Internet</label>
                                    <input type="text" id="number-format" value="1000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Contoh: 1000 / 1001 / 1002 (nomer akan berurutan ketika ada pelanggan baru)</p>
                                </div>
                                <button id="save-number-settings" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                    Simpan Pengaturan
                                </button>
                            </div>
                        </div>

                        <!-- Mode Generate Ticket -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Mode Generate Ticket</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Generate Nomor Ticket Otomatis</p>
                                        <p class="text-sm text-gray-600">Aktifkan untuk membuat nomor ticket otomatis saat buat gangguan</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-generate-ticket" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Format Nomor Ticket</label>
                                    <input type="text" id="ticket-format" value="TKT-{YYYY}-{MM}-{SEQ}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Contoh: TC0001 / GGN0001 (Ticket akan berurutan ketika create gangguan baru)</p>
                                </div>
                                <button id="save-ticket-settings" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                    Simpan Pengaturan
                                </button>
                            </div>
                        </div>

                        <!-- TTR Settings -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">TTR Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">TTR Maximum (jam)</label>
                                    <input type="number" id="ttr-max-hours" value="3" min="1" max="24" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Warning Threshold (jam)</label>
                                    <input type="number" id="ttr-warning-hours" value="1.5" min="0.5" max="24" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- Session Management -->
                        <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4">Manajemen Sesi</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Timeout Sesi (menit)</label>
                                    <input type="number" id="session-timeout" value="15" min="5" max="60" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Warning Timeout (menit)</label>
                                    <input type="number" id="warning-timeout" value="13" min="1" max="59" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex items-end">
                                    <button id="save-session-settings" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                        Simpan Pengaturan
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Ubah Password -->
                        <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4">Ubah Password</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Saat Ini</label>
                                    <input type="password" id="current-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Baru</label>
                                    <input type="password" id="new-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Password Baru</label>
                                    <input type="password" id="confirm-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="mt-4">
                                <button id="save-password" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                    Simpan Password
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Audit Log -->
                <div id="page-audit" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Audit Log</h2>
                    
                    <!-- Filter Section -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                <input type="date" id="audit-date-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pengguna</label>
                                <select id="audit-user-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Pengguna</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Aksi</label>
                                <select id="audit-action-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Aksi</option>
                                    <option value="create">Tambah</option>
                                    <option value="update">Edit</option>
                                    <option value="delete">Hapus</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Entitas</label>
                                <select id="audit-entity-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Semua Entitas</option>
                                    <option value="OLT">OLT</option>
                                    <option value="ODC">ODC</option>
                                    <option value="ODP">ODP</option>
                                    <option value="Pelanggan">Pelanggan</option>
                                    <option value="Paket">Paket</option>
                                    <option value="Karyawan">Karyawan</option>
                                    <option value="Tickets">Tickets</option>
                                    <option value="ONTTracking">ONT Tracking</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="apply-audit-filters" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mr-2">Terapkan Filter</button>
                            <button id="reset-audit-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">Reset Filter</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pengguna</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Entitas</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Detail</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-log-body" class="divide-y">
                                    <!-- Data log dinamis di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL FORM (Dinamis) -->
    <div id="form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="entity-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="form-title" class="text-2xl font-bold text-gray-800">Form Entitas</h2>
                <button type="button" id="close-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="form-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Konten form dinamis di-inject di sini -->
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <input type="hidden" id="form-entity-type">
                <input type="hidden" id="form-entity-id">
                <button type="button" id="cancel-modal-button" class="bg-gray-200 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 flex items-center">
                    <span id="submit-button-text">Simpan</span>
                    <div id="submit-spinner" class="loader w-5 h-5 border-2 border-t-blue-200 ml-2 hidden"></div>
                </button>
            </div>
        </form>
    </div>

    <!-- MODAL TICKET -->
    <div id="ticket-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="ticket-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="ticket-form-title" class="text-2xl font-bold text-gray-800">Form Ticket Gangguan</h2>
                <button type="button" id="close-ticket-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Ticket *</label>
                    <input type="text" id="ticket-number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase bg-gray-100" readonly required>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Internet *</label>
                    <select id="ticket-customer" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Pelanggan</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Gangguan *</label>
                    <select id="ticket-jenis" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Jenis Gangguan</option>
                        <option value="Tidak Ada Sinyal">Tidak Ada Sinyal</option>
                        <option value="Sinyal Lemah">Sinyal Lemah</option>
                        <option value="ONT Rusak">ONT Rusak</option>
                        <option value="Kabel Putus">Kabel Putus</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                
                <div id="sn-lama-container" class="md:col-span-2 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number Lama</label>
                    <input type="text" id="ticket-sn-lama" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                </div>
                
                <div id="sn-baru-container" class="md:col-span-2 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number Baru</label>
                    <input type="text" id="ticket-sn-baru" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teknisi</label>
                    <select id="ticket-teknisi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Pilih Teknisi</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lapor *</label>
                    <input type="datetime-local" id="ticket-tanggal-lapor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                    <select id="ticket-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="open">Open</option>
                        <option value="progress">In Progress</option>
                        <option value="pending">Pending</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <input type="hidden" id="ticket-id">
                <button type="button" id="cancel-ticket-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                    Simpan
                </button>
            </div>
        </form>
    </div>

    <!-- MODAL ONT TRACKING -->
    <div id="ont-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="ont-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="ont-form-title" class="text-2xl font-bold text-gray-800">Form ONT Tracking</h2>
                <button type="button" id="close-ont-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number *</label>
                    <input type="text" id="ont-sn" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                    <select id="ont-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"  required>
                        <option value="gudang">Gudang</option>
                        <option value="terpasang">Terpasang</option>
                        <option value="rusak">Rusak</option>
                        <option value="ganti-ont">Ganti ONT</option>
                        <option value="on-progress">On Progress</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teknisi</label>
                    <select id="ont-teknisi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Pilih Teknisi</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Ambil</label>
                    <input type="datetime-local" id="ont-tanggal-ambil" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kembali</label>
                    <input type="datetime-local" id="ont-tanggal-kembali" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <input type="hidden" id="ont-id">
                <button type="button" id="cancel-ont-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                    Simpan
                </button>
            </div>
        </form>
    </div>

    <!-- MODAL INVENTORY -->
    <div id="inventory-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="inventory-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="inventory-form-title" class="text-2xl font-bold text-gray-800">Form Inventory</h2>
                <button type="button" id="close-inventory-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Transaksi *</label>
                    <select id="inventory-transaction-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="masuk">Masuk</option>
                        <option value="keluar">Keluar</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Item *</label>
                    <input type="text" id="inventory-item-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Item *</label>
                    <select id="inventory-item-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="ONT">ONT</option>
                        <option value="SPLITTER">Splitter</option>
                        <option value="KABEL">Kabel</option>
                        <option value="ODP">ODP</option>
                        <option value="LAINNYA">Lainnya</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
                    <input type="text" id="inventory-sn" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah *</label>
                    <input type="number" id="inventory-quantity" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Satuan *</label>
                    <input type="text" id="inventory-unit" value="PCS" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lokasi Penyimpanan</label>
                    <input type="text" id="inventory-location" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                    <textarea id="inventory-notes" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <input type="hidden" id="inventory-id">
                <button type="button" id="cancel-inventory-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                    Simpan
                </button>
            </div>
        </form>
    </div>

    <!-- NOTIFICATION TOAST -->
    <div id="notification-toast" class="fixed top-5 right-5 z-50 hidden">
        <div class="bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg">
            <span id="toast-message"></span>
        </div>
    </div>

    <!-- SESSION WARNING MODAL -->
    <div id="session-warning" class="session-warning hidden">
        <div class="flex items-center mb-4">
            <i data-lucide="alert-circle" class="w-6 h-6 text-yellow-500 mr-3"></i>
            <h3 class="text-lg font-semibold">Sesi Akan Berakhir</h3>
        </div>
        <p class="text-gray-600 mb-4">Sesi Anda akan berakhir dalam <span id="session-countdown">2:00</span> menit karena tidak ada aktivitas. Apakah Anda ingin melanjutkan sesi?</p>
        <div class="flex justify-end space-x-2">
            <button id="extend-session" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Lanjutkan Sesi</button>
            <button id="logout-now" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Logout</button>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center">
            <div class="loader"></div>
            <p class="text-gray-700 mt-4" id="loading-message">Memproses...</p>
        </div>
    </div>

       

    <!-- WARNING MODAL -->
    <div id="warning-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex items-center mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-500 mr-3"></i>
                <h3 class="text-xl font-semibold">Perubahan Belum Disimpan</h3>
            </div>
            <p class="text-gray-600 mb-6">Anda memiliki perubahan yang belum disimpan. Apakah Anda yakin ingin meninggalkan halaman ini?</p>
            <div class="flex justify-end space-x-3">
                <button id="warning-cancel" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                    Batal
                </button>
                <button id="warning-confirm" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                    Ya, Tinggalkan
                </button>
            </div>
        </div>
    </div>

    <script>

        function getRoleDisplayName(role) {
    const roleMap = {
        'owner': 'Owner',
        'admin': 'Admin',
        'teknisi': 'Petugas Lapangan',
        'operator': 'Operator',
        'gudang': 'Petugas Gudang'
    };
    return roleMap[role] || role.charAt(0).toUpperCase() + role.slice(1);
}
        // ======================================================================
        // KONFIGURASI FIREBASE
        // ======================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDyXLfovZUAPzPfm1LakEFPPgwGegaQr4o",
            authDomain: "user-management-bccb1.firebaseapp.com",
            projectId: "user-management-bccb1",
            storageBucket: "user-management-bccb1.firebasestorage.app",
            messagingSenderId: "22188892577",
            appId: "1:22188892577:web:d8c7ebe3e00e1974956be0",
            measurementId: "G-4SEKELHMTF"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);

        // ⭐⭐ INIT EMAILJS ⭐⭐ - TAMBAH DI SINI
        emailjs.init("vbjhrBXWJrdgku8--"); // Ganti dengan Public Key Anda

        const auth = firebase.auth();
        const db = firebase.firestore();



        // ======================================================================
        // VARIABEL GLOBAL & STATE
        // ======================================================================
        let currentUser = null;
        let userId = null;
        let userRole = null;
        let isOnline = navigator.onLine;
        let map;
        let markerLayers = {
            OLT: L.layerGroup(),
            ODC: L.layerGroup(),
            ODP: L.markerClusterGroup(),
            Pelanggan: L.markerClusterGroup()
        };
        let connectionLines = [];
        let selectedMarker = null;
        let draggedMarker = null;
        
        // Data cache untuk aplikasi
        let dataCache = {
            OLT: [],
            ODC: [],
            ODP: [],
            Pelanggan: [],
            Paket: [],
            Karyawan: [],
            AuditLog: [],
            Inventory: [],
            InventoryTransaksi: [],
            Tickets: [],
            ONTTracking: []
        };
        
        let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
        let settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
        let currentPage = 1;
        let itemsPerPage = 10;
        let filteredData = [];
        
        // Session management variables
        let sessionTimeout;
        let warningTimeout;
        let countdownInterval;
        let sessionTimeoutMinutes = 15;
        let warningTimeoutMinutes = 13;

        // TTR Settings
        settings.ttrMaxHours = settings.ttrMaxHours || 3;
        settings.ttrWarningHours = settings.ttrWarningHours || 1.5;

        // NEW: Track form changes for warning modal
        let formHasChanges = false;
        let currentFormData = null;

        // ======================================================================
        // SELEKTOR DOM
        // ======================================================================
        const $ = document.getElementById.bind(document);
        const $$ = document.querySelectorAll.bind(document);
        
        const loginScreen = $('login-screen');
        const loginForm = $('login-form');
        const appLoader = $('app-loader');
        const appShell = $('app-shell');
        const sidebar = $('sidebar');
        const onlineIndicator = $('online-indicator');
        const onlineText = $('online-text');
        const formModal = $('form-modal');
        const entityForm = $('entity-form');
        const formTitle = $('form-title');
        const formContent = $('form-content');
        const formEntityType = $('form-entity-type');
        const formEntityId = $('form-entity-id');
        const toast = $('notification-toast');
        const toastMessage = $('toast-message');
        const sessionWarning = $('session-warning');
        const warningModal = $('warning-modal');
        
        // Ticket and ONT modals
        const ticketModal = $('ticket-modal');
        const ticketForm = $('ticket-form');
        const ontModal = $('ont-modal');
        const ontForm = $('ont-form');
        const inventoryModal = $('inventory-modal');
        const inventoryForm = $('inventory-form');

        // ======================================================================
        // INISIALISASI APLIKASI
        // ======================================================================
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupAuthStateListener();
            setupOfflineSync();
            updateOnlineStatusUI(isOnline);
            loadSettings();
            applySettings();
            setupSessionManagement();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });

        // ======================================================================
        // AUTHENTIKASI FIREBASE
        // ======================================================================
        function setupAuthStateListener() {
    auth.onAuthStateChanged((user) => {
        if (user) {
            // User sudah login
            currentUser = user;
            userId = user.uid;
            
            // Get user profile from Firestore
            getUserProfile(user.uid).then(profile => {
                userRole = profile.role;
                
                // Update UI dengan info user
                $('user-name').textContent = profile.nama;
                $('user-email').textContent = user.email;
                $('user-role').textContent = 
                    profile.role === 'gudang' ? 'Petugas Gudang' :
                    profile.role === 'teknisi' ? 'Petugas Lapangan' :
                    profile.role.charAt(0).toUpperCase() + profile.role.slice(1);
                
                // Apply role-based UI
                applyRoleBasedUI(userRole);
                
                // ⭐⭐ PEMBAKAN: PINDAHKAN INISIALISASI KE SINI ⭐⭐
                // Jalankan inisialisasi HANYA setelah profil pengguna berhasil diambil
                
                // Sembunyikan login screen, tampilkan aplikasi
                loginScreen.classList.add('hidden');
                appLoader.classList.remove('hidden');
                
                // Inisialisasi aplikasi
                initAppUI();
                setupDetailModalEvents();
                
            }).catch(error => {
                console.error("Gagal mengambil profil user:", error);
                // Tampilkan pesan error jika gagal mengambil profil
                alert("Gagal memuat data pengguna. Silakan coba lagi.");
                auth.signOut(); // Logout user jika gagal mengambil profil
            });
        } else {
            // User belum login
            currentUser = null;
            userId = null;
            userRole = null;
            
            // Tampilkan login screen, sembunyikan aplikasi
            loginScreen.classList.remove('hidden');
            appShell.classList.add('hidden');
            appLoader.classList.add('hidden');
        }
    });
}
        

       // ⭐⭐ FUNGSI BARU: MENGAMBIL NAMA DAN ROLE ⭐⭐
async function getUserProfile(uid) {
    try {
        const doc = await db.collection('Karyawan').doc(uid).get();
        if (doc.exists) {
            let data = doc.data();
            let role = (data.role || 'Operator').toLowerCase().trim();

            // Normalisasi role untuk UI
            if (role === 'petugas gudang') role = 'gudang';
            if (role === 'petugas lapangan') role = 'teknisi';
            
            return {
                nama: data.nama || 'Tidak ada nama',
                role: role
            };
        }
        return { nama: 'Tidak ada nama', role: 'operator' };
    } catch {
        return { nama: 'Error', role: 'operator' };
    }
}

function applyRoleBasedUI(role) {
    appShell.classList.remove(
        'role-admin',
        'role-teknisi',
        'role-operator',
        'role-gudang',
        'role-owner'
    );

    appShell.classList.add(`role-${role}`);
}

// ⭐⭐ FUNGSI PENGGANTI YANG LENGKAP DAN BENAR ⭐⭐
function updateUserRoleUI() {
    if (currentUser) {
        getUserProfile(currentUser.uid).then(profile => {
            userRole = profile.role;
            
            // Update UI dengan info user
            $('user-name').textContent = profile.nama;
            $('user-email').textContent = currentUser.email;
            $('user-role').textContent = getRoleDisplayName(profile.role);
            
            // Apply role-based UI
            applyRoleBasedUI(userRole);
        }).catch(error => {
            console.error('Error updating role UI:', error);
        });
    }
}

        // Event listener untuk form login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = $('login-email').value;
            const password = $('login-password').value;
            const loginError = $('login-error');
            const loginButtonText = $('login-button-text');
            const loginSpinner = $('login-spinner');
            
            // Tampilkan loading state
            loginButtonText.textContent = 'Logging in...';
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state listener akan menangani transisi ke aplikasi
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = getAuthErrorMessage(error.code);
                loginError.classList.remove('hidden');
            } finally {
                // Reset loading state
                loginButtonText.textContent = 'Login';
                loginSpinner.classList.add('hidden');
            }
        });

        // Event listener untuk logout
        $('logout-button').addEventListener('click', () => {
            auth.signOut();
        });

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'Format email tidak valid';
                case 'auth/user-disabled':
                    return 'Akun ini telah dinonaktifkan';
                case 'auth/user-not-found':
                    return 'Akun tidak ditemukan';
                case 'auth/wrong-password':
                    return 'Password salah';
                case 'auth/too-many-requests':
                    return 'Terlalu banyak percobaan login. Coba lagi nanti';
                default:
                    return 'Terjadi kesalahan saat login';
            }
        }

        // ======================================================================
// FUNGSI KIRIM EMAIL
// ======================================================================
// ⭐⭐ GANTI FUNGSI INI ⭐⭐
async function sendPasswordEmail(email, nama, password, role) {
    // ⭐⭐ VALIDASI - JIKA EMAIL KOSONG, BERHENTI ⭐⭐
    if (!email) {
        console.error('ERROR: Email penerima kosong');
        return false;
    }

    // ⭐⭐ VALIDASI - PASTIKAN EMAILJS SUDAH DIMUAT ⭐⭐
    if (typeof emailjs === 'undefined') {
        console.error('ERROR: EmailJS library tidak dimuat dengan benar.');
        alert('Error: Layanan email tidak tersedia. Silakan hubungi administrator.');
        return false;
    }

    try {
        const templateParams = {
            to_email: email,
            to_name: nama,
            password: password,
            role: role,
            login_url: window.location.origin
        };

        console.log('Mengirim email ke:', email);
        const response = await emailjs.send('service_oa7xsa4', 'template_qif5e7i', templateParams);
        console.log('Email berhasil dikirim. Respon dari EmailJS:', response);
        return true;
    } catch (error) {
        console.error('GAGAL kirim email. Detail Error:', error);
        // Tampilkan error yang lebih jelas ke user
        alert(`Gagal mengirim email ke ${email}. Silakan periksa console log (F12) untuk detail error dan pastikan konfigurasi EmailJS sudah benar.`);
        return false;
    }
}

        // ======================================================================
        // INISIALISASI UI APLIKASI
        // ======================================================================
        function initAppUI() {
            // Setup UI
            appLoader.classList.add('hidden');
            appShell.classList.remove('hidden');
            
            // Inisialisasi Peta
            initMap();
            
            // Setup Navigasi
            setupNavigation();

            // Setup User Menu
            $('user-menu-button').addEventListener('click', () => {
                $('user-menu-dropdown').classList.toggle('hidden');
            });

            // Setup Modal
            setupModalEvents();

             // ⭐⭐ TAMBAHKAN INI ⭐⭐ - Setup Detail Modal Events
    setupDetailModalEvents();
            
            // Setup Ticket Modal
            $('add-ticket-button').addEventListener('click', () => {
                showTicketModal();
            });
            ticketForm.addEventListener('submit', saveTicket);
            
            // Setup ONT Modal
            $('add-ont-button').addEventListener('click', () => {
                showOntModal();
            });
            ontForm.addEventListener('submit', saveOnt);
            
            // Setup Inventory Modal
            $('add-inventory-masuk').addEventListener('click', () => {
                showInventoryModal('masuk');
            });
            $('add-inventory-keluar').addEventListener('click', () => {
                showInventoryModal('keluar');
            });
            inventoryForm.addEventListener('submit', saveInventory);
            
            // Setup Dashboard Cards
            setupDashboardCards();
            
            // Setup Settings
            setupSettings();
            
            // Setup Backup & Restore
            setupBackupRestore();

            // Muat semua data dari Firebase atau cache lokal
            if (isOnline) {
                loadAllData();
            } else {
                loadLocalData();
            }

            // Tampilkan dashboard sebagai default
            showPage('dashboard');
        }

        function setupDetailModalEvents() {
    const closeModal = document.getElementById('close-detail-modal');
    const closeButton = document.getElementById('close-detail-button');
    const detailModal = document.getElementById('detail-modal');
    
    if (closeModal) {
        closeModal.onclick = () => {
            detailModal.classList.add('hidden');
        };
    }
    
    if (closeButton) {
        closeButton.onclick = () => {
            detailModal.classList.add('hidden');
        };
    }
    
    // Close modal when clicking outside content
    detailModal.onclick = (e) => {
        if (e.target === detailModal) {
            detailModal.classList.add('hidden');
        }
    };
}

        function setupModalEvents() {
            // Main form modal
            $('close-modal-button').addEventListener('click', () => {
                if (formHasChanges) {
                    showWarningModal(() => formModal.classList.add('hidden'));
                } else {
                    formModal.classList.add('hidden');
                }
            });
            
            $('cancel-modal-button').addEventListener('click', () => {
                if (formHasChanges) {
                    showWarningModal(() => formModal.classList.add('hidden'));
                } else {
                    formModal.classList.add('hidden');
                }
            });
            
            entityForm.addEventListener('submit', saveEntity);
            
            // Ticket modal
            $('close-ticket-modal-button').addEventListener('click', () => ticketModal.classList.add('hidden'));
            $('cancel-ticket-button').addEventListener('click', () => ticketModal.classList.add('hidden'));
            
            // ONT modal
            $('close-ont-modal-button').addEventListener('click', () => ontModal.classList.add('hidden'));
            $('cancel-ont-button').addEventListener('click', () => ontModal.classList.add('hidden'));
            
            // Inventory modal
            $('close-inventory-modal-button').addEventListener('click', () => inventoryModal.classList.add('hidden'));
            $('cancel-inventory-button').addEventListener('click', () => inventoryModal.classList.add('hidden'));
            
            // Warning modal
            $('warning-cancel').addEventListener('click', () => warningModal.classList.add('hidden'));
     $('warning-confirm').addEventListener('click', () => {
    // Tutup warning modal
    warningModal.classList.add('hidden');
    
    // TUTUP JUGA MODAL FORM EDIT YANG SEDANG TERBUKA
    formModal.classList.add('hidden');
    
    formHasChanges = false;
});
            
            // Add new button
            $('add-new-button').addEventListener('click', () => {
                const currentEntity = $('table-title').dataset.entity;
                if (currentEntity) {
                    showFormModal(currentEntity);
                }
            });
        }

        function showWarningModal(callback) {
            $('warning-confirm').dataset.callback = callback.name || 'null';
            warningModal.classList.remove('hidden');
        }

        function setupNavigation() {
            // Kontrol Sidebar
            $('sidebar-open-btn').addEventListener('click', () => sidebar.classList.remove('sidebar-collapsed'));
            $('sidebar-close-btn').addEventListener('click', () => sidebar.classList.add('sidebar-collapsed'));
            
            if (window.innerWidth < 640) {
                 sidebar.classList.add('sidebar-collapsed');
            }
            
            // Navigasi Halaman
            $$('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    const entity = link.dataset.entity;
                    
                    if (entity) {
                        loadTablePage(entity);
                    }
                    showPage(page);
                    
                    if (window.innerWidth < 640) {
                        sidebar.classList.add('sidebar-collapsed');
                    }
                });
            });
        }

        function setupDashboardCards() {
            $$('.dashboard-card').forEach(card => {
                card.addEventListener('click', () => {
                    const entity = card.dataset.entity;
                    if (entity) {
                        loadTablePage(entity);
                        showPage('table');
                    }
                });
            });
        }

        function showPage(pageId) {
            $$('.page-content').forEach(page => page.classList.add('hidden'));
            $(pageId === 'table' ? 'page-table' : `page-${pageId}`).classList.remove('hidden');
            
            if (pageId === 'map') {
                // Perlu me-refresh peta jika ukurannya berubah saat disembunyikan
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
            } else if (pageId === 'tickets') {
                // Load data tickets saat halaman dibuka
                if (isOnline) {
                    loadDataFromFirestore('Tickets').then(() => {
                        renderTicketsTable();
                    });
                } else {
                    renderTicketsTable();
                }
            } else if (pageId === 'ont-tracking') {
                // Load data ONT tracking saat halaman dibuka
                if (isOnline) {
                    loadDataFromFirestore('ONTTracking').then(() => {
                        renderOntTable();
                    });
                } else {
                    renderOntTable();
                }
            } else if (pageId === 'inventory') {
                // Load data inventory saat halaman dibuka
                if (isOnline) {
                    loadDataFromFirestore('Inventory').then(() => {
                        renderInventoryTable();
                    });
                } else {
                    renderInventoryTable();
                }
            } else if (pageId === 'backup-restore') {
                // Load backup history
                loadBackupHistory();
            }
        }

        // ======================================================================
        // LOGIKA PETA (LEAFLET)
        // ======================================================================
        function initMap() {
    // ⭐⭐ PEMBAIKAN: HAPUS PETA LAMA JIKA ADA ⭐⭐
    if (map) {
        map.remove(); // Hapus peta lama dari memori
        map = null; // Reset variabel map
    }

    // Inisialisasi peta baru
    map = L.map('map-container').setView([-6.2088, 106.8456], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Tambahkan semua layer group ke peta
    Object.values(markerLayers).forEach(layer => layer.addTo(map));
    
    // Setup event listeners untuk toggle layer
    setupMapControls();
    
    // Setup filter controls
    setupMapFilters();
}

        function setupMapControls() {
            // Toggle OLT
            $('toggle-olt').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.OLT)) {
                    map.removeLayer(markerLayers.OLT);
                    $('toggle-olt').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.OLT);
                    $('toggle-olt').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle ODC
            $('toggle-odc').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.ODC)) {
                    map.removeLayer(markerLayers.ODC);
                    $('toggle-odc').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.ODC);
                    $('toggle-odc').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle ODP
            $('toggle-odp').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.ODP)) {
                    map.removeLayer(markerLayers.ODP);
                    $('toggle-odp').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.ODP);
                    $('toggle-odp').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle Pelanggan
            $('toggle-pelanggan').addEventListener('click', () => {
                if (map.hasLayer(markerLayers.Pelanggan)) {
                    map.removeLayer(markerLayers.Pelanggan);
                    $('toggle-pelanggan').classList.replace('active', 'inactive');
                } else {
                    map.addLayer(markerLayers.Pelanggan);
                    $('toggle-pelanggan').classList.replace('inactive', 'active');
                }
            });
            
            // Toggle Connections
            $('toggle-connections').addEventListener('click', () => {
                if (connectionLines.length > 0) {
                    clearConnectionLines();
                    $('toggle-connections').classList.replace('active', 'inactive');
                } else {
                    showAllConnections();
                    $('toggle-connections').classList.replace('inactive', 'active');
                }
            });
            
            // Clear Connections
            $('clear-connections').addEventListener('click', () => {
                clearConnectionLines();
                $('toggle-connections').classList.replace('active', 'inactive');
            });
        }

        function setupMapFilters() {
            // Apply filters button
            $('apply-filters').addEventListener('click', () => {
                showToast('Filter diterapkan', 'success');
            });
            
            // Reset filters button
            $('reset-filters').addEventListener('click', () => {
                resetMapFilters();
            });
        }

        function resetMapFilters() {
            // Reset all filter inputs
            $('device-type-filter').value = '';
            $('region-code-filter').value = '';
            $('sector-code-filter').value = '';
            $('ont-sn-filter').value = '';
            
            // Render all markers
            Object.keys(markerLayers).forEach(entityType => {
                markerLayers[entityType].clearLayers();
                renderMarkers(entityType, dataCache[entityType]);
            });
        }

        function renderMarkers(entity, data) {
            const layer = markerLayers[entity];
            layer.clearLayers();

            data.forEach(item => {
                if (!item.location || !item.location.lat || !item.location.lng) return;

                const latLng = [item.location.lat, item.location.lng];
                let marker;

                // Kustomisasi marker berdasarkan entity
                if (entity === 'OLT') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'OLT-marker',
                            html: '<div class="w-8 h-8 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="server" class="w-4 h-4 text-white"></i></div>',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        }),
                        id: item.id,
                        draggable: true
                    });
                } else if (entity === 'ODC') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'odc-marker',
                            html: '<div class="w-8 h-8 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="server-cog" class="w-4 h-4 text-white"></i></div>',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        }),
                        id: item.id,
                        draggable: true
                    });
                } else if (entity === 'ODP') {
                    const capacity = getOdpCapacity(item);
                    const color = capacity.percentage >= 100 ? 'red' : (capacity.percentage >= 75 ? 'orange' : 'green');
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'odp-marker',
                            html: `<div class="w-8 h-8 bg-${color}-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="box" class="w-4 h-4 text-white"></i></div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        }),
                        id: item.id,
                        draggable: true
                    });
                } else if (entity === 'Pelanggan') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'pelanggan-marker',
                            html: '<div class="w-6 h-6 bg-green-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="user" class="w-3 h-3 text-white"></i></div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        }),
                        id: item.id,
                        draggable: true
                    });
                }

                if (marker) {
                    marker.bindPopup(createPopupContent(entity, item));
                    
                    // Add drag event
                    marker.on('dragstart', function(e) {
                        draggedMarker = {
                            entity: entity,
                            id: item.id,
                            originalPosition: item.location
                        };
                        this._icon.classList.add('marker-dragging');
                    });
                    
                    marker.on('dragend', async function(e) {
                        this._icon.classList.remove('marker-dragging');
                        
                        const newPosition = e.target.getLatLng();
                        const newLocation = {
                            lat: newPosition.lat,
                            lng: newPosition.lng
                        };
                        
                        try {
                            if (isOnline) {
                                // Update in database
                                await db.collection(entity).doc(item.id).update({
                                    location: newLocation,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedBy: currentUser.email
                                });
                                
                                // Update in cache
                                const index = dataCache[entity].findIndex(i => i.id === item.id);
                                if (index !== -1) {
                                    dataCache[entity][index].location = newLocation;
                                }
                                
                                // Log audit
                                await logAudit('update', entity, item.id, { 
                                    location: { 
                                        from: draggedMarker.originalPosition, 
                                        to: newLocation 
                                    } 
                                });
                                
                                showToast(`Lokasi ${entity} berhasil diperbarui`, 'success');
                            } else {
                                // Offline mode - add to queue
                                offlineQueue.push({
                                    action: 'update',
                                    entityType: entity,
                                    entityId: item.id,
                                    data: {
                                        location: newLocation,
                                        updatedAt: new Date(),
                                        updatedBy: currentUser.email
                                    },
                                    timestamp: new Date().getTime()
                                });
                                localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                                
                                // Update local cache immediately
                                const index = dataCache[entity].findIndex(i => i.id === item.id);
                                if (index !== -1) {
                                    dataCache[entity][index].location = newLocation;
                                }
                                
                                updateOfflineQueueUI();
                                showToast('Perubahan lokasi disimpan dalam antrian offline', 'warning');
                            }
                            
                            // Update popup content
                            this.setPopupContent(createPopupContent(entity, {
                                ...item,
                                location: newLocation
                            }));
                        } catch (error) {
                            console.error('Error updating marker position:', error);
                            showToast('Gagal memperbarui lokasi', 'error');
                            
                            // Revert to original position
                            this.setLatLng(draggedMarker.originalPosition);
                        }
                        
                        draggedMarker = null;
                    });
                    
                    marker.on('click', () => {
                        selectedMarker = { entity, item };
                        showConnections(entity, item);
                    });
                    layer.addLayer(marker);
                }
            });
            
            // Render ulang ikon
            lucide.createIcons();
        }
        
        function createPopupContent(entity, item) {
            let content = `<div class="font-bold text-base mb-1">${item.namaODP || item.namaODC || item.name || item.code}</div>`;
            
            if (entity === 'OLT') {
                content += `<p>Model: ${item.model || 'N/A'}</p>`;
                content += `<p>Slot: ${item.totalSlots || 0}, Port: ${item.totalPorts || 0}</p>`;
            } else if (entity === 'ODC') {
                content += `<p>Kapasitas: ${item.capacity || 0}</p>`;
            } else if (entity === 'ODP') {
                const { used, total, percentage } = getOdpCapacity(item);
                content += `<p>Kapasitas: ${used} / ${total} (${percentage.toFixed(1)}%)</p>`;
            } else if (entity === 'Pelanggan') {
                content += `<p>Alamat: ${item.address || 'N/A'}</p>`;
                content += `<p>Status: <span class="font-semibold ${item.status === 'active' ? 'text-green-600' : (item.status === 'pending' ? 'text-yellow-600' : 'text-gray-500')}">${item.status}</span></p>`;
            }
            
            if (item.location) {
                content += `<p class="text-xs text-gray-500">${item.location.lat.toFixed(4)}, ${item.location.lng.toFixed(4)}</p>`;
            }
            return content;
        }

        function showConnections(entity, item) {
            // Hapus koneksi yang ada
            clearConnectionLines();
            
            if (entity === 'OLT') {
                // Tampilkan koneksi ke ODC
                const connectedODCs = dataCache.ODC.filter(odc => odc.OLTRef === item.id);
                connectedODCs.forEach(odc => {
                    if (odc.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [odc.location.lat, odc.location.lng],
                            '#EF4444', // Red for OLT-ODC
                            'OLT-ODC'
                        );
                    }
                });
            } else if (entity === 'ODC') {
                // Tampilkan koneksi ke OLT
                const OLT = dataCache.OLT.find(o => o.id === item.OLTRef);
                if (OLT && OLT.location) {
                    drawConnectionLine(
                        [item.location.lat, item.location.lng],
                        [OLT.location.lat, OLT.location.lng],
                        '#EF4444', // Red for OLT-ODC
                        'ODC-OLT'
                    );
                }
                
                // Tampilkan koneksi ke ODP
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === item.id);
                connectedODPs.forEach(odp => {
                    if (odp.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [odp.location.lat, odp.location.lng],
                            '#3B82F6', // Blue for ODC-ODP
                            'ODC-ODP'
                        );
                    }
                });
            } else if (entity === 'ODP') {
                // Tampilkan koneksi ke ODC
                const odc = dataCache.ODC.find(o => o.id === item.odcRef);
                if (odc && odc.location) {
                    drawConnectionLine(
                        [item.location.lat, item.location.lng],
                        [odc.location.lat, odc.location.lng],
                        '#3B82F6', // Blue for ODC-ODP
                        'ODP-ODC'
                    );
                }
                
                // Tampilkan koneksi ke Pelanggan
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === item.id);
                connectedPelanggan.forEach(pelanggan => {
                    if (pelanggan.location) {
                        drawConnectionLine(
                            [item.location.lat, item.location.lng],
                            [pelanggan.location.lat, pelanggan.location.lng],
                            '#10B981', // Green for ODP-Pelanggan
                            'ODP-Pelanggan'
                        );
                    }
                });
            } else if (entity === 'Pelanggan') {
                // Tampilkan koneksi ke ODP
                const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                if (odp && odp.location) {
                    drawConnectionLine(
                        [item.location.lat, item.location.lng],
                        [odp.location.lat, odp.location.lng],
                        '#10B981', // Green for ODP-Pelanggan
                        'Pelanggan-ODP'
                    );
                }
            }
        }

        function showAllConnections() {
            // Hapus koneksi yang ada
            clearConnectionLines();
            
            // Tampilkan semua koneksi OLT-ODC
            dataCache.OLT.forEach(OLT => {
                if (!OLT.location) return;
                
                const connectedODCs = dataCache.ODC.filter(odc => odc.OLTRef === OLT.id);
                connectedODCs.forEach(odc => {
                    if (odc.location) {
                        drawConnectionLine(
                            [OLT.location.lat, OLT.location.lng],
                            [odc.location.lat, odc.location.lng],
                            '#EF4444', // Red for OLT-ODC
                            'OLT-ODC'
                        );
                    }
                });
            });
            
            // Tampilkan semua koneksi ODC-ODP
            dataCache.ODC.forEach(odc => {
                if (!odc.location) return;
                
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === odc.id);
                connectedODPs.forEach(odp => {
                    if (odp.location) {
                        drawConnectionLine(
                            [odc.location.lat, odc.location.lng],
                            [odp.location.lat, odp.location.lng],
                            '#3B82F6', // Blue for ODC-ODP
                            'ODC-ODP'
                        );
                    }
                });
            });
            
            // Tampilkan semua koneksi ODP-Pelanggan
            dataCache.ODP.forEach(odp => {
                if (!odp.location) return;
                
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === odp.id);
                connectedPelanggan.forEach(pelanggan => {
                    if (pelanggan.location) {
                        drawConnectionLine(
                            [odp.location.lat, odp.location.lng],
                            [pelanggan.location.lat, pelanggan.location.lng],
                            '#10B981', // Green for ODP-Pelanggan
                            'ODP-Pelanggan'
                        );
                    }
                });
            });
        }

        function drawConnectionLine(startLatLng, endLatLng, color, type) {
            const polyline = L.polyline([startLatLng, endLatLng], {
                color: color,
                weight: 4,
                opacity: 0.8,
                smoothFactor: 1
            }).addTo(map);
            
            connectionLines.push(polyline);
        }

        function clearConnectionLines() {
            connectionLines.forEach(line => {
                map.removeLayer(line);
            });
            connectionLines = [];
        }

        // ======================================================================
        // LOGIKA DATA & TAMPILAN
        // ======================================================================
        async function loadAllData() {
            try {
                // Load semua data dari Firebase
                await Promise.all([
                    loadDataFromFirestore('OLT'),
                    loadDataFromFirestore('ODC'),
                    loadDataFromFirestore('ODP'),
                    loadDataFromFirestore('Pelanggan'),
                    loadDataFromFirestore('Paket'),
                    loadDataFromFirestore('Karyawan'),
                    loadDataFromFirestore('AuditLog'),
                    loadDataFromFirestore('Inventory'),
                    loadDataFromFirestore('InventoryTransaksi'),
                    loadDataFromFirestore('Tickets'),
                    loadDataFromFirestore('ONTTracking')
                ]);
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
                // Update UI dengan data
                renderMarkers('OLT', dataCache.OLT);
                renderMarkers('ODC', dataCache.ODC);
                renderMarkers('ODP', dataCache.ODP);
                renderMarkers('Pelanggan', dataCache.Pelanggan);
                
                renderAuditLog(dataCache.AuditLog);
                updateDashboardStats();
                
                // Update tickets and ONT stats
                updateTicketStats();
                updateOntStats();
                
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Gagal memuat data', 'error');
                
                // Jika gagal memuat dari Firebase, coba dari localStorage
                loadLocalData();
            }
        }

        function loadLocalData() {
            try {
                // Load data dari localStorage
                const localData = JSON.parse(localStorage.getItem('ftthLocalData') || '{}');
                
                Object.keys(localData).forEach(key => {
                    if (dataCache.hasOwnProperty(key)) {
                        dataCache[key] = localData[key] || [];
                    }
                });
                
                // Update UI dengan data lokal
                renderMarkers('OLT', dataCache.OLT);
                renderMarkers('ODC', dataCache.ODC);
                renderMarkers('ODP', dataCache.ODP);
                renderMarkers('Pelanggan', dataCache.Pelanggan);
                
                renderAuditLog(dataCache.AuditLog);
                updateDashboardStats();
                
                // Update tickets and ONT stats
                updateTicketStats();
                updateOntStats();
                
                showToast('Data berhasil dimuat dari cache lokal', 'success');
            } catch (error) {
                console.error('Error loading local data:', error);
                showToast('Gagal memuat data lokal', 'error');
            }
        }

        function saveLocalData() {
            try {
                // Simpan data ke localStorage
                const dataToSave = {};
                Object.keys(dataCache).forEach(key => {
                    dataToSave[key] = dataCache[key];
                });
                
                localStorage.setItem('ftthLocalData', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Error saving local data:', error);
            }
        }

        async function loadDataFromFirestore(entityType) {
            try {
                const snapshot = await db.collection(entityType).get();
                dataCache[entityType] = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error(`Error loading ${entityType}:`, error);
                dataCache[entityType] = [];
            }
        }

        function loadTablePage(entity) {
            $('table-title').textContent = `Manajemen ${entity}`;
            $('table-title').dataset.entity = entity;
            
            // Setup search dan filter
            setupTableSearch(entity);
            
            // Reset pagination
            currentPage = 1;
            
            // Render tabel
            renderTable(entity, dataCache[entity]);
        }

        function setupTableSearch(entity) {
            const searchInput = $('table-search');
            
            // Clear previous event listeners
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            // Add new event listeners
            newSearchInput.addEventListener('input', () => {
                filterTableData(entity, newSearchInput.value);
            });
            
            // Setup pagination
            setupPagination();
        }

        function filterTableData(entity, searchTerm) {
            let data = [...dataCache[entity]];
            
            // Filter berdasarkan search term
            if (searchTerm) {
                data = data.filter(item => {
                    // Cari di semua properti
                    return Object.values(item).some(value => {
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(searchTerm.toLowerCase());
                        }
                        return false;
                    });
                });
            }
            
            // Simpan data yang sudah difilter
            filteredData = data;
            
            // Reset pagination
            currentPage = 1;
            
            // Render tabel dengan data yang sudah difilter
            renderTable(entity, filteredData);
        }

        function setupPagination() {
            const prevButton = $('prev-page');
            const nextButton = $('next-page');
            
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    const entity = $('table-title').dataset.entity;
                    renderTable(entity, filteredData.length > 0 ? filteredData : dataCache[entity]);
                }
            });
            
            nextButton.addEventListener('click', () => {
                const entity = $('table-title').dataset.entity;
                const data = filteredData.length > 0 ? filteredData : dataCache[entity];
                const totalPages = Math.ceil(data.length / itemsPerPage);
                
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable(entity, data);
                }
            });
        }

        function renderTable(entity, data) {
            const tableHeader = $('table-header-row');
            const tableBody = $('table-body');
            
            tableHeader.innerHTML = '';
            tableBody.innerHTML = "";

            let headers = [];
            
            // Definisikan header tabel berdasarkan entity
            if (entity === 'OLT') headers = ['OLT', 'Type', 'Model', 'SN', 'Rak', 'Total Slot/Port', 'Kapasitas Slot', 'Kapasitas Port', 'Lokasi', 'Aksi'];
            else if (entity === 'ODC') headers = ['Kode Wilayah', 'Kode Sektor', 'Nama ODC', 'Total Kapasitas', 'Terpakai', 'Tersisa', 'Utilisasi', 'OLT', 'Slot/Port OLT', 'Panel Feeder', 'Panel Distribusi', 'Aksi'];
            else if (entity === 'ODP') headers = ['Kode Wilayah', 'Kode Sektor', 'Nomor ODP', 'Nama ODP', 'Panel Feeder', 'Port Feeder', 'Panel Distribusi', 'Port Distribusi', 'Kapasitas', 'Aksi'];
            else if (entity === 'Pelanggan') headers = ['No. Pelanggan', 'Nama', 'Username', 'Paket', 'ODP', 'Port', 'Status', 'Aksi'];
            else if (entity === 'Paket') headers = ['Jenis Paket', 'Kecepatan', 'Harga', 'Aksi'];
            else if (entity === 'Karyawan') headers = ['Nama', 'Email', 'Role', 'Status', 'Aksi'];
            
            // Render header
            headers.forEach(h => {
                tableHeader.innerHTML += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`;
            });

            // Pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);
            
            // Update pagination info
            $('showing-from').textContent = data.length > 0 ? startIndex + 1 : 0;
            $('showing-to').textContent = Math.min(endIndex, data.length);
            $('total-records').textContent = data.length;
            $('page-info').textContent = `Halaman ${currentPage}`;
            
            // Update pagination buttons
            const totalPages = Math.ceil(data.length / itemsPerPage);
            $('prev-page').disabled = currentPage === 1;
            $('next-page').disabled = currentPage === totalPages || totalPages === 0;

            // Render data
            paginatedData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                let rowHtml = '';
                if (entity === 'OLT') {
    // HITUNG KAPASITAS
    const connectedODCs = dataCache.ODC.filter(odc => odc.OLTRef === item.id);
    const usedSlots = new Set(connectedODCs.map(odc => odc.OLTSlot)).size;
    const usedPorts = connectedODCs.length;
    
    const totalSlots = item.totalSlots || 0;
    const totalPorts = item.totalPorts || 0;
    
    const slotPercentage = totalSlots > 0 ? (usedSlots / totalSlots) * 100 : 0;
    const portPercentage = totalPorts > 0 ? (usedPorts / totalPorts) * 100 : 0;

    rowHtml = `
        <td class="px-4 py-3 text-sm text-gray-700">${item.code}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${item.name}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${item.model || 'N/A'}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${item.sn || 'N/A'}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${item.rack || 'N/A'}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${totalSlots} Slot / ${totalPorts} Port</td>
        
        <!-- KAPASITAS SLOT - PROGRESS BAR SENDIRI -->
        <td class="px-4 py-3 text-sm">
            <div class="flex items-center space-x-2">
                <span class="text-xs font-medium ${slotPercentage >= 90 ? 'text-red-600' : slotPercentage >= 75 ? 'text-orange-600' : slotPercentage >= 50 ? 'text-yellow-600' : 'text-green-600'}">
                    ${usedSlots}/${totalSlots}
                </span>
                <div class="flex-1 bg-gray-200 rounded-full h-2 min-w-[60px]">
                    <div class="h-2 rounded-full ${slotPercentage >= 90 ? 'bg-red-500' : slotPercentage >= 75 ? 'bg-orange-500' : slotPercentage >= 50 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${slotPercentage}%"></div>
                </div>
            </div>
        </td>
        
        <!-- KAPASITAS PORT - PROGRESS BAR SENDIRI -->
        <td class="px-4 py-3 text-sm">
            <div class="flex items-center space-x-2">
                <span class="text-xs font-medium ${portPercentage >= 90 ? 'text-red-600' : portPercentage >= 75 ? 'text-orange-600' : portPercentage >= 50 ? 'text-yellow-600' : 'text-green-600'}">
                    ${usedPorts}/${totalPorts}
                </span>
                <div class="flex-1 bg-gray-200 rounded-full h-2 min-w-[60px]">
                    <div class="h-2 rounded-full ${portPercentage >= 90 ? 'bg-red-500' : portPercentage >= 75 ? 'bg-orange-500' : portPercentage >= 50 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${portPercentage}%"></div>
                </div>
            </div>
        </td>
        
        <td class="px-4 py-3 text-sm text-gray-700">${item.location ? `${item.location.lat.toFixed(4)}, ${item.location.lng.toFixed(4)}` : 'N/A'}</td>
    `;

                } else if (entity === 'ODC') {
    const OLT = dataCache.OLT.find(o => o.id === item.OLTRef);
    
    // HITUNG KAPASITAS ODC
    const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === item.id);
    const usedPorts = connectedODPs.length;
    const totalCapacity = item.capacity || 0;
    const freePorts = totalCapacity - usedPorts;
    const utilization = totalCapacity > 0 ? (usedPorts / totalCapacity) * 100 : 0;

    rowHtml = `
        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeWilayah}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeSektor}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${item.namaODC}</td>
        
        <!-- TOTAL KAPASITAS -->
        <td class="px-4 py-3 text-sm text-gray-700">${totalCapacity} Port</td>
        
        <!-- TERPAKAI -->
        <td class="px-4 py-3 text-sm text-gray-700">${usedPorts}</td>
        
        <!-- TERSISA -->
        <td class="px-4 py-3 text-sm font-medium ${freePorts === 0 ? 'text-red-600' : 'text-green-600'}">${freePorts}</td>
        
        <!-- UTILISASI - PROGRESS BAR -->
        <td class="px-4 py-3 text-sm">
            <div class="flex items-center space-x-2">
                <span class="text-xs font-medium ${utilization >= 90 ? 'text-red-600' : utilization >= 75 ? 'text-orange-600' : utilization >= 50 ? 'text-yellow-600' : 'text-green-600'}">
                    ${utilization.toFixed(0)}%
                </span>
                <div class="flex-1 bg-gray-200 rounded-full h-2 min-w-[60px]">
                    <div class="h-2 rounded-full ${utilization >= 90 ? 'bg-red-500' : utilization >= 75 ? 'bg-orange-500' : utilization >= 50 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${utilization}%"></div>
                </div>
            </div>
        </td>
        
        <td class="px-4 py-3 text-sm text-gray-700">${OLT?.name || 'N/A'}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${item.OLTSlot || 'N/A'}/${item.OLTPort || 'N/A'}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${item.panelFeeder || 'N/A'}/${item.portFeeder || 'N/A'}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${item.panelDistribusi || 'N/A'}/${item.portDistribusi || 'N/A'}</td>
    `;

                } else if (entity === 'ODP') {
                    const { used, total, percentage } = getOdpCapacity(item);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeWilayah}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeSektor}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.nomorODC}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.namaODP}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelFeeder || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.portFeeder || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelDistribusi || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.portDistribusi || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            <div class="flex items-center">
                                <span class="font-medium ${percentage >= 100 ? 'text-red-600' : (percentage >= 75 ? 'text-orange-600' : 'text-green-600')}">
                                    ${used} / ${total}
                                </span>
                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full ${percentage >= 100 ? 'bg-red-500' : (percentage >= 75 ? 'bg-orange-500' : 'bg-green-500')}" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </td>
                    `;
                } else if (entity === 'Pelanggan') {
                    const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                    const paket = dataCache.Paket.find(p => p.id === item.paketRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.customerNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.username}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${paket?.jenis || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${odp?.namaODP || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.odpPort || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.status === 'active' ? 'bg-green-100 text-green-800' : (item.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800')}">
                                ${item.status}
                            </span>
                        </td>
                    `;
                } else if (entity === 'Paket') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.jenis}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kecepatan}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">Rp ${item.harga?.toLocaleString('id-ID') || 0}</td>
                    `;
                } else if (entity === 'Karyawan') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.nama}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.email}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.role}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${item.status}
                            </span>
                        </td>
                    `;
                }
                
                // Tombol aksi
                rowHtml += `
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center space-x-2">
                            <button class="view-btn text-green-600 hover:text-green-800 p-1" data-id="${item.id}" title="Lihat Detail">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button class="edit-btn text-blue-600 hover:text-blue-800 p-1" data-id="${item.id}" title="Edit">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-btn text-red-600 hover:text-red-800 p-1" data-id="${item.id}" title="Hapus">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                row.innerHTML = rowHtml;
                tableBody.appendChild(row);
            });

            // Render ulang ikon
            lucide.createIcons();

            // ⭐⭐ PERBAIKI INI ⭐⭐ - Tombol View
document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const entity = document.getElementById('table-title').dataset.entity;
        showDetailModal(entity, id);
    });
});

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    showFormModal(entity, id);
                });
            });

           document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    deleteEntity(entity, id);
                });
            });

           
        }

        // Render Inventory Table
        function renderInventoryTable() {
            const tbody = $('inventory-table-body');
            tbody.innerHTML = '';
            
            if (dataCache.Inventory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i data-lucide="package-2" class="w-12 h-12 text-gray-300 mb-2"></i>
                                <p class="text-lg font-medium">Tidak ada data inventory</p>
                                <p class="text-sm">Mulai dengan menambahkan item inventory baru</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            dataCache.Inventory.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Calculate stock status
                let statusClass = 'inventory-status-high';
                let statusText = 'Tinggi';
                
                if (item.stock <= 0) {
                    statusClass = 'inventory-status-out';
                    statusText = 'Habis';
                } else if (item.stock <= item.minStock) {
                    statusClass = 'inventory-status-low';
                    statusText = 'Rendah';
                } else if (item.stock <= item.minStock * 2) {
                    statusClass = 'inventory-status-medium';
                    statusText = 'Sedang';
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-700">${item.namaItem}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item.jenis}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item.serialNumber || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item.stock} ${item.satuan}</td>
                    <td class="px-6 py-4 text-sm">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item.lokasi || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item.updatedAt ? new Date(item.updatedAt).toLocaleDateString('id-ID') : '-'}</td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <button class="edit-inventory-btn text-blue-600 hover:text-blue-800 p-1" data-id="${item.id}" title="Edit">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-inventory-btn text-red-600 hover:text-red-800 p-1" data-id="${item.id}" title="Hapus">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update inventory stats
            updateInventoryStats();
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Setup event listeners
            $$('.edit-inventory-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    showInventoryModal('edit', id);
                });
            });
            
            $$('.delete-inventory-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    deleteInventory(id);
                });
            });
        }

        // Update Inventory Stats
        function updateInventoryStats() {
            const totalItems = dataCache.Inventory.length;
            const lowStockItems = dataCache.Inventory.filter(item => item.stock <= item.minStock && item.stock > 0).length;
            const outOfStock = dataCache.Inventory.filter(item => item.stock <= 0).length;
            const recentTransactions = dataCache.InventoryTransaksi.filter(t => {
                const transactionDate = new Date(t.tanggal);
                const now = new Date();
                const diffTime = Math.abs(now - transactionDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 7; // Transactions in the last 7 days
            }).length;
            
            $('total-items').textContent = totalItems;
            $('low-stock-items').textContent = lowStockItems;
            $('out-of-stock').textContent = outOfStock;
            $('recent-transactions').textContent = recentTransactions;
            $('inventory-total-count').textContent = totalItems;
        }

        // Render Tickets Table
       function renderTicketsTable() {
    const tbody = $('tickets-table-body');
    tbody.innerHTML = '';
    
    if (dataCache.Tickets.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <i data-lucide="alert-triangle" class="w-12 h-12 text-gray-300 mb-2"></i>
                        <p class="text-lg font-medium">Tidak ada data gangguan</p>
                        <p class="text-sm">Mulai dengan membuat ticket gangguan baru</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    dataCache.Tickets.forEach(ticket => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        // Calculate duration
        let duration = '-';
        let ttrStatus = 'good';
        
        if (ticket.tanggalSelesai && ticket.tanggalLapor) {
            const start = new Date(ticket.tanggalLapor);
            const end = new Date(ticket.tanggalSelesai);
            const diffMs = end - start;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            duration = `${diffHrs} jam ${diffMins} menit`;
            
            // Calculate TTR status
            const totalHours = diffHrs + (diffMins / 60);
            if (totalHours > settings.ttrMaxHours) {
                ttrStatus = 'overdue';
            } else if (totalHours > settings.ttrWarningHours) {
                ttrStatus = 'warning';
            }
        } else if (ticket.status !== 'closed' && ticket.tanggalLapor) {
            // Calculate ongoing duration
            const start = new Date(ticket.tanggalLapor);
            const now = new Date();
            const diffMs = now - start;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            duration = `${diffHrs} jam ${diffMins} menit`;
            
            // Calculate TTR status for ongoing tickets
            const totalHours = diffHrs + (diffMins / 60);
            if (totalHours > settings.ttrMaxHours) {
                ttrStatus = 'overdue';
            } else if (totalHours > settings.ttrWarningHours) {
                ttrStatus = 'warning';
            }
        }
        
        // Status badge
        let statusClass = 'status-open';
        let statusText = 'Open';
        if (ticket.status === 'progress') {
            statusClass = 'status-progress';
            statusText = 'In Progress';
        } else if (ticket.status === 'pending') {
            statusClass = 'status-pending';
            statusText = 'Pending';
        } else if (ticket.status === 'closed') {
            statusClass = 'status-closed';
            statusText = 'Closed';
        }
        
        // TTR Status indicator
        let ttrClass = 'ttr-good';
        let ttrText = 'Good';
        if (ttrStatus === 'warning') {
            ttrClass = 'ttr-warning';
            ttrText = 'Warning';
        } else if (ttrStatus === 'overdue') {
            ttrClass = 'ttr-overdue';
            ttrText = 'Overdue';
        }
        
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-700">${ticket.nomorTicket}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${ticket.nomorInternet}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${ticket.jenisGangguan}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${ticket.userIdTeknisi || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${ticket.tanggalLapor ? new Date(ticket.tanggalLapor).toLocaleString('id-ID') : '-'}</td>
            <td class="px-4 py-3 text-sm">
                <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-700">${duration}</td>
            <td class="px-4 py-3 text-sm">
                <span class="status-badge ${ttrClass}">${ttrText}</span>
            </td>
            <td class="px-4 py-3 text-sm">
                <div class="flex items-center space-x-2">
                    <button class="edit-ticket-btn text-blue-600 hover:text-blue-800 p-1" data-id="${ticket.id}" title="Edit">
                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                    </button>
                    <button class="delete-ticket-btn text-red-600 hover:text-red-800 p-1" data-id="${ticket.id}" title="Hapus">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Render ulang ikon
    lucide.createIcons();
    
    // Setup event listeners
    $$('.edit-ticket-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            showTicketModal(id);
        });
    });
    
    $$('.delete-ticket-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            deleteTicket(id);
        });
    });
}

        // Render ONT Table
        function renderOntTable() {
            const tbody = $('ont-table-body');
            tbody.innerHTML = '';
            
            if (dataCache.ONTTracking.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i data-lucide="monitor" class="w-12 h-12 text-gray-300 mb-2"></i>
                                <p class="text-lg font-medium">Tidak ada data ONT tracking</p>
                                <p class="text-sm">Mulai dengan menambahkan ONT baru</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            dataCache.ONTTracking.forEach(ont => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Calculate loan duration
                let duration = '-';
                if (ont.tanggalKembali) {
                    const start = new Date(ont.tanggalAmbil);
                    const end = new Date(ont.tanggalKembali);
                    const diffMs = end - start;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    const diffHrs = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    duration = `${diffDays} hari ${diffHrs} jam`;
                }
                
                // Status badge
                let statusClass = 'ont-status-gudang';
                let statusText = 'Gudang';
                if (ont.status === 'terpasang') {
                    statusClass = 'ont-status-terpasang';
                    statusText = 'Terpasang';
                } else if (ont.status === 'rusak') {
                    statusClass = 'ont-status-rusak';
                    statusText = 'Rusak';
                } else if (ont.status === 'ganti-ont') {
                    statusClass = 'ont-status-ganti-ont';
                    statusText = 'Ganti ONT';
                } else if (ont.status === 'on-progress') {
                    statusClass = 'ont-status-on-progress';
                    statusText = 'On Progress';
                }
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${ont.serialNumber}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">${ont.userIdTeknisi || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${ont.tanggalAmbil ? new Date(ont.tanggalAmbil).toLocaleDateString('id-ID') : '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${ont.tanggalKembali ? new Date(ont.tanggalKembali).toLocaleDateString('id-ID') : '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${duration}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center space-x-2">
                            <button class="edit-ont-btn text-blue-600 hover:text-blue-800 p-1" data-id="${ont.id}" title="Edit">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-ont-btn text-red-600 hover:text-red-800 p-1" data-id="${ont.id}" title="Hapus">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Setup event listeners
            $$('.edit-ont-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    showOntModal(id);
                });
            });
            
            $$('.delete-ont-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    deleteOnt(id);
                });
            });
        }

        function renderAuditLog(data) {
            const tbody = $('audit-log-body');
            tbody.innerHTML = '';
            
            // Urutkan berdasarkan waktu (terbaru dulu)
            const sortedData = [...data].sort((a, b) => {
                const timeA = getTimestamp(a);
                const timeB = getTimestamp(b);
                return new Date(timeB) - new Date(timeA);
            });
            
            // Batasi hanya 1000 log terbaru
            const limitedData = sortedData.slice(0, 1000);
            
            limitedData.forEach(log => {
                const timestamp = getTimestamp(log);
                const time = new Date(timestamp).toLocaleString('id-ID');
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${time}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.userEmail}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.action}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.entityType}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${JSON.stringify(log.details)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Helper function untuk mendapatkan timestamp dari berbagai format Firebase
        function getTimestamp(log) {
            // Cek berbagai kemungkinan format timestamp Firebase
            if (log.timestamp && log.timestamp.seconds) {
                // Format Firebase Timestamp {seconds: ..., nanoseconds: ...}
                return new Date(log.timestamp.seconds * 1000);
            } else if (log.timestamp && typeof log.timestamp.toDate === 'function') {
                // Format Firebase Timestamp object
                return log.timestamp.toDate();
            } else if (log.timestamp) {
                // Format Date string atau number
                return new Date(log.timestamp);
            } else if (log.createdAt) {
                // Fallback ke createdAt
                return getTimestamp({ timestamp: log.createdAt });
            } else {
                // Fallback ke waktu sekarang
                return new Date();
            }
        }

        function updateDashboardStats() {
            // Update statistik dashboard
            $('stat-odp').textContent = dataCache.ODP.length;
            $('stat-pelanggan').textContent = dataCache.Pelanggan.length;
            $('stat-olt').textContent = dataCache.OLT.length;
            $('stat-karyawan').textContent = dataCache.Karyawan.length;
            
            // Update network capacity
            updateNetworkCapacity();
        }

        // Update Ticket Stats
        function updateTicketStats() {
            const open = dataCache.Tickets.filter(t => t.status === 'open').length;
            const progress = dataCache.Tickets.filter(t => t.status === 'progress').length;
            const pending = dataCache.Tickets.filter(t => t.status === 'pending').length;
            const closed = dataCache.Tickets.filter(t => t.status === 'closed').length;
            
            $('ticket-open').textContent = open;
            $('ticket-progress').textContent = progress;
            $('ticket-pending').textContent = pending;
            $('ticket-closed').textContent = closed;
            
            // Update TTR stats
            updateTTRStats();
        }

        // Update TTR Stats
        function updateTTRStats() {
            let good = 0;
            let warning = 0;
            let overdue = 0;
            
            dataCache.Tickets.forEach(ticket => {
                if (ticket.status === 'closed' && ticket.tanggalSelesai) {
                    const start = new Date(ticket.tanggalLapor);
                    const end = new Date(ticket.tanggalSelesai);
                    const diffMs = end - start;
                    const totalHours = diffMs / (1000 * 60 * 60);
                    
                    if (totalHours > settings.ttrMaxHours) {
                        overdue++;
                    } else if (totalHours > settings.ttrWarningHours) {
                        warning++;
                    } else {
                        good++;
                    }
                }
            });
            
            $('ttr-good').textContent = good;
            $('ttr-warning').textContent = warning;
            $('ttr-overdue').textContent = overdue;
        }

        // Update ONT Stats
        function updateOntStats() {
            const gudang = dataCache.ONTTracking.filter(o => o.status === 'gudang').length;
            const terpasang = dataCache.ONTTracking.filter(o => o.status === 'terpasang').length;
            const rusak = dataCache.ONTTracking.filter(o => o.status === 'rusak').length;
            const progress = dataCache.ONTTracking.filter(o => o.status === 'on-progress').length;
            
            $('ont-gudang').textContent = gudang;
            $('ont-terpasang').textContent = terpasang;
            $('ont-rusak').textContent = rusak;
            $('ont-progress').textContent = progress;
        }

        function updateNetworkCapacity() {
            // Calculate ODP capacity
            const totalOdpPorts = dataCache.ODP.reduce((sum, odp) => sum + (odp.totalPorts || 0), 0);
            const usedOdpPorts = dataCache.Pelanggan.filter(p => p.status === 'active').length;
            const odpPercentage = totalOdpPorts > 0 ? (usedOdpPorts / totalOdpPorts) * 100 : 0;
            
            $('odp-capacity-bar').style.width = `${odpPercentage}%`;
            $('odp-capacity-text').textContent = `${odpPercentage.toFixed(1)}%`;
            
            // Update capacity bar color
            const odpBar = $('odp-capacity-bar');
            odpBar.classList.remove('capacity-low', 'capacity-medium', 'capacity-high');
            if (odpPercentage >= 100) {
                odpBar.classList.add('capacity-high');
            } else if (odpPercentage >= 75) {
                odpBar.classList.add('capacity-medium');
            } else {
                odpBar.classList.add('capacity-low');
            }
            
            // Calculate ODC capacity
            const totalOdcPorts = dataCache.ODC.reduce((sum, odc) => sum + (odc.capacity || 0), 0);
            const usedOdcPorts = dataCache.ODP.length;
            const odcPercentage = totalOdcPorts > 0 ? (usedOdcPorts / totalOdcPorts) * 100 : 0;
            
            $('odc-capacity-bar').style.width = `${odcPercentage}%`;
            $('odc-capacity-text').textContent = `${odcPercentage.toFixed(1)}%`;
            
            // Update capacity bar color
            const odcBar = $('odc-capacity-bar');
            odcBar.classList.remove('capacity-low', 'capacity-medium', 'capacity-high');
            if (odcPercentage >= 100) {
                odcBar.classList.add('capacity-high');
            } else if (odcPercentage >= 75) {
                odcBar.classList.add('capacity-medium');
            } else {
                odcBar.classList.add('capacity-low');
            }
            
            // Calculate OLT capacity
            const totalOLTPorts = dataCache.OLT.reduce((sum, OLT) => sum + (OLT.totalPorts || 0), 0);
            const usedOLTPorts = dataCache.ODC.length;
            const OLTPercentage = totalOLTPorts > 0 ? (usedOLTPorts / totalOLTPorts) * 100 : 0;
            
            $('olt-capacity-bar').style.width = `${OLTPercentage}%`;
            $('olt-capacity-text').textContent = `${OLTPercentage.toFixed(1)}%`;
            
            // Update capacity bar color
            const OLTBar = $('olt-capacity-bar');
            OLTBar.classList.remove('capacity-low', 'capacity-medium', 'capacity-high');
            if (OLTPercentage >= 100) {
                OLTBar.classList.add('capacity-high');
            } else if (OLTPercentage >= 75) {
                OLTBar.classList.add('capacity-medium');
            } else {
                OLTBar.classList.add('capacity-low');
            }
        }

        function getOdpCapacity(odp) {
            const total = odp.totalPorts || 0;
            const used = dataCache.Pelanggan.filter(p => p.odpRef === odp.id && p.status === 'active').length;
            const percentage = total > 0 ? (used / total) * 100 : 0;
            return { used, total, percentage };
        }

        // ======================================================================
        // FORM MODAL & CRUD OPERATIONS
        // ======================================================================
        function showFormModal(entityType, entityId = null) {
            formEntityType.value = entityType;
            formEntityId.value = entityId || '';
            formHasChanges = false;
            currentFormData = null;
            
            // Set judul form
            formTitle.textContent = entityId ? `Edit ${entityType}` : `Tambah ${entityType}`;
            
            // Generate form fields
            formContent.innerHTML = generateFormFields(entityType, entityId);
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Setup event listeners khusus
            setupFormEventListeners(entityType, entityId);
            
            // Track form changes
            setupFormChangeTracking();
            
            // Tampilkan modal
            formModal.classList.remove('hidden');
        }

        // Show Ticket Modal
        function showTicketModal(ticketId = null) {
            $('ticket-id').value = ticketId || '';
            
            // Set judul form
            $('ticket-form-title').textContent = ticketId ? 'Edit Ticket Gangguan' : 'Buat Ticket Gangguan';
            
            const statusSelect = $('ticket-status');
if (userRole === 'teknisi' || userRole === 'operator') {
    // Ganti dropdown jadi text input
    const statusText = document.createElement('input');
    statusText.type = 'text';
    statusText.id = 'ticket-status';
    statusText.className = 'w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100';
    statusText.value = statusSelect.value;
    statusText.readOnly = true;
    
    statusSelect.parentNode.replaceChild(statusText, statusSelect);
}    

            // Load customer dropdown
            const customerSelect = $('ticket-customer');
            customerSelect.innerHTML = '<option value="">Pilih Pelanggan</option>';
            dataCache.Pelanggan.forEach(pelanggan => {
                const option = document.createElement('option');
                option.value = pelanggan.customerNumber;
                option.textContent = `${pelanggan.customerNumber} - ${pelanggan.name}`;
                customerSelect.appendChild(option);
            });
            
            // Load teknisi dropdown
            const teknisiSelect = $('ticket-teknisi');
            teknisiSelect.innerHTML = '<option value="">Pilih Teknisi</option>';
            const teknisiList = dataCache.Karyawan.filter(k => k.role === 'Teknisi' && k.status === 'Aktif');
            teknisiList.forEach(teknisi => {
                const option = document.createElement('option');
                option.value = teknisi.id;
                option.textContent = teknisi.nama;
                teknisiSelect.appendChild(option);
            });
        // Auto-generate ticket number if needed
if (!ticketId && settings.autoGenerateTicket) {
    const now = new Date();
    
    // Hitung total tickets untuk sequence
    const nextNumber = dataCache.Tickets.length + 1;
    
    // Format: "TC0001", "TC0002", dst
    const generatedNumber = `TC${String(nextNumber).padStart(4, '0')}`;
    
    console.log('Generated ticket number:', generatedNumber);
    $('ticket-number').value = generatedNumber;
}
            // Fill form if editing
            if (ticketId) {
                const ticket = dataCache.Tickets.find(t => t.id === ticketId);
                if (ticket) {
                    $('ticket-number').value = ticket.nomorTicket;
                    $('ticket-customer').value = ticket.nomorInternet;
                    $('ticket-jenis').value = ticket.jenisGangguan;
                    $('ticket-sn-lama').value = ticket.serialNumberLama || '';
                    $('ticket-sn-baru').value = ticket.serialNumberBaru || '';
                    $('ticket-teknisi').value = ticket.userIdTeknisi || '';
                    $('ticket-tanggal-lapor').value = new Date(ticket.tanggalLapor).toISOString().slice(0, 16);
                    $('ticket-status').value = ticket.status;

                     // ⭐⭐ TARUH KODE READONLY DI SINI - SETELAH LINE DI ATAS ⭐⭐
        const statusSelect = $('ticket-status');
        if (userRole === 'teknisi' || userRole === 'operator') {
            const statusText = document.createElement('input');
            statusText.type = 'text';
            statusText.id = 'ticket-status';
            statusText.className = 'w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100';
            statusText.value = statusSelect.value;
            statusText.readOnly = true;
            statusSelect.parentNode.replaceChild(statusText, statusSelect);
        }
    
 
                    
                    // Show/hide SN fields based on jenis gangguan
                    toggleSnFields(ticket.jenisGangguan);
                }
            }
            
            // Add event listener for jenis gangguan change
            $('ticket-jenis').addEventListener('change', (e) => {
                toggleSnFields(e.target.value);
            });
            
            // Tampilkan modal
            ticketModal.classList.remove('hidden');
        }

        function toggleSnFields(jenisGangguan) {
            const snLamaContainer = $('sn-lama-container');
            const snBaruContainer = $('sn-baru-container');
            
            if (jenisGangguan === 'ONT Rusak') {
                snLamaContainer.classList.remove('hidden');
                snBaruContainer.classList.remove('hidden');
            } else {
                snLamaContainer.classList.add('hidden');
                snBaruContainer.classList.add('hidden');
            }
        }

        // Show ONT Modal
        function showOntModal(ontId = null) {
            $('ont-id').value = ontId || '';
            
            // Set judul form
            $('ont-form-title').textContent = ontId ? 'Edit ONT Tracking' : 'Tambah ONT Tracking';
            
            // Load teknisi dropdown
            const teknisiSelect = $('ont-teknisi');
            teknisiSelect.innerHTML = '<option value="">Pilih Teknisi</option>';
            const teknisiList = dataCache.Karyawan.filter(k => k.role === 'Teknisi' && k.status === 'Aktif');
            teknisiList.forEach(teknisi => {
                const option = document.createElement('option');
                option.value = teknisi.id;
                option.textContent = teknisi.nama;
                teknisiSelect.appendChild(option);
            });
            
            // Fill form if editing
            if (ontId) {
                const ont = dataCache.ONTTracking.find(o => o.id === ontId);
                if (ont) {
                    $('ont-sn').value = ont.serialNumber;
                    $('ont-status').value = ont.status;
                    $('ont-teknisi').value = ont.userIdTeknisi || '';
                    $('ont-tanggal-ambil').value = ont.tanggalAmbil ? new Date(ont.tanggalAmbil).toISOString().slice(0, 16) : '';
                    $('ont-tanggal-kembali').value = ont.tanggalKembali ? new Date(ont.tanggalKembali).toISOString().slice(0, 16) : '';
                }
            }
            
            // Tampilkan modal
            ontModal.classList.remove('hidden');
        }

        // Show Inventory Modal
        function showInventoryModal(transactionType, inventoryId = null) {
            $('inventory-id').value = inventoryId || '';
            
            // Set judul form
            $('inventory-form-title').textContent = inventoryId ? 'Edit Inventory' : (transactionType === 'masuk' ? 'Tambah Stock Masuk' : 'Tambah Stock Keluar');
            
            // Set transaction type
            $('inventory-transaction-type').value = transactionType;
            
            // Fill form if editing
            if (inventoryId) {
                const inventory = dataCache.Inventory.find(i => i.id === inventoryId);
                if (inventory) {
                    $('inventory-item-name').value = inventory.namaItem;
                    $('inventory-item-type').value = inventory.jenis;
                    $('inventory-sn').value = inventory.serialNumber || '';
                    $('inventory-quantity').value = inventory.stock;
                    $('inventory-unit').value = inventory.satuan || 'PCS';
                    $('inventory-location').value = inventory.lokasi || '';
                    $('inventory-notes').value = inventory.keterangan || '';
                }
            } else {
                // Reset form for new entry
                $('inventory-item-name').value = '';
                $('inventory-item-type').value = 'ONT';
                $('inventory-sn').value = '';
                $('inventory-quantity').value = 1;
                $('inventory-unit').value = 'PCS';
                $('inventory-location').value = '';
                $('inventory-notes').value = '';
            }
            
            // Tampilkan modal
            inventoryModal.classList.remove('hidden');
        }

        function setupFormChangeTracking() {
            const inputs = formContent.querySelectorAll('input, select, textarea');
            currentFormData = getFormData();
            
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const newData = getFormData();
                    formHasChanges = JSON.stringify(currentFormData) !== JSON.stringify(newData);
                });
                
                input.addEventListener('change', () => {
                    const newData = getFormData();
                    formHasChanges = JSON.stringify(currentFormData) !== JSON.stringify(newData);
                });
            });
        }

        function getFormData() {
            const formData = new FormData(entityForm);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            return data;
        }

        function setupFormEventListeners(entityType, entityId = null) {
            // Setup GPS untuk OLT, ODC, ODP, Pelanggan
            if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                const gpsBtn = formContent.querySelector('#get-gps-btn');
                if (gpsBtn) {
                    gpsBtn.addEventListener('click', getGpsLocation);
                }
            }
            
            // Auto-generate customer number
            if (entityType === 'Pelanggan' && !entityId && settings.autoGenerateNumber) {
                const customerNumberInput = formContent.querySelector('input[name="customerNumber"]');
                if (customerNumberInput) {
                    // Get last customer number
                    const lastCustomer = dataCache.Pelanggan
                        .filter(p => !isNaN(p.customerNumber))
                        .sort((a, b) => parseInt(b.customerNumber) - parseInt(a.customerNumber))[0];
                    
                    let nextNumber = 1000;
                    if (lastCustomer && !isNaN(lastCustomer.customerNumber)) {
                        nextNumber = parseInt(lastCustomer.customerNumber) + 1;
                    }
                    
                    customerNumberInput.value = nextNumber;
                }
            }
            
            // Auto-fill nama ODC
            if (entityType === 'ODC') {
                const regionInput = formContent.querySelector('input[name="kodeWilayah"]');
                const sectorInput = formContent.querySelector('input[name="kodeSektor"]');
                const namaInput = formContent.querySelector('input[name="namaODC"]');
                
                const updateNamaODC = () => {
                    const region = regionInput?.value.toUpperCase() || '';
                    const sector = sectorInput?.value.toUpperCase() || '';
                    if (region && sector) {
                        namaInput.value = `ODC-${region}-${sector}`;
                    }
                };
                
                if (regionInput) regionInput.addEventListener('input', updateNamaODC);
                if (sectorInput) sectorInput.addEventListener('input', updateNamaODC);
            }
            
            // Auto-fill nama ODP
            if (entityType === 'ODP') {
                const regionInput = formContent.querySelector('input[name="kodeWilayah"]');
                const sectorInput = formContent.querySelector('input[name="kodeSektor"]');
                const namaInput = formContent.querySelector('input[name="namaODP"]');
                
                const updateNamaODP = () => {
                    const region = regionInput?.value.toUpperCase() || '';
                    const sector = sectorInput?.value.toUpperCase() || '';
                    if (region && sector) {
                        namaInput.value = `ODP-${region}-${sector}`;
                    }
                };
                
                if (regionInput) regionInput.addEventListener('input', updateNamaODP);
                if (sectorInput) sectorInput.addEventListener('input', updateNamaODP);
            }
            
            // Enhanced ODC dropdown for ODP
            if (entityType === 'ODP') {
                const odcRefSelect = formContent.querySelector('select[name="odcRef"]');
                if (odcRefSelect) {
                    // Clear existing options
                    odcRefSelect.innerHTML = '<option value="">Pilih ODC</option>';
                    
                    // Add search functionality
                    const searchInput = document.createElement('input');
                    searchInput.type = 'text';
                    searchInput.placeholder = 'Cari ODC...';
                    searchInput.className = 'w-full px-3 py-2 border border-gray-300 rounded-md mb-2';
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const options = odcRefSelect.querySelectorAll('option');
                        options.forEach(option => {
                            if (option.value === '') return;
                            const text = option.textContent.toLowerCase();
                            option.style.display = text.includes(searchTerm) ? 'block' : 'none';
                        });
                    });
                    
                    odcRefSelect.parentNode.insertBefore(searchInput, odcRefSelect);
                    
                    // Add ODC options with scroll
                    odcRefSelect.className += ' dropdown-scroll';
                    dataCache.ODC.forEach(odc => {
                        const option = document.createElement('option');
                        option.value = odc.id;
                        option.textContent = `${odc.namaODC} (${odc.kodeWilayah}-${odc.kodeSektor})`;
                        odcRefSelect.appendChild(option);
                    });
                }
            }
            
            // Enhanced OLT dropdown for ODC
            if (entityType === 'ODC') {
                const OLTRefSelect = formContent.querySelector('select[name="OLTRef"]');
                if (OLTRefSelect) {
                    // Clear existing options
                    OLTRefSelect.innerHTML = '<option value="">Pilih OLT</option>';
                    
                    // Add search functionality
                    const searchInput = document.createElement('input');
                    searchInput.type = 'text';
                    searchInput.placeholder = 'Cari OLT...';
                    searchInput.className = 'w-full px-3 py-2 border border-gray-300 rounded-md mb-2';
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const options = OLTRefSelect.querySelectorAll('option');
                        options.forEach(option => {
                            if (option.value === '') return;
                            const text = option.textContent.toLowerCase();
                            option.style.display = text.includes(searchTerm) ? 'block' : 'none';
                        });
                    });
                    
                    OLTRefSelect.parentNode.insertBefore(searchInput, OLTRefSelect);
                    
                    // Add OLT options with scroll
                    OLTRefSelect.className += ' dropdown-scroll';
                    dataCache.OLT.forEach(OLT => {
                        const option = document.createElement('option');
                        option.value = OLT.id;
                        option.textContent = `${OLT.code} - ${OLT.name}`;
                        OLTRefSelect.appendChild(option);
                    });
                    
                    // Auto-fill OLT info when selected
                    OLTRefSelect.addEventListener('change', (e) => {
                        const OLTId = e.target.value;
                        const OLT = dataCache.OLT.find(g => g.id === OLTId);
                        if (OLT) {
                            const OLTTypeInput = formContent.querySelector('input[name="OLTType"]');
                            if (OLTTypeInput) {
                                OLTTypeInput.value = OLT.name;
                            }
                        }
                    });
                }
            }
            
            // Validasi ODP match dengan ODC
            if (entityType === 'ODP') {
                const regionInput = formContent.querySelector('input[name="kodeWilayah"]');
                const sectorInput = formContent.querySelector('input[name="kodeSektor"]');
                const odcRefSelect = formContent.querySelector('select[name="odcRef"]');
                
                if (regionInput && sectorInput && odcRefSelect) {
                    const validateOdpMatchOdc = () => {
                        const region = regionInput.value.toUpperCase();
                        const sector = sectorInput.value.toUpperCase();
                        const odcId = odcRefSelect.value;
                        
                        if (region && sector && odcId) {
                            const odc = dataCache.ODC.find(o => o.id === odcId);
                            
                            if (odc) {
                                const odcRegion = odc.kodeWilayah.toUpperCase();
                                const odcSector = odc.kodeSektor.toUpperCase();
                                
                                if (region !== odcRegion || sector !== odcSector) {
                                    showToast(`ERROR: ODP-${region}-${sector} tidak match dengan ODC-${odcRegion}-${odcSector}. Harus sama!`, 'error');
                                    regionInput.classList.add('border-red-500');
                                    sectorInput.classList.add('border-red-500');
                                    odcRefSelect.classList.add('border-red-500');
                                    return false;
                                } else {
                                    regionInput.classList.remove('border-red-500');
                                    sectorInput.classList.remove('border-red-500');
                                    odcRefSelect.classList.remove('border-red-500');
                                    return true;
                                }
                            }
                        }
                        return true;
                    };
                    
                    regionInput.addEventListener('blur', validateOdpMatchOdc);
                    sectorInput.addEventListener('blur', validateOdpMatchOdc);
                    odcRefSelect.addEventListener('change', validateOdpMatchOdc);
                }
            }
        }

        function getGpsLocation() {
            const statusEl = formContent.querySelector('#gps-status');
            const latInput = formContent.querySelector('#location-lat');
            const lngInput = formContent.querySelector('#location-lng');
            
            if (!navigator.geolocation) {
                statusEl.textContent = 'Geolocation tidak didukung browser ini.';
                statusEl.classList.add('text-red-500');
                return;
            }
            
            statusEl.textContent = 'Mencari lokasi...';
            statusEl.classList.remove('text-red-500', 'text-green-500');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    latInput.value = latitude.toFixed(6);
                    lngInput.value = longitude.toFixed(6);
                    
                    statusEl.textContent = `Lokasi berhasil di-set! Akurasi: ${accuracy.toFixed(2)} meter`;
                    statusEl.classList.add('text-green-500');
                    
                    showToast('Lokasi berhasil di-set dengan akurasi tinggi', 'success');
                },
                (error) => {
                    let errorMessage = 'Gagal mendapatkan lokasi: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Akses lokasi ditolak';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Informasi lokasi tidak tersedia';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Permintaan lokasi timeout';
                            break;
                        default:
                            errorMessage += 'Error tidak diketahui';
                    }
                    statusEl.textContent = errorMessage;
                    statusEl.classList.add('text-red-500');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function generateFormFields(entityType, entityId) {
            let fields = '';
            const entity = entityId ? dataCache[entityType].find(e => e.id === entityId) : null;
            
            if (entityType === 'OLT') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">OLT *</label>
                        <input type="text" name="code" value="${entity?.code || ''}" placeholder="Contoh: GPON00, GPON01, EPON00, EPON01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                        
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type OLT *</label>
                        <input type="text" name="name" value="${entity?.name || ''}" placeholder="ZTE / HWI / EPON" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model *</label>
                        <input type="text" name="model" value="${entity?.model || ''}" placeholder="Huawei MA5608T" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number *</label>
                        <input type="text" name="sn" value="${entity?.sn || ''}" placeholder="HWTX123456789" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rak *</label>
                        <input type="text" name="rack" value="${entity?.rack || ''}" placeholder="Rack A-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Slot *</label>
                        <input type="number" name="totalSlots" value="${entity?.totalSlots || 8}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Port *</label>
                        <input type="number" name="totalPorts" value="${entity?.totalPorts || 128}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'ODC') {
                const OLTOptions = dataCache.OLT.map(OLT => 
                    `<option value="${OLT.id}" ${entity?.OLTRef === OLT.id ? 'selected' : ''}>${OLT.code} - ${OLT.name}</option>`
                ).join('');
                
                fields = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Wilayah *</label>
                        <input type="text" name="kodeWilayah" value="${entity?.kodeWilayah || ''}" placeholder="SBY" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Sektor *</label>
                        <input type="text" name="kodeSektor" value="${entity?.kodeSektor || ''}" placeholder="FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama ODC *</label>
                        <input type="text" name="namaODC" value="${entity?.namaODC || ''}" placeholder="ODC-SBY-FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kapasitas *</label>
                        <input type="number" name="capacity" value="${entity?.capacity || 144}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">OLT *</label>
                        <select name="OLTRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih OLT</option>
                            ${OLTOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis OLT</label>
                        <input type="text" name="OLTType" value="${entity?.OLTType || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Slot OLT *</label>
                        <input type="number" name="OLTSlot" value="${entity?.OLTSlot || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port OLT *</label>
                        <input type="number" name="OLTPort" value="${entity?.OLTPort || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Feeder *</label>
                        <input type="text" name="panelFeeder" value="${entity?.panelFeeder || ''}" placeholder="PF-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Feeder *</label>
                        <input type="number" name="portFeeder" value="${entity?.portFeeder || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Distribusi *</label>
                        <input type="text" name="panelDistribusi" value="${entity?.panelDistribusi || ''}" placeholder="PD-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Distribusi *</label>
                        <input type="number" name="portDistribusi" value="${entity?.portDistribusi || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'ODP') {
                const odcOptions = dataCache.ODC.map(odc => 
                    `<option value="${odc.id}" ${entity?.odcRef === odc.id ? 'selected' : ''}>${odc.namaODC} (${odc.kodeWilayah}-${odc.kodeSektor})</option>`
                ).join('');
                
                // Get available splitters from inventory
                const splitters = dataCache.Inventory.filter(item => item.jenis === 'SPLITTER' && item.stock > 0);
                const splitterOptions = splitters.map(splitter => 
                    `<option value="${splitter.id}" ${entity?.splitterRef === splitter.id ? 'selected' : ''}>${splitter.namaItem} (Stock: ${splitter.stock})</option>`
                ).join('');
                
                fields = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Wilayah *</label>
                        <input type="text" name="kodeWilayah" value="${entity?.kodeWilayah || ''}" placeholder="SBY" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sektor ODP *</label>
                        <input type="text" name="kodeSektor" value="${entity?.kodeSektor || ''}" placeholder="FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor ODP *</label>
                        <input type="text" name="nomorODC" value="${entity?.nomorODC || ''}" placeholder="01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama ODP *</label>
                        <input type="text" name="namaODP" value="${entity?.namaODP || ''}" placeholder="ODP-SBY-FA/001" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ODC *</label>
                        <select name="odcRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih ODC</option>
                            ${odcOptions}
                        </select>
                        <p class="text-xs text-red-500 font-semibold mt-1">WARNING: Kode Wilayah & Sektor HARUS match dengan ODC terpilih!</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Material Splitter</label>
                        <select name="splitterRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Splitter</option>
                            ${splitterOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Feeder *</label>
                        <input type="text" name="panelFeeder" value="${entity?.panelFeeder || ''}" placeholder="PF-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Feeder *</label>
                        <input type="number" name="portFeeder" value="${entity?.portFeeder || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Distribusi *</label>
                        <input type="text" name="panelDistribusi" value="${entity?.panelDistribusi || ''}" placeholder="PD-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Distribusi *</label>
                        <select name="portDistribusi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="2" ${entity?.portDistribusi == 2 ? 'selected' : ''}>2 Port</option>
                            <option value="4" ${entity?.portDistribusi == 4 ? 'selected' : ''}>4 Port</option>
                            <option value="8" ${entity?.portDistribusi == 8 ? 'selected' : ''}>8 Port</option>
                            <option value="16" ${entity?.portDistribusi == 16 ? 'selected' : ''}>16 Port</option>
                            <option value="32" ${entity?.portDistribusi == 32 ? 'selected' : ''}>32 Port</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Port *</label>
                        <select name="totalPorts" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="2" ${entity?.totalPorts == 2 ? 'selected' : ''}>2 Port</option>
                            <option value="4" ${entity?.totalPorts == 4 ? 'selected' : ''}>4 Port</option>
                            <option value="8" ${entity?.totalPorts == 8 ? 'selected' : ''}>8 Port</option>
                            <option value="16" ${entity?.totalPorts == 16 ? 'selected' : ''}>16 Port</option>
                            <option value="32" ${entity?.totalPorts == 32 ? 'selected' : ''}>32 Port</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'Pelanggan') {
                const odpOptions = dataCache.ODP.map(odp => {
                    const capacity = getOdpCapacity(odp);
                    return `<option value="${odp.id}" ${entity?.odpRef === odp.id ? 'selected' : ''}>${odp.namaODP} (${capacity.used}/${odp.totalPorts})</option>`;
                }).join('');
                
                const paketOptions = dataCache.Paket.map(paket => 
                    `<option value="${paket.id}" ${entity?.paketRef === paket.id ? 'selected' : ''}>${paket.jenis} - ${paket.kecepatan}</option>`
                ).join('');
                
                // Generate nomor pelanggan otomatis jika mode aktif
                const autoGenerate = settings.autoGenerateNumber || false;
                let customerNumber = entity?.customerNumber || '';
                
                if (!entityId && autoGenerate) {
                    // Get last customer number
                    const lastCustomer = dataCache.Pelanggan
                        .filter(p => !isNaN(p.customerNumber))
                        .sort((a, b) => parseInt(b.customerNumber) - parseInt(a.customerNumber))[0];
                    
                    let nextNumber = 1000;
                    if (lastCustomer && !isNaN(lastCustomer.customerNumber)) {
                        nextNumber = parseInt(lastCustomer.customerNumber) + 1;
                    }
                    
                    customerNumber = nextNumber;
                }
                
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Pelanggan *</label>
                        <input type="text" name="customerNumber" value="${customerNumber}" placeholder="1000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        ${autoGenerate && !entityId ? '<p class="text-xs text-green-600 mt-1">Nomor di-generate otomatis</p>' : ''}
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                        <input type="text" name="name" value="${entity?.name || ''}" placeholder="Budi Santoso" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                        <input type="text" name="username" value="${entity?.username || ''}" placeholder="budi123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 lowercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" name="password" value="${entity?.password || ''}" placeholder="••••••" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat *</label>
                        <textarea name="address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>${entity?.address || ''}</textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Paket Layanan *</label>
                        <select name="paketRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Paket</option>
                            ${paketOptions}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ODP *</label>
                        <select name="odpRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih ODP</option>
                            ${odpOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port ODP *</label>
                        <input type="number" name="odpPort" value="${entity?.odpPort || ''}" min="1" max="32" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis ONT</label>
                        <input type="text" name="jenisONT" value="${entity?.jenisONT || ''}" placeholder="HG8245H" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">SN ONT</label>
                        <input type="text" name="snONT" value="${entity?.snONT || ''}" placeholder="ONT123456789" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IP Address</label>
                        <input type="text" name="ipAddress" value="${entity?.ipAddress || ''}" placeholder="192.168.1.100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="active" ${entity?.status === 'active' ? 'selected' : ''}>Aktif</option>
                            <option value="pending" ${entity?.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="inactive" ${entity?.status === 'inactive' ? 'selected' : ''}>Nonaktif</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'Paket') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Paket *</label>
                        <input type="text" name="jenis" value="${entity?.jenis || ''}" placeholder="Basic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kecepatan *</label>
                        <input type="text" name="kecepatan" value="${entity?.kecepatan || ''}" placeholder="10 Mbps" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Harga *</label>
                        <input type="number" name="harga" value="${entity?.harga || ''}" placeholder="150000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                `;
            } else if (entityType === 'Karyawan') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                        <input type="text" name="nama" value="${entity?.nama || ''}" placeholder="Ahmad Fauzi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" name="email" value="${entity?.email || ''}" placeholder="ahmad@ftth.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 lowercase" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
                        <select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Role</option>
                            <option value="Owner" ${entity?.role === 'Owner' ? 'selected' : ''}>Owner</option>
                            <option value="Admin" ${entity?.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Teknisi" ${entity?.role === 'Teknisi' ? 'selected' : ''}>Teknisi</option>
                            <option value="Operator" ${entity?.role === 'Operator' ? 'selected' : ''}>Operator</option>
                            <option value="Gudang" ${entity?.role === 'Gudang' ? 'selected' : ''}>Petugas Gudang</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="Aktif" ${entity?.status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                            <option value="Nonaktif" ${entity?.status === 'Nonaktif' ? 'selected' : ''}>Nonaktif</option>
                        </select>
                    </div>
                `;
            }
            
            return fields;
        }

        // Event listener untuk form submission
        entityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveEntity();
        });

        // Save Ticket
        async function saveTicket(e) {
            e.preventDefault();
            
            const ticketId = $('ticket-id').value;
            const nomorTicket = $('ticket-number').value;
            const nomorInternet = $('ticket-customer').value;
            const jenisGangguan = $('ticket-jenis').value;
            const serialNumberLama = $('ticket-sn-lama').value;
            const serialNumberBaru = $('ticket-sn-baru').value;
            const userIdTeknisi = $('ticket-teknisi').value;
            const tanggalLapor = $('ticket-tanggal-lapor').value;
            const status = $('ticket-status').value;
            
            // Validate workflow
            if (ticketId) {
                const oldTicket = dataCache.Tickets.find(t => t.id === ticketId);
                if (oldTicket && oldTicket.status === 'open' && status === 'closed') {
                    showToast('Tidak bisa langsung mengubah status dari Open ke Closed', 'error');
                    return;
                }
            }
            
            try {
                const ticketData = {
                    nomorTicket,
                    nomorInternet,
                    jenisGangguan,
                    serialNumberLama,
                    serialNumberBaru,
                    userIdTeknisi,
                    tanggalLapor: new Date(tanggalLapor),
                    status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser?.email || 'unknown@user.com'
                };
                
                if (isOnline) {
                    if (ticketId) {
                        // Update existing ticket
                        await db.collection('Tickets').doc(ticketId).update(ticketData);
                        showToast('Ticket gangguan berhasil diperbarui', 'success');
                    } else {
                        // Add new ticket
                        ticketData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        ticketData.createdBy = currentUser?.email || 'unknown@user.com';
                        await db.collection('Tickets').add(ticketData);
                        showToast('Ticket gangguan berhasil dibuat', 'success');
                    }
                    
                    // Log audit
                    await logAudit(ticketId ? 'update' : 'create', 'Tickets', ticketId || 'new', ticketData);
                    
                    // Reload data
                    await loadDataFromFirestore('Tickets');
                } else {
                    // Offline mode - save to queue
                    if (ticketId) {
                        offlineQueue.push({
                            action: 'update',
                            entityType: 'Tickets',
                            entityId: ticketId,
                            data: ticketData,
                            timestamp: new Date().getTime()
                        });
                        showToast('Perubahan ticket disimpan dalam antrian offline', 'warning');
                    } else {
                        ticketData.createdAt = new Date();
                        ticketData.createdBy = currentUser?.email || 'unknown@user.com';
                        offlineQueue.push({
                            action: 'create',
                            entityType: 'Tickets',
                            data: ticketData,
                            timestamp: new Date().getTime()
                        });
                        showToast('Ticket baru disimpan dalam antrian offline', 'warning');
                    }
                    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                    updateOfflineQueueUI();
                }
                
                // Refresh UI
                renderTicketsTable();
                updateTicketStats();
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
                // Tutup modal
                ticketModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving ticket:', error);
                showToast('Gagal menyimpan ticket gangguan', 'error');
            }
        }

        // Save ONT
        async function saveOnt(e) {
            e.preventDefault();
            
            const ontId = $('ont-id').value;
            const serialNumber = $('ont-sn').value;
            const status = $('ont-status').value;
            const userIdTeknisi = $('ont-teknisi').value;
            const tanggalAmbil = $('ont-tanggal-ambil').value;
            const tanggalKembali = $('ont-tanggal-kembali').value;
            
            // Calculate loan duration if returned
            let durasiPinjaman = null;
            if (tanggalKembali) {
                const start = new Date(tanggalAmbil);
                const end = new Date(tanggalKembali);
                const diffMs = end - start;
                durasiPinjaman = Math.floor(diffMs / (1000 * 60 * 60)); // in hours
            }
            
            try {
                const ontData = {
                    serialNumber,
                    status,
                    userIdTeknisi,
                    tanggalAmbil: tanggalAmbil ? new Date(tanggalAmbil) : null,
                    tanggalKembali: tanggalKembali ? new Date(tanggalKembali) : null,
                    durasiPinjaman,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser?.email || 'unknown@user.com'
                };
                
                if (isOnline) {
                    if (ontId) {
                        // Update existing ONT
                        await db.collection('ONTTracking').doc(ontId).update(ontData);
                        showToast('ONT tracking berhasil diperbarui', 'success');
                    } else {
                        // Add new ONT
                        ontData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        ontData.createdBy = currentUser?.email || 'unknown@user.com';
                        await db.collection('ONTTracking').add(ontData);
                        showToast('ONT tracking berhasil ditambahkan', 'success');
                    }
                    
                    // Log audit
                    await logAudit(ontId ? 'update' : 'create', 'ONTTracking', ontId || 'new', ontData);
                    
                    // Reload data
                    await loadDataFromFirestore('ONTTracking');
                } else {
                    // Offline mode - save to queue
                    if (ontId) {
                        offlineQueue.push({
                            action: 'update',
                            entityType: 'ONTTracking',
                            entityId: ontId,
                            data: ontData,
                            timestamp: new Date().getTime()
                        });
                        showToast('Perubahan ONT disimpan dalam antrian offline', 'warning');
                    } else {
                        ontData.createdAt = new Date();
                        ontData.createdBy = currentUser?.email || 'unknown@user.com';
                        offlineQueue.push({
                            action: 'create',
                            entityType: 'ONTTracking',
                            data: ontData,
                            timestamp: new Date().getTime()
                        });
                        showToast('ONT baru disimpan dalam antrian offline', 'warning');
                    }
                    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                    updateOfflineQueueUI();
                }
                
                // Refresh UI
                renderOntTable();
                updateOntStats();
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
                // Tutup modal
                ontModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving ONT:', error);
                showToast('Gagal menyimpan ONT tracking', 'error');
            }
        }

        // Save Inventory
        async function saveInventory(e) {
            e.preventDefault();
            
            const inventoryId = $('inventory-id').value;
            const transactionType = $('inventory-transaction-type').value;
            const itemName = $('inventory-item-name').value;
            const itemType = $('inventory-item-type').value;
            const serialNumber = $('inventory-sn').value;
            const quantity = parseInt($('inventory-quantity').value);
            const unit = $('inventory-unit').value;
            const location = $('inventory-location').value;
            const notes = $('inventory-notes').value;
            
            try {
                const inventoryData = {
                    namaItem: itemName,
                    jenis: itemType,
                    serialNumber: serialNumber || null,
                    satuan: unit,
                    lokasi: location,
                    keterangan: notes,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser?.email || 'unknown@user.com'
                };
                
                if (isOnline) {
                    if (inventoryId) {
                        // Update existing inventory
                        await db.collection('Inventory').doc(inventoryId).update(inventoryData);
                        showToast('Inventory berhasil diperbarui', 'success');
                    } else {
                        // Add new inventory
                        inventoryData.stock = transactionType === 'masuk' ? quantity : -quantity;
                        inventoryData.minStock = 5; // Default minimum stock
                        inventoryData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        inventoryData.createdBy = currentUser?.email || 'unknown@user.com';
                        await db.collection('Inventory').add(inventoryData);
                        
                        // Add transaction record
                        const transactionData = {
                            itemName,
                            itemType,
                            serialNumber,
                            quantity,
                            unit,
                            transactionType,
                            location,
                            notes,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: currentUser?.email || 'unknown@user.com'
                        };
                        await db.collection('InventoryTransaksi').add(transactionData);
                        
                        showToast('Inventory berhasil ditambahkan', 'success');
                    }
                    
                    // Log audit
                    await logAudit(inventoryId ? 'update' : 'create', 'Inventory', inventoryId || 'new', inventoryData);
                    
                    // Reload data
                    await loadDataFromFirestore('Inventory');
                    await loadDataFromFirestore('InventoryTransaksi');
                } else {
                    // Offline mode - save to queue
                    if (inventoryId) {
                        offlineQueue.push({
                            action: 'update',
                            entityType: 'Inventory',
                            entityId: inventoryId,
                            data: inventoryData,
                            timestamp: new Date().getTime()
                        });
                        showToast('Perubahan inventory disimpan dalam antrian offline', 'warning');
                    } else {
                        inventoryData.stock = transactionType === 'masuk' ? quantity : -quantity;
                        inventoryData.minStock = 5;
                        inventoryData.createdAt = new Date();
                        inventoryData.createdBy = currentUser?.email || 'unknown@user.com';
                        offlineQueue.push({
                            action: 'create',
                            entityType: 'Inventory',
                            data: inventoryData,
                            timestamp: new Date().getTime()
                        });
                        
                        // Add transaction to queue
                        const transactionData = {
                            itemName,
                            itemType,
                            serialNumber,
                            quantity,
                            unit,
                            transactionType,
                            location,
                            notes,
                            createdAt: new Date(),
                            createdBy: currentUser?.email || 'unknown@user.com'
                        };
                        offlineQueue.push({
                            action: 'create',
                            entityType: 'InventoryTransaksi',
                            data: transactionData,
                            timestamp: new Date().getTime()
                        });
                        
                        showToast('Inventory baru disimpan dalam antrian offline', 'warning');
                    }
                    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                    updateOfflineQueueUI();
                }
                
                // Refresh UI
                renderInventoryTable();
                updateInventoryStats();
                
                // Simpan data ke localStorage untuk mode offline
                saveLocalData();
                
                // Tutup modal
                inventoryModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving inventory:', error);
                showToast('Gagal menyimpan inventory', 'error');
            }
        }

        async function saveEntity() {
    const entityType = formEntityType.value;
    const entityId = formEntityId.value;
    const submitButton = entityForm.querySelector('button[type="submit"]');
    const submitSpinner = $('submit-spinner');
    const submitText = $('submit-button-text');
    
    // Tampilkan loading state
    submitText.textContent = 'Menyimpan...';
    submitSpinner.classList.remove('hidden');
    submitButton.disabled = true;
    
    try {
        const formData = new FormData(entityForm);
        const data = Object.fromEntries(formData.entries());

        // ⭐⭐ DEBUG - TARUH DI SINI ⭐⭐
        console.log('🔍 DATA EMAIL:', data.email);
        console.log('🔍 FULL DATA:', data);

        // KHUSUS UNTUK KARYAWAN - BUAT FIREBASE AUTH ACCOUNT
        if (entityType === 'Karyawan' && !entityId) {
            // Generate random password
            const generatedPassword = generateRandomPassword();
            
            // Buat user di Firebase Auth
            const userCredential = await auth.createUserWithEmailAndPassword(
                data.email, 
                generatedPassword
            );
            
            const uid = userCredential.user.uid;
            
            // Simpan data ke Firestore
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            data.createdBy = currentUser?.email || 'unknown@user.com';
            await db.collection('Karyawan').doc(uid).set(data);
            
            // KIRIM EMAIL PASSWORD
            await sendPasswordEmail(data.email, data.nama, generatedPassword, data.role);
            
            showToast('Karyawan berhasil ditambahkan dan password dikirim via email', 'success');
        }

        // ⭐⭐ PERBAIKAN: JIKA EDIT KARYAWAN DAN YANG DIEDIT ADALAH USER SENDIRI ⭐⭐
        if (entityType === 'Karyawan' && entityId && entityId === userId) {
            console.log('🔄 User mengedit data sendiri, memeriksa perubahan role...');
            // Simpan role lama untuk perbandingan
            const oldRole = userRole;
            const newRole = data.role;
            
            if (oldRole !== newRole) {
                console.log(`🔄 Role berubah dari ${oldRole} menjadi ${newRole}`);
                // Tunggu sebentar untuk memastikan Firestore sudah update
                setTimeout(() => {
                    updateUserRoleUI();
                }, 1500);
            }
        }

        // ⭐⭐ VALIDASI: HANYA ADMIN YANG BISA EDIT ROLE/STATUS KARYAWAN ⭐⭐
        if (entityType === 'Karyawan' && entityId) {
            // Cek jika user mencoba mengubah role atau status
            const oldData = dataCache.Karyawan.find(k => k.id === entityId);
            if (oldData) {
                const isRoleChanged = oldData.role !== data.role;
                const isStatusChanged = oldData.status !== data.status;
                
                // Jika mencoba mengubah role atau status, validasi apakah user adalah admin
                if ((isRoleChanged || isStatusChanged) && userRole !== 'Admin' && userRole !== 'Owner') {
                    throw new Error('Hanya Admin yang dapat mengubah role atau status karyawan');
                }
            }
        }
        
        // Convert to uppercase for specific fields
        if (entityType === 'OLT') {
            data.name = data.name ? data.name.toUpperCase() : '';
            data.model = data.model ? data.model.toUpperCase() : '';
            data.sn = data.sn ? data.sn.toUpperCase() : '';
            data.rack = data.rack ? data.rack.toUpperCase() : '';
        } else if (entityType === 'ODC') {
            data.kodeWilayah = data.kodeWilayah ? data.kodeWilayah.toUpperCase() : '';
            data.kodeSektor = data.kodeSektor ? data.kodeSektor.toUpperCase() : '';
            data.namaODC = data.namaODC ? data.namaODC.toUpperCase() : '';
            data.panelFeeder = data.panelFeeder ? data.panelFeeder.toUpperCase() : '';
            data.panelDistribusi = data.panelDistribusi ? data.panelDistribusi.toUpperCase() : '';
        } else if (entityType === 'ODP') {
            data.kodeWilayah = data.kodeWilayah ? data.kodeWilayah.toUpperCase() : '';
            data.kodeSektor = data.kodeSektor ? data.kodeSektor.toUpperCase() : '';
            data.namaODP = data.namaODP ? data.namaODP.toUpperCase() : '';
            data.panelFeeder = data.panelFeeder ? data.panelFeeder.toUpperCase() : '';
            data.panelDistribusi = data.panelDistribusi ? data.panelDistribusi.toUpperCase() : '';
        } else if (entityType === 'Pelanggan') {
            data.name = data.name ? data.name.toUpperCase() : '';
            data.jenisONT = data.jenisONT ? data.jenisONT.toUpperCase() : '';
            data.snONT = data.snONT ? data.snONT.toUpperCase() : '';
        } else if (entityType === 'Paket') {
            data.jenis = data.jenis ? data.jenis.toUpperCase() : '';
        } else if (entityType === 'Karyawan') {
            data.nama = data.nama ? data.nama.toUpperCase() : '';
        }
        
        // Parse nested objects
        if (data.location && data.location.lat && data.location.lng) {
            data.location = {
                lat: parseFloat(data.location.lat),
                lng: parseFloat(data.location.lng)
            };
        }
        
        // Parse numbers
        Object.keys(data).forEach(key => {
            if (!isNaN(data[key]) && data[key] !== '') {
                data[key] = parseFloat(data[key]);
            }
        });
        
        // Validasi khusus untuk ODP - cek apakah ada ODC di sektor yang sama
        if (entityType === 'ODP') {
            const region = data.kodeWilayah;
            const sector = data.kodeSektor;
            
            if (region && sector) {
                const matchingODC = dataCache.ODC.find(odc => 
                    odc.kodeWilayah === region && odc.kodeSektor === sector
                );
                
                if (!matchingODC) {
                    throw new Error(`Tidak ada ODC dengan wilayah ${region} dan sektor ${sector}. Tidak dapat menambah ODP di sektor ini.`);
                }
            }
        }
        
        // Validasi khusus untuk Pelanggan - cek port ODP
        if (entityType === 'Pelanggan') {
            const odpId = data.odpRef;
            const port = data.odpPort;
            
            if (odpId && port) {
                const odp = dataCache.ODP.find(o => o.id === odpId);
                const capacity = getOdpCapacity(odp);
                
                if (port > capacity.total) {
                    throw new Error(`Port ${port} melebihi kapasitas ODP (${capacity.total})`);
                }
                
                const existingCustomer = dataCache.Pelanggan.find(p => 
                    p.odpRef === odpId && p.odpPort === port && p.id !== entityId
                );
                
                if (existingCustomer) {
                    throw new Error(`Port ${port} pada ODP ini sudah terisi oleh pelanggan ${existingCustomer.name}`);
                }
            }
        }
        
        // Validasi untuk ODC - cek duplikasi slot/port OLT
        if (entityType === 'ODC') {
            const OLTId = data.OLTRef;
            const slot = data.OLTSlot;
            const port = data.OLTPort;
            
            if (OLTId && slot && port) {
                const existingODC = dataCache.ODC.find(odc => 
                    odc.OLTRef === OLTId && 
                    odc.OLTSlot === parseInt(slot) && 
                    odc.OLTPort === parseInt(port) &&
                    odc.id !== entityId
                );
                
                if (existingODC) {
                    throw new Error(`Slot ${slot}/Port ${port} pada OLT ini sudah digunakan oleh ODC ${existingODC.namaODC}`);
                }
            }
        }
        
        // Validasi untuk ODC - cek duplikasi panel feeder/port feeder
        if (entityType === 'ODC') {
            const panelFeeder = data.panelFeeder;
            const portFeeder = data.portFeeder;
            
            if (panelFeeder && portFeeder) {
                const existingODC = dataCache.ODC.find(odc => 
                    odc.panelFeeder === panelFeeder && 
                    odc.portFeeder === parseInt(portFeeder) &&
                    odc.id !== entityId
                );
                
                if (existingODC) {
                    throw new Error(`Panel Feeder ${panelFeeder}/Port ${portFeeder} sudah digunakan oleh ODC ${existingODC.namaODC}`);
                }
            }
        }
        
        // Validasi untuk ODC - cek port distribusi tidak melebihi kapasitas
        if (entityType === 'ODC') {
            const portDistribusi = data.portDistribusi;
            const capacity = data.capacity;
            
            if (portDistribusi && capacity && parseInt(portDistribusi) > parseInt(capacity)) {
                throw new Error(`Port Distribusi (${portDistribusi}) tidak boleh melebihi kapasitas ODC (${capacity})`);
            }
        }

        // Validasi khusus untuk EDIT ODC
        if (entityType === 'ODC' && entityId) {
            const OLTId = data.OLTRef;
            const slot = data.OLTSlot;
            const port = data.OLTPort;
            
            if (OLTId && slot && port) {
                const selectedOLT = dataCache.OLT.find(olt => olt.id === OLTId);
                if (selectedOLT) {
                    if (parseInt(slot) > parseInt(selectedOLT.totalSlots)) {
                        throw new Error(`Slot ${slot} melebihi kapasitas OLT ${selectedOLT.code} (maks: ${selectedOLT.totalSlots})`);
                    }
                    if (parseInt(port) > parseInt(selectedOLT.totalPorts)) {
                        throw new Error(`Port ${port} melebihi kapasitas OLT ${selectedOLT.code} (maks: ${selectedOLT.totalPorts})`);
                    }
                }
            }
        }
        
        // Tambah timestamp dan user info
        data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        data.updatedBy = currentUser?.email || 'unknown@user.com';
        
        if (isOnline) {
            if (entityId) {
                // Update existing entity
                await db.collection(entityType).doc(entityId).update(data);
                showToast(`${entityType} berhasil diperbarui`, 'success');
                
                // Update local cache
                const index = dataCache[entityType].findIndex(item => item.id === entityId);
                if (index !== -1) {
                    dataCache[entityType][index] = { ...dataCache[entityType][index], ...data };
                }
                
                // Log audit
                await logAudit('update', entityType, entityId, data);
            } else {
                // Add new entity
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                data.createdBy = currentUser?.email || 'unknown@user.com';
                const docRef = await db.collection(entityType).add(data);
                const newId = docRef.id;
                
                // Update local cache
                dataCache[entityType].push({ ...data, id: newId });
                
                showToast(`${entityType} berhasil ditambahkan`, 'success');
                
                // Log audit
                await logAudit('create', entityType, newId, data);
            }
            
            // Reload data from Firestore to ensure consistency
            await loadDataFromFirestore(entityType);
        } else {
            // Offline mode - save to queue
            if (entityId) {
                offlineQueue.push({
                    action: 'update',
                    entityType: entityType,
                    entityId: entityId,
                    data: data,
                    timestamp: new Date().getTime()
                });
                showToast('Perubahan disimpan dalam antrian offline', 'warning');
            } else {
                data.createdAt = new Date();
                data.createdBy = currentUser?.email || 'unknown@user.com';
                offlineQueue.push({
                    action: 'create',
                    entityType: entityType,
                    data: data,
                    timestamp: new Date().getTime()
                });
                showToast('Data baru disimpan dalam antrian offline', 'warning');
            }
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            updateOfflineQueueUI();
        }
        
        // Update UI
        if ($('table-title').dataset.entity === entityType) {
            renderTable(entityType, dataCache[entityType]);
        }
        
        if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
            renderMarkers(entityType, dataCache[entityType]);
        }
        
        updateDashboardStats();
        
        // Save data to localStorage for offline mode
        saveLocalData();
        
        // Close modal
        formModal.classList.add('hidden');
        formHasChanges = false;
        
    } catch (error) {
        console.error('Error saving entity:', error);
        showToast(`Gagal menyimpan ${entityType}: ${error.message}`, 'error');
    } finally {
        // Reset loading state
        submitText.textContent = 'Simpan';
        submitSpinner.classList.add('hidden');
        submitButton.disabled = false;
    }
}

    
        // Delete Ticket
        // ⭐⭐ GANTI FUNGSI INI SEPENUHNYA ⭐⭐
async function deleteTicket(ticketId) {
    if (!confirm('Hapus ticket ini?')) return;
    
    // 1. HAPUS DARI UI & CACHE SEKARANG JUGA
    dataCache.Tickets = dataCache.Tickets.filter(item => item.id !== ticketId);
    
    // 2. REFRESH UI IMMEDIATE
    renderTicketsTable();
    updateTicketStats();
    
    showToast('Ticket dihapus', 'success');
    
    // 3. PROSES FIREBASE DI BACKGROUND
    if (isOnline) {
        db.collection('Tickets').doc(ticketId).delete().catch(e => {
            console.error('Gagal hapus ticket dari server:', e);
        });
    } else {
        offlineQueue.push({
            action: 'delete',
            entityType: 'Tickets',
            entityId: ticketId,
            timestamp: Date.now()
        });
        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
    }
}

        // Delete ONT
        // ⭐⭐ GANTI FUNGSI INI SEPENUHNYA ⭐⭐
async function deleteOnt(ontId) {
    if (!confirm('Hapus ONT ini?')) return;
    
    // 1. HAPUS DARI UI & CACHE SEKARANG JUGA
    dataCache.ONTTracking = dataCache.ONTTracking.filter(item => item.id !== ontId);
    
    // 2. REFRESH UI IMMEDIATE
    renderOntTable();
    updateOntStats();
    
    showToast('ONT dihapus', 'success');
    
    // 3. PROSES FIREBASE DI BACKGROUND
    if (isOnline) {
        db.collection('ONTTracking').doc(ontId).delete().catch(e => {
            console.error('Gagal hapus ONT dari server:', e);
        });
    } else {
        offlineQueue.push({
            action: 'delete',
            entityType: 'ONTTracking',
            entityId: ontId,
            timestamp: Date.now()
        });
        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
    }
}

        // Delete Inventory
        // ⭐⭐ GANTI FUNGSI INI SEPENUHNYA ⭐⭐
async function deleteInventory(inventoryId) {
    if (!confirm('Hapus inventory ini?')) return;
    
    // 1. HAPUS DARI UI & CACHE SEKARANG JUGA
    dataCache.Inventory = dataCache.Inventory.filter(item => item.id !== inventoryId);
    
    // 2. REFRESH UI IMMEDIATE
    renderInventoryTable();
    updateInventoryStats();
    
    showToast('Inventory dihapus', 'success');
    
    // 3. PROSES FIREBASE DI BACKGROUND
    if (isOnline) {
        db.collection('Inventory').doc(inventoryId).delete().catch(e => {
            console.error('Gagal hapus inventory dari server:', e);
        });
    } else {
        offlineQueue.push({
            action: 'delete',
            entityType: 'Inventory',
            entityId: inventoryId,
            timestamp: Date.now()
        });
        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
    }
}

        // ⭐⭐ GANTI FUNGSI INI SEPENUHNYA ⭐⭐
async function deleteEntity(entityType, entityId) {
    if (!confirm(`Hapus ${entityType} ini?`)) return;
    
    // 1. HAPUS DARI UI & CACHE SEKARANG JUGA
    dataCache[entityType] = dataCache[entityType].filter(item => item.id !== entityId);
    
    // 2. REFRESH UI IMMEDIATE  
    if ($('table-title').dataset.entity === entityType) {
        renderTable(entityType, dataCache[entityType]);
    }
    
    showToast(`${entityType} dihapus`, 'success');
    
    // 3. PROSES FIREBASE DI BACKGROUND (TIDAK PERLU TUNGGU)
    if (isOnline) {
        db.collection(entityType).doc(entityId).delete().catch(e => {
            console.error('Gagal hapus dari server:', e);
        });
    } else {
        offlineQueue.push({
            action: 'delete',
            entityType: entityType,
            entityId: entityId,
            timestamp: Date.now()
        });
        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
    }
}
    function showDetailModal(entityType, entityId) {
    const entity = dataCache[entityType].find(e => e.id === entityId);
    if (!entity) return;

    document.getElementById('detail-title').textContent = `Detail ${entityType}`;
    
    let content = '';
    
    if (entityType === 'OLT') {
        const connectedODCs = dataCache.ODC.filter(odc => odc.OLTRef === entityId);
        const capacityPercentage = entity.totalPorts > 0 ? ((connectedODCs.length / entity.totalPorts) * 100).toFixed(1) : 0;
        
        // Hitung total ODP dan Pelanggan yang terhubung
        let totalODP = 0;
        let totalPelanggan = 0;
        let totalPelangganAktif = 0;
        
        connectedODCs.forEach(odc => {
            const odpList = dataCache.ODP.filter(odp => odp.odcRef === odc.id);
            totalODP += odpList.length;
            odpList.forEach(odp => {
                const pelangganList = dataCache.Pelanggan.filter(p => p.odpRef === odp.id);
                totalPelanggan += pelangganList.length;
                totalPelangganAktif += pelangganList.filter(p => p.status === 'active').length;
            });
        });
        
        content = `
            <div class="space-y-6">
                <!-- Informasi OLT -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Informasi OLT</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Kode OLT</label>
                            <div class="text-lg font-bold text-gray-900">${entity.code || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Type OLT</label>
                            <div class="text-lg font-bold text-gray-900">${entity.name || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Model</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.model || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Serial Number</label>
                            <div class="text-lg font-semibold text-gray-800 font-mono">${entity.sn || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Lokasi Rak</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.rack || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Total Slot</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.totalSlots || 0}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Total Port</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.totalPorts || 0}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Port Terpakai</label>
                            <div class="text-lg font-semibold ${connectedODCs.length >= entity.totalPorts ? 'text-red-600' : 'text-green-600'}">${connectedODCs.length}</div>
                        </div>
                    </div>
                    
                    <!-- Statistik -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 p-4 bg-blue-50 rounded-lg">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${connectedODCs.length}</div>
                            <div class="text-sm text-blue-800">ODC</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${totalODP}</div>
                            <div class="text-sm text-green-800">ODP</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${totalPelanggan}</div>
                            <div class="text-sm text-purple-800">Total Pelanggan</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${totalPelangganAktif}</div>
                            <div class="text-sm text-green-800">Aktif</div>
                        </div>
                    </div>
                    
                    <!-- Capacity Indicator -->
                    <div class="mt-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Utilisasi Port</span>
                            <span class="font-semibold ${capacityPercentage >= 100 ? 'text-red-600' : (capacityPercentage >= 75 ? 'text-yellow-600' : 'text-green-600')}">${capacityPercentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full ${capacityPercentage >= 100 ? 'bg-red-500' : (capacityPercentage >= 75 ? 'bg-yellow-500' : 'bg-green-500')}" style="width: ${Math.min(capacityPercentage, 100)}%"></div>
                        </div>
                    </div>
                    
                    ${entity.location ? `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Lokasi GPS</label>
                        <div class="text-md font-mono text-gray-800">${entity.location.lat.toFixed(6)}, ${entity.location.lng.toFixed(6)}</div>
                    </div>
                    ` : ''}
                </div>

                <!-- ODC Terhubung -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">ODC Terhubung (${connectedODCs.length})</h3>
                    ${connectedODCs.length > 0 ? 
                        `<div class="space-y-4">
                            ${connectedODCs.map(odc => {
                                const odpList = dataCache.ODP.filter(odp => odp.odcRef === odc.id);
                                const totalPelangganODC = odpList.reduce((sum, odp) => {
                                    return sum + dataCache.Pelanggan.filter(p => p.odpRef === odp.id).length;
                                }, 0);
                                
                                return `
                                <div class="border rounded-lg p-4 bg-gray-50">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                                <i data-lucide="server-cog" class="w-5 h-5 text-blue-600"></i>
                                            </div>
                                            <div>
                                                <div class="font-bold text-gray-900">${odc.namaODC}</div>
                                                <div class="text-sm text-gray-600">${odc.kodeWilayah}-${odc.kodeSektor} | Slot ${odc.OLTSlot}/Port ${odc.OLTPort}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-semibold">${odpList.length} ODP</div>
                                            <div class="text-sm text-gray-600">${totalPelangganODC} Pelanggan</div>
                                        </div>
                                    </div>
                                    
                                    <!-- ODP dalam ODC ini -->
                                    ${odpList.length > 0 ? `
                                    <div class="ml-12 space-y-2">
                                        ${odpList.map(odp => {
                                            const pelangganList = dataCache.Pelanggan.filter(p => p.odpRef === odp.id);
                                            const capacity = getOdpCapacity(odp);
                                            return `
                                            <div class="flex items-center justify-between p-2 bg-white rounded border">
                                                <div class="flex items-center space-x-2">
                                                    <i data-lucide="box" class="w-4 h-4 text-green-600"></i>
                                                    <span class="font-medium">${odp.namaODP}</span>
                                                    <span class="text-sm text-gray-500">${capacity.used}/${capacity.total}</span>
                                                </div>
                                                <span class="text-sm text-gray-600">${pelangganList.length} pelanggan</span>
                                            </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>` : 
                        '<div class="text-center py-8 text-gray-500"><i data-lucide="server-off" class="w-12 h-12 mx-auto mb-2"></i><p>Tidak ada ODC terhubung</p></div>'
                    }
                </div>
            </div>
        `;
    } else if (entityType === 'ODC') {
        const connectedOLT = dataCache.OLT.find(olt => olt.id === entity.OLTRef);
        const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === entityId);
        const capacityPercentage = entity.capacity > 0 ? ((connectedODPs.length / entity.capacity) * 100).toFixed(1) : 0;
        
        // Hitung total pelanggan
        let totalPelanggan = 0;
        let totalPelangganAktif = 0;
        
        connectedODPs.forEach(odp => {
            const pelangganList = dataCache.Pelanggan.filter(p => p.odpRef === odp.id);
            totalPelanggan += pelangganList.length;
            totalPelangganAktif += pelangganList.filter(p => p.status === 'active').length;
        });
        
        content = `
            <div class="space-y-6">
                <!-- Informasi ODC -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Informasi ODC</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Kode Wilayah</label>
                            <div class="text-lg font-bold text-gray-900">${entity.kodeWilayah || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Kode Sektor</label>
                            <div class="text-lg font-bold text-gray-900">${entity.kodeSektor || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Nama ODC</label>
                            <div class="text-lg font-bold text-gray-900">${entity.namaODC || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Kapasitas</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.capacity || 0} Port</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">OLT</label>
                            <div class="text-lg font-semibold text-gray-800">${connectedOLT ? connectedOLT.name + ' (' + connectedOLT.code + ')' : '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Slot/Port OLT</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.OLTSlot || '-'}/${entity.OLTPort || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Panel Feeder</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.panelFeeder || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Port Feeder</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.portFeeder || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Panel Distribusi</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.panelDistribusi || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Port Distribusi</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.portDistribusi || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">ODP Terhubung</label>
                            <div class="text-lg font-semibold ${connectedODPs.length >= entity.capacity ? 'text-red-600' : 'text-green-600'}">${connectedODPs.length}/${entity.capacity || 0}</div>
                        </div>
                    </div>
                    
                    <!-- Statistik -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-6 p-4 bg-blue-50 rounded-lg">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${connectedODPs.length}</div>
                            <div class="text-sm text-blue-800">ODP</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${totalPelanggan}</div>
                            <div class="text-sm text-purple-800">Total Pelanggan</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${totalPelangganAktif}</div>
                            <div class="text-sm text-green-800">Aktif</div>
                        </div>
                    </div>
                    
                    <!-- Capacity Indicator -->
                    <div class="mt-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Utilisasi Kapasitas</span>
                            <span class="font-semibold ${capacityPercentage >= 100 ? 'text-red-600' : (capacityPercentage >= 75 ? 'text-yellow-600' : 'text-green-600')}">${capacityPercentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full ${capacityPercentage >= 100 ? 'bg-red-500' : (capacityPercentage >= 75 ? 'bg-yellow-500' : 'bg-green-500')}" style="width: ${Math.min(capacityPercentage, 100)}%"></div>
                        </div>
                    </div>
                    
                    ${entity.location ? `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Lokasi GPS</label>
                        <div class="text-md font-mono text-gray-800">${entity.location.lat.toFixed(6)}, ${entity.location.lng.toFixed(6)}</div>
                    </div>
                    ` : ''}
                </div>

                <!-- Hierarki Jaringan -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Hierarki Jaringan</h3>
                    <div class="space-y-4">
                        <!-- OLT -->
                        <div class="flex items-center space-x-4 p-4 bg-red-50 rounded-lg border">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i data-lucide="server" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-red-800">OLT</div>
                                <div class="text-lg font-semibold">${connectedOLT ? connectedOLT.name + ' (' + connectedOLT.code + ')' : 'Tidak terhubung'}</div>
                                ${connectedOLT ? `<div class="text-sm text-gray-600">${connectedOLT.model || ''} | ${connectedOLT.totalPorts} Port</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- ODC -->
                        <div class="flex items-center space-x-4 p-4 bg-blue-50 rounded-lg border ml-8">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <i data-lucide="server-cog" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-blue-800">ODC</div>
                                <div class="text-lg font-semibold">${entity.namaODC}</div>
                                <div class="text-sm text-gray-600">${entity.kodeWilayah}-${entity.kodeSektor} | Slot ${entity.OLTSlot}/Port ${entity.OLTPort}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ODP Terhubung -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">ODP Terhubung (${connectedODPs.length})</h3>
                    ${connectedODPs.length > 0 ? 
                        `<div class="space-y-4">
                            ${connectedODPs.map(odp => {
                                const pelangganList = dataCache.Pelanggan.filter(p => p.odpRef === odp.id);
                                const capacity = getOdpCapacity(odp);
                                
                                return `
                                <div class="border rounded-lg p-4 bg-gray-50">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 ${capacity.percentage >= 100 ? 'bg-red-100' : (capacity.percentage >= 75 ? 'bg-yellow-100' : 'bg-green-100')} rounded-full flex items-center justify-center">
                                                <i data-lucide="box" class="w-5 h-5 ${capacity.percentage >= 100 ? 'text-red-600' : (capacity.percentage >= 75 ? 'text-yellow-600' : 'text-green-600')}"></i>
                                            </div>
                                            <div>
                                                <div class="font-bold text-gray-900">${odp.namaODP}</div>
                                                <div class="text-sm text-gray-600">${odp.kodeWilayah}-${odp.kodeSektor}</div>
                                                <div class="text-sm ${capacity.percentage >= 100 ? 'text-red-600' : (capacity.percentage >= 75 ? 'text-yellow-600' : 'text-green-600')}">
                                                    ${capacity.used}/${capacity.total} Port (${capacity.percentage.toFixed(1)}%)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-semibold">${pelangganList.length} Pelanggan</div>
                                            <div class="text-sm text-gray-600">${pelangganList.filter(p => p.status === 'active').length} Aktif</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Pelanggan dalam ODP ini -->
                                    ${pelangganList.length > 0 ? `
                                    <div class="ml-12 space-y-2">
                                        ${pelangganList.slice(0, 5).map(pelanggan => {
                                            const packageInfo = dataCache.Paket.find(p => p.id === pelanggan.paketRef);
                                            return `
                                            <div class="flex items-center justify-between p-2 bg-white rounded border">
                                                <div class="flex items-center space-x-2">
                                                    <i data-lucide="user" class="w-4 h-4 text-purple-600"></i>
                                                    <span class="font-medium">${pelanggan.name}</span>
                                                    <span class="text-sm text-gray-500">Port ${pelanggan.odpPort}</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-sm ${pelanggan.status === 'active' ? 'text-green-600' : (pelanggan.status === 'pending' ? 'text-yellow-600' : 'text-red-600')}">${pelanggan.status}</span>
                                                    <span class="text-sm text-gray-600">${packageInfo ? packageInfo.kecepatan : '-'}</span>
                                                </div>
                                            </div>
                                            `;
                                        }).join('')}
                                        ${pelangganList.length > 5 ? `
                                        <div class="text-center py-2">
                                            <span class="text-sm text-gray-500">+ ${pelangganList.length - 5} pelanggan lainnya</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>` : 
                        '<div class="text-center py-8 text-gray-500"><i data-lucide="box" class="w-12 h-12 mx-auto mb-2"></i><p>Tidak ada ODP terhubung</p></div>'
                    }
                </div>
            </div>
        `;
    } else if (entityType === 'ODP') {
        const connectedODC = dataCache.ODC.find(odc => odc.id === entity.odcRef);
        const connectedOLT = connectedODC ? dataCache.OLT.find(olt => olt.id === connectedODC.OLTRef) : null;
        const connectedCustomers = dataCache.Pelanggan.filter(p => p.odpRef === entityId);
        const capacity = getOdpCapacity(entity);
        const activeCustomers = connectedCustomers.filter(c => c.status === 'active').length;
        
        content = `
            <div class="space-y-6">
                <!-- Informasi ODP -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Informasi ODP</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Kode Wilayah</label>
                            <div class="text-lg font-bold text-gray-900">${entity.kodeWilayah || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Kode Sektor</label>
                            <div class="text-lg font-bold text-gray-900">${entity.kodeSektor || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Nomor ODP</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.nomorODC || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Nama ODP</label>
                            <div class="text-lg font-bold text-gray-900">${entity.namaODP || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">ODC</label>
                            <div class="text-lg font-semibold text-gray-800">${connectedODC ? connectedODC.namaODC : '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">OLT</label>
                            <div class="text-lg font-semibold text-gray-800">${connectedOLT ? connectedOLT.name : '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Panel Feeder</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.panelFeeder || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Port Feeder</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.portFeeder || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Panel Distribusi</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.panelDistribusi || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Port Distribusi</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.portDistribusi || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Total Port</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.totalPorts || 0}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Pelanggan Aktif</label>
                            <div class="text-lg font-semibold ${capacity.percentage >= 100 ? 'text-red-600' : (capacity.percentage >= 75 ? 'text-yellow-600' : 'text-green-600')}">${activeCustomers}/${capacity.total}</div>
                        </div>
                    </div>
                    
                    <!-- Statistik -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 p-4 bg-blue-50 rounded-lg">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${capacity.total}</div>
                            <div class="text-sm text-blue-800">Total Port</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${capacity.used}</div>
                            <div class="text-sm text-green-800">Port Terpakai</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${connectedCustomers.length}</div>
                            <div class="text-sm text-purple-800">Total Pelanggan</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${activeCustomers}</div>
                            <div class="text-sm text-green-800">Aktif</div>
                        </div>
                    </div>
                    
                    <!-- Capacity Indicator -->
                    <div class="mt-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-700">Utilisasi Port</span>
                            <span class="font-semibold ${capacity.percentage >= 100 ? 'text-red-600' : (capacity.percentage >= 75 ? 'text-yellow-600' : 'text-green-600')}">${capacity.percentage.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full ${capacity.percentage >= 100 ? 'bg-red-500' : (capacity.percentage >= 75 ? 'bg-yellow-500' : 'bg-green-500')}" style="width: ${Math.min(capacity.percentage, 100)}%"></div>
                        </div>
                    </div>
                    
                    ${entity.location ? `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Lokasi GPS</label>
                        <div class="text-md font-mono text-gray-800">${entity.location.lat.toFixed(6)}, ${entity.location.lng.toFixed(6)}</div>
                    </div>
                    ` : ''}
                </div>

                <!-- Hierarki Jaringan -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Hierarki Jaringan</h3>
                    <div class="space-y-4">
                        <!-- OLT -->
                        <div class="flex items-center space-x-4 p-4 bg-red-50 rounded-lg border">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i data-lucide="server" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-red-800">OLT</div>
                                <div class="text-lg font-semibold">${connectedOLT ? connectedOLT.name + ' (' + connectedOLT.code + ')' : 'Tidak terhubung'}</div>
                                ${connectedOLT ? `<div class="text-sm text-gray-600">${connectedOLT.model || ''} | ${connectedOLT.totalPorts} Port</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- ODC -->
                        <div class="flex items-center space-x-4 p-4 bg-blue-50 rounded-lg border ml-8">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <i data-lucide="server-cog" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-blue-800">ODC</div>
                                <div class="text-lg font-semibold">${connectedODC ? connectedODC.namaODC : 'Tidak terhubung'}</div>
                                ${connectedODC ? `<div class="text-sm text-gray-600">${connectedODC.kodeWilayah}-${connectedODC.kodeSektor} | Slot ${connectedODC.OLTSlot}/Port ${connectedODC.OLTPort}</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- ODP -->
                        <div class="flex items-center space-x-4 p-4 bg-green-50 rounded-lg border ml-16">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <i data-lucide="box" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-green-800">ODP</div>
                                <div class="text-lg font-semibold">${entity.namaODP || '-'}</div>
                                <div class="text-sm text-gray-600">${entity.kodeWilayah}-${entity.kodeSektor} | ${capacity.used}/${capacity.total} Port</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pelanggan Terhubung -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Pelanggan Terhubung (${connectedCustomers.length})</h3>
                    ${connectedCustomers.length > 0 ? 
                        `<div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold">No. Pelanggan</th>
                                        <th class="px-4 py-3 text-left font-semibold">Nama</th>
                                        <th class="px-4 py-3 text-left font-semibold">Port</th>
                                        <th class="px-4 py-3 text-left font-semibold">Paket</th>
                                        <th class="px-4 py-3 text-left font-semibold">Status</th>
                                        <th class="px-4 py-3 text-left font-semibold">ONT</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${connectedCustomers.map(customer => {
                                        const packageInfo = dataCache.Paket.find(p => p.id === customer.paketRef);
                                        return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 font-mono font-semibold">${customer.customerNumber}</td>
                                            <td class="px-4 py-3 font-medium">${customer.name}</td>
                                            <td class="px-4 py-3 font-bold">${customer.odpPort || '-'}</td>
                                            <td class="px-4 py-3">${packageInfo ? packageInfo.kecepatan : '-'}</td>
                                            <td class="px-4 py-3">
                                                <span class="px-3 py-1 rounded-full text-xs font-medium ${customer.status === 'active' ? 'bg-green-100 text-green-800' : (customer.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800')}">
                                                    ${customer.status}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 font-mono text-xs">${customer.snONT || '-'}</td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>` : 
                        '<div class="text-center py-8 text-gray-500"><i data-lucide="user-x" class="w-12 h-12 mx-auto mb-2"></i><p>Tidak ada pelanggan terhubung</p></div>'
                    }
                </div>
            </div>
        `;
    } else if (entityType === 'Pelanggan') {
        const connectedODP = dataCache.ODP.find(odp => odp.id === entity.odpRef);
        const connectedODC = connectedODP ? dataCache.ODC.find(odc => odc.id === connectedODP.odcRef) : null;
        const connectedOLT = connectedODC ? dataCache.OLT.find(olt => olt.id === connectedODC.OLTRef) : null;
        const packageInfo = dataCache.Paket.find(p => p.id === entity.paketRef);
        const tickets = dataCache.Tickets.filter(t => t.nomorInternet === entity.customerNumber);
        
        content = `
            <div class="space-y-6">
                <!-- Informasi Pelanggan -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Informasi Pelanggan</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">No. Pelanggan</label>
                            <div class="text-lg font-bold text-gray-900 font-mono">${entity.customerNumber || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Nama</label>
                            <div class="text-lg font-bold text-gray-900">${entity.name || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Username</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.username || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Paket</label>
                            <div class="text-lg font-semibold text-blue-600">${packageInfo ? packageInfo.jenis + ' - ' + packageInfo.kecepatan : '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Jenis ONT</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.jenisONT || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">SN ONT</label>
                            <div class="text-lg font-semibold text-gray-800 font-mono">${entity.snONT || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">IP Address</label>
                            <div class="text-lg font-semibold text-gray-800">${entity.ipAddress || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
                            <div class="text-lg font-semibold ${entity.status === 'active' ? 'text-green-600' : (entity.status === 'pending' ? 'text-yellow-600' : 'text-red-600')}">
                                ${entity.status || '-'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alamat -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Alamat</h3>
                    <p class="text-gray-700 text-lg leading-relaxed">${entity.address || 'Tidak ada alamat'}</p>
                    
                    ${entity.location ? `
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <label class="block text-sm font-medium text-blue-700 mb-2">Lokasi GPS</label>
                        <div class="text-lg font-mono text-blue-800">${entity.location.lat.toFixed(6)}, ${entity.location.lng.toFixed(6)}</div>
                    </div>
                    ` : ''}
                </div>

                <!-- Hierarki Jaringan Pelanggan -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Hierarki Jaringan Pelanggan</h3>
                    <div class="space-y-4">
                        <!-- OLT -->
                        <div class="flex items-center space-x-4 p-4 bg-red-50 rounded-lg border">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i data-lucide="server" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-red-800">OLT</div>
                                <div class="text-lg font-semibold">${connectedOLT ? connectedOLT.name + ' (' + connectedOLT.code + ')' : 'Tidak terhubung'}</div>
                                ${connectedOLT ? `
                                <div class="text-sm text-gray-600">
                                    ${connectedOLT.model || ''} | 
                                    Slot ${connectedODC ? connectedODC.OLTSlot : '-'}/Port ${connectedODC ? connectedODC.OLTPort : '-'}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- ODC -->
                        <div class="flex items-center space-x-4 p-4 bg-blue-50 rounded-lg border ml-8">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <i data-lucide="server-cog" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-blue-800">ODC</div>
                                <div class="text-lg font-semibold">${connectedODC ? connectedODC.namaODC : 'Tidak terhubung'}</div>
                                ${connectedODC ? `
                                <div class="text-sm text-gray-600">
                                    ${connectedODC.kodeWilayah}-${connectedODC.kodeSektor} | 
                                    Panel ${connectedODC.panelDistribusi || '-'}/${connectedODC.portDistribusi || '-'}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- ODP -->
                        <div class="flex items-center space-x-4 p-4 bg-green-50 rounded-lg border ml-16">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <i data-lucide="box" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-green-800">ODP</div>
                                <div class="text-lg font-semibold">${connectedODP ? connectedODP.namaODP : 'Tidak terhubung'}</div>
                                ${connectedODP ? `
                                <div class="text-sm text-gray-600">
                                    ${connectedODP.kodeWilayah}-${connectedODP.kodeSektor} | 
                                    Port ${entity.odpPort || '-'}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Pelanggan -->
                        <div class="flex items-center space-x-4 p-4 bg-purple-50 rounded-lg border ml-24">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <i data-lucide="user" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-purple-800">PELANGGAN</div>
                                <div class="text-lg font-semibold">${entity.name}</div>
                                <div class="text-sm text-gray-600">
                                    ${entity.customerNumber} | ${packageInfo ? packageInfo.kecepatan : '-'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informasi Teknis -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Informasi Teknis</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Jenis Perangkat</label>
                                <div class="text-lg font-semibold text-gray-900">${entity.jenisONT || '-'}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Serial Number</label>
                                <div class="text-lg font-semibold text-gray-900 font-mono">${entity.snONT || '-'}</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Alamat IP</label>
                                <div class="text-lg font-semibold text-gray-900">${entity.ipAddress || '-'}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Kecepatan</label>
                                <div class="text-lg font-semibold text-blue-600">${packageInfo ? packageInfo.kecepatan : '-'}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Riwayat Gangguan -->
                ${tickets.length > 0 ? `
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Riwayat Gangguan Terakhir</h3>
                    <div class="space-y-3">
                        ${tickets.slice(0, 3).map(ticket => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                                <div class="flex-1">
                                    <div class="font-semibold">${ticket.nomorTicket}</div>
                                    <div class="text-sm text-gray-600">${ticket.jenisGangguan}</div>
                                    <div class="text-xs text-gray-500">${new Date(ticket.tanggalLapor).toLocaleDateString('id-ID')}</div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${ticket.status === 'closed' ? 'bg-green-100 text-green-800' : (ticket.status === 'progress' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800')}">
                                    ${ticket.status === 'closed' ? 'Selesai' : (ticket.status === 'progress' ? 'Proses' : 'Open')}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    document.getElementById('detail-content').innerHTML = content;
    document.getElementById('detail-modal').classList.remove('hidden');
    
    // Refresh icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

        async function logAudit(action, entityType, entityId, details) {
            try {
                if (!isOnline) return; // Skip audit logging in offline mode
                
                // Cek jumlah audit log yang ada
                const snapshot = await db.collection('AuditLog').get();
                const logCount = snapshot.size;
                
                // Jika sudah mencapai 1000, hapus yang paling lama
                if (logCount >= 1000) {
                    const oldestLogs = snapshot.docs
                        .sort((a, b) => new Date(a.data().timestamp) - new Date(b.data().timestamp))
                        .slice(0, logCount - 999); // Hapus cukup untuk membuat ruang
                    
                    const batch = db.batch();
                    oldestLogs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }
                
                // Tambah log baru
                await db.collection('AuditLog').add({
                    userEmail: currentUser?.email || 'unknown@user.com',
                    action: action,
                    entityType: entityType,
                    entityId: entityId,
                    details: details,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Reload audit log data
                await loadDataFromFirestore('AuditLog');
            } catch (error) {
                console.error('Error logging audit:', error);
            }
        }

        // ======================================================================
        // BACKUP & RESTORE SYSTEM
        // ======================================================================
        function setupBackupRestore() {
            // Select all backup checkboxes
            $('select-all-backup').addEventListener('click', () => {
                $$('.backup-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
            });
            
            // Deselect all backup checkboxes
            $('deselect-all-backup').addEventListener('click', () => {
                $$('.backup-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
            
            // Backup data
            $('backup-data').addEventListener('click', generateBackup);
            
            // Restore data
            $('restore-data').addEventListener('click', restoreData);
        }

        function generateBackup() {
            const selectedEntities = [];
            $$('.backup-checkbox:checked').forEach(checkbox => {
                selectedEntities.push(checkbox.dataset.entity);
            });
            
            if (selectedEntities.length === 0) {
                showToast('Pilih setidaknya satu jenis data untuk backup', 'error');
                return;
            }
            
            const backupData = {
                timestamp: new Date().toISOString(),
                version: '2.0',
                entities: {}
            };
            
            selectedEntities.forEach(entity => {
                backupData.entities[entity] = dataCache[entity];
            });
            
            // Create and download backup file
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ftth-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Save backup history
            saveBackupHistory(backupData);
            
            showToast('Backup berhasil di-generate', 'success');
        }

        function saveBackupHistory(backupData) {
            const backupHistory = JSON.parse(localStorage.getItem('backupHistory') || '[]');
            backupHistory.push({
                timestamp: backupData.timestamp,
                entities: Object.keys(backupData.entities),
                size: JSON.stringify(backupData).length
            });
            
            // Keep only last 10 backups
            if (backupHistory.length > 10) {
                backupHistory.splice(0, backupHistory.length - 10);
            }
            
            localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
            loadBackupHistory();
        }

        function loadBackupHistory() {
            const backupHistory = JSON.parse(localStorage.getItem('backupHistory') || '[]');
            const tbody = $('backup-history-body');
            
            if (backupHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i data-lucide="database" class="w-12 h-12 text-gray-300 mb-2"></i>
                                <p class="text-lg font-medium">Belum ada riwayat backup</p>
                                <p class="text-sm">Lakukan backup pertama Anda</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            // Sort by timestamp (newest first)
            backupHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            backupHistory.forEach(backup => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${new Date(backup.timestamp).toLocaleString('id-ID')}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${backup.entities.join(', ')}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${(backup.size / 1024).toFixed(2)} KB</td>
                    <td class="px-4 py-3 text-sm">
                        <button class="text-blue-600 hover:text-blue-800" onclick="downloadBackup('${backup.timestamp}')">
                            <i data-lucide="download" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            lucide.createIcons();
        }

        function downloadBackup(timestamp) {
            const backupHistory = JSON.parse(localStorage.getItem('backupHistory') || '[]');
            const backup = backupHistory.find(b => b.timestamp === timestamp);
            
            if (!backup) {
                showToast('Backup tidak ditemukan', 'error');
                return;
            }
            
            // Create backup data from current cache
            const backupData = {
                timestamp: timestamp,
                version: '2.0',
                entities: {}
            };
            
            backup.entities.forEach(entity => {
                backupData.entities[entity] = dataCache[entity];
            });
            
            // Create and download backup file
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ftth-backup-${timestamp.split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Backup berhasil diunduh ulang', 'success');
        }

        function restoreData() {
            const fileInput = $('restore-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Pilih file backup terlebih dahulu', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup file
                    if (!backupData.timestamp || !backupData.entities) {
                        throw new Error('Format file backup tidak valid');
                    }
                    
                    const restoreMode = document.querySelector('input[name="restore-mode"]:checked').value;
                    
                    if (!confirm(`Anda akan melakukan restore data. Mode: ${restoreMode === 'merge' ? 'Gabung' : 'Ganti'}. Lanjutkan?`)) {
                        return;
                    }
                    
                    showLoadingOverlay('Memproses restore data...');
                    
                    // Process restore based on mode
                    if (restoreMode === 'replace') {
                        // Replace all data
                        Object.keys(backupData.entities).forEach(entity => {
                            dataCache[entity] = backupData.entities[entity];
                        });
                    } else {
                        // Merge data
                        Object.keys(backupData.entities).forEach(entity => {
                            if (!dataCache[entity]) {
                                dataCache[entity] = [];
                            }
                            
                            backupData.entities[entity].forEach(item => {
                                const existingIndex = dataCache[entity].findIndex(i => i.id === item.id);
                                if (existingIndex !== -1) {
                                    dataCache[entity][existingIndex] = item;
                                } else {
                                    dataCache[entity].push(item);
                                }
                            });
                        });
                    }
                    
                    // Save to localStorage
                    saveLocalData();
                    
                    // Update UI
                    updateDashboardStats();
                    renderMarkers('OLT', dataCache.OLT);
                    renderMarkers('ODC', dataCache.ODC);
                    renderMarkers('ODP', dataCache.ODP);
                    renderMarkers('Pelanggan', dataCache.Pelanggan);
                    
                    hideLoadingOverlay();
                    showToast('Restore data berhasil', 'success');
                    
                    // Clear file input
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('Error restoring data:', error);
                    hideLoadingOverlay();
                    showToast('Gagal memproses file backup: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // ======================================================================
        // SETTINGS MANAGEMENT
        // ======================================================================
        function setupSettings() {
            // Load current settings
            $('auto-generate-number').checked = settings.autoGenerateNumber || false;
            $('number-format').value = settings.numberFormat || '1000';
            $('auto-generate-ticket').checked = settings.autoGenerateTicket || true;
            $('ticket-format').value = settings.ticketFormat || 'TKT-{YYYY}-{MM}-{SEQ}';
            $('ttr-max-hours').value = settings.ttrMaxHours || 3;
            $('ttr-warning-hours').value = settings.ttrWarningHours || 1.5;
            $('session-timeout').value = settings.sessionTimeout || 15;
            $('warning-timeout').value = settings.warningTimeout || 13;
            
            // Save settings
            $('save-number-settings').addEventListener('click', saveNumberSettings);
            $('save-ticket-settings').addEventListener('click', saveTicketSettings);
            $('save-session-settings').addEventListener('click', saveSessionSettings);
            $('save-password').addEventListener('click', changePassword);
        }

        function loadSettings() {
            // Load settings from localStorage
            const savedSettings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            settings = { ...settings, ...savedSettings };
        }

        function saveNumberSettings() {
            settings.autoGenerateNumber = $('auto-generate-number').checked;
            settings.numberFormat = $('number-format').value;
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            showToast('Pengaturan nomor berhasil disimpan', 'success');
        }

        function saveTicketSettings() {
            settings.autoGenerateTicket = $('auto-generate-ticket').checked;
            settings.ticketFormat = $('ticket-format').value;
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            showToast('Pengaturan ticket berhasil disimpan', 'success');
        }

        function saveSessionSettings() {
            settings.sessionTimeout = parseInt($('session-timeout').value);
            settings.warningTimeout = parseInt($('warning-timeout').value);
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            showToast('Pengaturan sesi berhasil disimpan', 'success');
            
            // Apply settings
            applySettings();
        }

        function applySettings() {
            // Apply session timeout settings
            sessionTimeoutMinutes = settings.sessionTimeout || 15;
            warningTimeoutMinutes = settings.warningTimeout || 13;
            
            // Reset session management
            resetSessionTimer();
        }

        async function changePassword() {
            const currentPassword = $('current-password').value;
            const newPassword = $('new-password').value;
            const confirmPassword = $('confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Semua field password harus diisi', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Password baru dan konfirmasi password tidak cocok', 'error');
                return;
            }
            
            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Update password
                await currentUser.updatePassword(newPassword);
                
                showToast('Password berhasil diubah', 'success');
                
                // Clear form
                $('current-password').value = '';
                $('new-password').value = '';
                $('confirm-password').value = '';
                
            } catch (error) {
                console.error('Error changing password:', error);
                showToast('Gagal mengubah password: ' + error.message, 'error');
            }
        }

        // ======================================================================
        // OFFLINE SUPPORT
        // ======================================================================
        function setupOfflineSync() {
            // Listen for online/offline events
            window.addEventListener('online', () => {
                isOnline = true;
                updateOnlineStatusUI(true);
                showToast('Koneksi internet tersedia', 'success');
                
                // Try to sync offline queue
                if (offlineQueue.length > 0) {
                    processOfflineQueue();
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateOnlineStatusUI(false);
                showToast('Anda sedang offline. Data akan disimpan secara lokal.', 'warning');
            });
        }

        function updateOnlineStatusUI(online) {
            const indicator = $('online-indicator');
            const text = $('online-text');
            const queueCount = $('offline-queue-count');
            
            if (online) {
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                text.textContent = 'Online';
                text.className = 'text-sm font-medium text-gray-700';
                queueCount.classList.add('hidden');
            } else {
                indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                text.textContent = 'Offline';
                text.className = 'text-sm font-medium text-red-600';
                
                if (offlineQueue.length > 0) {
                    queueCount.textContent = offlineQueue.length;
                    queueCount.classList.remove('hidden');
                }
            }
        }

        function updateOfflineQueueUI() {
            const queueList = $('offline-queue-list');
            const queueCount = $('offline-queue-count');
            
            if (offlineQueue.length === 0) {
                queueList.innerHTML = 'Tidak ada item dalam antrian.';
                queueCount.classList.add('hidden');
            } else {
                queueList.innerHTML = `
                    <div class="text-sm font-medium text-gray-700 mb-2">${offlineQueue.length} item dalam antrian:</div>
                    ${offlineQueue.slice(0, 5).map((item, index) => `
                        <div class="offline-queue-item">
                            <div class="flex justify-between">
                                <span class="font-medium">${item.entityType}</span>
                                <span class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleTimeString()}</span>
                            </div>
                            <div class="text-xs text-gray-600">${item.action === 'create' ? 'Tambah' : (item.action === 'update' ? 'Edit' : 'Hapus')}</div>
                        </div>
                    `).join('')}
                    ${offlineQueue.length > 5 ? `<div class="text-xs text-gray-500 mt-2">... dan ${offlineQueue.length - 5} item lainnya</div>` : ''}
                `;
                queueCount.textContent = offlineQueue.length;
                queueCount.classList.remove('hidden');
            }
            
            updateOnlineStatusUI(isOnline);
        }

        async function processOfflineQueue() {
            if (!isOnline || offlineQueue.length === 0) return;
            
            const progressBar = $('sync-progress-bar');
            const syncStatus = $('sync-status');
            const syncProgress = $('sync-progress');
            
            syncProgress.classList.remove('hidden');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < offlineQueue.length; i++) {
                const item = offlineQueue[i];
                const progress = ((i + 1) / offlineQueue.length) * 100;
                
                progressBar.style.width = `${progress}%`;
                syncStatus.textContent = `Memproses ${i + 1} dari ${offlineQueue.length}: ${item.entityType} (${item.action})`;
                
                try {
                    if (item.action === 'create') {
                        await db.collection(item.entityType).add(item.data);
                    } else if (item.action === 'update') {
                        await db.collection(item.entityType).doc(item.entityId).update(item.data);
                    } else if (item.action === 'delete') {
                        await db.collection(item.entityType).doc(item.entityId).delete();
                    }
                    
                    successCount++;
                } catch (error) {
                    console.error(`Error processing offline item:`, error);
                    errorCount++;
                }
                
                // Small delay to prevent overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Clear processed items from queue
            offlineQueue = [];
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            
            // Update UI
            updateOfflineQueueUI();
            syncProgress.classList.add('hidden');
            
            // Reload all data to ensure consistency
            await loadAllData();
            
            showToast(`Sinkronisasi selesai: ${successCount} berhasil, ${errorCount} gagal`, 
                     errorCount > 0 ? 'warning' : 'success');
        }

        // ======================================================================
        // SESSION MANAGEMENT
        // ======================================================================
        function setupSessionManagement() {
            // Reset timer on user activity
            document.addEventListener('click', resetSessionTimer);
            document.addEventListener('keypress', resetSessionTimer);
            document.addEventListener('scroll', resetSessionTimer);
            document.addEventListener('mousemove', resetSessionTimer);
            
            // Session warning buttons
            $('extend-session').addEventListener('click', resetSessionTimer);
            $('logout-now').addEventListener('click', () => {
                auth.signOut();
            });
            
            // Start the session timer
            resetSessionTimer();
        }

        function resetSessionTimer() {
            // Clear existing timeouts
            clearTimeout(sessionTimeout);
            clearTimeout(warningTimeout);
            clearInterval(countdownInterval);
            
            // Hide warning if visible
            sessionWarning.classList.add('hidden');
            
            // Set new timeouts
            warningTimeout = setTimeout(showSessionWarning, (sessionTimeoutMinutes - warningTimeoutMinutes) * 60 * 1000);
            sessionTimeout = setTimeout(logoutUser, sessionTimeoutMinutes * 60 * 1000);
        }

        function showSessionWarning() {
            sessionWarning.classList.remove('hidden');
            
            let timeLeft = warningTimeoutMinutes * 60; // Convert to seconds
            $('session-countdown').textContent = formatTime(timeLeft);
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                $('session-countdown').textContent = formatTime(timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
        }

        function logoutUser() {
            auth.signOut();
            showToast('Sesi telah berakhir karena tidak ada aktivitas', 'info');
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        function generateRandomPassword() {
    const length = 12;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
    let password = "";
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    return password;
}

        // ======================================================================
        // UTILITY FUNCTIONS
        // ======================================================================
     function showToast(message, type = 'success') {
    // Hapus toast lama
    const oldToasts = document.querySelectorAll('[id^="toast-"]');
    oldToasts.forEach(toast => toast.remove());
    
    // Tentukan warna
    const colors = {
        success: { bg: 'bg-green-500', text: 'text-white' },
        error: { bg: 'bg-red-500', text: 'text-white' },
        warning: { bg: 'bg-yellow-500', text: 'text-gray-900' },
        info: { bg: 'bg-blue-500', text: 'text-white' }
    };
    
    const color = colors[type] || colors.success;
    
    // Buat toast
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `fixed top-4 right-4 z-50 ${color.bg} ${color.text} px-4 py-3 rounded-md shadow-lg font-medium`;
    
    toast.innerHTML = `
        <div class="flex items-center justify-between">
            <span>${message}</span>
            <button onclick="document.getElementById('${toastId}').remove()" class="ml-3 ${color.text} hover:opacity-70">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Refresh icons
    lucide.createIcons();
    
    // Auto remove
    setTimeout(() => {
        const toastElement = document.getElementById(toastId);
        if (toastElement) {
            toastElement.remove();
        }
    }, 4000);
}

// Helper function untuk icon toast
function getToastIcon(type) {
    switch (type) {
        case 'success': return 'check-circle';
        case 'error': return 'x-circle';
        case 'warning': return 'alert-triangle';
        case 'info': return 'info';
        default: return 'check-circle';
    }
}
    
    // Style toast - ukuran lebih kecil dan elegan
    toast.className = `fixed top-5 right-5 z-50 ${bg-Color} ${textColor} px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-0 opacity-100`;
    toast.style.minWidth = '300px';
    toast.style.maxWidth = '400px';
    
    toast.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i data-lucide="${getToastIcon(type)}" class="w-5 h-5"></i>
                <span class="font-medium text-sm">${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200 ml-4">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Refresh icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    
    // Auto remove setelah 4 detik
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }
    }, 4000);


// Helper function untuk icon toast
function getToastIcon(type) {
    switch (type) {
        case 'success': return 'check-circle';
        case 'error': return 'alert-circle';
        case 'warning': return 'alert-triangle';
        case 'info': return 'info';
        default: return 'check-circle';
    }
}

        function showLoadingOverlay(message = 'Memproses...') {
            $('loading-message').textContent = message;
            $('loading-overlay').classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            $('loading-overlay').classList.add('hidden');
        }

        function updateCurrentTime() {
            const now = new Date();
            $('current-time').textContent = now.toLocaleString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // ======================================================================
        // EXPORT/IMPORT FUNCTIONALITY
        // ======================================================================
        $('export-button').addEventListener('click', () => {
            const entity = $('table-title').dataset.entity;
            if (!entity) return;
            
            const data = dataCache[entity];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, entity);
            XLSX.writeFile(wb, `${entity}-export-${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast(`Data ${entity} berhasil diexport`, 'success');
        });

        $('import-button').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        const entity = $('table-title').dataset.entity;
                        if (confirm(`Anda akan mengimpor ${jsonData.length} data ${entity}. Lanjutkan?`)) {
                            // Process import data
                            processImportData(entity, jsonData);
                        }
                    } catch (error) {
                        console.error('Error importing file:', error);
                        showToast('Gagal memproses file import', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        });

        function processImportData(entity, data) {
            showLoadingOverlay('Mengimpor data...');
            
            // Process data in batches to avoid overwhelming the system
            const batchSize = 10;
            let processed = 0;
            
            const processBatch = async () => {
                const batch = data.slice(processed, processed + batchSize);
                
                for (const item of batch) {
                    try {
                        // Clean up the data
                        const cleanItem = { ...item };
                        delete cleanItem.id; // Remove ID to avoid conflicts
                        
                        // Add timestamps
                        cleanItem.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        cleanItem.createdBy = currentUser?.email || 'unknown@user.com';
                        cleanItem.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        cleanItem.updatedBy = currentUser?.email || 'unknown@user.com';
                        
                        if (isOnline) {
                            await db.collection(entity).add(cleanItem);
                        } else {
                            offlineQueue.push({
                                action: 'create',
                                entityType: entity,
                                data: cleanItem,
                                timestamp: new Date().getTime()
                            });
                        }
                    } catch (error) {
                        console.error('Error importing item:', error);
                    }
                }
                
                processed += batch.length;
                
                if (processed < data.length) {
                    setTimeout(processBatch, 100);
                } else {
                    // Import complete
                    if (isOnline) {
                        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                        updateOfflineQueueUI();
                    }
                    
                    hideLoadingOverlay();
                    showToast(`Berhasil mengimpor ${data.length} data ${entity}`, 'success');
                    
                    // Reload data
                    if (isOnline) {
                        loadDataFromFirestore(entity).then(() => {
                            renderTable(entity, dataCache[entity]);
                        });
                    } else {
                        // Add to local cache for immediate UI update
                        data.forEach(item => {
                            dataCache[entity].push({
                                id: `import-${Date.now()}-${Math.random()}`,
                                ...item
                            });
                        });
                        renderTable(entity, dataCache[entity]);
                    }
                }
            };
            
            processBatch();
        }


        // ======================================================================
        // SYNC OFFLINE DATA
        // ======================================================================
        $('sync-offline-data').addEventListener('click', () => {
            if (isOnline && offlineQueue.length > 0) {
                processOfflineQueue();
            } else if (!isOnline) {
                showToast('Tidak ada koneksi internet untuk sinkronisasi', 'error');
            } else {
                showToast('Tidak ada data dalam antrian offline', 'info');
            }
        });

        // ======================================================================
        // INITIALIZATION COMPLETE
        // ======================================================================
        console.log('FTTH Management System v2.0 initialized successfully');

    </script>
</body>
</html>
