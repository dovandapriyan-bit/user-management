<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTTH Topology — Dashboard</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Icons (Lucide) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --accent:#2563eb; --success:#10b981; --danger:#ef4444;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(180deg,#07102a,#061025); color:#e6eef8;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Top header */
    header.appbar{
      height:64px; display:flex; align-items:center; gap:16px;
      padding:0 20px; background:linear-gradient(90deg, rgba(37,99,235,0.12), rgba(10,10,20,0.0));
      border-bottom:1px solid rgba(255,255,255,0.03); position:sticky; top:0; z-index:50;
    }
    .brand {display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:0.3px}
    .brand .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#3b82f6,#06b6d4);display:flex;align-items:center;justify-content:center;color:white;font-weight:800}

    .top-actions { margin-left:auto; display:flex; gap:8px; align-items:center; }

    /* Layout */
    .wrap { display:flex; height:calc(100vh - 64px); gap:12px; padding:12px; }
    .sidebar {
      width:360px; min-width:300px; background:var(--card); border-radius:12px; padding:14px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6); overflow:auto;
    }
    .map-panel {
      flex:1; border-radius:12px; overflow:hidden; box-shadow: 0 6px 30px rgba(2,6,23,0.6);
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }
    #map { width:100%; height:100%; display:block; }

    h2.section { font-size:16px; margin:6px 0 12px 0; color:#e6f0ff; }

    .card { background:var(--glass); border-radius:10px; padding:10px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.03); }
    .row { display:flex; gap:8px; }
    input, select, textarea {
      width:100%; padding:10px; border-radius:8px; border:none; background:rgba(255,255,255,0.02); color: #e6eef8;
      outline: none; font-size:14px;
    }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }

    button.btn {
      background:linear-gradient(90deg,var(--accent),#1e3a8a); color:white; border:none; padding:10px 12px; border-radius:8px;
      cursor:pointer; font-weight:600; box-shadow: 0 6px 16px rgba(37,99,235,0.14);
    }
    button.ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px; border-radius:8px; }

    .flex { display:flex; gap:8px; }
    .small { font-size:13px; color:var(--muted) }
    .muted { color:var(--muted) }
    .list { max-height:300px; overflow:auto; margin-top:8px; }
    .list-item {
      padding:8px; border-radius:8px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid rgba(255,255,255,0.02); margin-bottom:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .tag { padding:6px 8px; border-radius:999px; font-weight:600; font-size:12px; color:#032; background:#a7f3d0; }

    /* detail panel */
    .detail { padding:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border-radius:10px; }

    /* responsive */
    @media (max-width:900px){
      .wrap{ flex-direction:column; }
      .sidebar{ width:100%; min-width:unset; max-height:50vh; overflow:auto; }
      .map-panel { height:50vh; }
    }
  </style>
</head>
<body>

  <header class="appbar">
    <div class="brand">
      <div class="logo">FT</div>
      <div>
        <div style="font-size:15px">FTTH Topology</div>
        <div style="font-size:12px;color:var(--muted)">Monitoring & Mapping</div>
      </div>
    </div>

    <div class="top-actions">
      <div id="userArea" class="small muted">Not signed in</div>
      <button id="btnSignOut" class="ghost" style="display:none">Sign out</button>
    </div>
  </header>

  <div class="wrap">
    <aside class="sidebar">
      <!-- Auth -->
      <div class="card" id="authCard">
        <h2 class="section">Masuk / Daftar</h2>
        <label>Email</label>
        <input id="authEmail" type="email" placeholder="email@contoh.com" />
        <label>Password</label>
        <input id="authPass" type="password" placeholder="password" />
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="btnLogin" class="btn">Masuk</button>
          <button id="btnRegister" class="ghost">Daftar</button>
        </div>
        <div class="small muted" style="margin-top:8px">Gunakan akun untuk menyimpan perubahan.</div>
      </div>

      <!-- Add entities -->
      <div class="card" id="formsCard" style="display:none">
        <h2 class="section">Buat / Tambah Data</h2>

        <!-- OLT -->
        <div style="margin-bottom:10px">
          <div class="small muted">OLT</div>
          <label>Nama / Kode</label><input id="olt_name" placeholder="OLT-1 (rumah / lokasi)" />
          <label>Total Slot</label><input id="olt_slots" type="number" placeholder="2" />
          <label>Port per Slot</label><input id="olt_ports" type="number" placeholder="16" />
          <div class="flex" style="margin-top:8px">
            <button id="btnAddOLT" class="btn">Tambah OLT</button>
            <button id="btnLocateOLT" class="ghost">Ambil Lokasi</button>
          </div>
        </div>

        <hr style="opacity:0.04;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <!-- Feeder Panel -->
        <div style="margin-bottom:10px">
          <div class="small muted">Feeder Panel</div>
          <label>Nama / Kode</label><input id="feeder_name" placeholder="Feeder-A" />
          <label>Total Ports</label><input id="feeder_total" type="number" placeholder="24" />
          <div class="flex" style="margin-top:8px">
            <button id="btnAddFeeder" class="btn">Tambah Feeder</button>
            <button id="btnLocateFeeder" class="ghost">Ambil Lokasi</button>
          </div>
        </div>

        <hr style="opacity:0.04;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <!-- Distrib Panel -->
        <div style="margin-bottom:10px">
          <div class="small muted">Distribusi Panel</div>
          <label>Name / Code</label><input id="dist_name" placeholder="Distrib-1" />
          <label>Feeder Panel</label>
          <select id="selectFeeder"></select>
          <label>Feeder Port</label><input id="dist_feeder_port" placeholder="12" />
          <label>Split Type (1:4 / 1:8 ...)</label><input id="dist_split" placeholder="1:8" />
          <div class="flex" style="margin-top:8px">
            <button id="btnAddDist" class="btn">Tambah Distribusi</button>
            <button id="btnLocateDist" class="ghost">Ambil Lokasi</button>
          </div>
        </div>

        <hr style="opacity:0.04;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <!-- ODC (opsional) -->
        <div style="margin-bottom:10px">
          <div class="small muted">ODC (Opsional)</div>
          <label>Nama / Kode</label><input id="odc_name" placeholder="ODC-1" />
          <label>Feeder Panel</label><select id="selectFeederForODC"></select>
          <label>Feeder Port</label><input id="odc_feeder_port" placeholder="12" />
          <label>Distrib Panel (opsional)</label><select id="selectDistForODC"></select>
          <label>Distrib Port</label><input id="odc_dist_port" placeholder="5" />
          <label>OLT Slot</label><input id="odc_olt_slot" type="number" placeholder="1" />
          <label>OLT Port</label><input id="odc_olt_port" type="number" placeholder="1" />
          <div class="flex" style="margin-top:8px">
            <button id="btnAddODC" class="btn">Tambah ODC</button>
            <button id="btnLocateODC" class="ghost">Ambil Lokasi</button>
          </div>
        </div>

        <hr style="opacity:0.04;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <!-- ODP -->
        <div style="margin-bottom:10px">
          <div class="small muted">ODP</div>
          <label>Nama / Kode</label><input id="odp_name" placeholder="ODP-1" />
          <label>Distrib Panel</label><select id="selectDist"></select>
          <label>Distrib Port</label><input id="odp_dist_port" placeholder="5" />
          <label>Total Ports</label><input id="odp_total" type="number" placeholder="16" />
          <div class="flex" style="margin-top:8px">
            <button id="btnAddODP" class="btn">Tambah ODP</button>
            <button id="btnLocateODP" class="ghost">Ambil Lokasi</button>
          </div>
        </div>

        <hr style="opacity:0.04;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <!-- Pelanggan -->
        <div>
          <div class="small muted">Pelanggan</div>
          <label>Nama</label><input id="pel_name" placeholder="Nama pelanggan" />
          <label>Alamat</label><input id="pel_address" placeholder="Alamat" />
          <label>Pilih ODP</label><select id="selectODPForPel"></select>
          <label>Port ODP</label><input id="pel_odp_port" placeholder="1" />
          <label>Foto Aktivasi (opsional)</label><input id="pel_photo" type="file" accept="image/*" />
          <div class="flex" style="margin-top:8px">
            <button id="btnAddPel" class="btn">Tambah Pelanggan</button>
            <button id="btnLocatePel" class="ghost">Ambil Lokasi</button>
          </div>
        </div>
      </div>

      <!-- Viewer -->
      <div class="card" id="viewerCard" style="display:none">
        <h2 class="section">Data & Pencarian</h2>
        <label>Cari</label>
        <input id="searchBox" placeholder="Cari ODC/ODP/Pelanggan..." />
        <div style="display:flex;gap:8px;margin-top:8px;">
          <select id="viewSelect">
            <option value="ODC">ODC</option>
            <option value="Feeder">Feeder</option>
            <option value="Distrib">Distrib</option>
            <option value="ODP">ODP</option>
            <option value="Pelanggan">Pelanggan</option>
            <option value="OLT">OLT</option>
          </select>
          <button id="btnRefresh" class="ghost">Refresh</button>
        </div>
        <div class="list" id="dataList" style="margin-top:10px"></div>
      </div>

      <!-- Detail -->
      <div class="card" id="detailCard" style="display:none">
        <h2 class="section">Detail</h2>
        <div id="detailContent" class="detail small muted">Pilih item untuk lihat detail.</div>
      </div>

    </aside>

    <section class="map-panel">
      <div id="map"></div>
    </section>
  </div>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, onSnapshot, query, where, updateDoc, serverTimestamp, setDoc, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref as stRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // ---------- Firebase config (ganti jika perlu) ----------
    const firebaseConfig = {
       apiKey: "AIzaSyDyXLfovZUAPzPfm1LakEFPPgwGegaQr4o",
  authDomain: "user-management-bccb1.firebaseapp.com",
  projectId: "user-management-bccb1",
  storageBucket: "user-management-bccb1.firebasestorage.app",
  messagingSenderId: "22188892577",
  appId: "1:22188892577:web:d8c7ebe3e00e1974956be0",
  measurementId: "G-4SEKELHMTF"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------- UI refs ----------
    const authCard = document.getElementById('authCard');
    const formsCard = document.getElementById('formsCard');
    const viewerCard = document.getElementById('viewerCard');
    const detailCard = document.getElementById('detailCard');

    const userArea = document.getElementById('userArea');
    const btnSignOut = document.getElementById('btnSignOut');

    // Auth controls
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const authEmail = document.getElementById('authEmail');
    const authPass = document.getElementById('authPass');

    btnLogin.onclick = async () => {
      try{
        const email = authEmail.value.trim(), pass = authPass.value;
        if(!email || !pass) return alert('Isi email & password');
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){ alert('Login error: '+e.message) }
    };
    btnRegister.onclick = async () => {
      try {
        const email = authEmail.value.trim(), pass = authPass.value;
        if(!email || !pass) return alert('Isi email & password');
        await createUserWithEmailAndPassword(auth, email, pass);
        alert('Akun dibuat, silakan login');
      } catch(e){ alert('Register error: '+e.message) }
    };
    btnSignOut.onclick = async ()=> { await signOut(auth); };

    onAuthStateChanged(auth, user => {
      if(user){
        userArea.textContent = user.email;
        authCard.style.display = 'none';
        formsCard.style.display = 'block';
        viewerCard.style.display = 'block';
        detailCard.style.display = 'block';
        btnSignOut.style.display = 'inline-block';
      } else {
        userArea.textContent = 'Not signed in';
        authCard.style.display = 'block';
        formsCard.style.display = 'none';
        viewerCard.style.display = 'none';
        detailCard.style.display = 'none';
        btnSignOut.style.display = 'none';
      }
    });

    // ---------- Map ----------
    const map = L.map('map').setView([-6.2, 106.816], 12);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // layers groups
    const layerOLT = L.layerGroup().addTo(map);
    const layerODC = L.layerGroup().addTo(map);
    const layerFeeder = L.layerGroup().addTo(map);
    const layerDist = L.layerGroup().addTo(map);
    const layerODP = L.layerGroup().addTo(map);
    const layerPel = L.layerGroup().addTo(map);
    const layerLines = L.layerGroup().addTo(map);

    // helper: create marker style
    function mkIcon(color, text){
      return L.divIcon({
        html: `<div style="background:${color};padding:6px 8px;border-radius:6px;color:white;font-weight:700;font-size:12px">${text}</div>`,
        className: ''
      });
    }

    // ---------- Realtime listeners & load initial data ----------
    // caches
    let cache = { OLT:[], ODC:[], Feeder:[], Distrib:[], ODP:[], Pelanggan:[] };

    async function initRealtime(){
      // OLT
      onSnapshot(collection(db,'OLT'), snap => {
        cache.OLT = [];
        layerOLT.clearLayers();
        snap.forEach(doc => {
          const d = { id: doc.id, ...doc.data() };
          cache.OLT.push(d);
          if(d.location) {
            const m = L.marker([d.location.lat,d.location.lng],{icon: mkIcon('#10b981','OLT')}).addTo(layerOLT);
            m.bindPopup(`<b>OLT:</b> ${d.name||d.code||'-'}<br/>Slots:${d.totalSlots||'-'} Ports/Slot:${d.portsPerSlot||'-'}`);
            m.on('click', ()=> showDetail('OLT',d));
          }
        });
      });

      // Feeder
      onSnapshot(collection(db,'FeederPanel'), snap=>{
        cache.Feeder = []; layerFeeder.clearLayers();
        snap.forEach(doc=>{
          const d = { id:doc.id, ...doc.data() };
          cache.Feeder.push(d);
          if(d.location){
            const m=L.marker([d.location.lat,d.location.lng],{icon: mkIcon('#7c3aed','FEED')}).addTo(layerFeeder);
            m.bindPopup(`<b>Feeder:</b> ${d.name||d.code||'-'}<br/>ports:${d.totalPorts||0}`);
            m.on('click', ()=> showDetail('Feeder', d));
          }
        });
      });

      // Distrib
      onSnapshot(collection(db,'DistribPanel'), snap=>{
        cache.Distrib = []; layerDist.clearLayers();
        snap.forEach(doc=>{
          const d = { id:doc.id, ...doc.data() };
          cache.Distrib.push(d);
          if(d.location){
            const m=L.circleMarker([d.location.lat,d.location.lng],{radius:8,color:'#f97316'}).addTo(layerDist);
            m.bindPopup(`<b>Distrib:</b> ${d.name||'-'}<br/>from:${d.feederPanelName||'-'} port:${d.feederPort||'-'}`);
            m.on('click', ()=> showDetail('Distrib', d));
          }
        });
      });

      // ODC
      onSnapshot(collection(db,'ODC'), snap=>{
        cache.ODC = []; layerODC.clearLayers();
        snap.forEach(doc=>{
          const d = { id:doc.id, ...doc.data() };
          cache.ODC.push(d);
          if(d.location){
            const m = L.marker([d.location.lat,d.location.lng],{icon: mkIcon('#3b82f6','ODC')}).addTo(layerODC);
            m.bindPopup(`<b>ODC:</b> ${d.name||d.code||'-'}<br/>Feeder:${d.feederPanelName||'-'}:${d.feederPort||'-'}`);
            m.on('click', ()=> showDetail('ODC', d));
          }
        });
      });

      // ODP
      onSnapshot(collection(db,'ODP'), snap=>{
        cache.ODP = []; layerODP.clearLayers();
        snap.forEach(doc=>{
          const d = { id:doc.id, ...doc.data() };
          cache.ODP.push(d);
          if(d.location){
            const used = d.usedPorts||0, total=d.totalPorts||0;
            const color = (total>0 && used/total>=1) ? '#ef4444' : (used/total >=0.75 ? '#f59e0b':'#06b6d4');
            const m = L.circleMarker([d.location.lat,d.location.lng],{radius:9,color}).addTo(layerODP);
            m.bindPopup(`<b>ODP:</b> ${d.name||d.code||'-'}<br/>Used: ${used}/${total}`);
            m.on('click', ()=> showDetail('ODP', d));
          }
        });
      });

      // Pelanggan
      onSnapshot(collection(db,'Pelanggan'), snap=>{
        cache.Pelanggan = []; layerPel.clearLayers();
        snap.forEach(doc=>{
          const d = { id:doc.id, ...doc.data() };
          cache.Pelanggan.push(d);
          if(d.location){
            const m = L.circleMarker([d.location.lat,d.location.lng],{radius:6,color:'#10b981'}).addTo(layerPel);
            m.bindPopup(`<b>Pelanggan:</b> ${d.name||'-'}<br/>ODP:${d.odpName||'-'} Port:${d.odpPort||'-'}`);
            m.on('click', ()=> showDetail('Pelanggan', d));
          }
        });
      });

      // populate selects when caches change
      setInterval(populateSelects, 800); // small debounce
    }

    initRealtime();

    // ---------- UI helpers ----------
    function populateSelects(){
      // feeders
      const selF = document.getElementById('selectFeeder');
      const selF2 = document.getElementById('selectFeederForODC');
      selF.innerHTML = '<option value="">-- Pilih Feeder --</option>';
      selF2.innerHTML = '<option value="">-- Pilih Feeder --</option>';
      cache.Feeder.forEach(f => {
        selF.innerHTML += `<option value="${f.id}">${f.name||f.code||f.id}</option>`;
        selF2.innerHTML += `<option value="${f.id}">${f.name||f.code||f.id}</option>`;
      });

      // distrib
      const selDist = document.getElementById('selectDist');
      const selDistForODC = document.getElementById('selectDistForODC');
      selDist.innerHTML = '<option value="">-- Pilih Distrib --</option>';
      selDistForODC.innerHTML = '<option value="">-- Pilih Distrib --</option>';
      cache.Distrib.forEach(d => {
        selDist.innerHTML += `<option value="${d.id}">${d.name||d.code||d.id}</option>`;
        selDistForODC.innerHTML += `<option value="${d.id}">${d.name||d.code||d.id}</option>`;
      });

      // odp
      const selODP = document.getElementById('selectODPForPel');
      selODP.innerHTML = '<option value="">-- Pilih ODP --</option>';
      cache.ODP.forEach(o => selODP.innerHTML += `<option value="${o.id}">${o.name||o.code||o.id}</option>`);

      // feeders for distrib-panel creation: for label display set feederPanelName in cache lookup
      cache.Distrib.forEach(d=>{
        const feeder = cache.Feeder.find(f=>f.id===d.feederPanelId) || {};
        d.feederPanelName = feeder.name || feeder.code || '';
      });
      cache.ODC.forEach(o=>{
        const feeder = cache.Feeder.find(f=>f.id===o.feederPanelId) || {};
        o.feederPanelName = feeder.name || feeder.code || '';
      });
      cache.ODP.forEach(o=>{
        const dist = cache.Distrib.find(dd=>dd.id===o.panelDistId) || {};
        o.distPanelName = dist.name || dist.code || '';
      });
    }

    // ---------- Detail viewer ----------
    const dataList = document.getElementById('dataList');
    const viewSelect = document.getElementById('viewSelect');
    const searchBox = document.getElementById('searchBox');
    const btnRefresh = document.getElementById('btnRefresh');
    btnRefresh.onclick = ()=> renderDataList();

    viewSelect.onchange = ()=> renderDataList();
    searchBox.oninput = ()=> renderDataList();

    function renderDataList(){
      const kind = viewSelect.value;
      const q = searchBox.value.trim().toLowerCase();
      let arr = cache[kind] || [];
      if(q) {
        arr = arr.filter(x => ((x.name||'') + ' ' + (x.code||'') + ' ' + (x.address||'') ).toLowerCase().includes(q));
      }
      dataList.innerHTML = '';
      arr.slice(0,200).forEach(item => {
        const el = document.createElement('div'); el.className='list-item';
        el.innerHTML = `<div>
            <div style="font-weight:700">${item.name||item.code||'(no name)'}</div>
            <div class="small muted">${(item.code||'')}${item.feederPanelName? ' • '+item.feederPanelName: ''}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
            <button class="ghost" style="padding:6px 8px" onclick='zoomTo("${kind}","${item.id}")'>Lihat</button>
            <button class="ghost" style="padding:6px 8px" onclick='showDetail("${kind}", ${JSON.stringify(item).replaceAll("'","\\'")})'>Detail</button>
          </div>`;
        dataList.appendChild(el);
      });
    }

    window.zoomTo = (kind, id) => {
      let arr = cache[kind] || [];
      const it = arr.find(x=>x.id===id);
      if(!it || !it.location) return alert('Lokasi tidak tersedia');
      map.setView([it.location.lat, it.location.lng], 17);
      // highlight polyline if pelanggan
      if(kind==='Pelanggan') {
        drawChainForPelanggan(it);
      }
    };

    function showDetail(kind, item){
      // if item passed as object, use it, else find by id
      let obj = (typeof item === 'object' && item !== null) ? item : (cache[kind]||[]).find(x => x.id===item);
      if(!obj) return;
      const ct = document.getElementById('detailContent');
      let html = `<div style="font-weight:700">${obj.name||obj.code||'(Tanpa Nama)'}</div>`;
      html += `<div class="small muted">${kind} • ID: ${obj.id}</div><hr style="opacity:0.04"/>`;
      if(kind==='ODP'){
        html += `<div>ODP Code: ${obj.code||'-'}</div>`;
        html += `<div>Panel Distrib: ${obj.panelDistName||obj.panelDistId||'-'} Port: ${obj.panelDistPort||'-'}</div>`;
        html += `<div>Used: ${obj.usedPorts||0} / ${obj.totalPorts||0}</div>`;
        html += `<div style="margin-top:8px"><button class="btn" onclick='listPelangganByODP("${obj.id}")'>Lihat Pelanggan di ODP</button></div>`;
      } else if(kind==='Pelanggan'){
        html += `<div>Alamat: ${obj.address||'-'}</div>`;
        html += `<div>ODP: ${obj.odpName||obj.odpRef||'-'} Port: ${obj.odpPort||'-'}</div>`;
        if(obj.photoUrl) html += `<div style="margin-top:8px"><img src="${obj.photoUrl}" style="width:100%;border-radius:8px"/></div>`;
        html += `<div style="margin-top:8px"><button class="btn" onclick='drawChainForPelanggan(${JSON.stringify(obj).replaceAll("'","\\'")})'>Tampilkan Jalur</button></div>`;
      } else if(kind==='ODC'){
        html += `<div>Feeder: ${obj.feederPanelName||obj.feederPanelId||'-'} Port: ${obj.feederPort||'-'}</div>`;
        html += `<div>Distrib: ${obj.distribPanelName||obj.distribPanelId||'-'} Port: ${obj.distribPort||'-'}</div>`;
        html += `<div style="margin-top:8px"><button class="btn" onclick='listODPByODC("${obj.id}")'>Lihat ODP di ODC</button></div>`;
      } else if(kind==='Feeder' || kind==='Distrib' || kind==='OLT'){
        html += `<div>Code: ${obj.code||'-'}</div>`;
        if(obj.totalPorts) html += `<div>Total ports: ${obj.totalPorts}</div>`;
      }
      ct.innerHTML = html;
      // zoom
      if(obj.location) map.setView([obj.location.lat,obj.location.lng], 16);
    }

    // list pelanggan by ODP
    async function listPelangganByODP(odpId){
      const pelSnap = await getDocs(query(collection(db,'Pelanggan'), where('odpRef','==', odpId)));
      let html = `<div style="font-weight:700">Pelanggan di ODP</div>`;
      pelSnap.forEach(d=> {
        const dd = d.data();
        html += `<div style="padding:6px;border-top:1px solid rgba(255,255,255,0.02)">${dd.name||dd.code||''} • Port:${dd.odpPort}</div>`;
      });
      document.getElementById('detailContent').innerHTML = html;
    }

    async function listODPByODC(odcId){
      const odpSnap = await getDocs(query(collection(db,'ODP'), where('odcRef','==', odcId)));
      let html = `<div style="font-weight:700">ODP di ODC</div>`;
      odpSnap.forEach(d=>{
        const dd = d.data();
        html += `<div style="padding:6px;border-top:1px solid rgba(255,255,255,0.02)">${dd.name||dd.code} • ${dd.usedPorts||0}/${dd.totalPorts||0} <button class="ghost" style="margin-left:8px" onclick='showDetail("ODP", ${JSON.stringify({...dd,id:d.id}).replaceAll("'","\\'")})'>Detail</button></div>`;
      });
      document.getElementById('detailContent').innerHTML = html;
    }

    // ---------- Draw chain function ----------
    function drawChainForPelanggan(pel){
      try{
        layerLines.clearLayers();
        if(!pel) return;
        // we need to find odp -> distrib -> feeder -> odc -> olt if present
        const odp = cache.ODP.find(o=>o.id===pel.odpRef || o.id===pel.odpId);
        if(!odp) return alert('ODP not found for this pelanggan');
        const dist = cache.Distrib.find(d=>d.id===odp.panelDistId);
        const feeder = cache.Feeder.find(f=>f.id=== (dist? dist.feederPanelId: null) );
        const odc = cache.ODC.find(o=>o.id===odp.odcRef || o.id===odp.odcId);
        const olt = cache.OLT.find(x=>x.id=== (odc? odc.oltId : null));

        const points = [];
        if(olt && olt.location) points.push([olt.location.lat, olt.location.lng]);
        if(feeder && feeder.location) points.push([feeder.location.lat, feeder.location.lng]);
        if(dist && dist.location) points.push([dist.location.lat, dist.location.lng]);
        if(odc && odc.location) points.push([odc.location.lat, odc.location.lng]);
        if(odp && odp.location) points.push([odp.location.lat, odp.location.lng]);
        if(pel.location) points.push([pel.location.lat, pel.location.lng]);

        // draw polyline
        const poly = L.polyline(points, {color:'#60a5fa', weight:4, opacity:0.9}).addTo(layerLines);
        map.fitBounds(poly.getBounds().pad(0.4));

        // highlight each node with tooltip
        points.forEach((pt, idx)=> {
          L.circleMarker(pt, {radius:6, color:'#60a5fa'}).addTo(layerLines);
        });

      } catch(e){
        console.error(e);
      }
    }

    // ---------- Add entity functions (with geolocation) ----------
    async function getGeo(){
      return new Promise((res,rej)=>{
        if(!navigator.geolocation) return rej(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(p=>{
          res({ lat: p.coords.latitude, lng: p.coords.longitude, accuracy: p.coords.accuracy });
        }, err=>{
          rej(err);
        }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
      });
    }

    // OLT add
    document.getElementById('btnAddOLT').onclick = async ()=>{
      try{
        const name = document.getElementById('olt_name').value.trim();
        if(!name) return alert('Isi nama OLT');
        const loc = await getGeo();
        await addDoc(collection(db,'OLT'), {
          name, code:name, totalSlots: parseInt(document.getElementById('olt_slots').value||0),
          portsPerSlot: parseInt(document.getElementById('olt_ports').value||0),
          location: { lat:loc.lat, lng:loc.lng, accuracy:loc.accuracy },
          createdAt: serverTimestamp()
        });
        alert('OLT berhasil ditambahkan');
      }catch(e){ alert('Gagal tambah OLT: '+e.message) }
    };

    // Feeder add
    document.getElementById('btnAddFeeder').onclick = async ()=>{
      try{
        const name = document.getElementById('feeder_name').value.trim();
        if(!name) return alert('Isi nama feeder');
        const loc = await getGeo();
        await addDoc(collection(db,'FeederPanel'), {
          name, code:name, totalPorts: parseInt(document.getElementById('feeder_total').value||24),
          location:{lat:loc.lat,lng:loc.lng, accuracy:loc.accuracy}, createdAt: serverTimestamp()
        });
        alert('Feeder ditambahkan');
      }catch(e){ alert('Gagal tambah feeder: '+e.message) }
    };

    // Dist add
    document.getElementById('btnAddDist').onclick = async ()=>{
      try{
        const name = document.getElementById('dist_name').value.trim();
        const feederId = document.getElementById('selectFeeder').value;
        if(!name || !feederId) return alert('Isi nama & pilih feeder');
        const loc = await getGeo();
        const docRef = await addDoc(collection(db,'DistribPanel'), {
          name, code:name, feederPanelId: feederId,
          feederPanelName: (cache.Feeder.find(f=>f.id===feederId)||{}).name || '',
          feederPort: parseInt(document.getElementById('dist_feeder_port').value||0),
          splitterType: document.getElementById('dist_split').value || null,
          totalPorts: parseInt(document.getElementById('dist_split').value ? (document.getElementById('odp_total').value||16) : (document.getElementById('dist_total')?.value||16)),
          location:{lat:loc.lat,lng:loc.lng, accuracy: loc.accuracy},
          createdAt: serverTimestamp()
        });
        alert('Distrib Panel ditambahkan');
      }catch(e){ alert('Gagal tambah distrib: '+e.message) }
    };

    // ODC add
    document.getElementById('btnAddODC').onclick = async ()=>{
      try{
        const name = document.getElementById('odc_name').value.trim();
        if(!name) return alert('Isi nama ODC');
        const feederId = document.getElementById('selectFeederForODC').value;
        const distId = document.getElementById('selectDistForODC').value;
        const loc = await getGeo();
        await addDoc(collection(db,'ODC'), {
          name, code:name, feederPanelId: feederId || null,
          feederPanelName: (cache.Feeder.find(f=>f.id===feederId)||{}).name || '',
          feederPort: parseInt(document.getElementById('odc_feeder_port').value||0),
          distribPanelId: distId || null,
          distribPanelName: (cache.Distrib.find(d=>d.id===distId)||{}).name || '',
          distribPort: parseInt(document.getElementById('odc_dist_port').value||0),
          oltSlot: parseInt(document.getElementById('odc_olt_slot').value||0),
          oltPort: parseInt(document.getElementById('odc_olt_port').value||0),
          location:{lat:loc.lat, lng:loc.lng, accuracy:loc.accuracy},
          createdAt: serverTimestamp()
        });
        alert('ODC ditambahkan');
      }catch(e){ alert('Gagal tambah ODC: '+e.message) }
    };

    // ODP add
    document.getElementById('btnAddODP').onclick = async ()=>{
      try{
        const name = document.getElementById('odp_name').value.trim();
        const distId = document.getElementById('selectDist').value;
        if(!name || !distId) return alert('Isi nama & pilih distrib panel');
        const loc = await getGeo();
        await addDoc(collection(db,'ODP'), {
          name, code:name, panelDistId: distId,
          panelDistName: (cache.Distrib.find(d=>d.id===distId)||{}).name || '',
          panelDistPort: parseInt(document.getElementById('odp_dist_port').value||0),
          odcRef: null, // optional can be set by admin via ODP edit or by adding odcRef to ODP
          totalPorts: parseInt(document.getElementById('odp_total').value||16),
          usedPorts: 0,
          portMapping: {}, // start empty
          location: { lat: loc.lat, lng: loc.lng, accuracy: loc.accuracy },
          createdAt: serverTimestamp()
        });
        alert('ODP ditambahkan');
      }catch(e){ alert('Gagal tambah ODP: '+e.message) }
    };

    // Pelanggan add (with storage upload and transaction for usedPorts)
    document.getElementById('btnAddPel').onclick = async ()=>{
      try{
        const name = document.getElementById('pel_name').value.trim();
        const address = document.getElementById('pel_address').value.trim();
        const odpId = document.getElementById('selectODPForPel').value;
        const port = parseInt(document.getElementById('pel_odp_port').value||0);
        if(!name || !odpId || !port) return alert('Isi nama, pilih ODP dan port');
        const loc = await getGeo();

        // If photo provided, upload to storage
        const photoEl = document.getElementById('pel_photo');
        let photoUrl = null;
        if(photoEl.files && photoEl.files[0]) {
          const f = photoEl.files[0];
          const stRefPath = `pelanggan_photos/${Date.now()}_${f.name}`;
          const sRef = stRef(storage, stRefPath);
          await uploadBytes(sRef, f);
          photoUrl = await getDownloadURL(sRef);
        }

        // Use transaction to ensure unique port assignment and update usedPorts & portMapping
        const odpDocRef = doc(db, 'ODP', odpId);

        await runTransaction(db, async (t)=>{
          const odpSnap = await t.get(odpDocRef);
          if(!odpSnap.exists()) throw new Error('ODP tidak ditemukan');
          const odpData = odpSnap.data();
          const pm = odpData.portMapping || {};
          // check port available
          if(pm[String(port)] && pm[String(port)].status === 'used') throw new Error('Port sudah terpakai');
          // set port mapping to used with a temp pelanggan id (we will create pelanggan after)
          pm[String(port)] = { status:'used', pelangganTemp:true };
          t.update(odpDocRef, { portMapping: pm, usedPorts: (odpData.usedPorts||0) + 1 });
          // create pelanggan doc
          const pelDocRef = doc(collection(db,'Pelanggan'));
          t.set(pelDocRef, {
            name, address, odpRef: odpId, odpName: odpData.name || odpData.code || '',
            odpPort: port, location:{lat:loc.lat, lng:loc.lng, accuracy:loc.accuracy},
            odcRef: odpData.odcRef || null, createdAt: serverTimestamp(),
            photoUrl: photoUrl || null
          });
        });

        alert('Pelanggan berhasil ditambahkan');
        // clear form
        document.getElementById('pel_name').value=''; document.getElementById('pel_address').value=''; document.getElementById('pel_odp_port').value='';
      }catch(e){ alert('Gagal tambah pelanggan: '+(e.message||e)); console.error(e) }
    };

    // location buttons
    document.getElementById('btnLocateOLT').onclick = async ()=> {
      try{ const g = await getGeo(); map.setView([g.lat,g.lng],17); alert('Lokasi ditangkap di peta. Silakan klik Tambah OLT.'); }catch(e){ alert('Gagal ambil lokasi: '+e.message) }
    };
    document.getElementById('btnLocateFeeder').onclick = async ()=> { try{ const g=await getGeo(); map.setView([g.lat,g.lng],17); }catch(e){ alert(e) } };
    document.getElementById('btnLocateDist').onclick = async ()=> { try{ const g=await getGeo(); map.setView([g.lat,g.lng],17); }catch(e){ alert(e) } };
    document.getElementById('btnLocateODC').onclick = async ()=> { try{ const g=await getGeo(); map.setView([g.lat,g.lng],17); }catch(e){ alert(e) } };
    document.getElementById('btnLocateODP').onclick = async ()=> { try{ const g=await getGeo(); map.setView([g.lat,g.lng],17); }catch(e){ alert(e) } };
    document.getElementById('btnLocatePel').onclick = async ()=> { try{ const g=await getGeo(); map.setView([g.lat,g.lng],17); }catch(e){ alert(e) } };

    // ---------- Init render ----------
    renderDataList();

    // small helper: safe stringify for showDetail calls in list
    window.showDetail = (kind, obj) => {
      showDetail(kind, obj);
    };

    // expose drawChain for debugging
    window.drawChainForPelanggan = (obj) => drawChainForPelanggan(obj);

    // initial population handled by real-time listeners
  </script>
</body>
</html>
