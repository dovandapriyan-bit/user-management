<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTTH Topology Center</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (Peta) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster (untuk ODP) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        /* Kustomisasi Leaflet agar sesuai Tailwind */
        .leaflet-popup-content-wrapper { @apply rounded-lg shadow-lg border-0; }
        .leaflet-popup-content { @apply text-sm; }
        .leaflet-popup-tip { @apply shadow-none; }
        
        /* Sembunyikan scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        
        /* Sidebar transition */
        #sidebar { transition: margin-left 0.3s ease-in-out; }
        #main-content { transition: margin-left 0.3s ease-in-out; }
        .sidebar-collapsed { margin-left: -256px; /* 16rem */ }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Detail Modal */
        .detail-section {
            @apply border-b border-gray-200 pb-4 mb-4;
        }
        .detail-section:last-child {
            @apply border-b-0 pb-0 mb-0;
        }
        
        /* Placeholder text yang redup */
        .placeholder-help {
            @apply text-xs text-gray-400 mt-1;
        }
        
        /* Login form styles */
        .login-container {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center login-container">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-600">FTTH Center</h1>
                <p class="text-gray-600 mt-2">Silakan login untuk melanjutkan</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin@ftth.com">
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                    <span id="login-button-text">Login</span>
                    <div id="login-spinner" class="loader w-5 h-5 border-2 border-t-blue-200 ml-2 hidden"></div>
                </button>
                
                <div id="login-error" class="text-red-600 text-sm text-center hidden"></div>
            </form>
        </div>
    </div>

    <!-- 2. OVERLAY LOADING APLIKASI -->
    <div id="app-loader" class="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center hidden">
        <div class="loader"></div>
        <p class="text-gray-700 mt-4 text-lg">Memuat aplikasi...</p>
    </div>

    <!-- 3. SHELL APLIKASI UTAMA (Hidden by default) -->
    <div id="app-shell" class="hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-30">
            <div class="flex items-center justify-between p-4 border-b">
                <h1 class="text-xl font-bold text-blue-600">FTTH Center</h1>
                <button id="sidebar-close-btn" class="sm:hidden p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <nav class="py-4">
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="map">
                    <i data-lucide="map" class="w-5 h-5 mr-3"></i> Peta Jaringan
                </a>
                <div class="px-6 py-2 text-xs font-semibold text-gray-400 uppercase">Aset Jaringan</div>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="OLT">
                    <i data-lucide="server" class="w-5 h-5 mr-3"></i> OLT
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="ODC">
                    <i data-lucide="server-cog" class="w-5 h-5 mr-3"></i> ODC
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="ODP">
                    <i data-lucide="box" class="w-5 h-5 mr-3"></i> ODP
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="Pelanggan">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i> Pelanggan
                </a>
                <div class="px-6 py-2 text-xs font-semibold text-gray-400 uppercase">Manajemen</div>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="Paket">
                    <i data-lucide="package" class="w-5 h-5 mr-3"></i> Paket Layanan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="table" data-entity="Karyawan">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i> Karyawan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="pengaturan">
                    <i data-lucide="settings" class="w-5 h-5 mr-3"></i> Pengaturan
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" data-page="audit">
                    <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Audit Log
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="ml-0 sm:ml-64 relative min-h-screen">
            <!-- Top Navbar -->
            <header class="sticky top-0 bg-white shadow-md z-20">
                <div class="flex items-center justify-between h-16 px-4 sm:px-8">
                    <button id="sidebar-open-btn" class="p-2 -ml-2 rounded-md sm:hidden">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <!-- Search bar (placeholder) -->
                    <div class="relative hidden sm:block">
                        <input type="text" placeholder="Cari aset..." class="px-4 py-2 border rounded-full w-64 bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i data-lucide="search" class="w-4 h-4 absolute top-1/2 right-4 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div id="online-status" class="flex items-center space-x-2">
                            <span id="online-indicator" class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span id="online-text" class="text-sm font-medium text-gray-700">Online</span>
                        </div>
                        <div class="relative" id="user-menu-button">
                            <button class="flex items-center space-x-2 p-2 rounded-full hover:bg-gray-100">
                                <img src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="User" class="w-8 h-8 rounded-full">
                                <div class="hidden md:block text-left">
                                    <div id="user-email" class="text-sm font-semibold">Admin FTTH</div>
                                    <div id="user-role" class="text-xs text-gray-500">Administrator</div>
                                </div>
                            </button>
                            <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content Area -->
            <div class="p-4 sm:p-8">
                
                <!-- Page: Dashboard -->
                <div id="page-dashboard" class="page-content">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Total ODP</div>
                                    <div id="stat-odp" class="text-3xl font-bold text-gray-900">0</div>
                                </div>
                                <i data-lucide="box" class="w-10 h-10 text-blue-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Total Pelanggan</div>
                                    <div id="stat-pelanggan" class="text-3xl font-bold text-gray-900">0</div>
                                </div>
                                <i data-lucide="users" class="w-10 h-10 text-green-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Kapasitas Port</div>
                                    <div id="stat-ports" class="text-3xl font-bold text-gray-900">0/0</div>
                                </div>
                                <i data-lucide="pie-chart" class="w-10 h-10 text-yellow-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Karyawan</div>
                                    <div id="stat-karyawan" class="text-3xl font-bold text-blue-500">0</div>
                                </div>
                                <i data-lucide="user-check" class="w-10 h-10 text-blue-500"></i>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Antrian Sinkronisasi Offline</h3>
                        <div id="offline-queue-list" class="text-gray-600">Tidak ada item dalam antrian.</div>
                    </div>
                    <div class="mt-8 bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200">
                        <div class="flex items-center">
                            <i data-lucide="shield-check" class="w-6 h-6 text-blue-600 mr-3"></i>
                            <h3 class="text-lg font-semibold text-blue-800">Mode Administrator</h3>
                        </div>
                        <p class="mt-2 text-blue-700">Anda login sebagai Administrator dengan akses penuh ke semua fitur sistem.</p>
                    </div>
                </div>

                <!-- Page: Peta Jaringan -->
                <div id="page-map" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Peta Jaringan</h2>
                    <div id="map-container" class="w-full h-[70vh] rounded-lg shadow-md z-10"></div>
                </div>

                <!-- Page: Tabel Entitas (Dinamis) -->
                <div id="page-table" class="page-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="table-title" class="text-3xl font-bold text-gray-800">Manajemen Aset</h2>
                        <button id="add-new-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-blue-700">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span>Tambah Baru</span>
                        </button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr id="table-header-row">
                                        <!-- Header dinamis di-inject di sini -->
                                    </tr>
                                </thead>
                                <tbody id="table-body" class="divide-y">
                                    <!-- Data dinamis di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page: Pengaturan -->
                <div id="page-pengaturan" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Pengaturan Sistem</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Mode Generate Nomor -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Mode Generate Nomor</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium">Generate Nomor Internet Otomatis</p>
                                        <p class="text-sm text-gray-600">Aktifkan untuk membuat nomor internet otomatis saat tambah pelanggan</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-generate-number" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Format Nomor Internet</label>
                                    <input type="text" value="PLG-{YYYY}-{MM}-{SEQ}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Variabel: {YYYY} = Tahun, {MM} = Bulan, {SEQ} = Urutan</p>
                                </div>
                            </div>
                        </div>

                        <!-- Ubah Password -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Ubah Password</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Saat Ini</label>
                                    <input type="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Baru</label>
                                    <input type="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Password Baru</label>
                                    <input type="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                    Simpan Password
                                </button>
                            </div>
                        </div>

                        <!-- Pengaturan Sistem Lainnya -->
                        <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4">Pengaturan Sistem Lainnya</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex items-center justify-between p-3 border rounded-lg">
                                    <div>
                                        <p class="font-medium">Notifikasi Email</p>
                                        <p class="text-sm text-gray-600">Aktifkan notifikasi via email</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 border rounded-lg">
                                    <div>
                                        <p class="font-medium">Backup Otomatis</p>
                                        <p class="text-sm text-gray-600">Backup data setiap hari</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 border rounded-lg">
                                    <div>
                                        <p class="font-medium">Mode Warna</p>
                                        <p class="text-sm text-gray-600">Tema gelap/terang</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 border rounded-lg">
                                    <div>
                                        <p class="font-medium">Bahasa</p>
                                        <p class="text-sm text-gray-600">Bahasa Indonesia</p>
                                    </div>
                                    <select class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option>Indonesia</option>
                                        <option>English</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Audit Log -->
                <div id="page-audit" class="page-content hidden">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Audit Log</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pengguna</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Entitas</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Detail</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-log-body" class="divide-y">
                                    <!-- Data log dinamis di-inject di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- 4. MODAL FORM (Dinamis) -->
    <div id="form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <form id="entity-form" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="form-title" class="text-2xl font-bold text-gray-800">Form Entitas</h2>
                <button type="button" id="close-modal-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="form-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Konten form dinamis di-inject di sini -->
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <input type="hidden" id="form-entity-type">
                <input type="hidden" id="form-entity-id">
                <button type="button" id="cancel-modal-button" class="bg-gray-200 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Batal
                </button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 flex items-center">
                    <span id="submit-button-text">Simpan</span>
                    <div id="submit-spinner" class="loader w-5 h-5 border-2 border-t-blue-200 ml-2 hidden"></div>
                </button>
            </div>
        </form>
    </div>

    <!-- 5. MODAL DETAIL (View Detail) -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="detail-title" class="text-2xl font-bold text-gray-800">Detail Data</h2>
                <button type="button" id="close-detail-button" class="p-1 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="detail-content">
                <!-- Konten detail di-inject di sini -->
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button type="button" id="close-detail-modal-button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- 6. NOTIFICATION TOAST -->
    <div id="notification-toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden transition-opacity duration-300">
        <span id="toast-message"></span>
    </div>

    <!-- ====================================================================== -->
    <!-- SCRIPT UTAMA APLIKASI -->
    <!-- ====================================================================== -->
    <script>
        // --- Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyXLfovZUAPzPfm1LakEFPPgwGegaQr4o",
            authDomain: "user-management-bccb1.firebaseapp.com",
            projectId: "user-management-bccb1",
            storageBucket: "user-management-bccb1.firebasestorage.app",
            messagingSenderId: "22188892577",
            appId: "1:22188892577:web:d8c7ebe3e00e1974956be0",
            measurementId: "G-4SEKELHMTF"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Variabel Global & State ---
        let currentUser = null;
        let userId = null;
        let userRole = null;
        let isOnline = navigator.onLine;
        let map;
        let markerLayers = {
            OLT: L.layerGroup(),
            ODC: L.layerGroup(),
            ODP: L.markerClusterGroup(),
            Pelanggan: L.markerClusterGroup()
        };
        
        // Data cache untuk aplikasi
        let dataCache = {
            OLT: [],
            ODC: [],
            ODP: [],
            Pelanggan: [],
            Paket: [],
            Karyawan: [],
            AuditLog: []
        };
        
        let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');

        // --- Selektor DOM ---
        const $ = document.getElementById.bind(document);
        const $$ = document.querySelectorAll.bind(document);
        
        const loginScreen = $('login-screen');
        const loginForm = $('login-form');
        const appLoader = $('app-loader');
        const appShell = $('app-shell');
        const sidebar = $('sidebar');
        const onlineIndicator = $('online-indicator');
        const onlineText = $('online-text');
        const formModal = $('form-modal');
        const entityForm = $('entity-form');
        const formTitle = $('form-title');
        const formContent = $('form-content');
        const formEntityType = $('form-entity-type');
        const formEntityId = $('form-entity-id');
        const detailModal = $('detail-modal');
        const detailTitle = $('detail-title');
        const detailContent = $('detail-content');
        const toast = $('notification-toast');
        const toastMessage = $('toast-message');

        // --- 1. Inisialisasi Aplikasi ---
        
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupAuthStateListener();
            setupOfflineSync();
            updateOnlineStatusUI(isOnline);
        });

        // --- 2. Autentikasi Firebase ---
        
        function setupAuthStateListener() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User sudah login
                    currentUser = user;
                    userId = user.uid;
                    userRole = 'Administrator'; // Default role
                    
                    // Update UI dengan info user
                    $('user-email').textContent = user.email;
                    $('user-role').textContent = userRole;
                    
                    // Sembunyikan login screen, tampilkan aplikasi
                    loginScreen.classList.add('hidden');
                    appLoader.classList.remove('hidden');
                    
                    // Inisialisasi aplikasi
                    initAppUI();
                } else {
                    // User belum login
                    currentUser = null;
                    userId = null;
                    userRole = null;
                    
                    // Tampilkan login screen, sembunyikan aplikasi
                    loginScreen.classList.remove('hidden');
                    appShell.classList.add('hidden');
                    appLoader.classList.add('hidden');
                }
            });
        }

        // Event listener untuk form login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = $('login-email').value;
            const password = $('login-password').value;
            const loginError = $('login-error');
            const loginButtonText = $('login-button-text');
            const loginSpinner = $('login-spinner');
            
            // Tampilkan loading state
            loginButtonText.textContent = 'Logging in...';
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state listener akan menangani transisi ke aplikasi
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = getAuthErrorMessage(error.code);
                loginError.classList.remove('hidden');
            } finally {
                // Reset loading state
                loginButtonText.textContent = 'Login';
                loginSpinner.classList.add('hidden');
            }
        });

        // Event listener untuk logout
        $('logout-button').addEventListener('click', () => {
            auth.signOut();
        });

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'Format email tidak valid';
                case 'auth/user-disabled':
                    return 'Akun ini telah dinonaktifkan';
                case 'auth/user-not-found':
                    return 'Akun tidak ditemukan';
                case 'auth/wrong-password':
                    return 'Password salah';
                case 'auth/too-many-requests':
                    return 'Terlalu banyak percobaan login. Coba lagi nanti';
                default:
                    return 'Terjadi kesalahan saat login';
            }
        }

        // --- 3. Inisialisasi UI Aplikasi ---
        
        function initAppUI() {
            // Setup UI
            appLoader.classList.add('hidden');
            appShell.classList.remove('hidden');
            
            // Inisialisasi Peta
            initMap();
            
            // Setup Navigasi
            setupNavigation();

            // Setup User Menu
            $('user-menu-button').addEventListener('click', () => {
                $('user-menu-dropdown').classList.toggle('hidden');
            });

            // Setup Modal Detail
            $('close-detail-button').addEventListener('click', () => detailModal.classList.add('hidden'));
            $('close-detail-modal-button').addEventListener('click', () => detailModal.classList.add('hidden'));

            // Muat semua data dari Firebase
            loadAllData();

            // Tampilkan dashboard sebagai default
            showPage('dashboard');
        }

        // --- 4. Navigasi & UI Interactivity ---

        function setupNavigation() {
            // Kontrol Sidebar
            $('sidebar-open-btn').addEventListener('click', () => sidebar.classList.remove('sidebar-collapsed'));
            $('sidebar-close-btn').addEventListener('click', () => sidebar.classList.add('sidebar-collapsed'));
            
            if (window.innerWidth < 640) {
                 sidebar.classList.add('sidebar-collapsed');
            }
            
            // Navigasi Halaman
            $$('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    const entity = link.dataset.entity;
                    
                    if (entity) {
                        loadTablePage(entity);
                    }
                    showPage(page);
                    
                    if (window.innerWidth < 640) {
                        sidebar.classList.add('sidebar-collapsed');
                    }
                });
            });

            // Kontrol Modal
            $('close-modal-button').addEventListener('click', () => formModal.classList.add('hidden'));
            $('cancel-modal-button').addEventListener('click', () => formModal.classList.add('hidden'));
            $('add-new-button').addEventListener('click', () => {
                const currentEntity = $('table-title').dataset.entity;
                if (currentEntity) {
                    showFormModal(currentEntity);
                }
            });
        }

        function showPage(pageId) {
            $$('.page-content').forEach(page => page.classList.add('hidden'));
            $(pageId === 'table' ? 'page-table' : `page-${pageId}`).classList.remove('hidden');
            
            if (pageId === 'map') {
                // Perlu me-refresh peta jika ukurannya berubah saat disembunyikan
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
            }
        }

        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            if (type === 'error') {
                toast.classList.replace('bg-gray-900', 'bg-red-600');
            } else if (type === 'warning') {
                toast.classList.replace('bg-gray-900', 'bg-yellow-600');
            } else {
                toast.classList.replace('bg-red-600', 'bg-gray-900');
                toast.classList.replace('bg-yellow-600', 'bg-gray-900');
            }
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // --- 5. Logika Peta (Leaflet) ---

        function initMap() {
            map = L.map('map-container').setView([-6.2088, 106.8456], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Tambahkan semua layer group ke peta
            Object.values(markerLayers).forEach(layer => layer.addTo(map));
        }

        function renderMarkers(entity, data) {
            const layer = markerLayers[entity];
            layer.clearLayers();

            data.forEach(item => {
                if (!item.location || !item.location.lat || !item.location.lng) return;

                const latLng = [item.location.lat, item.location.lng];
                let marker;

                // Kustomisasi marker berdasarkan entity
                if (entity === 'OLT') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'olt-marker',
                            html: '<div class="w-6 h-6 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="server" class="w-3 h-3 text-white"></i></div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    });
                } else if (entity === 'ODC') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'odc-marker',
                            html: '<div class="w-6 h-6 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="server-cog" class="w-3 h-3 text-white"></i></div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    });
                } else if (entity === 'ODP') {
                    const capacity = getOdpCapacity(item);
                    const color = capacity.percentage >= 100 ? 'red' : (capacity.percentage >= 75 ? 'orange' : 'green');
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'odp-marker',
                            html: `<div class="w-6 h-6 bg-${color}-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="box" class="w-3 h-3 text-white"></i></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    });
                } else if (entity === 'Pelanggan') {
                    marker = L.marker(latLng, { 
                        icon: L.divIcon({
                            className: 'pelanggan-marker',
                            html: '<div class="w-5 h-5 bg-green-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><i data-lucide="user" class="w-2 h-2 text-white"></i></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                }

                if (marker) {
                    marker.bindPopup(createPopupContent(entity, item));
                    layer.addLayer(marker);
                }
            });
            
            // Render ulang ikon Lucide
            lucide.createIcons();
        }
        
        function createPopupContent(entity, item) {
            let content = `<div class="font-bold text-base mb-1">${item.namaODP || item.namaODC || item.name || item.code}</div>`;
            if (entity === 'OLT') {
                content += `<p>Model: ${item.model || 'N/A'}</p>`;
                content += `<p>Slot: ${item.totalSlots || 0}, Port: ${item.totalPorts || 0}</p>`;
            } else if (entity === 'ODC') {
                content += `<p>Kapasitas: ${item.capacity || 0}</p>`;
            } else if (entity === 'ODP') {
                const { used, total, percentage } = getOdpCapacity(item);
                content += `<p>Kapasitas: ${used} / ${total} (${percentage.toFixed(1)}%)</p>`;
            } else if (entity === 'Pelanggan') {
                content += `<p>Alamat: ${item.address || 'N/A'}</p>`;
                content += `<p>Status: <span class="font-semibold ${item.status === 'active' ? 'text-green-600' : (item.status === 'pending' ? 'text-yellow-600' : 'text-gray-500')}">${item.status}</span></p>`;
            }
            if (item.location) {
                content += `<p class="text-xs text-gray-500">${item.location.lat.toFixed(4)}, ${item.location.lng.toFixed(4)}</p>`;
            }
            return content;
        }

        // --- 6. Logika Data & Tampilan ---

        async function loadAllData() {
            try {
                // Load semua data dari Firebase
                await Promise.all([
                    loadDataFromFirestore('OLT'),
                    loadDataFromFirestore('ODC'),
                    loadDataFromFirestore('ODP'),
                    loadDataFromFirestore('Pelanggan'),
                    loadDataFromFirestore('Paket'),
                    loadDataFromFirestore('Karyawan'),
                    loadDataFromFirestore('AuditLog')
                ]);
                
                // Update UI dengan data
                renderMarkers('OLT', dataCache.OLT);
                renderMarkers('ODC', dataCache.ODC);
                renderMarkers('ODP', dataCache.ODP);
                renderMarkers('Pelanggan', dataCache.Pelanggan);
                
                renderAuditLog(dataCache.AuditLog);
                updateDashboardStats();
                
                showToast('Data berhasil dimuat', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Gagal memuat data', 'error');
            }
        }

        async function loadDataFromFirestore(entityType) {
            try {
                const snapshot = await db.collection(entityType).get();
                dataCache[entityType] = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error(`Error loading ${entityType}:`, error);
                dataCache[entityType] = [];
            }
        }

        function loadTablePage(entity) {
            $('table-title').textContent = `Manajemen ${entity}`;
            $('table-title').dataset.entity = entity;
            renderTable(entity, dataCache[entity]);
        }

        function renderTable(entity, data) {
            const tableHeader = $('table-header-row');
            const tableBody = $('table-body');
            
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            let headers = [];
            
            // Definisikan header tabel berdasarkan entity
            if (entity === 'OLT') headers = ['Kode', 'Nama', 'Model', 'SN', 'Rak', 'Slot/Port', 'Lokasi', 'Aksi'];
            else if (entity === 'ODC') headers = ['Kode Wilayah', 'Kode Sektor', 'Nama ODC', 'Kapasitas', 'OLT', 'Slot/Port OLT', 'Panel Feeder', 'Aksi'];
            else if (entity === 'ODP') headers = ['Kode Wilayah', 'Sektor ODC', 'Nomor ODC', 'Nama ODP', 'Panel Feeder', 'Panel Distribusi', 'Kapasitas', 'Aksi'];
            else if (entity === 'Pelanggan') headers = ['No. Pelanggan', 'Nama', 'Username', 'Paket', 'ODP', 'Port', 'Status', 'Aksi'];
            else if (entity === 'Paket') headers = ['Jenis Paket', 'Kecepatan', 'Harga', 'Aksi'];
            else if (entity === 'Karyawan') headers = ['Nama', 'Email', 'Role', 'Status', 'Aksi'];
            
            // Render header
            headers.forEach(h => {
                tableHeader.innerHTML += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">${h}</th>`;
            });

            // Render data
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                let rowHtml = '';
                if (entity === 'OLT') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.code}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.model || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.sn || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.rack || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.totalSlots || 0} Slot / ${item.totalPorts || 0} Port</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.location ? `${item.location.lat.toFixed(4)}, ${item.location.lng.toFixed(4)}` : 'N/A'}</td>
                    `;
                } else if (entity === 'ODC') {
                    const olt = dataCache.OLT.find(o => o.id === item.oltRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeWilayah}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeSektor}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.namaODC}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.capacity || 0}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${olt?.name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.oltSlot || 'N/A'}/${item.oltPort || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelFeeder || 'N/A'}/${item.portFeeder || 'N/A'}</td>
                    `;
                } else if (entity === 'ODP') {
                    const { used, total, percentage } = getOdpCapacity(item);
                    const odc = dataCache.ODC.find(o => o.id === item.odcRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeWilayah}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kodeSektor}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.nomorODC}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.namaODP}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelFeeder || 'N/A'}/${item.portFeeder || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.panelDistribusi || 'N/A'}/${item.portDistribusi || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            <div class="flex items-center">
                                <span class="font-medium ${percentage >= 100 ? 'text-red-600' : (percentage >= 75 ? 'text-orange-600' : 'text-green-600')}">
                                    ${used} / ${total}
                                </span>
                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full ${percentage >= 100 ? 'bg-red-500' : (percentage >= 75 ? 'bg-orange-500' : 'bg-green-500')}" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </td>
                    `;
                } else if (entity === 'Pelanggan') {
                    const odp = dataCache.ODP.find(o => o.id === item.odpRef);
                    const paket = dataCache.Paket.find(p => p.id === item.paketRef);
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.customerNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.username}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${paket?.jenis || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${odp?.namaODP || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.odpPort || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.status === 'active' ? 'bg-green-100 text-green-800' : (item.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800')}">
                                ${item.status}
                            </span>
                        </td>
                    `;
                } else if (entity === 'Paket') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.jenis}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.kecepatan}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">Rp ${item.harga?.toLocaleString('id-ID') || 0}</td>
                    `;
                } else if (entity === 'Karyawan') {
                    rowHtml = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.nama}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.email}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.role}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${item.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${item.status}
                            </span>
                        </td>
                    `;
                }
                
                // Tombol aksi
                rowHtml += `
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center space-x-2">
                            <button class="view-btn text-green-600 hover:text-green-800 p-1" data-id="${item.id}" title="Lihat Detail">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button class="edit-btn text-blue-600 hover:text-blue-800 p-1" data-id="${item.id}" title="Edit">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-btn text-red-600 hover:text-red-800 p-1" data-id="${item.id}" title="Hapus">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                row.innerHTML = rowHtml;
                tableBody.appendChild(row);
            });

            // Render ulang ikon
            lucide.createIcons();

            // Tambahkan event listener untuk tombol aksi
            $$('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    showDetailModal(entity, id);
                });
            });

            $$('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    showFormModal(entity, id);
                });
            });

            $$('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const entity = $('table-title').dataset.entity;
                    deleteEntity(entity, id);
                });
            });
        }

        function showDetailModal(entityType, entityId) {
            const entity = dataCache[entityType].find(e => e.id === entityId);
            if (!entity) return;
            
            detailTitle.textContent = `Detail ${entityType}`;
            detailContent.innerHTML = generateDetailContent(entityType, entity);
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Tampilkan modal
            detailModal.classList.remove('hidden');
        }

        function generateDetailContent(entityType, entity) {
            let content = '';
            
            if (entityType === 'OLT') {
                const connectedODCs = dataCache.ODC.filter(odc => odc.oltRef === entity.id);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi OLT</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Kode OLT</p>
                                <p class="font-medium">${entity.code}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Nama OLT</p>
                                <p class="font-medium">${entity.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Model</p>
                                <p class="font-medium">${entity.model}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Serial Number</p>
                                <p class="font-medium">${entity.sn}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Rak</p>
                                <p class="font-medium">${entity.rack}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kapasitas</p>
                                <p class="font-medium">${entity.totalSlots} Slot / ${entity.totalPorts} Port</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Koneksi ke ODC</h3>
                        ${connectedODCs.length > 0 ? `
                            <div class="space-y-3">
                                ${connectedODCs.map(odc => `
                                    <div class="border rounded-lg p-3">
                                        <p class="font-medium">${odc.namaODC}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                            <div>
                                                <p class="text-gray-600">Slot/Port OLT</p>
                                                <p>${odc.oltSlot}/${odc.oltPort}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Panel Feeder</p>
                                                <p>${odc.panelFeeder}/${odc.portFeeder}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500">Tidak ada ODC yang terhubung</p>'}
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Rangkuman Jaringan</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="font-medium">OLT ${entity.name} terhubung ke:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                ${connectedODCs.map(odc => `
                                    <li>ODC ${odc.namaODC} melalui Slot ${odc.oltSlot} Port ${odc.oltPort}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            } else if (entityType === 'ODC') {
                const olt = dataCache.OLT.find(o => o.id === entity.oltRef);
                const connectedODPs = dataCache.ODP.filter(odp => odp.odcRef === entity.id);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi ODC</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Kode Wilayah</p>
                                <p class="font-medium">${entity.kodeWilayah}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kode Sektor</p>
                                <p class="font-medium">${entity.kodeSektor}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Nama ODC</p>
                                <p class="font-medium">${entity.namaODC}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kapasitas</p>
                                <p class="font-medium">${entity.capacity}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">OLT</p>
                                <p class="font-medium">${olt?.name || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Slot/Port OLT</p>
                                <p class="font-medium">${entity.oltSlot}/${entity.oltPort}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Feeder</p>
                                <p class="font-medium">${entity.panelFeeder}/${entity.portFeeder}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Distribusi</p>
                                <p class="font-medium">${entity.panelDistribusi}/${entity.portDistribusi}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Koneksi ke ODP</h3>
                        ${connectedODPs.length > 0 ? `
                            <div class="space-y-3">
                                ${connectedODPs.map(odp => `
                                    <div class="border rounded-lg p-3">
                                        <p class="font-medium">${odp.namaODP}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                            <div>
                                                <p class="text-gray-600">Panel Feeder</p>
                                                <p>${odp.panelFeeder}/${odp.portFeeder}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Panel Distribusi</p>
                                                <p>${odp.panelDistribusi}/${odp.portDistribusi}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Kapasitas</p>
                                                <p>${getOdpCapacity(odp).used}/${odp.totalPorts}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500">Tidak ada ODP yang terhubung</p>'}
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Rangkuman Hirarki Jaringan</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="font-medium">ODC ${entity.namaODC} terhubung dari:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                <li>OLT ${olt?.name || 'N/A'} melalui Slot ${entity.oltSlot} Port ${entity.oltPort}</li>
                                <li>Panel Feeder ${entity.panelFeeder} Port ${entity.portFeeder}</li>
                            </ul>
                            <p class="font-medium mt-3">Dan terhubung ke:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                ${connectedODPs.map(odp => `
                                    <li>ODP ${odp.namaODP} melalui Panel Distribusi ${odp.panelDistribusi} Port ${odp.portDistribusi}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            } else if (entityType === 'ODP') {
                const odc = dataCache.ODC.find(o => o.id === entity.odcRef);
                const olt = odc ? dataCache.OLT.find(o => o.id === odc.oltRef) : null;
                const connectedPelanggan = dataCache.Pelanggan.filter(p => p.odpRef === entity.id);
                const { used, total, percentage } = getOdpCapacity(entity);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi ODP</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Kode Wilayah</p>
                                <p class="font-medium">${entity.kodeWilayah}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Sektor ODC</p>
                                <p class="font-medium">${entity.kodeSektor}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Nomor ODC</p>
                                <p class="font-medium">${entity.nomorODC}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Nama ODP</p>
                                <p class="font-medium">${entity.namaODP}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Feeder</p>
                                <p class="font-medium">${entity.panelFeeder}/${entity.portFeeder}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Panel Distribusi</p>
                                <p class="font-medium">${entity.panelDistribusi}/${entity.portDistribusi}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kapasitas Port</p>
                                <p class="font-medium ${percentage >= 100 ? 'text-red-600' : (percentage >= 75 ? 'text-orange-600' : 'text-green-600')}">
                                    ${used} / ${total} (${percentage.toFixed(1)}%)
                                </p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Hirarki Jaringan Lengkap</h3>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">OLT:</span>
                                    <span>${olt?.name || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Slot/Port OLT:</span>
                                    <span>${odc?.oltSlot || 'N/A'}/${odc?.oltPort || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODC:</span>
                                    <span>${odc?.namaODC || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Feeder:</span>
                                    <span>${entity.panelFeeder}/${entity.portFeeder}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Distribusi:</span>
                                    <span>${entity.panelDistribusi}/${entity.portDistribusi}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODP:</span>
                                    <span>${entity.namaODP}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Pelanggan Terhubung</h3>
                        ${connectedPelanggan.length > 0 ? `
                            <div class="space-y-3">
                                ${connectedPelanggan.map(pelanggan => `
                                    <div class="border rounded-lg p-3">
                                        <p class="font-medium">${pelanggan.name}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                            <div>
                                                <p class="text-gray-600">No. Pelanggan</p>
                                                <p>${pelanggan.customerNumber}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Port ODP</p>
                                                <p>${pelanggan.odpPort}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Jenis ONT</p>
                                                <p>${pelanggan.jenisONT}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600">Status</p>
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${pelanggan.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                    ${pelanggan.status}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500">Tidak ada pelanggan yang terhubung</p>'}
                    </div>
                `;
            } else if (entityType === 'Pelanggan') {
                const odp = dataCache.ODP.find(o => o.id === entity.odpRef);
                const odc = odp ? dataCache.ODC.find(o => o.id === odp.odcRef) : null;
                const olt = odc ? dataCache.OLT.find(o => o.id === odc.oltRef) : null;
                const paket = dataCache.Paket.find(p => p.id === entity.paketRef);
                
                content = `
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi Pelanggan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">No. Pelanggan</p>
                                <p class="font-medium">${entity.customerNumber}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Nama</p>
                                <p class="font-medium">${entity.name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Username</p>
                                <p class="font-medium">${entity.username}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Paket</p>
                                <p class="font-medium">${paket?.jenis || 'N/A'} - ${paket?.kecepatan || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Jenis ONT</p>
                                <p class="font-medium">${entity.jenisONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">SN ONT</p>
                                <p class="font-medium">${entity.snONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">IP Address</p>
                                <p class="font-medium">${entity.ipAddress}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Status</p>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${entity.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${entity.status}
                                </span>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Alamat</p>
                                <p class="font-medium">${entity.address}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">Lokasi</p>
                                <p class="font-medium">${entity.location ? `${entity.location.lat}, ${entity.location.lng}` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Detail Jaringan Pelanggan</h3>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODP:</span>
                                    <span>${odp?.namaODP || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Port ODP:</span>
                                    <span>${entity.odpPort}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">ODC:</span>
                                    <span>${odc?.namaODC || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Distribusi:</span>
                                    <span>${odp?.panelDistribusi || 'N/A'}/${odp?.portDistribusi || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Panel Feeder:</span>
                                    <span>${odp?.panelFeeder || 'N/A'}/${odp?.portFeeder || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">OLT:</span>
                                    <span>${olt?.name || 'N/A'}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium">Slot/Port OLT:</span>
                                    <span>${odc?.oltSlot || 'N/A'}/${odc?.oltPort || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3 class="text-lg font-semibold mb-3">Informasi Teknis</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Jenis Perangkat</p>
                                <p class="font-medium">${entity.jenisONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Serial Number</p>
                                <p class="font-medium">${entity.snONT}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Alamat IP</p>
                                <p class="font-medium">${entity.ipAddress}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Kecepatan</p>
                                <p class="font-medium">${paket?.kecepatan || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        function renderAuditLog(data) {
            const tbody = $('audit-log-body');
            tbody.innerHTML = '';
            
            // Urutkan berdasarkan waktu (terbaru dulu)
            const sortedData = [...data].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sortedData.forEach(log => {
                const time = new Date(log.timestamp).toLocaleString('id-ID');
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${time}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.userEmail}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.action}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${log.entityType}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${JSON.stringify(log.details)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDashboardStats() {
            // Update statistik dashboard
            $('stat-odp').textContent = dataCache.ODP.length;
            $('stat-pelanggan').textContent = dataCache.Pelanggan.length;
            $('stat-karyawan').textContent = dataCache.Karyawan.length;
            
            // Hitung kapasitas port
            const totalPorts = dataCache.ODP.reduce((sum, odp) => sum + (odp.totalPorts || 0), 0);
            const usedPorts = dataCache.Pelanggan.filter(p => p.status === 'active').length;
            $('stat-ports').textContent = `${usedPorts}/${totalPorts}`;
        }

        function getOdpCapacity(odp) {
            const total = odp.totalPorts || 0;
            const used = dataCache.Pelanggan.filter(p => p.odpRef === odp.id && p.status === 'active').length;
            const percentage = total > 0 ? (used / total) * 100 : 0;
            return { used, total, percentage };
        }

        // --- 7. Form Modal & CRUD Operations ---

        function showFormModal(entityType, entityId = null) {
            formEntityType.value = entityType;
            formEntityId.value = entityId || '';
            
            // Set judul form
            formTitle.textContent = entityId ? `Edit ${entityType}` : `Tambah ${entityType}`;
            
            // Generate form fields
            formContent.innerHTML = generateFormFields(entityType, entityId);
            
            // Render ulang ikon
            lucide.createIcons();
            
            // Setup event listeners khusus
            setupFormEventListeners(entityType, entityId);
            
            // Tampilkan modal
            formModal.classList.remove('hidden');
        }

        function setupFormEventListeners(entityType, entityId = null) {
            // Setup GPS untuk OLT, ODC, ODP, Pelanggan
            if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                const gpsBtn = formContent.querySelector('#get-gps-btn');
                if (gpsBtn) {
                    gpsBtn.addEventListener('click', getGpsLocation);
                }
            }
            
            // Setup search untuk ODP di form Pelanggan
            if (entityType === 'Pelanggan') {
                const odpSearch = formContent.querySelector('#odp-search');
                const odpSelect = formContent.querySelector('#odpRef');
                
                if (odpSearch && odpSelect) {
                    odpSearch.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const options = odpSelect.querySelectorAll('option');
                        
                        options.forEach(option => {
                            const text = option.textContent.toLowerCase();
                            if (text.includes(searchTerm) || searchTerm === '') {
                                option.style.display = '';
                            } else {
                                option.style.display = 'none';
                            }
                        });
                    });
                }
                
                // Setup camera scan untuk SN ONT - HANYA untuk form Pelanggan
                const scanBtn = formContent.querySelector('#scan-sn-btn');
                if (scanBtn) {
                    scanBtn.addEventListener('click', simulateCameraScan);
                }
                
                // Validasi port ODP yang sudah terisi
                const odpPortInput = formContent.querySelector('input[name="odpPort"]');
                const odpRefSelect = formContent.querySelector('select[name="odpRef"]');
                
                if (odpPortInput && odpRefSelect) {
                    const validatePortAvailability = () => {
                        const odpId = odpRefSelect.value;
                        const port = parseInt(odpPortInput.value);
                        
                        if (odpId && port) {
                            const existingCustomer = dataCache.Pelanggan.find(p => 
                                p.odpRef === odpId && p.odpPort === port && p.id !== entityId
                            );
                            
                            if (existingCustomer) {
                                showToast(`Port ${port} pada ODP ini sudah terisi oleh pelanggan ${existingCustomer.name}`, 'warning');
                                odpPortInput.classList.add('border-red-500');
                            } else {
                                odpPortInput.classList.remove('border-red-500');
                            }
                        }
                    };
                    
                    odpPortInput.addEventListener('blur', validatePortAvailability);
                    odpRefSelect.addEventListener('change', validatePortAvailability);
                }
            }
            
            // Setup camera scan untuk SN OLT - HANYA untuk form OLT
            if (entityType === 'OLT') {
                const scanBtn = formContent.querySelector('#scan-sn-btn');
                if (scanBtn) {
                    scanBtn.addEventListener('click', simulateCameraScan);
                }
            }
        }

        function getGpsLocation() {
            const statusEl = formContent.querySelector('#gps-status');
            const latInput = formContent.querySelector('#location-lat');
            const lngInput = formContent.querySelector('#location-lng');
            
            if (!navigator.geolocation) {
                statusEl.textContent = 'Geolocation tidak didukung browser ini.';
                statusEl.classList.add('text-red-500');
                return;
            }
            
            statusEl.textContent = 'Mencari lokasi...';
            statusEl.classList.remove('text-red-500', 'text-green-500');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    latInput.value = latitude.toFixed(6);
                    lngInput.value = longitude.toFixed(6);
                    
                    statusEl.textContent = `Lokasi berhasil di-set! Akurasi: ${accuracy.toFixed(2)} meter`;
                    statusEl.classList.add('text-green-500');
                    
                    showToast('Lokasi berhasil di-set dengan akurasi tinggi', 'success');
                },
                (error) => {
                    let errorMessage = 'Gagal mendapatkan lokasi: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Akses lokasi ditolak';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Informasi lokasi tidak tersedia';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Permintaan lokasi timeout';
                            break;
                        default:
                            errorMessage += 'Error tidak diketahui';
                    }
                    statusEl.textContent = errorMessage;
                    statusEl.classList.add('text-red-500');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function simulateCameraScan() {
            // Tentukan field mana yang akan diisi berdasarkan entity type
            let fieldToFill;
            const entityType = formEntityType.value;
            
            if (entityType === 'OLT') {
                fieldToFill = formContent.querySelector('input[name="sn"]');
            } else if (entityType === 'Pelanggan') {
                fieldToFill = formContent.querySelector('input[name="snONT"]');
            }
            
            if (!fieldToFill) return;
            
            // Simulasi scan barcode/kamera
            showToast('Membuka kamera untuk scan...', 'warning');
            
            setTimeout(() => {
                // Data contoh hasil scan
                if (entityType === 'OLT') {
                    fieldToFill.value = 'HWTX' + Math.random().toString(36).substr(2, 9).toUpperCase();
                } else if (entityType === 'Pelanggan') {
                    fieldToFill.value = 'ONT' + Math.random().toString(36).substr(2, 9).toUpperCase();
                }
                showToast('Scan berhasil! Serial Number telah diisi.', 'success');
            }, 2000);
        }

        function generateFormFields(entityType, entityId) {
            let fields = '';
            const entity = entityId ? dataCache[entityType].find(e => e.id === entityId) : null;
            
            if (entityType === 'OLT') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode OLT *</label>
                        <input type="text" name="code" value="${entity?.code || ''}" placeholder="OLT-JKT-001" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama OLT *</label>
                        <input type="text" name="name" value="${entity?.name || ''}" placeholder="OLT Central Jakarta" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model *</label>
                        <input type="text" name="model" value="${entity?.model || ''}" placeholder="Huawei MA5608T" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number *</label>
                        <div class="flex space-x-2">
                            <input type="text" name="sn" value="${entity?.sn || ''}" placeholder="HWTX123456789" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <button type="button" id="scan-sn-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                <span>Scan</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rak *</label>
                        <input type="text" name="rack" value="${entity?.rack || ''}" placeholder="Rack A-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Slot *</label>
                        <input type="number" name="totalSlots" value="${entity?.totalSlots || 8}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Port *</label>
                        <input type="number" name="totalPorts" value="${entity?.totalPorts || 128}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'ODC') {
                const oltOptions = dataCache.OLT.map(olt => 
                    `<option value="${olt.id}" ${entity?.oltRef === olt.id ? 'selected' : ''}>${olt.name} (${olt.code})</option>`
                ).join('');
                
                fields = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Wilayah *</label>
                        <input type="text" name="kodeWilayah" value="${entity?.kodeWilayah || ''}" placeholder="SBY" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="placeholder-help">Contoh: SBY, MLG, LMJ</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Sektor *</label>
                        <input type="text" name="kodeSektor" value="${entity?.kodeSektor || ''}" placeholder="FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="placeholder-help">Contoh: FA, FB, FC</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama ODC *</label>
                        <input type="text" name="namaODC" value="${entity?.namaODC || ''}" placeholder="ODC-SBY-FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="placeholder-help">Format: ODC-{Wilayah}-{Sektor}</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kapasitas *</label>
                        <input type="number" name="capacity" value="${entity?.capacity || 144}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">OLT *</label>
                        <select name="oltRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih OLT</option>
                            ${oltOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Slot OLT *</label>
                        <input type="number" name="oltSlot" value="${entity?.oltSlot || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port OLT *</label>
                        <input type="number" name="oltPort" value="${entity?.oltPort || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Feeder *</label>
                        <input type="text" name="panelFeeder" value="${entity?.panelFeeder || ''}" placeholder="PF-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Feeder *</label>
                        <input type="number" name="portFeeder" value="${entity?.portFeeder || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'ODP') {
                const odcOptions = dataCache.ODC.map(odc => 
                    `<option value="${odc.id}" ${entity?.odcRef === odc.id ? 'selected' : ''}>${odc.namaODC}</option>`
                ).join('');
                
                fields = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Wilayah *</label>
                        <input type="text" name="kodeWilayah" value="${entity?.kodeWilayah || ''}" placeholder="SBY" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="placeholder-help">Contoh: SBY, MLG, LMJ</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sektor ODC *</label>
                        <input type="text" name="kodeSektor" value="${entity?.kodeSektor || ''}" placeholder="FA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="placeholder-help">Contoh: FA, FB, FC</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor ODC *</label>
                        <input type="text" name="nomorODC" value="${entity?.nomorODC || ''}" placeholder="01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="placeholder-help">Contoh: 01, 02, 03</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama ODP *</label>
                        <input type="text" name="namaODP" value="${entity?.namaODP || ''}" placeholder="ODP-SBY-FA-001" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="placeholder-help">Format: ODP-{Wilayah}-{Sektor}-{Nomor}</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ODC *</label>
                        <select name="odcRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih ODC</option>
                            ${odcOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Feeder *</label>
                        <input type="text" name="panelFeeder" value="${entity?.panelFeeder || ''}" placeholder="PF-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Feeder *</label>
                        <input type="number" name="portFeeder" value="${entity?.portFeeder || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Panel Distribusi *</label>
                        <input type="text" name="panelDistribusi" value="${entity?.panelDistribusi || ''}" placeholder="PD-01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Distribusi *</label>
                        <input type="number" name="portDistribusi" value="${entity?.portDistribusi || 1}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Port *</label>
                        <select name="totalPorts" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="8" ${entity?.totalPorts == 8 ? 'selected' : ''}>8 Port</option>
                            <option value="16" ${entity?.totalPorts == 16 ? 'selected' : ''}>16 Port</option>
                            <option value="32" ${entity?.totalPorts == 32 ? 'selected' : ''}>32 Port</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port Terpakai</label>
                        <input type="number" name="usedPorts" value="${entity?.usedPorts || 0}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'Pelanggan') {
                const odpOptions = dataCache.ODP.map(odp => 
                    `<option value="${odp.id}" ${entity?.odpRef === odp.id ? 'selected' : ''}>${odp.namaODP} (${getOdpCapacity(odp).used}/${odp.totalPorts})</option>`
                ).join('');
                
                const paketOptions = dataCache.Paket.map(paket => 
                    `<option value="${paket.id}" ${entity?.paketRef === paket.id ? 'selected' : ''}>${paket.jenis} - ${paket.kecepatan}</option>`
                ).join('');
                
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Pelanggan *</label>
                        <input type="text" name="customerNumber" id="customerNumber" value="${entity?.customerNumber || ''}" placeholder="PLG-2024-01-001" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <!-- Tombol Generate dinonaktifkan sesuai permintaan -->
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                        <input type="text" name="name" value="${entity?.name || ''}" placeholder="Budi Santoso" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                        <input type="text" name="username" value="${entity?.username || ''}" placeholder="budi123" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" name="password" value="${entity?.password || ''}" placeholder="••••••" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat *</label>
                        <textarea name="address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>${entity?.address || ''}</textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Paket Layanan *</label>
                        <select name="paketRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Paket</option>
                            ${paketOptions}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ODP *</label>
                        <input type="text" id="odp-search" placeholder="Cari ODP..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                        <select name="odpRef" id="odpRef" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih ODP</option>
                            ${odpOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port ODP *</label>
                        <input type="number" name="odpPort" value="${entity?.odpPort || ''}" min="1" max="32" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis ONT</label>
                        <div class="flex space-x-2">
                            <input type="text" name="jenisONT" id="jenisONT" value="${entity?.jenisONT || ''}" placeholder="HG8245H" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" id="scan-sn-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                <span>Scan</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">SN ONT</label>
                        <input type="text" name="snONT" id="snONT" value="${entity?.snONT || ''}" placeholder="ONT123456789" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IP Address</label>
                        <input type="text" name="ipAddress" value="${entity?.ipAddress || ''}" placeholder="192.168.1.100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="active" ${entity?.status === 'active' ? 'selected' : ''}>Aktif</option>
                            <option value="pending" ${entity?.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="inactive" ${entity?.status === 'inactive' ? 'selected' : ''}>Nonaktif</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 border-t pt-4 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tagging Lokasi</label>
                        <div class="flex items-end space-x-2">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Latitude</label>
                                <input type="text" id="location-lat" name="location.lat" value="${entity?.location?.lat || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Longitude</label>
                                <input type="text" id="location-lng" name="location.lng" value="${entity?.location?.lng || ''}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                            </div>
                            <button type="button" id="get-gps-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                <span>Set Lokasi</span>
                            </button>
                        </div>
                        <div id="gps-status" class="text-xs text-gray-500 mt-1">Klik "Set Lokasi" untuk mendapatkan koordinat GPS yang akurat</div>
                    </div>
                `;
            } else if (entityType === 'Paket') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Paket *</label>
                        <input type="text" name="jenis" value="${entity?.jenis || ''}" placeholder="Basic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kecepatan *</label>
                        <input type="text" name="kecepatan" value="${entity?.kecepatan || ''}" placeholder="10 Mbps" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Harga *</label>
                        <input type="number" name="harga" value="${entity?.harga || ''}" placeholder="150000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                `;
            } else if (entityType === 'Karyawan') {
                fields = `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                        <input type="text" name="nama" value="${entity?.nama || ''}" placeholder="Ahmad Fauzi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" name="email" value="${entity?.email || ''}" placeholder="ahmad@ftth.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
                        <select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Role</option>
                            <option value="Admin" ${entity?.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Teknisi" ${entity?.role === 'Teknisi' ? 'selected' : ''}>Teknisi</option>
                            <option value="Operator" ${entity?.role === 'Operator' ? 'selected' : ''}>Operator</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="Aktif" ${entity?.status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                            <option value="Nonaktif" ${entity?.status === 'Nonaktif' ? 'selected' : ''}>Nonaktif</option>
                        </select>
                    </div>
                `;
            }
            
            return fields;
        }

        // Event listener untuk form submission
        entityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveEntity();
        });

        async function saveEntity() {
            const entityType = formEntityType.value;
            const entityId = formEntityId.value;
            const submitButton = entityForm.querySelector('button[type="submit"]');
            const submitSpinner = $('submit-spinner');
            const submitText = $('submit-button-text');
            
            // Tampilkan loading state
            submitText.textContent = 'Menyimpan...';
            submitSpinner.classList.remove('hidden');
            submitButton.disabled = true;
            
            try {
                const formData = new FormData(entityForm);
                const data = Object.fromEntries(formData.entries());
                
                // Parse nested objects
                if (data.location && data.location.lat && data.location.lng) {
                    data.location = {
                        lat: parseFloat(data.location.lat),
                        lng: parseFloat(data.location.lng)
                    };
                }
                
                // Parse numbers
                Object.keys(data).forEach(key => {
                    if (!isNaN(data[key]) && data[key] !== '') {
                        data[key] = parseFloat(data[key]);
                    }
                });
                
                // Validasi khusus untuk Pelanggan - cek port ODP
                if (entityType === 'Pelanggan') {
                    const odpId = data.odpRef;
                    const port = data.odpPort;
                    
                    if (odpId && port) {
                        const existingCustomer = dataCache.Pelanggan.find(p => 
                            p.odpRef === odpId && p.odpPort === port && p.id !== entityId
                        );
                        
                        if (existingCustomer) {
                            throw new Error(`Port ${port} pada ODP ini sudah terisi oleh pelanggan ${existingCustomer.name}`);
                        }
                    }
                }
                
                // Tambah timestamp dan user info
                data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                data.updatedBy = currentUser.email;
                
                if (entityId) {
                    // Update existing document
                    await db.collection(entityType).doc(entityId).update(data);
                    showToast(`${entityType} berhasil diperbarui`, 'success');
                } else {
                    // Add new document
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    data.createdBy = currentUser.email;
                    await db.collection(entityType).add(data);
                    showToast(`${entityType} berhasil ditambahkan`, 'success');
                }
                
                // Log audit
                await logAudit(entityId ? 'update' : 'create', entityType, entityId || 'new', data);
                
                // Reload data
                await loadDataFromFirestore(entityType);
                
                // Refresh UI jika di halaman tabel
                if ($('table-title').dataset.entity === entityType) {
                    renderTable(entityType, dataCache[entityType]);
                }
                
                // Refresh peta jika entity memiliki lokasi
                if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                    renderMarkers(entityType, dataCache[entityType]);
                }
                
                // Update dashboard stats
                updateDashboardStats();
                
                // Tutup modal
                formModal.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving entity:', error);
                showToast(`Gagal menyimpan ${entityType}: ${error.message}`, 'error');
            } finally {
                // Reset loading state
                submitText.textContent = 'Simpan';
                submitSpinner.classList.add('hidden');
                submitButton.disabled = false;
            }
        }

        async function deleteEntity(entityType, entityId) {
            if (!confirm(`Apakah Anda yakin ingin menghapus ${entityType} ini?`)) return;
            
            try {
                await db.collection(entityType).doc(entityId).delete();
                showToast(`${entityType} berhasil dihapus`, 'success');
                
                // Log audit
                await logAudit('delete', entityType, entityId, {});
                
                // Reload data
                await loadDataFromFirestore(entityType);
                
                // Refresh UI jika di halaman tabel
                if ($('table-title').dataset.entity === entityType) {
                    renderTable(entityType, dataCache[entityType]);
                }
                
                // Refresh peta jika entity memiliki lokasi
                if (['OLT', 'ODC', 'ODP', 'Pelanggan'].includes(entityType)) {
                    renderMarkers(entityType, dataCache[entityType]);
                }
                
                // Update dashboard stats
                updateDashboardStats();
                
            } catch (error) {
                console.error('Error deleting entity:', error);
                showToast(`Gagal menghapus ${entityType}`, 'error');
            }
        }

        async function logAudit(action, entityType, entityId, details) {
            try {
                await db.collection('AuditLog').add({
                    userEmail: currentUser.email,
                    action: action,
                    entityType: entityType,
                    entityId: entityId,
                    details: details,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Reload audit log data
                await loadDataFromFirestore('AuditLog');
            } catch (error) {
                console.error('Error logging audit:', error);
            }
        }

        // --- 8. Offline Support & Sync ---

        function setupOfflineSync() {
            // Deteksi status online/offline
            window.addEventListener('online', () => {
                isOnline = true;
                updateOnlineStatusUI(true);
                processOfflineQueue();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateOnlineStatusUI(false);
            });
        }

        function updateOnlineStatusUI(online) {
            if (online) {
                onlineIndicator.classList.replace('bg-red-500', 'bg-green-500');
                onlineText.textContent = 'Online';
            } else {
                onlineIndicator.classList.replace('bg-green-500', 'bg-red-500');
                onlineText.textContent = 'Offline';
            }
        }

        async function processOfflineQueue() {
            if (offlineQueue.length === 0) return;
            
            showToast('Menyinkronkan data offline...', 'warning');
            
            for (const item of offlineQueue) {
                try {
                    if (item.action === 'create') {
                        await db.collection(item.entityType).add(item.data);
                    } else if (item.action === 'update') {
                        await db.collection(item.entityType).doc(item.entityId).update(item.data);
                    } else if (item.action === 'delete') {
                        await db.collection(item.entityType).doc(item.entityId).delete();
                    }
                    
                    // Hapus dari queue jika berhasil
                    offlineQueue = offlineQueue.filter(i => i !== item);
                } catch (error) {
                    console.error('Error processing offline item:', error);
                }
            }
            
            // Simpan queue yang tersisa
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            updateOfflineQueueUI();
            
            if (offlineQueue.length === 0) {
                showToast('Sinkronisasi offline selesai', 'success');
            } else {
                showToast(`Sinkronisasi sebagian berhasil. ${offlineQueue.length} item gagal.`, 'warning');
            }
        }

        function updateOfflineQueueUI() {
            const queueList = $('offline-queue-list');
            
            if (offlineQueue.length === 0) {
                queueList.textContent = 'Tidak ada item dalam antrian.';
            } else {
                queueList.innerHTML = `
                    <div class="space-y-2">
                        ${offlineQueue.map(item => `
                            <div class="flex items-center justify-between p-2 bg-yellow-50 rounded">
                                <div>
                                    <span class="font-medium">${item.entityType}</span>
                                    <span class="text-sm text-gray-600"> - ${item.action}</span>
                                </div>
                                <span class="text-xs text-yellow-600">Menunggu sinkronisasi</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // --- 9. Responsif & Event Listener Lainnya ---

        window.addEventListener('resize', () => {
            if (window.innerWidth >= 640) {
                sidebar.classList.remove('sidebar-collapsed');
            } else {
                sidebar.classList.add('sidebar-collapsed');
            }
            
            // Refresh peta jika perlu
            if (map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
        });

        // Tutup dropdown user menu jika klik di luar
        document.addEventListener('click', (e) => {
            if (!$('user-menu-button').contains(e.target)) {
                $('user-menu-dropdown').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
